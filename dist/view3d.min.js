/*
Copyright (c) 2020-present NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.1.0
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/lights/LightProbeGenerator"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["three","@egjs/component","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/lights/LightProbeGenerator","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.THREE,e.Component,e.RGBELoader,e.LightProbeGenerator,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(T,e,o,c,s,t,i){"use strict";class N extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,N.prototype),this.name="View3DError",this.code=t}}var r={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,PROVIDE_WIDTH_OR_HEIGHT:5,FORMAT_NOT_SUPPORTED:6,FILE_NOT_SUPPORTED:7,NOT_INITIALIZED:8},F=r,z={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization',PROVIDE_WIDTH_OR_HEIGHT:"Either width or height should be given.",FORMAT_NOT_SUPPORTED:e=>`Given format "${e}" is not supported or invalid`,FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet"};const U=(e,t)=>{let s=null;if("string"==typeof e){const i=t||document;t=i.querySelector(e);if(!t)throw new N(z.ELEMENT_NOT_FOUND(e),F.ELEMENT_NOT_FOUND);s=t}else e&&e.nodeType===Node.ELEMENT_NODE&&(s=e);return s},_=e=>e*Math.PI/180,d=(e,t,s)=>Math.max(Math.min(e,s),t),n=(e,t,s)=>e*(1-s)+t*s,a=(e,t,s)=>{var i=Math.abs(s-t);return e<t?e=s-(t-e)%i:s<e&&(e=t+(e-s)%i),e},h=(i,...e)=>(e.forEach(s=>{Object.keys(s).forEach(e=>{var t=s[e];Array.isArray(i[e])&&Array.isArray(t)?i[e]=[...i[e],...t]:i[e]=t})}),i),V=e=>"object"==typeof e?e:{},l=e=>e?"true":"false",u=(e,t,s)=>{t=_(t),s=_(s);const i=new T.Vector3(0,0,0);return i.y=e*Math.sin(s),i.z=e*Math.cos(s),i.x=i.z*Math.sin(-t),i.z=i.z*Math.cos(-t),i};function p(e,n,a,h){return new(a=a||Promise)(function(s,t){function i(e){try{r(h.next(e))}catch(e){t(e)}}function o(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,o)}r((h=h.apply(e,n||[])).next())})}const k="auto",w={READY:"ready",LOAD_START:"loadStart",LOAD:"load",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",QUICK_LOOK_TAP:"quickLookTap",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced"},v={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,s=2.75;return e<1/s?t*e*e:e<2/s?t*(e-=1.5/s)*e+.75:e<2.5/s?t*(e-=2.25/s)*e+.9375:t*(e-=2.625/s)*e+.984375}},m={POSTER:"view3d-poster"};var g={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const E={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var b,f,R,y,O;class G{constructor(e){this._defaultRenderLoop=e=>{const t=this._view3D,s=this._renderer,{scene:i,camera:o,control:r,autoPlayer:n,animator:a}=t;var h=1e3*e;a.update(e),r.update(h),n.update(h),t.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:t,delta:h}),o.updatePosition(),s.autoClear=!1,s.clear(),i.skybox&&(i.skybox.updateCamera(),s.render(i.skybox.scene,i.skybox.camera)),s.render(i.root,o.threeCamera),s.autoClear=!0,t.trigger(w.RENDER,{type:w.RENDER,target:t,delta:h})},this._view3D=e,this._canvas=((e,t)=>{t=e.querySelector(t);if(!t)throw new N(z.CANVAS_NOT_FOUND,F.CANVAS_NOT_FOUND);return t})(e.rootEl,e.canvasSelector);const t=new T.WebGLRenderer({canvas:this._canvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!0});t.toneMapping=T.LinearToneMapping,t.toneMappingExposure=e.exposure,t.outputEncoding=T.sRGBEncoding,t.setClearColor(0,0),this._renderer=t,this._clock=new T.Clock(!1),this.enableShadow()}get canvas(){return this._canvas}get context(){return this._renderer.context}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new T.Vector2);return{width:e.width,height:e.y}}resize(){const e=this._renderer;var t=this._canvas;e.xr.isPresenting||(e.setPixelRatio(window.devicePixelRatio),e.setSize(t.offsetWidth,t.offsetHeight,!1))}setAnimationLoop(i){this._clock.start(),this._renderer.setAnimationLoop((e,t)=>{var s=this._clock.getDelta();i(s,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}enableShadow(){const e=this._renderer;e.shadowMap.enabled=!0,e.shadowMap.type=T.PCFSoftShadowMap}disableShadow(){const e=this._renderer;e.shadowMap.enabled=!1}}class M{constructor(e){this._renderer=e}load(i){return new Promise((e,t)=>{const s=new T.TextureLoader;s.load(i,e,void 0,t)})}loadEquirectagularTexture(i){return new Promise((t,e)=>{const s=new T.TextureLoader;s.load(i,e=>{e.mapping=T.EquirectangularReflectionMapping,t(e)},void 0,e)})}loadCubeTexture(i){return new Promise((e,t)=>{const s=new T.CubeTextureLoader;s.load(i,e,void 0,t)})}loadHDRTexture(i){return new Promise((t,e)=>{const s=new o.RGBELoader;s.setCrossOrigin("anonymous"),s.load(i,e=>{e.mapping=T.EquirectangularReflectionMapping,t(e)},void 0,e)})}}const S=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap"],x={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"};(O=b=b||{})[O.NONE=0]="NONE",O[O.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",O[O.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",O[O.ONE_FINGER=3]="ONE_FINGER",O[O.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",O[O.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",O[O.TWO_FINGER=12]="TWO_FINGER",O[O.PINCH=16]="PINCH";const P="EXT_View3D_texture_LOD",C={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",LOAD:"load",ERROR:"error"},L={GRAB:"grab",GRABBING:"grabbing",NONE:""};(O=f=f||{})[O.LEFT=0]="LEFT",O[O.MIDDLE=1]="MIDDLE",O[O.RIGHT=2]="RIGHT";const D=Number.MAX_SAFE_INTEGER||9007199254740991;class A{constructor(e,{opacity:t=.3,hardness:s=6,yaw:i=0,pitch:o=0}={}){this._hardness=s,this._yaw=i,this._pitch=o,this._geometry=new T.PlaneBufferGeometry(2,2),this._material=new T.ShadowMaterial({opacity:t,fog:!1}),this._mesh=new T.Mesh(this._geometry,this._material),this._light=new T.DirectionalLight,this._baseLightPos=new T.Vector3,this._modelRadius=0;const r=this._mesh;r.rotateX(-Math.PI/2),r.scale.setScalar(Math.pow(2,32)-1),r.receiveShadow=!0,r.castShadow=!1,r.name="ShadowPlane-Mesh";const n=this._light;n.intensity=0,n.target=r,n.castShadow=!0,n.name="ShadowPlane-Light";e=e.renderer.threeRenderer.capabilities.maxTextureSize;this._maxHardness=Math.round(Math.log(e)/Math.log(2)),this._updateSoftnessLevel()}get mesh(){return this._mesh}get light(){return this._light}get opacity(){return this._material.opacity}get hardness(){return this._hardness}get yaw(){return this._yaw}get pitch(){return this._pitch}get radius(){return this._light.shadow.radius}set opacity(e){this._material.opacity=e}set hardness(e){this._hardness=Math.min(e,this._maxHardness),this._updateSoftnessLevel()}set radius(e){this._light.shadow.radius=e,this._light.shadow.needsUpdate=!0}update(e){this._updatePlane(e),this._updateLightPosition(e),this.updateShadow()}updateShadow(e=1){const t=this._light;const s=t.shadow.camera;var i=this._modelRadius;t.position.copy(this._baseLightPos.clone().multiplyScalar(e));i*=1.5*e;s.near=0,s.far=D,s.left=-i,s.right=i,s.top=i,s.bottom=-i,s.updateProjectionMatrix()}_updateSoftnessLevel(){const e=this._light;var t=d(Math.floor(this._hardness),1,this._maxHardness),t=Math.pow(2,Math.floor(t));e.shadow.mapSize.set(t,t),null!==(t=e.shadow.map)&&void 0!==t&&t.dispose(),e.shadow.map=null}_updatePlane(e){const t=this._mesh,s=e.bbox;e=[s.min.x,s.min.z,s.max.x,s.max.z].map(e=>Math.abs(e)),e=Math.max(...e);t.scale.setScalar(100*e)}_updateLightPosition(e){var t=this._yaw,s=this._pitch,e=e.bbox.getBoundingSphere(new T.Sphere).radius,s=u(2*e+.1,t,90-s);this._baseLightPos.copy(s),this._modelRadius=e}}class I{constructor(e){this._view3D=e,this._scene=new T.Scene,this._camera=new T.PerspectiveCamera}get scene(){return this._scene}get camera(){return this._camera}destroy(){this._disposeOldSkybox()}updateCamera(){var e=this._view3D;const t=this._camera;var s=e.camera,e=s.currentPose.pivot;t.copy(s.threeCamera),t.lookAt(e),t.updateProjectionMatrix()}useBlurredHDR(e){this._disposeOldSkybox();const t=this._view3D.renderer.threeRenderer,s=new T.Scene;s.background=e;var i=t.toneMappingExposure;t.toneMappingExposure=1;var o=new T.WebGLCubeRenderTarget(256,{encoding:T.sRGBEncoding,format:T.RGBAFormat});const r=new T.CubeCamera(.1,1e3,o);r.update(t,s);var n=c.LightProbeGenerator.fromCubeRenderTarget(t,o),e=new T.MeshStandardMaterial({side:T.BackSide});const a=new T.IcosahedronBufferGeometry(1,4),h=new T.Scene;e=new T.Mesh(a,e);const l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return h.add(e),h.add(n),r.update(t,h),t.toneMappingExposure=i,this._scene.background=o.texture,this}useTexture(e){return this._scene.background=e,this}useColor(e){return this._scene.background=new T.Color(e),this}_disposeOldSkybox(){const e=this._scene.background;e&&(e.dispose(),this._scene.background=null)}}class B{constructor(e){this._view3D=e,this._root=new T.Scene,this._skybox=null,this._userObjects=new T.Group,this._envObjects=new T.Group,this._fixedObjects=new T.Group,this._shadowPlane=new A(e,V(e.shadow));const t=this._root,s=this._userObjects,i=this._envObjects,o=this._fixedObjects;var r=this._shadowPlane;s.name="userObjects",i.name="envObjects",o.name="fixedObjects",t.add(s,i,o),e.shadow&&o.add(r.mesh,r.light)}get root(){return this._root}get skybox(){return this._skybox}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const s=t?this._userObjects:this._envObjects;e=Array.isArray(e)?e:[e];s.add(...e)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(o){return p(this,void 0,void 0,function*(){var e=this._view3D;const t=new I(e);if(this._skybox=t,"number"==typeof o||"#"===o.charAt(0))t.useColor(o);else{const s=new M(this._view3D.renderer),i=yield s.load(o);i.encoding=T.sRGBEncoding,t.useTexture(i)}})}setSkybox(r){var n;return p(this,void 0,void 0,function*(){const e=this._root;var t=this._view3D;if(null!==(n=this._skybox)&&void 0!==n&&n.destroy(),r){const i=new M(t.renderer);var s=yield i.loadHDRTexture(r);const o=new I(t);t.skyboxBlur?o.useBlurredHDR(s):o.useTexture(s),this._skybox=o,e.environment=s}else this._skybox=null,e.environment=null})}setEnvMap(s){return p(this,void 0,void 0,function*(){if(s){const t=new M(this._view3D.renderer);var e=yield t.loadHDRTexture(s);this._root.environment=e}else this._root.environment=null})}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e;t.geometry.dispose();const s=Array.isArray(t.material)?t.material:[t.material];s.forEach(t=>{S.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}class H{constructor(e,t,s,i=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=s,this.pivot=(new T.Vector3).fromArray(i)}clone(){return new H(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}}const W=v.EASE_OUT_CUBIC,j={min:0,max:1},Y=new H(0,15,0,[0,0,0]),X={min:-1/0,max:1/0},q={min:-89.9,max:89.9},Q=[g.WEBXR,g.SCENE_VIEWER,g.QUICK_LOOK];class Z{constructor({duration:e=300,loop:t=!1,range:s=j,easing:i=W}={}){this._duration=e,this._loop=t,this._range=s,this._easing=i,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,s=this._end,i=this._duration,o=this._val,r=this._loop,i=this._progress+e/i;this._progress=(r?a:d)(i,0,1);i=this._easing(this._progress);return this._val=n(t,s,i),!r&&1<=this._progress&&(this._activated=!1),this._val-o}reset(e){var t=this._range,t=d(e,t.min,t.max);this._start=t,this._end=t,this._val=t,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=d(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class K{constructor(e,t,s,{duration:i=300,easing:o=W}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,t=t.clone(),s=s.clone(),t.yaw=a(t.yaw,0,360),s.yaw=a(s.yaw,0,360),180<Math.abs(s.yaw-t.yaw)&&(s.yaw=s.yaw<t.yaw?s.yaw+360:s.yaw-360),this._motion=new Z({duration:i,range:j,easing:o}),this._from=t,this._to=s}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}update(e){if(this._enabled){const s=this._view3D.camera,i=this._from;var t=this._to;const o=this._motion;o.update(e);e=o.val;s.yaw=n(i.yaw,t.yaw,e),s.pitch=n(i.pitch,t.pitch,e),s.zoom=n(i.zoom,t.zoom,e),s.pivot=i.pivot.clone().lerp(t.pivot,e),1<=e&&(this.disable(),this._finishCallbacks.forEach(e=>e()))}}enable(){this._enabled||(this._enabled=!0,this._motion.reset(0),this._motion.setEndDelta(1))}disable(){this._enabled&&(this._enabled=!1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class ${constructor(e){this._distance=0,this._baseFov=45,this._defaultPose=Y,this._currentPose=this._defaultPose.clone(),this._view3D=e,this._threeCamera=new T.PerspectiveCamera,this._maxTanHalfHFov=0,this._defaultPose=new H(e.yaw,e.pitch,0),this._currentPose=this._defaultPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get pose(){return this._currentPose}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this._distance*Math.tan(_(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._currentPose.yaw=e}set pitch(e){this._currentPose.pitch=e}set zoom(e){this._currentPose.zoom=e}set pivot(e){this._currentPose.pivot=e}reset(n=0,a=W){return p(this,void 0,void 0,function*(){const t=this._view3D,s=t.control;var e=this._currentPose;const i=this._defaultPose;if(n<=0)return this._currentPose=i.clone(),s.sync(),Promise.resolve();{const o=new K(t,e,i);o.duration=n,o.easing=a,o.enable(),s.disable();const r=e=>{o.update(e.delta)};return t.on(w.BEFORE_RENDER,r),new Promise(e=>{o.onFinished(()=>{s.sync(),s.enable(),t.off(w.BEFORE_RENDER,r),e()})})}})}resize({width:e,height:t}){const s=this._threeCamera;var i=this._view3D.fov;s.aspect=e/t,i===k?this._applyEffectiveFov(45):this._baseFov=i}fit(e,t){var s=this._view3D;const i=this._threeCamera,o=s.control,r=this._defaultPose,n=e.bbox;var a=s.fov,s=a===k?45:a;const h=Array.isArray(t)?(new T.Vector3).fromArray(t):n.getCenter(new T.Vector3);t=e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(h)),0),t=Math.sqrt(t);const l=t/Math.sin(_(s/2));e=e.reduceVertices((e,t)=>{var s=(new T.Vector3).subVectors(t,h),t=Math.sqrt(s.x*s.x+s.z*s.z);return Math.max(e,t/(l-Math.abs(s.y)))},0);a===k?(this._maxTanHalfHFov=e,this._applyEffectiveFov(s)):this._maxTanHalfHFov=a,r.pivot=h.clone(),this._distance=l,i.near=.1*(l-t),i.far=10*(l+t),o.zoom.updateRange()}updatePosition(){var e=this._view3D["control"];const t=this._threeCamera,s=this._currentPose;var i=this._distance,o=this._baseFov,e=e.zoom.range;s.yaw=a(s.yaw,0,360),s.pitch=d(s.pitch,q.min,q.max),s.zoom=-(d(o-s.zoom,e.min,e.max)-o);const r=u(i,s.yaw,s.pitch);o-=s.zoom;r.add(s.pivot),t.fov=o,t.position.copy(r),t.lookAt(s.pivot),t.updateProjectionMatrix()}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(_(e/2)),t=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=180*(2*Math.atan(t))/Math.PI}}class J{constructor(e){this._onResize=()=>{this._view3d.resize()},this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const t=new ResizeObserver(this._onResize);t.observe(e.renderer.canvas),this._resizeObserver=t}else e.resize(),window.addEventListener(C.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(C.RESIZE,this._onResize),this._enabled=!1,this}}class ee{constructor(e){this._view3D=e,this._mixer=new T.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!==(e=this._clips[this._activeAnimationIdx])&&void 0!==e?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}setClips(e){const s=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=s.clipAction(e);return t.setEffectiveWeight(0),t})}play(e){const t=this._actions[e];t&&(this.stop(),this._restoreTimeScale(),t.setEffectiveTimeScale(1),t.setEffectiveWeight(1),t.play(),this._activeAnimationIdx=e,this._flushFadePromises())}crossFade(l,c,{synchronize:_=!1}={}){var d;return p(this,void 0,void 0,function*(){const s=this._view3D,t=this._mixer;var e=this._actions,i=this._activeAnimationIdx;const o=e[l],r=null!==(d=e[i])&&void 0!==d?d:o,n="loop";this._restoreTimeScale();const a=()=>{o.enabled=!0,o.setEffectiveTimeScale(1),o.setEffectiveWeight(1),o.time=0,o.play(),r.crossFadeTo(o,c/1e3,!0),this._activeAnimationIdx=l};if(_){const h=e=>{e.action===r&&(t.removeEventListener(n,h),a())};t.addEventListener(n,h)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{o.getEffectiveWeight()<1||(s.off(w.BEFORE_RENDER,t),e(!0))};s.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return p(this,void 0,void 0,function*(){const s=this._view3D;const i=this._actions[this._activeAnimationIdx];return!!i&&(this._flushFadePromises(),this._restoreTimeScale(),i.fadeOut(e/1e3),this._activeAnimationIdx=-1,new Promise(e=>{const t=()=>{0<i.getEffectiveWeight()||(s.off(w.BEFORE_RENDER,t),e(!0))};s.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=1}_flushFadePromises(){const s=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),s.off(w.BEFORE_RENDER,t)}),this._fadePromises=[]}}class te extends e{constructor({context:e=window,repeat:t=0,duration:s=300,easing:i=v.EASE_OUT_CUBIC}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,s=this._repeat,e=this._time+e,i=Math.floor(e/t);this._time=(this._loopCount>=s?d:a)(e,0,t);var t=this._time/t,o={progress:t,easedProgress:this._easing(t)};this.trigger("progress",o);for(let e=0;e<i;e++){if(this._loopCount++,this._loopCount>s)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},o),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=s,this._easing=i,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const se={AR:"immersive-ar",VR:"immersive-vr"},ie={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},oe={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend"},re={TOUCH:"generic-touchscreen"},ne={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{}},ae={},he={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class le{constructor({scale:e=1}={}){this.rotation=new T.Quaternion,this._axis=new T.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new T.Vector2,this._fromQuat=new T.Quaternion,this._toQuat=new T.Quaternion,this._motion=new Z({range:X}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:s}){if(this._active&&1===s.length){const i=this._prevPos,o=this._motion;s=s[0];const r=e.modelMovable.getWorldPosition(new T.Vector3);e=((e,t,s)=>{const i=(new T.Vector2).subVectors(t,e).normalize(),o=(new T.Vector2).subVectors(s,e).normalize();s=o.angle()-i.angle(),e=-Math.sign(s)*(2*Math.PI-Math.abs(s));return Math.abs(s)<Math.abs(e)?s:e})((new T.Vector2).fromArray(r.project(t).toArray()),i,s)*this._userScale,t=(new T.Quaternion).setFromAxisAngle(this._axis,e),e=this._getInterpolatedQuaternion();this._fromQuat.copy(e),this._toQuat.premultiply(t),o.reset(0),o.setEndDelta(1),i.copy(s)}}update({scene:e},t){if(this._active){const s=this._motion;s.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,s=this._fromQuat,e=e.val;return(new T.Quaternion).copy(s).slerp(t,e)}}(O=R=R||{})[O.WAITING=0]="WAITING",O[O.TRANSLATING=1]="TRANSLATING",O[O.BOUNCING=2]="BOUNCING";class ce{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:s=v.EASE_OUT_BOUNCE}={}){this._hoverPosition=new T.Vector3,this._floorPosition=new T.Vector3,this._wallRotation=new T.Quaternion,this._dragPlane=new T.Plane,this._enabled=!1,this._vertical=!1,this._state=R.WAITING,this._initialPos=new T.Vector2,this._hoverHeight=e,this._bounceMotion=new Z({duration:t,easing:s,range:X})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=R.TRANSLATING}}deactivate(){if(this._enabled&&!this._vertical&&this._state!==R.WAITING){this._state=R.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const s=this._bounceMotion;e=t.y-e.y;s.reset(e),s.setEndDelta(-e)}else this._state=R.WAITING}init(e,t,s){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=s?new T.Vector3(0,1,0).applyQuaternion(t):new T.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=s}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:s},{hitResults:i}){var o=this._state,r=o===R.WAITING||o===R.BOUNCING;if(i&&1===i.length&&!r){const _=i[0];var n=this._floorPosition.clone();const d=this._floorPosition,u=this._hoverPosition;var a=this._hoverHeight;const p=this._dragPlane;var h=this._vertical,l=_.results[0]&&_.results[0].getPose(t),o=l&&(new T.Matrix4).fromArray(l.transform.matrix),r=l&&.75<o.elements[5],i=l&&o.elements[5]<.25,s=(new T.Vector3).setFromMatrixPosition(s.matrixWorld),o=l&&(new T.Vector3).setFromMatrixPosition(o);if(h)if(!e||l&&i){const v=new T.Vector3(0,1,0);h=l.transform.orientation,i=v.clone().applyQuaternion(new T.Quaternion(h.x,h.y,h.z,h.w)).normalize(),h=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),i);const m=new T.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(m.dot(i)))>=Math.PI/18){var c=(new T.Matrix4).makeBasis(h,v,i);const E=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(c);E.z=0,E.x=Math.PI/2,this._wallRotation.setFromEuler(E),p.normal.copy(new T.Vector3(0,1,0).applyQuaternion(this._wallRotation)),p.constant=this._calcDragPlaneConstant(o)}c=(new T.Vector3).subVectors(o,s).normalize();const g=new T.Ray(s,c);c=g.intersectPlane(p,new T.Vector3);c&&d.copy(c)}else{c=e.getPose(_.inputSource.targetRaySpace,t);if(!c)return;c=c.transform.position;const w=new T.Vector3(c.x,c.y,c.z);c=w.sub(s).normalize();const b=new T.Ray(s,c);c=b.intersectPlane(p,new T.Vector3);c&&d.copy(c)}else if(!e||l&&r){r=-p.constant,a=o.y+a;.1<a-r&&(p.constant=-a);a=(new T.Vector3).subVectors(o,s).normalize();const f=new T.Ray(s,a);a=f.intersectPlane(p,new T.Vector3);a&&(d.copy(a),d.setY(o.y),u.copy(a))}else{t=e.getPose(_.inputSource.targetRaySpace,t);if(!t)return;t=t.transform.position;const y=new T.Vector3(t.x,t.y,t.z);t=y.sub(s).normalize();const O=new T.Ray(s,t);t=O.intersectPlane(p,new T.Vector3);t&&(d.copy(t),d.setY(n.y),u.copy(t))}}}update({scene:e},t){var s=this._state,i=this._floorPosition;const o=this._hoverPosition,r=this._bounceMotion;var n=this._vertical;s===R.BOUNCING&&(r.update(t),o.setY(i.y+r.val),1<=r.progress&&(this._state=R.WAITING)),e.setRootPosition(i),n?e.setWallRotation(this._wallRotation):e.setModelHovering(o.y-i.y)}_calcDragPlaneConstant(e){var t=this._vertical,s=this._dragPlane.normal.clone();const i=new T.Plane(s,0);t=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+t)}}class _e{constructor({width:e=.1,padding:t=20,offset:s=.05,font:i="64px sans-serif",color:o="white"}={}){const r=document.createElement("canvas"),n=r.getContext("2d");n.font=i;var a=n.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,l=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,a=(e=>{let t=1;for(;t<e;)t*=2;return t})(h);r.width=a;a=e*((r.height=a)/h);this._ctx=n,this._canvas=r,this._height=a*l/h,this._texture=new T.CanvasTexture(r);a=new T.PlaneGeometry(a,a),a=new T.Mesh(a,new T.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=i,this._color=o,this._padding=t,this._offset=s,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,s){const i=this._mesh;s=this._height/2+this._offset+s,e=new T.Vector3(0,s,0).applyQuaternion(e.clone().invert());i.position.copy(e),i.lookAt(t)}updateScale(e){const t=this._ctx;var s=this._canvas,i=this._padding,o=(100*e).toFixed(0);t.clearRect(0,0,s.width,s.height);var r=s.width/2,n=s.height/2,a=t.measureText(o+"%"),s=(a.actualBoundingBoxLeft+a.actualBoundingBoxRight)/2,a=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(r-s,n-a-i),t.lineTo(r+s,n-a-i),t.quadraticCurveTo(r+s+i,n-a-i,r+s+i,n-a),t.lineTo(r+s+i,n+a),t.quadraticCurveTo(r+s+i,n+a+i,r+s,n+a+i),t.lineTo(r-s,n+a+i),t.quadraticCurveTo(r-s-i,n+a+i,r-s-i,n+a),t.lineTo(r-s-i,n-a),t.quadraticCurveTo(r-s-i,n-a-i,r-s,n-a-i),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(o+"%",r,n),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class de{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new _e,this._motion=new Z({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new _e}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:s,xrCam:i,initialScale:o}){const r=this._motion;var n=r.range;if(o===k){var a=2*Math.atan(1/i.projectionMatrix.elements[5]),h=i.projectionMatrix.elements[0]/i.projectionMatrix.elements[5];const c=i.position;i=t.bbox.max.y-t.bbox.min.y,a=c.distanceTo((new T.Vector3).addVectors(s,new T.Vector3(0,i/2,0)))*Math.tan(a/2),h=a*h,t=t.bbox.getBoundingSphere(new T.Sphere),a=a/t.radius,t=h/t.radius;const l=d(Math.min(t,a),n.min,1);r.reset(l)}else r.reset(d(o,n.min,n.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new T.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const i=this._motion;var s=(new T.Vector2).subVectors(t[0],t[1]).length(),t=s-this._prevCoordDistance;i.setEndDelta(t),this._prevCoordDistance=s,this._updateUIPosition(e)}}update({view3D:e,scene:t},s){if(this._enabled&&this._active){const i=this._motion;i.update(s),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),t.setModelScale(this._scaleMultiplier),e.scene.shadowPlane.updateShadow(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:s,vertical:i}){const o=e.model;s=(new T.Vector3).setFromMatrixPosition(s.matrixWorld),i=i?o.bbox.getBoundingSphere(new T.Sphere).radius:o.bbox.max.y-o.bbox.min.y;this._ui.updatePosition(t.root.quaternion,s,i)}}class ue{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:s=1e3}={}){var i=Math.PI/18;const o=new T.RingGeometry(.975,1,150,1,-6*i,30*i),r=new T.CircleGeometry(.1,30,0,2*Math.PI);o.rotateX(-Math.PI/2),r.rotateX(-Math.PI/2);const n=new T.RingGeometry(.96,1.015,30,1,25*i,4*i),a=n.attributes["position"];var h=Math.floor(11*a.count/16),l=Math.floor(13*a.count/16),c=Math.floor((l-h+1)/2),_=(new T.Vector3).fromBufferAttribute(a,h).y;for(let e=h;e<l;e++){var d=e-h,d=.025*(c-Math.abs(d-c));a.setY(e,_-d)}n.rotateX(-Math.PI/2);var u=new T.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),p=new T.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),i=new T.Mesh(o,u),u=new T.Mesh(r,u),p=new T.Mesh(n,p);const v=new T.Group;v.add(i,u,p),v.position.setY(1e-4),this._mesh=v,this._ring=i,this._reticle=u,this._arrow=p,this._animator=new Z({duration:s}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new T.Sphere).radius)}update({delta:e,rotation:t}){const s=this._mesh,i=this._animator;if(s.visible){i.update(e);const o=this._ring.material,r=this._arrow.material;e=this._opacityRange;o.opacity=i.val*e.min,r.opacity=i.val*e.max,i.val<=0&&(s.visible=!1),s.quaternion.copy(t),s.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(O=y=y||{})[O.WAITING=0]="WAITING",O[O.IN_DEADZONE=1]="IN_DEADZONE",O[O.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class pe{constructor({size:e=.1}={}){this._state=y.WAITING,this._detectedGesture=b.NONE,this._testingGestures=b.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new T.Vector2,this._prevTwoFingerPos=new T.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===y.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new T.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new T.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=y.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,b.NONE)}cleanup(){this._testingGestures=b.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=b.NONE,this._state=y.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,s=this._size,i=this._testingGestures,o=this._lastFingerCount,r=e.length;if(t===y.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=r,this.applyScreenAspect(e),r!==o)return this.setFirstInput(e),b.NONE;if(1===r){var o=e[0],n=this._prevOneFingerPos.clone();const a=(new T.Vector2).subVectors(o,n);a.length()>s&&(Math.abs(a.x)>Math.abs(a.y)?b.ONE_FINGER_HORIZONTAL&i&&(this._detectedGesture=b.ONE_FINGER_HORIZONTAL):b.ONE_FINGER_VERTICAL&i&&(this._detectedGesture=b.ONE_FINGER_VERTICAL))}else if(2===r){n=(new T.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),r=this._prevTwoFingerPos.clone();const h=(new T.Vector2).subVectors(n,r);h.length()>s&&(Math.abs(h.x)>Math.abs(h.y)?b.TWO_FINGER_HORIZONTAL&i&&(this._detectedGesture=b.TWO_FINGER_HORIZONTAL):b.TWO_FINGER_VERTICAL&i&&(this._detectedGesture=b.TWO_FINGER_VERTICAL));e=(new T.Vector2).subVectors(e[1],e[0]).length();Math.abs(e-this._initialTwoFingerDistance)>s&&b.PINCH&i&&(this._detectedGesture=b.PINCH)}return this._detectedGesture!==b.NONE&&(this._state=y.OUT_OF_DEADZONE),this._detectedGesture}}class ve{constructor(e,t,{rotate:s,translate:i,scale:o,ring:r,deadzone:n,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var s=this._view3D,i=this._arScene,o=this._hitTestSource;const r=this._deadzoneChecker;var n=this._rotateControl,a=this._translateControl,h=this._scaleControl;const l=s.renderer.threeRenderer;var c=l.xr.getCamera(new T.PerspectiveCamera),e=l.xr.getReferenceSpace();if(o&&!(c.cameras.length<=0)){c=c.cameras[0];const _=s.model;n.enabled&&r.addTestingGestures(b.ONE_FINGER),a.enabled&&r.addTestingGestures(b.ONE_FINGER),h.enabled&&r.addTestingGestures(b.PINCH);h=t.getHitTestResultsForTransientInput(o),o=this._hitResultToVector(h);if(r.applyScreenAspect(o),r.setFirstInput(o),1===o.length){e=t.getPose(h[0].inputSource.targetRaySpace,e);if(e){c=(new T.Vector3).setFromMatrixPosition(c.matrixWorld),e=e.transform.position,e=new T.Vector3(e.x,e.y,e.z).sub(c).normalize();const d=new T.Ray(c,e),u=_.bbox.getBoundingSphere(new T.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new T.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=s,this._translate=i,this._scale=o,this._initialScale=a,this._rotateControl=new le(V(s)),this._translateControl=new ce(V(i)),this._scaleControl=new de(V(o)),this._floorIndicator=new ue(r),this._deadzoneChecker=new pe(n)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:r,session:n,size:a,vertical:h,hitPosition:l,hitRotation:c}){return p(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var s=this._scaleControl,i=this._floorIndicator;const o=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),o.setAspect(a.height/a.width),e.add(i.mesh,s.ui.mesh),this.syncTargetModel(r);s=yield n.requestHitTestSourceForTransientInput({profile:re.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(oe.SELECT_START,this._onSelectStart),e.removeEventListener(oe.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,s=this._translate,i=this._scale;const o=this._rotateControl,r=this._translateControl,n=this._scaleControl;var a=this._vertical;e.addEventListener(oe.SELECT_START,this._onSelectStart),e.addEventListener(oe.SELECT_END,this._onSelectEnd),t&&!a&&o.enable(),s&&r.enable(),i&&n.enable()}disable(e){const t=this._rotateControl,s=this._translateControl,i=this._scaleControl;e.removeEventListener(oe.SELECT_START,this._onSelectStart),e.removeEventListener(oe.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),s.disable(),i.disable()}update(e){const{view3D:t,session:s,frame:i}=e;var o,r,n=this._hitTestSource;n&&t.model&&(o=this._deadzoneChecker,r=s.inputSources,n=null!==(n=null===i||void 0===i?void 0:i.getHitTestResultsForTransientInput(n))&&void 0!==n?n:[],n={coords:this._hitResultToVector(n),inputSources:r,hitResults:n},o.inDeadzone?this._checkDeadzone(e,n):this._processInput(e,n),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,s=this._translateControl.floorPosition,i=this._view3D.renderer.threeRenderer.xr.getCamera(new T.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:s,xrCam:i,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var s=this._arScene;const i=this._rotateControl,o=this._translateControl,r=this._scaleControl;var n=this._deadzoneChecker.check(t.map(e=>e.clone()));if(n!==b.NONE)switch(n){case b.ONE_FINGER_HORIZONTAL:case b.ONE_FINGER_VERTICAL:this._modelHit?(o.activate(),o.setInitialPos(t)):(i.activate(),i.updateRotation(s.modelMovable.quaternion),i.setInitialPos(t));break;case b.PINCH:r.activate(e),r.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const s=this._arScene,i=this._rotateControl,o=this._translateControl,r=this._scaleControl,n=this._floorIndicator;var a=1e3*t;i.update(e,a),o.update(e,a),r.update(e,a);t=i.rotation,e=o.floorPosition;s.setRootPosition(e),n.update({delta:a,rotation:t})}_hitResultToVector(e){return e.map(e=>(new T.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class me{constructor(){this._root=new T.Scene,this._modelRoot=new T.Group,this._modelMovable=new T.Group,this._modelFixed=new T.Group,this._arRoot=new T.Group;const e=this._root,t=this._modelRoot;var s=this._modelMovable,i=this._modelFixed,o=this._arRoot;t.add(s),e.add(t,i,o)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,s=this._modelMovable,i=this._modelFixed;e=e.scene;s.add(e.userObjects,e.envObjects),i.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,s=this._modelFixed;const i=e.scene;[...t.children,...s.children].forEach(e=>{i.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const s=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,s.position.setZ(t/2),s.position.setY(-e.bbox.min.z),s.rotateX(-Math.PI/2),s.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class ge{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,ne.DOM_OVERLAY(e)}}class Ee{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(ie.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return ne.HIT_TEST}getResults(e){return null!==(e=null==e?void 0:e.getHitTestResults(this._source))&&void 0!==e?e:[]}}class we{constructor(e,{features:t=ae,vertical:s=!1,overlayRoot:i=null,rotate:o=!0,translate:r=!0,scale:n=!0,ring:a={},deadzone:h={},initialScale:l=k}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=s,this.overlayRoot=i,this._arScene=new me,this._control=new ve(e,this._arScene,{rotate:o,translate:r,scale:n,ring:a,deadzone:h,initialScale:l}),this._hitTest=new Ee,this._domOverlay=new ge}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&Ee.isAvailable()&&ge.isAvailable()?navigator.xr.isSessionSupported(se.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}enter(){return p(this,void 0,void 0,function*(){const a=this._view3D,h=this._arScene,t=a.renderer,l=t.threeRenderer,c=this._control,e=this._hitTest,s=this._domOverlay,_=this.vertical;var i=this._getAllXRFeatures();l.xr.enabled=!0;const d=yield navigator.xr.requestSession(se.AR,i),o=l.getPixelRatio();l.setPixelRatio(1),l.xr.setReferenceSpaceType(ie.LOCAL),yield l.xr.setSession(d),h.init(a),e.init(d);d.addEventListener("end",()=>p(this,void 0,void 0,function*(){var e=s.root;c.destroy(d),h.destroy(a),!this.overlayRoot&&e&&a.rootEl.removeChild(e),s.destroy(),a.scene.shadowPlane.updateShadow(),l.setPixelRatio(o),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),a.trigger(w.AR_END,{target:a,type:w.AR_END,session:this})}),{once:!0});const u=new T.Clock;u.start(),t.stopAnimationLoop(),l.xr.setAnimationLoop((e,t)=>{var s,i,o,r=l.xr.getCamera(new T.PerspectiveCamera),n=u.getDelta();r.cameras.length<=0||(s=r.cameras[0],i=l.xr.getReferenceSpace(),o={width:null!==(r=null==(o=d.renderState.baseLayer)?void 0:o.framebufferWidth)&&void 0!==r?r:1,height:null!==(o=null==o?void 0:o.framebufferHeight)&&void 0!==o?o:1},i={view3D:a,scene:h,session:d,delta:n,frame:t,vertical:_,referenceSpace:i,xrCam:s,size:o},o=1e3*n,a.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:a,delta:o}),this._modelPlaced?(c.update(i),a.animator.update(n),l.render(h.root,s)):this._initModelPosition(i),a.trigger(w.RENDER,{type:w.RENDER,target:a,delta:o}))}),a.trigger(w.AR_START,{type:w.AR_START,target:a,session:this})})}exit(){return p(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!==(t=U(this.overlayRoot))&&void 0!==t?t:this._createARRootElement();return h({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:s,size:i,vertical:o,referenceSpace:r}=e,n=this._view3D;var a=n.model;const h=this._arScene,l=this._hitTest;if(l.ready&&a){const d=this._control;var c=l.getResults(t);if(!(c.length<=0)){const u=c[0];var _=u.getPose(r);if(_){e=(new T.Matrix4).fromArray(_.transform.matrix);if(!(!o&&e.elements[5]<.75||o&&(.25<=e.elements[5]||e.elements[5]<=-.25))){c=(new T.Vector3).setFromMatrixPosition(e);const p=new T.Quaternion;if(o){const g=new T.Vector3(0,1,0);e=_.transform.orientation,_=g.clone().applyQuaternion(new T.Quaternion(e.x,e.y,e.z,e.w)).normalize(),e=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),_),_=(new T.Matrix4).makeBasis(e,g,_);const E=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);E.z=0,E.x=Math.PI/2,p.setFromEuler(E),h.setWallRotation(p)}h.updateModelRootPosition(a,o),h.setRootPosition(c),h.showModel(),l.destroy(),this._modelPlaced=!0,n.trigger(w.AR_MODEL_PLACED,{type:w.AR_MODEL_PLACED,target:n,session:this,model:a}),d.init({model:a,vertical:o,session:s,size:i,hitPosition:c,hitRotation:p});const v=d.scale.scale,m=new te({context:s,duration:1e3});m.on("progress",e=>{h.setModelScale(e.easedProgress*v)}),m.on("finish",()=>{h.setModelScale(v),d.enable(s)}),m.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement("div");return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(w.AR_END,()=>{e.rootEl.removeChild(t)}),t}}we.type=g.WEBXR;class be{constructor(e,t={}){var{file:s=null,mode:i=E.ONLY_AR,fallbackURL:o=null,title:r=null,link:n=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=k,shareText:d=null}=t,t=function(e,t){var s={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(s[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(s[o[i]]=e[o[i]]);return s}(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=s,this.fallbackURL=o,this.mode=i,this.title=r,this.link=n,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var o;return p(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=l(this.resizable),t.enable_vertical_placement=l(this.vertical),t.disable_occlusion=l(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var s=null!==(o=this.file)&&void 0!==o?o:e.src;if(!s)return Promise.reject(new N(z.FILE_NOT_SUPPORTED(null!==(o=this.file)&&void 0!==o?o:e.src),F.FILE_NOT_SUPPORTED));t.file=new URL(s,window.location.href).href;e=this.fallbackURL,s=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),s=t.mode===E.ONLY_AR?he.INTENT_AR_CORE(s,e):he.INTENT_SEARCHBOX(s,e||he.FALLBACK_DEFAULT(s));const i=document.createElement("a");i.href=s,i.click()})}exit(){return Promise.resolve()}}be.type=g.SCENE_VIEWER;class fe{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:s=null,applePayButtonType:i=null,callToAction:o=null,checkoutTitle:r=null,checkoutSubtitle:n=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=s,this.applePayButtonType=i,this.callToAction=o,this.checkoutTitle=r,this.checkoutSubtitle=n,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new N(z.FILE_NOT_SUPPORTED(""+e),F.FILE_NOT_SUPPORTED));var s=this.canonicalWebPageURL,i=this.custom,o=window.location.href;const r=document.createElement("a");r.setAttribute("rel","ar"),r.appendChild(document.createElement("img"));const n=Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,s])=>(s&&(e[t]=s),e),{}),a=new URL(e,o);return this.allowsContentScaling||(n.allowsContentScaling="0"),s&&(n.canonicalWebPageURL=new URL(s,o).href),i&&(n.custom=new URL(i,o).href),a.hash=new URLSearchParams(n).toString(),r.setAttribute("href",a.href),r.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(w.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:w.QUICK_LOOK_TAP,target:t}))},!1),r.click(),Promise.resolve()}exit(){return Promise.resolve()}}fe.type=g.QUICK_LOOK;const ye={[g.WEBXR]:we,[g.SCENE_VIEWER]:be,[g.QUICK_LOOK]:fe};class Oe{constructor(e){this._view3D=e,this._activeSession=null,e.on(w.AR_START,({session:e})=>{this._activeSession=e}),e.on(w.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return p(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return p(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new N(z.NOT_INITIALIZED,F.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const s=new t(e,V(e[t.type]));return yield s.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return p(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>ye[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class Te extends e{constructor(e,{duration:t=300,easing:s=W,scale:i=1,disablePitch:o=!1,disableYaw:r=!1}={}){super(),this._screenScale=new T.Vector2(0,0),this._prevPos=new T.Vector2(0,0),this._enabled=!1,this._onMouseDown=e=>{if(e.button===f.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(C.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(C.MOUSE_UP,this._onMouseUp,!1),this.trigger(x.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,s=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);s.multiply(this._screenScale),this._xMotion.setEndDelta(s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(C.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(C.MOUSE_UP,this._onMouseUp,!1),this.trigger(x.RELEASE)},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY)},this._onTouchMove=e=>{if(!(1<e.touches.length||this._isScrolling)){var t=e.touches[0],s=this._view3D.scrollable;if(!s||e.cancelable){if(this._isFirstTouch){if(s){var i=new T.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._isScrolling=!0)}this._isFirstTouch=!1}!s&&e.cancelable&&e.preventDefault(),e.stopPropagation();const o=this._prevPos,r=new T.Vector2(t.clientX,t.clientY).sub(o).multiplyScalar(this._scale);r.multiply(this._screenScale),this._xMotion.setEndDelta(r.x),this._yMotion.setEndDelta(r.y),o.set(t.clientX,t.clientY)}}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):this._prevPos.set(0,0),this._isScrolling=!1},this._view3D=e,this._scale=i,this._duration=t,this._easing=s,this._disablePitch=o,this._disableYaw=r,this._isFirstTouch=!1,this._isScrolling=!1,this._xMotion=new Z({duration:t,range:X,easing:s}),this._yMotion=new Z({duration:t,range:q,easing:s})}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._xMotion,i=this._yMotion;var o=!this._disableYaw,r=!this._disablePitch,e=new T.Vector2(s.update(e),i.update(e));o&&(t.yaw+=e.x),r&&(t.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(C.MOUSE_DOWN,this._onMouseDown),e.addEventListener(C.TOUCH_START,this._onTouchStart,{passive:!0}),e.addEventListener(C.TOUCH_MOVE,this._onTouchMove,{passive:this._view3D.scrollable}),e.addEventListener(C.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(x.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(C.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(C.MOUSE_MOVE,this._onMouseMove),window.removeEventListener(C.MOUSE_UP,this._onMouseUp),e.removeEventListener(C.TOUCH_START,this._onTouchStart),e.removeEventListener(C.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(C.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(x.DISABLE)}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Re extends e{constructor(e,{easing:t=W,duration:s=0,scale:i=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new T.Vector2(0,0),this._screenSize=new T.Vector2(0,0),this._onMouseDown=e=>{if(e.button===f.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(C.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(C.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(C.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(x.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var s=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(C.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(C.MOUSE_UP,this._onMouseUp,!1),this.trigger(x.RELEASE)},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._prevPos;var t=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return s.copy(t),void(this._touchInitialized=!0);e=(new T.Vector2).subVectors(t,s).multiplyScalar(this._scale);this._xMotion.setEndDelta(-e.x),this._yMotion.setEndDelta(e.y),s.copy(t)}},this._onTouchEnd=e=>{2===e.touches.length?(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0):this._touchInitialized=!1},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(C.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new Z({duration:s,range:X,easing:t}),this._yMotion=new Z({duration:s,range:X,easing:t}),this._scale=i}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera;var s=this._screenSize;const i=new T.Vector2(this._xMotion.update(e),this._yMotion.update(e)),o=new T.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),r=new T.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);s=new T.Vector2(t.renderWidth,t.renderHeight).divide(s);i.multiply(s),t.pivot.add(o.multiplyScalar(i.x)),t.pivot.add(r.multiplyScalar(i.y))}resize(e){const t=this._screenSize;t.copy(new T.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(C.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(C.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(C.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(C.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(x.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(C.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(C.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(C.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(C.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(C.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(C.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(C.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(x.DISABLE)}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new T.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class Me{constructor(e,{scale:t=1,duration:s=300,minFov:i=1,maxFov:o=k,easing:r=W}={}){this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const s=this._motion;e=-this._scale*this._wheelModifier*e.deltaY;s.setEndDelta(e)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._motion;var s=this._prevTouchDistance;const o=new T.Vector2(t[0].pageX,t[0].pageY);e=new T.Vector2(t[1].pageX,t[1].pageY);const r=o.sub(e);t=r.length()*this._scale*this._touchModifier,e=t-s;this._prevTouchDistance=t,s<0||i.setEndDelta(e)}},this._onTouchEnd=()=>{this._prevTouchDistance=-1},this._view3D=e,this._scale=t,this._duration=s,this._minFov=i,this._maxFov=o,this._easing=r,this._range={min:i,max:o===k?180:o},this._motion=new Z({duration:s,easing:r})}get enabled(){return this._enabled}get range(){return this._range}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get easing(){return this._easing}set scale(e){this._scale=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._motion;t.zoom+=s.update(e)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(C.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(C.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(C.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync()}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(C.WHEEL,this._onWheel,!1),e.removeEventListener(C.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(C.TOUCH_END,this._onTouchEnd,!1),this._enabled=!1}}sync(){var e=this._view3D.camera;this._motion.reset(e.zoom)}updateRange(){var e=this._maxFov;const t=this._range,s=this._motion;var i=this._view3D["camera"],i=i.baseFov;e===k&&(t.max=Math.min(i+45,175)),s.range.min=t.min-i,s.range.max=t.max-i}}class Se{constructor(e){this._onEnable=()=>{var e=this._view3D,t=e.renderer.canvas;e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===L.NONE&&this._setCursor(L.GRAB)},this._onDisable=()=>{this._view3D.renderer.canvas.style.cursor===L.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(L.NONE)},this._onHold=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(L.GRABBING)},this._onRelease=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(L.GRAB)},this._view3D=e,this._rotateControl=new Te(e,V(e.rotate)),this._translateControl=new Re(e,V(e.translate)),this._zoomControl=new Me(e,V(e.zoom)),[this._rotateControl,this._translateControl].forEach(e=>{e.on({[x.HOLD]:this._onHold,[x.RELEASE]:this._onRelease,[x.ENABLE]:this._onEnable,[x.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy()}update(e){this._rotateControl.update(e),this._translateControl.update(e),this._zoomControl.update(e)}resize(e){this._rotateControl.resize(e),this._translateControl.resize(e),this._zoomControl.resize(e)}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable()}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable()}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync()}updateCursor(){var e=this._view3D.useGrabCursor?L.GRAB:L.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===L.NONE){const s=t.renderer.canvas;s.style.cursor=e}}}class xe{constructor(e,{delay:t=2e3,delayOnMouseLeave:s=0,speed:i=1,pauseOnHover:o=!1,canInterrupt:r=!0,disableOnInterrupt:n=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{this._canInterrupt&&(e.button!==f.LEFT&&e.button!==f.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(C.MOUSE_UP,this._onMouseUp,!1)))},this._onMouseUp=()=>{window.removeEventListener(C.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=s,this._speed=i,this._pauseOnHover=o,this._canInterrupt=r,this._disableOnInterrupt=n}get enabled(){return this._enabled}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(C.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(C.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(C.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(C.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(C.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(C.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(C.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(C.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(C.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(C.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(C.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(C.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(C.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Pe{constructor({src:e,scenes:t,animations:s=[],json:i={},fixSkinnedBbox:o=!1,castShadow:r=!0,receiveShadow:n=!1}){this._src=e,this._scene=new T.Group,this._scene.add(...t),this._animations=s,this._json=i,this._bbox=this._getInitialBbox(o);o=this._bbox.min.y;this._scene.translateY(-o),this._bbox.translate(new T.Vector3(0,-o,0)),this.castShadow=r,this.receiveShadow=n}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get json(){return this._json}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(o,e){const t=this.meshes;let r=e;return t.forEach(t=>{var s=t.geometry.attributes["position"];if(s){t.updateMatrixWorld();for(let e=0;e<s.count;e++){const i=(new T.Vector3).fromBufferAttribute(s,e);i.applyMatrix4(t.matrixWorld),r=o(r,i)}}}),r}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new T.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const u=new T.Box3;return this.meshes.forEach(t=>{if(t.isSkinnedMesh){var e=t.geometry;const s=e.attributes.position,i=e.attributes.skinIndex,o=e.attributes.skinWeight,r=t.skeleton;r.update();const n=r.boneMatrices,a=new T.Matrix4;for(let e=0;e<s.count;e++){a.identity();const h=new T.Vector4;h.set(0,0,0,0);const l=new T.Vector4;l.set(s.getX(e),s.getY(e),s.getZ(e),1).applyMatrix4(t.bindMatrix);const c=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)],_=[i.getX(e),i.getY(e),i.getZ(e),i.getW(e)];c.forEach((e,t)=>{t=(new T.Matrix4).fromArray(n,16*_[t]);h.add(l.clone().applyMatrix4(t).multiplyScalar(e))});const d=(new T.Vector3).fromArray(h.applyMatrix4(t.bindMatrixInverse).toArray());d.applyMatrix4(t.matrixWorld),u.expandByPoint(d)}}else u.expandByObject(t)}),u}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}}const Ce=new t.DRACOLoader,Le=new i.KTX2Loader;class De{constructor(e){this._view3D=e,this._loader=new s.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(Ce),t.setKTX2Loader(Le.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(i){return p(this,void 0,void 0,function*(){return new Promise((e,t)=>{const s=document.createElement("script");s.addEventListener("load",()=>p(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,De.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(s),e()})),s.addEventListener("error",()=>{document.body.removeChild(s),t()}),s.src=new URL(i,location.href).href,document.body.appendChild(s)})})}load(i){const o=this._view3D,e=this._loader;return Ce.setDecoderPath(o.dracoPath),Le.setTranscoderPath(o.ktxPath),De.meshoptDecoder&&e.setMeshoptDecoder(De.meshoptDecoder),e.manager=T.DefaultLoadingManager,new Promise((t,s)=>{try{e.load(i,e=>{e=this._parseToModel(e,i);t(e)},e=>{o.trigger(w.PROGRESS,{type:w.PROGRESS,target:o,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},e=>{s(e)})}catch(e){s(e)}})}loadFromFiles(n){var e=this._view3D;const a=this._loader,h=[],l=()=>{h.forEach(e=>{URL.revokeObjectURL(e)})};return Ce.setDecoderPath(e.dracoPath),Le.setTranscoderPath(e.ktxPath),De.meshoptDecoder&&a.setMeshoptDecoder(De.meshoptDecoder),new Promise((t,s)=>{if(n.length<=0)s(new Error("No files found"));else{const i=n.find(e=>/\.(gltf|glb)$/i.test(e.name));if(i){const o=new Map;n.forEach(e=>{o.set(e.name,e)});var e=URL.createObjectURL(i);h.push(e);const r=new T.LoadingManager;r.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";if(o.has(t)){t=o.get(t),t=URL.createObjectURL(t);return h.push(t),t}return e}),a.manager=r,a.load(e,e=>{e=this._parseToModel(e,i.name);t(e),l()},void 0,e=>{s(e),l()})}else s(new Error("No glTF file found"))}})}_parseToModel(o,e){var t=this._view3D,s=t.fixSkinnedBbox;o.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const i=o.parser.json.extensionsUsed;if(i&&i.some(e=>e===P)){const r=t.renderer.threeRenderer.capabilities.maxTextureSize,n=[];o.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&n.push(e)})});const a=n.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[]),h=a.reduce((e,t)=>[...e,...S.filter(e=>t[e]).map(e=>t[e])],[]),l=o.parser.associations,c=o.parser.json,_=h.filter(e=>l.has(e)).map(e=>c.textures[l.get(e).textures]),d=_.reduce((i,e,t)=>{if(!e.extensions[P])return i;const o=h[t],s=e.extensions[P].levels;return s.forEach(({index:e,size:t},s)=>{t>r||(i[s]||(i[s]=[]),i[s].push({index:e,texture:o}))}),i},[]),u=d.map(()=>!1);d.forEach((i,s)=>p(this,void 0,void 0,function*(){const e=yield Promise.all(i.map(({index:e})=>o.parser.getDependency("texture",e)));var t=u.slice(s+1).some(e=>!!e);u[s]=!0,t||e.forEach((e,t)=>{const s=i[t].texture;s.image=e.image,s.needsUpdate=!0})}))}return new Pe({src:e,scenes:o.scenes,json:o.parser.json,animations:o.animations,fixSkinnedBbox:s})}}class Ae extends e{constructor(e,{src:t=null,iosSrc:s=null,dracoPath:i="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:o="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:r=null,fixSkinnedBbox:n=!1,fov:a=k,center:h=k,yaw:l=0,pitch:c=0,rotate:_=!0,translate:d=!0,zoom:u=!0,autoplay:p=!1,scrollable:v=!0,wheelScrollable:m=!1,useGrabCursor:g=!0,skybox:E=null,envmap:w=null,background:b=null,exposure:f=1,shadow:y=!0,skyboxBlur:O=!1,webAR:T=!0,sceneViewer:R=!0,quickLook:M=!0,arPriority:S=Q,poster:x=null,canvasSelector:P="canvas",autoInit:C=!0,autoResize:L=!0,useResizeObserver:D=!0,on:A={},plugins:I=[]}={}){super(),this._rootEl=((e,t)=>{t=U(e,t);if(!t)throw new N(z.WRONG_TYPE(e,["HTMLElement","string"]),F.WRONG_TYPE);return t})(e),this._src=t,this._iosSrc=s,this._dracoPath=i,this._ktxPath=o,this._meshoptPath=r,this._fixSkinnedBbox=n,this._fov=a,this._center=h,this._yaw=l,this._pitch=c,this._rotate=_,this._translate=d,this._zoom=u,this._autoplay=p,this._scrollable=v,this._wheelScrollable=m,this._useGrabCursor=g,this._skybox=E,this._envmap=w,this._background=b,this._exposure=f,this._shadow=y,this._skyboxBlur=O,this._webAR=T,this._sceneViewer=R,this._quickLook=M,this._arPriority=S,this._poster=x,this._canvasSelector=P,this._autoInit=C,this._autoResize=L,this._useResizeObserver=D,this._renderer=new G(this),this._camera=new $(this),this._control=new Se(this),this._scene=new B(this),this._animator=new ee(this),this._autoPlayer=new xe(this,V(p)),this._autoResizer=new J(this),this._arManager=new Oe(this),this._model=null,this._initialized=!1,this._plugins=I,this._addEventHandlers(A),this._addPosterImage(),this._initPlugins(I).then(()=>{t&&C&&this.init()})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}set skybox(e){this._scene.setSkybox(e),this._skybox=e}set envmap(e){this._scene.setEnvMap(e),this._envmap=e}set exposure(e){this._renderer.threeRenderer.toneMappingExposure=e,this._exposure=e}set skyboxBlur(e){this._skyboxBlur=e;const t=this._scene;var s=t.root.environment;s&&t.skybox&&(e?t.skybox.useBlurredHDR(s):t.skybox.useTexture(s))}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}destroy(){this._scene.reset(),this._renderer.stopAnimationLoop(),this._control.destroy(),this._autoResizer.disable(),this._animator.reset(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return p(this,void 0,void 0,function*(){if(!this._src)throw new N(z.PROVIDE_SRC_FIRST,F.PROVIDE_SRC_FIRST);this._autoResize&&this._autoResizer.enable();const e=this._scene,t=this._renderer;var s=this._skybox,i=this._envmap,o=this._background,r=this._meshoptPath;if(r&&!De.meshoptDecoder&&(yield De.setMeshoptDecoder(r)),s||i){const n=new T.AmbientLight;e.add(n,!1);const a=s?e.setSkybox(s):e.setEnvMap(i);a.then(()=>{e.remove(n)})}!s&&o&&e.setBackground(o),yield this._loadModel(this._src),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),this._control.enable(),this._autoplay&&this._autoPlayer.enable(),this._initialized=!0,this.trigger(w.READY,{type:w.READY,target:this})})}resize(){const e=this._renderer;e.resize();var t=e.size;this._camera.resize(t),this._control.resize(t),e.threeRenderer.xr.isPresenting||e.defaultRenderLoop(0),this.trigger(w.RESIZE,Object.assign(Object.assign({},t),{type:w.RESIZE,target:this}))}load(e){return p(this,void 0,void 0,function*(){this._initialized?(yield this._loadModel(e),this._src=e):(this._src=e,yield this.init())})}display(e,{resetCamera:t=!0}={}){var s=this._renderer;const i=this._scene,o=this._camera,r=this._animator;s=s.threeRenderer.xr.isPresenting;if(i.reset(),i.add(e.scene),i.shadowPlane.update(e),t&&(o.fit(e,this._center),o.reset(0)),r.reset(),r.setClips(e.animations),0<e.animations.length&&r.play(0),this._model=e,s){const n=this._arManager.activeSession;n&&n.control.syncTargetModel(e)}this.trigger(w.MODEL_CHANGE,{type:w.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return p(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return p(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var s=t.toDataURL("png");const i=document.createElement("a");i.href=s,i.download=e,i.click()}_loadModel(t){return p(this,void 0,void 0,function*(){const r=new De(this);if(Array.isArray(t)){const n=t.map(()=>!1);var e=t.map((i,o)=>p(this,void 0,void 0,function*(){this.trigger(w.LOAD_START,{type:w.LOAD_START,target:this,src:i,level:o});var e=yield r.load(i),t=n.slice(o+1).some(e=>!!e),s=n.some(e=>!!e);this.trigger(w.LOAD,{type:w.LOAD,target:this,model:e,level:o}),n[o]=!0,t||this.display(e,{resetCamera:!s})}));yield Promise.race(e)}else{this.trigger(w.LOAD_START,{type:w.LOAD_START,target:this,src:t,level:0});e=yield r.load(t);this.trigger(w.LOAD,{type:w.LOAD,target:this,model:e,level:0}),this.display(e)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var e=this._poster;const t=this._rootEl;if(e){const s=document.createElement("img");s.className=m.POSTER,s.src=e,t.appendChild(s),this.once(w.READY,()=>{s.parentElement===t&&t.removeChild(s)})}}_initPlugins(e){return p(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}}Ae.VERSION="2.1.0";class Ie{constructor(e={}){this._startLoading=({target:e})=>{const{type:t="default",loadingLabel:s="Loading 3D Model...",parsingLabel:i="Parsing 3D Model...",labelColor:o="#ffffff",barHeight:r="10px",barBackground:n="#bbbbbb",barForeground:a="#3e8ed0",overlayBackground:h="rgba(0, 0, 0, 0.3)"}=this._options,l=document.createElement("div"),c=document.createElement("div"),_=document.createElement("div"),d=document.createElement("div"),u=document.createElement("div");if(l.classList.add("view3d-lb-overlay"),c.classList.add("view3d-lb-wrapper"),d.classList.add("view3d-lb-base"),_.classList.add("view3d-lb-label"),u.classList.add("view3d-lb-filler"),d.style.height=r,l.style.backgroundColor=h,t!==Ie.TYPE.SPINNER?(d.style.backgroundColor=n,u.style.backgroundColor=a):d.classList.add("type-spinner"),t===Ie.TYPE.TOP&&l.classList.add("type-top"),_.style.color=o,_.innerText=s,d.appendChild(u),c.appendChild(d),c.appendChild(_),l.appendChild(c),e.rootEl.appendChild(l),t!==Ie.TYPE.SPINNER){const p=e=>{const t=e.loaded/e.total*100;u.style.width=t.toFixed(2)+"%",e.loaded===e.total&&(_.innerText=i)};e.on(w.PROGRESS,p),e.once(w.LOAD,()=>{e.off(w.PROGRESS,p)})}e.once(w.LOAD,()=>{this._removeOverlay(e)}),this._overlay=l},this._options=e}init(e){return p(this,void 0,void 0,function*(){e.on(w.LOAD_START,this._startLoading)})}teardown(e){e.off(w.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}Ie.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};r={__proto__:null,default:Ae,Animation:te,ARManager:Oe,AutoPlayer:xe,AutoResizer:J,Camera:$,Model:Pe,ModelAnimator:ee,Motion:Z,Pose:H,Renderer:G,Scene:B,ShadowPlane:A,Skybox:I,View3DError:N,AnimationControl:K,OrbitControl:Se,RotateControl:Te,TranslateControl:Re,ZoomControl:Me,GLTFLoader:De,TextureLoader:M,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return p(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return p(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:s="view3d-ar-button",tooltipClass:i="view3d-tooltip"}=this._options;const o=yield a.ar.isAvailable(),r=document.createElement("button"),n=document.createElement("div");t=document.createTextNode(o?e:t);r.classList.add(s),n.classList.add(i),r.disabled=!0,r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',r.appendChild(n),n.appendChild(t),a.rootEl.appendChild(r),this._button=r,a.initialized?yield this._setAvailable(a,r,o):a.once(w.MODEL_CHANGE,()=>{this._setAvailable(a,r,o)})})}_setAvailable(e,t,s){return p(this,void 0,void 0,function*(){s?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:class{constructor(e={}){this._options=e}init(o){return p(this,void 0,void 0,function*(){o.on(w.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){if(this._cachedElements)Object.values(this._cachedElements).map(e=>{t.contains(e)||t.appendChild(e)});else{const s=document.createElement("div");s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',s.classList.add("view3d-ar-close"),t.appendChild(s),this._cachedElements={closeButton:s}}const s=this._cachedElements["closeButton"],i=()=>{e.exit()};s.addEventListener("click",i),o.once(w.AR_END,()=>{s.parentElement&&s.parentElement.removeChild(s),s.removeEventListener("click",i)})}})})}teardown(){}},LoadingBar:Ie,AUTO:k,EVENTS:w,EASING:v,DEFAULT_CLASS:m,AR_SESSION_TYPE:g,SCENE_VIEWER_MODE:E,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},ERROR_CODES:r,isAvailable:({webGL:e=!0,fetch:t=!0,stream:s=!0,wasm:i=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(s&&!(window&&window.ReadableStream))return!1;if(i&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0}};return h(Ae,r),Ae});
