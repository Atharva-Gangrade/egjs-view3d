

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: xr/WebARSession.ts</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">@egjs/view3d Documentation</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/naver/egjs-view3d" target="_blank">
                                Github
                            </a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="../../../" target="_blank">
                                Demo
                            </a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Tutorials</h3><ul><li><a href="tutorial-Adding Controls.html">Adding Controls</a></li><li><a href="tutorial-Adding Lights.html">Adding Lights</a></li><li><a href="tutorial-Adding Skybox and Envmap.html">Adding Skybox and Envmap</a></li><li><a href="tutorial-Displaying Shadows.html">Displaying Shadows</a></li><li><a href="tutorial-Handling Errors.html">Handling Errors</a></li><li><a href="tutorial-Loading a Model.html">Loading a Model</a></li><li><a href="tutorial-Playing Animations.html">Playing Animations</a></li></ul><h3>Namespaces</h3><ul><li><a href="EASING.html">EASING</a></li><li><a href="Constants.html">Constants</a></li></ul><h3>Classes</h3><ul><li><a href="Pose.html">Pose</a></li><li><a href="View3D.html">View3D</a></li></ul><h3>Interfaces</h3><ul><li><a href="FloorARSessionOption.html">FloorARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="Animation.html#event:progress">progress</a></li><li><a href="Animation.html#event:loop">loop</a></li><li><a href="Animation.html#event:finish">finish</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AnyFunction">AnyFunction</a></li><li><a href="global.html#AnyObject">AnyObject</a></li></ul></div><div class="category"><h2>Controls</h2><h3>Classes</h3><ul><li><a href="AnimationControl.html">AnimationControl</a></li><li><a href="AutoControl.html">AutoControl</a></li><li><a href="DistanceControl.html">DistanceControl</a></li><li><a href="OrbitControl.html">OrbitControl</a></li><li><a href="RotateControl.html">RotateControl</a></li><li><a href="TranslateControl.html">TranslateControl</a></li></ul><h3>Interfaces</h3><ul><li><a href="CameraControl.html">CameraControl</a></li></ul></div><div class="category"><h2>Controls-AR</h2><h3>Classes</h3><ul><li><a href="ARFloorControl.html">ARFloorControl</a></li><li><a href="ARFloorTranslateControl.html">ARFloorTranslateControl</a></li><li><a href="ARHoverControl.html">ARHoverControl</a></li><li><a href="ARHoverRotateControl.html">ARHoverRotateControl</a></li><li><a href="ARHoverTranslateControl.html">ARHoverTranslateControl</a></li><li><a href="ArrowIndicator.html">ArrowIndicator</a></li><li><a href="ARScaleControl.html">ARScaleControl</a></li><li><a href="ARSwipeControl.html">ARSwipeControl</a></li><li><a href="ARSwirlControl.html">ARSwirlControl</a></li><li><a href="ARWallControl.html">ARWallControl</a></li><li><a href="ARWallTranslateControl.html">ARWallTranslateControl</a></li><li><a href="DeadzoneChecker.html">DeadzoneChecker</a></li><li><a href="FloorIndicator.html">FloorIndicator</a></li><li><a href="RotationIndicator.html">RotationIndicator</a></li><li><a href="ScaleUI.html">ScaleUI</a></li></ul><h3>Interfaces</h3><ul><li><a href="ScaleUIOption.html">ScaleUIOption</a></li><li><a href="RotationIndicatorOption.html">RotationIndicatorOption</a></li><li><a href="FloorIndicatorOption.html">FloorIndicatorOption</a></li><li><a href="DeadzoneCheckerOption.html">DeadzoneCheckerOption</a></li><li><a href="ARWallTranslateControlOption.html">ARWallTranslateControlOption</a></li><li><a href="ARWallControlOption.html">ARWallControlOption</a></li><li><a href="ARSwirlControlOption.html">ARSwirlControlOption</a></li><li><a href="ARSwipeControlOption.html">ARSwipeControlOption</a></li><li><a href="ARScaleControlOption.html">ARScaleControlOption</a></li><li><a href="ArrowIndicatorOption.html">ArrowIndicatorOption</a></li><li><a href="ARHoverTranslateControlOption.html">ARHoverTranslateControlOption</a></li><li><a href="ARHoverRotateControlOption.html">ARHoverRotateControlOption</a></li><li><a href="ARHoverControlOption.html">ARHoverControlOption</a></li><li><a href="ARFloorTranslateControlOption.html">ARFloorTranslateControlOption</a></li><li><a href="ARFloorControlOption.html">ARFloorControlOption</a></li><li><a href="ARControl.html">ARControl</a></li></ul></div><div class="category"><h2>Core</h2><h3>Classes</h3><ul><li><a href="Animation.html">Animation</a></li><li><a href="Camera.html">Camera</a></li><li><a href="Controller.html">Controller</a></li><li><a href="Model.html">Model</a></li><li><a href="ModelAnimator.html">ModelAnimator</a></li><li><a href="Renderer.html">Renderer</a></li><li><a href="Scene.html">Scene</a></li><li><a href="XRManager.html">XRManager</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:afterRender">afterRender</a></li></ul></div><div class="category"><h2>Environment</h2><h3>Classes</h3><ul><li><a href="AutoDirectionalLight.html">AutoDirectionalLight</a></li><li><a href="ShadowPlane.html">ShadowPlane</a></li></ul><h3>Interfaces</h3><ul><li><a href="Environment.html">Environment</a></li></ul></div><div class="category"><h2>Extra</h2><h3>Classes</h3><ul><li><a href="TextureModel.html">TextureModel</a></li></ul></div><div class="category"><h2>Loaders</h2><h3>Classes</h3><ul><li><a href="DracoLoader.html">DracoLoader</a></li><li><a href="GLTFLoader.html">GLTFLoader</a></li><li><a href="TextureLoader.html">TextureLoader</a></li></ul><h3>Interfaces</h3><ul><li><a href="ModelLoadOption.html">ModelLoadOption</a></li><li><a href="DracoLoadOption.html">DracoLoadOption</a></li></ul></div><div class="category"><h2>XR</h2><h3>Classes</h3><ul><li><a href="DOMOverlay.html">DOMOverlay</a></li><li><a href="FloorARSession.html">FloorARSession</a></li><li><a href="HitTest.html">HitTest</a></li><li><a href="HoverARSession.html">HoverARSession</a></li><li><a href="QuickLookSession.html">QuickLookSession</a></li><li><a href="SceneViewerSession.html">SceneViewerSession</a></li><li><a href="WallARSession.html">WallARSession</a></li><li><a href="WebARSession.html">WebARSession</a></li></ul><h3>Interfaces</h3><ul><li><a href="XRSession.html">XRSession</a></li><li><a href="WebARSessionOption.html">WebARSessionOption</a></li><li><a href="WallARSessionOption.html">WallARSessionOption</a></li><li><a href="HoverARSessionOption.html">HoverARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="WebARSession.html#.event:start">start</a></li><li><a href="WebARSession.html#.event:modelPlaced">modelPlaced</a></li><li><a href="WebARSession.html#.event:end">end</a></li><li><a href="WebARSession.html#.event:canPlace">canPlace</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>xr/WebARSession.ts</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2020 NAVER Corp.
 * egjs projects are licensed under the MIT license
 */

import * as THREE from "three";
import View3D from "~/View3D";
import XRSession from "./XRSession";
import DOMOverlay from "./features/DOMOverlay";
import EventEmitter from "~/core/EventEmitter";
import { getElement, merge } from "~/utils";
import * as DEFAULT from "~/consts/default";
import * as XR from "~/consts/xr";
import { XRContext, XRRenderContext } from "~/types/internal";

declare global {
  interface Navigator { xr: any; }
}

/**
 * Options for WebARSession
 * @category XR
 * @interface
 * @property {object} [features={}] You can set additional features(see {@link https://developer.mozilla.org/en-US/docs/Web/API/XRSessionInit XRSessionInit}) with this option.
 * @property {number} [maxModelSize=Infinity] If model's size is too big to show on AR, you can restrict it's size with this option. Model with size bigger than this value will clamped to this value.
 * @property {HTMLElement|string|null} [overlayRoot=null] If this value is set, dom-overlay feature will be automatically added for this session. And this value will be used as dom-overlay's root element. You can set either HTMLElement or query selector for that element.
 * @property {HTMLElement|string|null} [loadingEl=null] This will be used for loading indicator element, which will automatically invisible after placing 3D model by setting `visibility: hidden`. This element must be placed under `overlayRoot`. You can set either HTMLElement or query selector for that element.
 * @property {boolean} [forceOverlay=false] Whether to apply `dom-overlay` feature as required. If set to false, `dom-overlay` will be optional feature.
 */
export interface WebARSessionOption {
  features: typeof XR.EMPTY_FEATURES;
  maxModelSize: number;
  overlayRoot: HTMLElement | string | null;
  loadingEl: HTMLElement | string | null;
  forceOverlay: boolean;
}

/**
 * WebXR based abstract AR session class
 * @category XR
 * @fires WebARSession#start
 * @fires WebARSession#end
 * @fires WebARSession#canPlace
 * @fires WebARSession#modelPlaced
 */
abstract class WebARSession extends EventEmitter&lt;{
  start: void;
  end: void;
  canPlace: void;
  modelPlaced: void;
}> implements XRSession {
  /**
   * Whether it's webxr-based session or not
   * @type true
   */
  public readonly isWebXRSession = true;

  protected _session: any = null;
  protected _domOverlay: DOMOverlay | null = null;
  // As "dom-overlay" is an optional feature by default,
  // user can choose whether to show XR only when this feature is available
  protected _forceOverlay: boolean;
  protected _features: typeof XR.EMPTY_FEATURES;
  protected _maxModelSize: number;

  /**
   * {@link https://developer.mozilla.org/en-US/docs/Web/API/XRSession XRSession} of this session
   * This value is only available after calling enter
   */
  public get session() { return this._session; }
  /**
   * {@link https://developer.mozilla.org/en-US/docs/Web/API/XRSessionInit XRSessionInit} object for this session.
   */
  public get features() { return this._features; }

  /**
   * Emitted when session is started.
   * @event start
   * @category XR
   * @memberof WebARSession
   * @type void
   */
  /**
   * Emitted when session is ended.
   * @event end
   * @category XR
   * @memberof WebARSession
   * @type void
   */
  /**
   * Emitted when model can be placed on the space.
   * @event canPlace
   * @category XR
   * @memberof WebARSession
   * @type void
   */
  /**
   * Emitted when model is placed.
   * @event modelPlaced
   * @category XR
   * @memberof WebARSession
   * @type void
   */

  /**
   * Create new instance of WebARSession
   * @param {object} [options={}] Options
   * @param {object} [options.features={}] You can set additional features(see {@link https://developer.mozilla.org/en-US/docs/Web/API/XRSessionInit XRSessionInit}) with this option.
   * @param {number} [options.maxModelSize=Infinity] If model's size is too big to show on AR, you can restrict it's size with this option. Model with size bigger than this value will clamped to this value.
   * @param {HTMLElement|string|null} [options.overlayRoot=null] If this value is set, dom-overlay feature will be automatically added for this session. And this value will be used as dom-overlay's root element. You can set either HTMLElement or query selector for that element.
   * @param {HTMLElement|string|null} [options.loadingEl=null] This will be used for loading indicator element, which will automatically invisible after placing 3D model by setting `visibility: hidden`. This element must be placed under `overlayRoot`. You can set either HTMLElement or query selector for that element.
   * @param {boolean} [options.forceOverlay=false] Whether to apply `dom-overlay` feature as required. If set to false, `dom-overlay` will be optional feature.
   */
  constructor({
    features: userFeatures = XR.EMPTY_FEATURES, // https://developer.mozilla.org/en-US/docs/Web/API/XRSessionInit
    maxModelSize = Infinity,
    overlayRoot = DEFAULT.NULL_ELEMENT,
    loadingEl = DEFAULT.NULL_ELEMENT,
    forceOverlay = false,
  }: Partial&lt;WebARSessionOption> = {}) {
    super();
    const overlayEl = getElement(overlayRoot);

    const features: (typeof XR.EMPTY_FEATURES)[] = [];
    if (overlayEl) {
      this._domOverlay = new DOMOverlay({
        root: overlayEl,
        loadingEl: getElement(loadingEl, overlayEl),
      });
      features.push(this._domOverlay.features);
    }

    this._features = merge({}, ...features, userFeatures);
    this._maxModelSize = maxModelSize;
    this._forceOverlay = forceOverlay;
  }

  /**
   * Return availability of this session
   * @returns {Promise} A Promise that resolves availability of this session(boolean).
   */
  public isAvailable() {
    const domOverlay = this._domOverlay;

    if (!XR.WEBXR_SUPPORTED || !XR.HIT_TEST_SUPPORTED) return Promise.resolve(false);
    if (this._forceOverlay) {
      if (domOverlay &amp;&amp; !domOverlay.isAvailable()) return Promise.resolve(false);
    }

    return navigator.xr.isSessionSupported(XR.SESSION.AR);
  }

  /**
   * Enter session
   * @param view3d Instance of the View3D
   * @returns {Promise}
   */
  public enter(view3d: View3D) {
    // Model not loaded yet
    if (!view3d.model) return Promise.reject("3D Model is not loaded");

    const model = view3d.model;

    return navigator.xr.requestSession(XR.SESSION.AR, this._features)
      .then(session => {
        const renderer = view3d.renderer;
        const threeRenderer = renderer.threeRenderer;
        const xrContext = {
          view3d,
          model,
          session,
        };

        // Cache original values
        const originalMatrix = model.scene.matrix.clone();
        const originalModelSize = model.size;
        const originalBackground = view3d.scene.root.background;

        const arModelSize = Math.min(model.originalSize, this._maxModelSize);
        model.size = arModelSize;
        model.moveToOrigin();
        view3d.scene.setBackground(null);

        // Cache original model rotation
        threeRenderer.xr.setReferenceSpaceType(XR.REFERENCE_SPACE.LOCAL);
        threeRenderer.xr.setSession(session);
        threeRenderer.setPixelRatio(1);

        this.onStart(xrContext);
        session.addEventListener("end", () => {
          this.onEnd(xrContext);

          // Restore original values
          model.scene.matrix.copy(originalMatrix);
          model.scene.matrix.decompose(model.scene.position, model.scene.quaternion, model.scene.scale);
          model.size = originalModelSize;
          model.moveToOrigin();

          view3d.scene.update(model);
          view3d.scene.setBackground(originalBackground);

          // Restore renderer values
          threeRenderer.xr.setSession(null);
          threeRenderer.setPixelRatio(window.devicePixelRatio);

          // Restore render loop
          renderer.stopAnimationLoop();
          renderer.setAnimationLoop(view3d.renderLoop);
        }, { once: true });

        // Set XR session render loop
        renderer.stopAnimationLoop();
        renderer.setAnimationLoop((delta, frame) => {
          const xrCam = threeRenderer.xr.getCamera(new THREE.PerspectiveCamera()) as THREE.PerspectiveCamera;
          const referenceSpace = threeRenderer.xr.getReferenceSpace();
          const glLayer = session.renderState.baseLayer;
          const size = {
            width: glLayer.framebufferWidth,
            height: glLayer.framebufferHeight,
          };
          const renderContext: XRRenderContext = {
            ...xrContext,
            delta,
            frame,
            referenceSpace,
            xrCam,
            size,
          };

          this._beforeRender(renderContext);
          view3d.renderLoop(delta);
        });
      });
  }

  /**
   * Exit this session
   * @param view3d Instance of the View3D
   */
  public exit(view3d: View3D) {
    const session = view3d.renderer.threeRenderer.xr.getSession();
    session.end();
  }

  public onStart(ctx: XRContext) {
    this._session = ctx.session;
    this._domOverlay?.showLoading();
    this.emit("start");
  }

  public onEnd(ctx: XRContext) {
    this._session = null;
    this._domOverlay?.hideLoading();
    this.emit("end");
  }

  protected abstract _beforeRender(ctx: XRRenderContext): void;
}

export default WebARSession;
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>


<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 0.3.7</a> on Tue Sep 07 2021 16:12:07 GMT+0900 (Korean Standard Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>


<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
