/*
Copyright (c) NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.9.1
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["three","@egjs/component"],t):(e=e||self).View3D=t(e.THREE,e.Component)}(this,function(O,s){"use strict";class l extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,l.prototype),this.name="View3DError",this.code=t}}var n={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,FILE_NOT_SUPPORTED:5,NOT_INITIALIZED:6,MODEL_FAIL_TO_LOAD:7},h=n,c={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const N=e=>"number"==typeof e,o=e=>"string"==typeof e,a=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,F=(e,t)=>{let s=null;if(o(e)){const i=t||document;t=i.querySelector(e);if(!t)return null;s=t}else a(e)&&(s=e);return s},ee=(e,t)=>{t=F(e,t);if(t)return t;throw o(e)?new l(c.ELEMENT_NOT_FOUND(e),h.ELEMENT_NOT_FOUND):new l(c.WRONG_TYPE(e,["HTMLElement","string"]),h.WRONG_TYPE)},U=(e,t)=>{e=e.querySelector(t);if(e)return e;throw new l(c.CANVAS_NOT_FOUND,h.CANVAS_NOT_FOUND)},B=e=>{if(!o(e))return!1;const t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0},k=e=>!e||e<=0?[]:Array.apply(0,Array(e)).map((e,t)=>t),_=e=>e*Math.PI/180,m=e=>180*e/Math.PI,d=(e,t,s)=>Math.max(Math.min(e,s),t),H=(e,t,s)=>e*(1-s)+t*s,u=(e,t,s)=>{var i=Math.abs(s-t);return e<t?e=s-(t-e)%i:s<e&&(e=t+(e-s)%i),e},G=(i,...e)=>(e.forEach(s=>{Object.keys(s).forEach(e=>{var t=s[e];Array.isArray(i[e])&&Array.isArray(t)?i[e]=[...i[e],...t]:i[e]=t})}),i);const V=e=>{let t=1;for(;t<e;)t*=2;return t};const z=(e,t,s)=>{const i=(new O.Vector2).subVectors(t,e).normalize(),r=(new O.Vector2).subVectors(s,e).normalize();t=r.angle()-i.angle(),s=-Math.sign(t)*(2*Math.PI-Math.abs(t));return Math.abs(t)<Math.abs(s)?t:s},Z=e=>"object"==typeof e?e:{},W=e=>e?"true":"false",j=(e,t,s)=>{t=_(t),s=_(s);const i=new O.Vector3(0,0,0);return i.y=e*Math.sin(s),i.z=e*Math.cos(s),i.x=i.z*Math.sin(-t),i.z=i.z*Math.cos(-t),i},K=e=>{const t=new O.Vector2(e.x,e.z);var s=new O.Vector2;return{yaw:Math.abs(e.y)<=.99?z(s,new O.Vector2(0,1),t):0,pitch:Math.atan2(e.y,t.distanceTo(s))}},X=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t},q=e=>{var t;return e.normalized&&ArrayBuffer.isView(e.array)?(e=e.array,t=te(e),e=1/(Math.pow(2,8*e.BYTES_PER_ELEMENT)-1),t?2*e:e):1},Y=(e,t,s,i)=>{var r=t.geometry,n=r.attributes.position;const o=r.attributes.skinIndex,a=r.attributes.skinWeight,l=t.skeleton.boneMatrices;r=(new O.Vector3).fromBufferAttribute(n,e).multiplyScalar(s);const h=new O.Vector4(0,0,0,0),c=new O.Vector4(r.x,r.y,r.z).applyMatrix4(t.bindMatrix),d=[a.getX(e),a.getY(e),a.getZ(e),a.getW(e)].map(e=>e*i),u=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)],_=(d.forEach((e,t)=>{t=(new O.Matrix4).fromArray(l,16*u[t]);h.add(c.clone().applyMatrix4(t).multiplyScalar(e))}),(new O.Vector3).fromArray(h.applyMatrix4(t.bindMatrixInverse).toArray()));return _.applyMatrix4(t.matrixWorld),_},te=e=>{const t=new e.constructor(1);return t[0]=-1,t[0]<0},se=e=>{if(e.capabilities.isWebGL2)return!0;{const r=e.getContext();e=r.createTexture();let t=!0;try{var s=new Uint16Array(4),i=r.getExtension("OES_texture_half_float");t=!!i&&(r.bindTexture(r.TEXTURE_2D,e),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,i.HALF_FLOAT_OES,s),r.getError()===r.NO_ERROR)}catch(e){t=!1}return r.deleteTexture(e),t}},ie=(e,t,s)=>{if(!e||t<0||s<0)return null;const i=e.meshes[t],r=null==(e=null===i||void 0===i?void 0:i.geometry.index)?void 0:e.array,n=r?k(3).map(e=>r[3*s+e]):null;if(!i||!r||!n||n.some(e=>null==e))return null;const o=i.geometry.getAttribute("position");return n.map(e=>(new O.Vector3).fromBufferAttribute(o,e))},re=(e,t,s)=>{const i=ie(e,t,s);if(!i)return null;const r=e.meshes[t],n=r.geometry.getIndex(),o=n.array.slice(3*s,3*s+3);if(r.isSkinnedMesh){e=r.geometry,t=e.attributes.position,s=e.attributes.skinWeight;const a=q(t),l=q(s);i.forEach((e,t)=>{t=o[t],t=Y(t,r,a,l);e.copy(t)})}else i.forEach(e=>{e.applyMatrix4(r.matrixWorld)});return i};var ne;const oe=(e,t,s=!1)=>!e||!s&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e),ae=(e,t)=>{const s=t.min.toArray(),i=(new O.Vector3).subVectors(t.max,t.min).toArray();return(new O.Vector3).fromArray(e.map((e,t)=>{if(!o(e))return e;e=.01*parseFloat(e);return s[t]+e*i[t]}))};function le(e,t){var s={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(s[r[i]]=e[r[i]]);return s}function Q(e,o,a,l){return new(a=a||Promise)(function(s,t){function i(e){try{n(l.next(e))}catch(e){t(e)}}function r(e){try{n(l.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,r)}n((l=l.apply(e,o||[])).next())})}const p={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",POINTER_UP:"pointerup",POINTER_ENTER:"pointerenter",POINTER_LEAVE:"pointerleave",LOAD:"load",ERROR:"error",CLICK:"click",DOUBLE_CLICK:"dblclick",CONTEXT_LOST:"webglcontextlost",CONTEXT_RESTORED:"webglcontextrestored"},i={GRAB:"grab",GRABBING:"grabbing",NONE:""},he=((e=ne=ne||{})[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT","anonymous"),f="div",ce="button",$="auto",E={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",INPUT_START:"inputStart",INPUT_END:"inputEnd",CAMERA_CHANGE:"cameraChange",ANIMATION_START:"animationStart",ANIMATION_LOOP:"animationLoop",ANIMATION_FINISHED:"animationFinished",ANNOTATION_FOCUS:"annotationFocus",ANNOTATION_UNFOCUS:"annotationUnfocus",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced",QUICK_LOOK_TAP:"quickLookTap"},de={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,s=2.75;return e<1/s?t*e*e:e<2/s?t*(e-=1.5/s)*e+.75:e<2.5/s?t*(e-=2.25/s)*e+.9375:t*(e-=2.625/s)*e+.984375}},J={WRAPPER:"view3d-wrapper",CANVAS:"view3d-canvas",POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay",ANNOTATION_WRAPPER:"view3d-annotation-wrapper",ANNOTATION:"view3d-annotation",ANNOTATION_TOOLTIP:"view3d-annotation-tooltip",ANNOTATION_DEFAULT:"default",ANNOTATION_SELECTED:"selected",ANNOTATION_HIDDEN:"hidden",ANNOTATION_FLIP_X:"flip-x",ANNOTATION_FLIP_Y:"flip-y",CTX_LOST:"ctx-lost"},ue={LINEAR:O.LinearToneMapping,REINHARD:O.ReinhardToneMapping,CINEON:O.CineonToneMapping,ACES_FILMIC:O.ACESFilmicToneMapping},_e={FOV:"fov",DISTANCE:"distance"};var e={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const pe={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var v;const g={ROTATE:0,TRANSLATE:1,ZOOM:2},me={ONE:"one",NONE:"none",ALL:"all"};class ve{constructor(e){this._defaultRenderLoop=e=>{var{control:t,autoPlayer:s,animator:i}=this._view3D;(i.animating||t.animating||s.animating)&&this._renderFrame(e)},this._onContextLost=()=>{const e=this._canvas;e.classList.add(J.CTX_LOST)},this._onContextRestore=()=>{const e=this._canvas,t=this._view3D.scene;e.classList.remove(J.CTX_LOST),t.initTextures(),this.renderSingleFrame()};const t=U(e.rootEl,e.canvasSelector),s=(this._canvas=t,this._view3D=e,this._renderQueued=!1,new O.WebGLRenderer({canvas:t,alpha:!0,antialias:!0,preserveDrawingBuffer:!0}));s.toneMapping=e.toneMapping,s.toneMappingExposure=e.exposure,s.outputEncoding=O.sRGBEncoding,s.setClearColor(0,0),this._halfFloatAvailable=se(s),this._renderer=s,this._clock=new O.Clock(!1),this._canvasSize=new O.Vector2,t.addEventListener(p.CONTEXT_LOST,this._onContextLost),t.addEventListener(p.CONTEXT_RESTORED,this._onContextRestore)}get canvas(){return this._canvas}get context(){return this._renderer.getContext()}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new O.Vector2);return{width:e.width,height:e.y}}get canvasSize(){return this._canvasSize}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}destroy(){const e=this._canvas;this.stopAnimationLoop(),this._renderer.dispose(),e.removeEventListener(p.CONTEXT_LOST,this._onContextLost),e.removeEventListener(p.CONTEXT_RESTORED,this._onContextRestore)}resize(){const e=this._renderer;var t,s=this._canvas;e.xr.isPresenting||(t=s.clientWidth,s=s.clientHeight,e.setPixelRatio(window.devicePixelRatio),e.setSize(t,s,!1),this._canvasSize.set(t,s))}setAnimationLoop(i){const r=this._view3D,n=this._clock;n.start(),this._renderer.setAnimationLoop((e,t)=>{var s=Math.min(n.getDelta(),r.maxDeltaTime);i(s,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}renderSingleFrame(e=!1){this._renderer.xr.isPresenting||(e?this._renderFrame(0):this._renderQueued||(requestAnimationFrame(()=>{this._renderFrame(0)}),this._renderQueued=!0))}_renderFrame(e){const t=this._view3D,s=this._renderer,{scene:i,camera:r,control:n,autoPlayer:o,animator:a,annotation:l}=t;var h;s.getContext().isContextLost()||(h=1e3*e,this._renderQueued=!1,a.update(e),n.update(h),o.update(h),t.trigger(E.BEFORE_RENDER,{type:E.BEFORE_RENDER,target:t,delta:h}),r.updatePosition(),i.shadowPlane.render(),s.render(i.root,r.threeCamera),l.render(),t.trigger(E.RENDER,{type:E.RENDER,target:t,delta:h}))}}class ge extends O.DataTextureLoader{constructor(e){super(e),this.type=O.HalfFloatType}parse(r){const s=-1,m=1,i=2,v=3,g=4,f=function(e,t){switch(e){case m:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case i:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case v:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case g:console.error("THREE.RGBELoader: Error: "+(t||""))}return s},l=1,h=2,c=4,d="\n",u=function(e,t,s){t=t||1024;let i=e.pos,r=-1,n=0,o="",a=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));for(;(r=a.indexOf(d))<0&&n<t&&i<e.byteLength;)o+=a,n+=a.length,i+=128,a+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));return-1<r&&(!1!==s&&(e.pos+=n+r+1),o+a.slice(0,r))};const e=new Uint8Array(r);e.pos=0;var n,o,a,_,p,E,T,w,b,y,r=function(e){const t=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*FORMAT=(\S+)\s*$/,r=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,n={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let o,a;if(e.pos>=e.byteLength||!(o=u(e)))return f(m,"no header found");if(!(a=o.match(/^#\?(\S+)/)))return f(v,"bad initial token");for(n.valid|=l,n.programtype=a[1],n.string+=o+"\n";;){if(!1===(o=u(e)))break;if(n.string+=o+"\n","#"===o.charAt(0))n.comments+=o+"\n";else if((a=o.match(t))&&(n.gamma=parseFloat(a[1],10)),(a=o.match(s))&&(n.exposure=parseFloat(a[1],10)),(a=o.match(i))&&(n.valid|=h,n.format=a[1]),(a=o.match(r))&&(n.valid|=c,n.height=parseInt(a[1],10),n.width=parseInt(a[2],10)),n.valid&h&&n.valid&c)break}return n.valid&h?n.valid&c?n:f(v,"missing image size specifier"):f(v,"missing format specifier")}(e);if(s!==r){var S=r.width,A=r.height,L=function(e,t,s){var i=t;if(i<8||32767<i||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(i!==(e[2]<<8|e[3]))return f(v,"wrong scanline width");const r=new Uint8Array(4*t*s);if(!r.length)return f(g,"unable to allocate buffer space");let n=0,o=0;var a=4*i;const l=new Uint8Array(4),h=new Uint8Array(a);let c=s;for(;0<c&&o<e.byteLength;){if(o+4>e.byteLength)return f(m);if(l[0]=e[o++],l[1]=e[o++],l[2]=e[o++],l[3]=e[o++],2!=l[0]||2!=l[1]||(l[2]<<8|l[3])!=i)return f(v,"bad rgbe scanline format");let t=0,s;for(;t<a&&o<e.byteLength;){var d=128<(s=e[o++]);if(d&&(s-=128),0===s||t+s>a)return f(v,"bad scanline data");if(d){var u=e[o++];for(let e=0;e<s;e++)h[t++]=u}else h.set(e.subarray(o,o+s),t),t+=s,o+=s}var _=i;for(let e=0;e<_;e++){var p=0;r[n]=h[e+0],p+=i,r[n+1]=h[e+p],p+=i,r[n+2]=h[e+p],p+=i,r[n+3]=h[e+p],n+=4}c--}return r}(e.subarray(e.pos),S,A);if(s!==L){let e,t,s,i;switch(this.type){case O.UnsignedByteType:e=L,t=O.RGBEFormat,s=O.UnsignedByteType;break;case O.FloatType:i=L.length/4;var R=new Float32Array(3*i);for(let e=0;e<i;e++)E=L,T=4*e,w=R,b=3*e,y=void 0,y=E[T+3],y=Math.pow(2,y-128)/255,w[b+0]=E[T+0]*y,w[b+1]=E[T+1]*y,w[b+2]=E[T+2]*y;e=R,t=O.RGBFormat,s=O.FloatType;break;case O.HalfFloatType:i=L.length/4;var x=new Uint16Array(3*i);for(let e=0;e<i;e++)n=L,o=4*e,a=x,_=3*e,p=void 0,p=n[o+3],p=Math.pow(2,p-128)/255,a[_+0]=O.DataUtils.toHalfFloat(Math.min(n[o+0]*p,65504)),a[_+1]=O.DataUtils.toHalfFloat(Math.min(n[o+1]*p,65504)),a[_+2]=O.DataUtils.toHalfFloat(Math.min(n[o+2]*p,65504));e=x,t=O.RGBFormat,s=O.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:S,height:A,data:e,header:r.string,gamma:r.gamma,exposure:r.exposure,format:t,type:s}}}return null}setDataType(e){return this.type=e,this}load(e,s,t,i){return super.load(e,function(e,t){switch(e.type){case O.UnsignedByteType:e.encoding=O.RGBEEncoding,e.minFilter=O.NearestFilter,e.magFilter=O.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case O.FloatType:case O.HalfFloatType:e.encoding=O.LinearEncoding,e.minFilter=O.LinearFilter,e.magFilter=O.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}s&&s(e,t)},t,i)}}class fe{constructor(e){this._onLoadingProgress=(e,t,s)=>{const i=this._view3D;s.initialized=!0,s.lengthComputable=e.lengthComputable,s.loaded=e.loaded,s.total=e.total,i.trigger(E.PROGRESS,{type:E.PROGRESS,target:i,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class Ee extends fe{constructor(e){super(e)}load(r){const n=this._view3D;return new Promise((e,t)=>{const s=new O.TextureLoader,i=X(n,r);s.setCrossOrigin(he),s.load(r,e,e=>this._onLoadingProgress(e,r,i),e=>{i.initialized=!0,t(e)})})}loadHDRTexture(r){const n=this._view3D;return new Promise((t,s)=>{const e=new ge,i=(n.renderer.capabilities.halfFloat||(e.type=O.FloatType),X(n,r));e.setCrossOrigin(he),e.load(r,e=>{e.mapping=O.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,i),e=>{i.initialized=!0,s(e)})})}}const Te=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap","sheenColorMap","sheenRoughnessMap","specularColorMap","specularIntensityMap","transmissionMap","clearcoatMap","clearcoatNormalMap"],T={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},we=((t=v=v||{})[t.NONE=0]="NONE",t[t.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",t[t.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",t[t.ONE_FINGER=3]="ONE_FINGER",t[t.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",t[t.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",t[t.TWO_FINGER=12]="TWO_FINGER",t[t.PINCH=16]="PINCH","KHR_materials_variants"),be="EXT_View3D_texture_LOD",ye="view3d-lod",Se="view3d-annotation";var y,w,Ae={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float h;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

			gl_FragColor = sum;

		}`};const Le={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float v;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

			gl_FragColor = sum;

		}`};class Re{constructor(e,{darkness:t=.5,mapSize:s=9,blur:i=3.5,shadowScale:r=1,planeScale:n=2}={}){this._view3D=e,this._darkness=t,this._mapSize=s,this._blur=i,this._shadowScale=r,this._planeScale=n;t=e.renderer.threeRenderer,i=Math.min(Math.pow(2,Math.floor(s)),t.capabilities.maxTextureSize);this._root=new O.Group,this._renderTarget=new O.WebGLRenderTarget(i,i,{format:O.RGBAFormat}),this._blurTarget=new O.WebGLRenderTarget(i,i,{format:O.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1;const o=new O.OrthographicCamera(-.5,.5,.5,-.5,0);o.rotation.x=Math.PI/2,this._shadowCamera=o,this._root.add(o);r=new O.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=r,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){const t=this._root,s=this._shadowCamera;var i=this._planeScale,r=e.bbox.getBoundingSphere(new O.Sphere),i=2*i*r.radius,n=this._shadowScale;s.far=n*(e.bbox.max.y-e.bbox.min.y)/i,s.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(i),s.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:s}=e,i=this._shadowCamera;const r=t.threeRenderer;t=s.activeSession?s.activeSession.arScene:e.scene,s=r.xr.enabled;r.xr.enabled=!1;const n=t.root;var e=n.background,t=(n.background=null,n.overrideMaterial=this._depthMaterial,r.getClearAlpha()),o=(r.setClearAlpha(0),r.getRenderTarget());r.setRenderTarget(this._renderTarget),r.clear(),r.render(n,i),n.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),r.xr.enabled=s,r.setRenderTarget(o),r.setClearAlpha(t),n.background=e,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],s=this._blurCamera;const i=t.threeRenderer,r=this._blurPlane;var t=this._renderTarget,n=this._blurTarget;const o=this._horizontalBlurMaterial,a=this._verticalBlurMaterial;r.visible=!0,o.uniforms.tDiffuse.value=t.texture,o.uniforms.h.value=+e/256,o.needsUpdate=!0,r.material=o,i.setRenderTarget(n),i.render(r,s),a.uniforms.tDiffuse.value=n.texture,a.uniforms.v.value=+e/256,a.needsUpdate=!0,r.material=a,i.setRenderTarget(t),i.render(r,s),r.visible=!1}_setupPlanes(){const e=this._root;var t=new O.PlaneBufferGeometry,s=new O.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:O.BackSide,depthWrite:!1,map:this._renderTarget.texture});const i=new O.Mesh(t,s);i.renderOrder=1,i.scale.set(-1,-1,1),i.rotation.order="YXZ",i.rotation.x=Math.PI/2,this._plane=i,e.add(i);s=new O.Mesh(t);this._blurPlane=s;const r=new O.MeshDepthMaterial,n=(r.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=r,new O.ShaderMaterial(Ae)),o=(n.depthTest=!1,this._horizontalBlurMaterial=n,new O.ShaderMaterial(Le));o.depthTest=!1,this._verticalBlurMaterial=o}}class xe{static fromCubeTexture(i){let r=0;const n=new O.Vector3,o=new O.Vector3,a=new O.Color;var l=[0,0,0,0,0,0,0,0,0],e=new O.SphericalHarmonics3;const h=e.coefficients;for(let s=0;s<6;s++){var t=i.image[s],c=t.width,d=t.height;const E=document.createElement("canvas"),T=(E.width=c,E.height=d,E.getContext("2d"));T.drawImage(t,0,0,c,d);var t=T.getImageData(0,0,c,d),u=t.data,_=t.width,p=2/_;for(let e=0,t=u.length;e<t;e+=4){a.setRGB(u[e]/255,u[e+1]/255,u[e+2]/255),Oe(a,i.encoding);var m=e/4,v=(m%_+.5)*p-1,g=1-(Math.floor(m/_)+.5)*p;switch(s){case 0:n.set(-1,g,-v);break;case 1:n.set(1,g,v);break;case 2:n.set(-v,1,-g);break;case 3:n.set(-v,-1,g);break;case 4:n.set(-v,g,1);break;case 5:n.set(v,g,-1)}var m=n.lengthSq(),f=4/(Math.sqrt(m)*m);r+=f,o.copy(n).normalize(),O.SphericalHarmonics3.getBasisAt(o,l);for(let e=0;e<9;e++)h[e].x+=l[e]*a.r*f,h[e].y+=l[e]*a.g*f,h[e].z+=l[e]*a.b*f}}var s=4*Math.PI/r;for(let e=0;e<9;e++)h[e].x*=s,h[e].y*=s,h[e].z*=s;return new O.LightProbe(e)}static fromCubeRenderTarget(e,i){let r=0;const n=new O.Vector3,o=new O.Vector3,a=new O.Color;var l=[0,0,0,0,0,0,0,0,0],t=new O.SphericalHarmonics3;const h=t.coefficients;for(let s=0;s<6;s++){var c=i.width,d=new Uint8Array(c*c*4),u=(e.readRenderTargetPixels(i,0,0,c,c,d,s),2/c);for(let e=0,t=d.length;e<t;e+=4){a.setRGB(d[e]/255,d[e+1]/255,d[e+2]/255),Oe(a,i.texture.encoding);var _=e/4,p=(_%c+.5)*u-1,m=1-(Math.floor(_/c)+.5)*u;switch(s){case 0:n.set(1,m,-p);break;case 1:n.set(-1,m,p);break;case 2:n.set(p,1,-m);break;case 3:n.set(p,-1,m);break;case 4:n.set(p,m,1);break;case 5:n.set(-p,m,-1)}var _=n.lengthSq(),v=4/(Math.sqrt(_)*_);r+=v,o.copy(n).normalize(),O.SphericalHarmonics3.getBasisAt(o,l);for(let e=0;e<9;e++)h[e].x+=l[e]*a.r*v,h[e].y+=l[e]*a.g*v,h[e].z+=l[e]*a.b*v}}var s=4*Math.PI/r;for(let e=0;e<9;e++)h[e].x*=s,h[e].y*=s,h[e].z*=s;return new O.LightProbe(t)}}function Oe(e,t){switch(t){case O.sRGBEncoding:e.convertSRGBToLinear();break;case O.LinearEncoding:break;default:console.warn("WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.")}}class b{static createDefaultEnv(e){const t=new O.Scene,s=new O.PointLight(16777215,.8,20);s.decay=2,s.position.set(0,7,0),t.add(s);var i=new O.BoxBufferGeometry(1,1,1),r=new O.MeshStandardMaterial({side:O.BackSide});const n=new O.Mesh(i,r),o=(n.castShadow=!1,n.scale.set(15,45,15),n.position.set(0,20,0),t.add(n),b._createRectAreaLightSource({intensity:4.5,width:4,height:4}));o.position.set(0,2.5,0),o.rotateX(Math.PI/2);const a=b._createRectAreaLightSource({intensity:3,width:2,height:2}),l=(a.position.set(0,1,4),a.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),h=(l.position.set(-4,1,1),l.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),c=(h.position.set(4,1,1),h.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),d=(c.position.set(1.5,1,-4),c.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2}));d.position.set(-1.5,1,-4),d.lookAt(0,0,0),t.add(o,a,l,h,c,d);var i=e.outputEncoding,r=e.toneMapping,u=(e.outputEncoding=O.LinearEncoding,e.toneMapping=O.NoToneMapping,new O.PMREMGenerator(e).fromScene(t,.035));return e.outputEncoding=i,e.toneMapping=r,u.texture}static createBlurredHDR(e,t){const s=e.renderer.threeRenderer,i=new O.Scene;i.background=t;e=s.toneMappingExposure,s.toneMappingExposure=1,t=new O.WebGLCubeRenderTarget(256,{encoding:O.sRGBEncoding,format:O.RGBAFormat});const r=new O.CubeCamera(.1,1e3,t);r.update(s,i);var n=xe.fromCubeRenderTarget(s,t),o=new O.MeshStandardMaterial({side:O.BackSide});const a=new O.IcosahedronBufferGeometry(1,4),l=new O.Scene;o=new O.Mesh(a,o);const h=a.getAttribute("normal");for(let e=0;e<h.count;e++)h.setXYZ(e,-h.getX(e),-h.getY(e),-h.getZ(e));return l.add(o),l.add(n),r.update(s,l),s.toneMappingExposure=e,t.texture}static _createRectAreaLightSource({intensity:e,width:t,height:s}){t=new O.PlaneBufferGeometry(t,s);const i=new O.MeshBasicMaterial;return i.color.setScalar(e),new O.Mesh(t,i)}}class Ce{constructor(e){this._view3D=e,this._root=new O.Scene,this._userObjects=new O.Group,this._envObjects=new O.Group,this._fixedObjects=new O.Group,this._shadowPlane=new Re(e,Z(e.shadow));const t=this._root,s=this._userObjects,i=this._envObjects,r=this._fixedObjects;var n=this._shadowPlane;s.name="userObjects",i.name="envObjects",r.name="fixedObjects",t.add(s,i,r),e.shadow&&r.add(n.root)}get root(){return this._root}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const s=t?this._userObjects:this._envObjects;t=Array.isArray(e)?e:[e];s.add(...t)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(r){return Q(this,void 0,void 0,function*(){const e=this._view3D,t=this._root;if("number"==typeof r||"#"===r.charAt(0))t.background=new O.Color(r);else{const s=new Ee(e),i=yield s.load(r);i.encoding=O.sRGBEncoding,t.background=i}e.renderer.renderSingleFrame()})}setSkybox(r){return Q(this,void 0,void 0,function*(){const e=this._root,t=this._view3D;if(e.background&&e.background.isTexture&&e.background.dispose(),r){const i=new Ee(t);var s=yield i.loadHDRTexture(r);t.skyboxBlur?e.background=b.createBlurredHDR(t,s):e.background=s,e.environment=s}else e.background=null,e.environment=null;t.renderer.renderSingleFrame()})}setEnvMap(r){return Q(this,void 0,void 0,function*(){const e=this._view3D,t=this._root;if(r){const i=new Ee(e);var s=yield i.loadHDRTexture(r);t.environment=s}else t.environment=null;e.renderer.renderSingleFrame()})}initTextures(){var{skybox:e,envmap:t,background:s,useDefaultEnv:i}=this._view3D;const r=[];return i&&this.setDefaultEnv(),(e||t)&&(i=e?this.setSkybox(e):this.setEnvMap(t),r.push(i)),!e&&s&&r.push(this.setBackground(s)),r}setDefaultEnv(){var e=this._view3D.renderer,e=b.createDefaultEnv(e.threeRenderer);this._root.environment=e}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e,s=(t.geometry.dispose(),Array.isArray(t.material)?t.material:[t.material]);s.forEach(t=>{Te.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}const S=de.EASE_OUT_CUBIC,Me={min:0,max:1},Ie={min:-1/0,max:1/0},De={min:-89.9,max:89.9},Pe={165:0,135:.4,0:1},Ne=[e.WEBXR,e.SCENE_VIEWER,e.QUICK_LOOK];class A{constructor({duration:e=300,loop:t=!1,range:s=Me,easing:i=S}={}){this._duration=e,this._loop=t,this._range=s,this._easing=i,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}get activated(){return this._activated}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,s=this._end,i=this._duration,r=this._val,n=this._loop,e=this._progress+e/i,i=(this._progress=(n?u:d)(e,0,1),this._easing(this._progress));return this._val=H(t,s,i),!n&&1<=this._progress&&(this._activated=!1),this._val-r}reset(e){var t=this._range,e=d(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=d(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class Fe{constructor(e,t,s,{duration:i=300,easing:r=S,disableOnFinish:n=!0}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,this._motion=new A({duration:i,range:Me,easing:r}),this._disableOnFinish=n,this.changeStartEnd(t,s)}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}get animating(){return this._motion.activated}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}changeStartEnd(e,t){e=e.clone(),t=t.clone(),e.yaw=u(e.yaw,0,360),t.yaw=u(t.yaw,0,360),180<Math.abs(t.yaw-e.yaw)&&(t.yaw=t.yaw<e.yaw?t.yaw+360:t.yaw-360),this._from=e,this._to=t}update(e){if(this._enabled){const s=this._view3D.camera,i=this._from;var t=this._to;const r=this._motion;r.update(e);e=r.val;s.yaw=H(i.yaw,t.yaw,e),s.pitch=H(i.pitch,t.pitch,e),s.zoom=H(i.zoom,t.zoom,e),s.pivot=i.pivot.clone().lerp(t.pivot,e),1<=e&&(this._disableOnFinish&&this.disable(),this._finishCallbacks.forEach(e=>e()),this.clearFinished())}}enable(){this._enabled||(this._enabled=!0,this.reset())}disable(){this._enabled&&(this._enabled=!1)}reset(){this._motion.reset(0),this._motion.setEndDelta(1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class L{constructor(e,t,s,i=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=s,this.pivot=(new O.Vector3).fromArray(i)}clone(){return new L(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}copy(e){this.yaw=e.yaw,this.pitch=e.pitch,this.zoom=e.zoom,this.pivot.copy(e.pivot)}equals(e){const{yaw:t,pitch:s,zoom:i,pivot:r}=this;return u(t,0,360)===u(e.yaw,0,360)&&s===e.pitch&&i===e.zoom&&r.equals(e.pivot)}}class Ue{constructor(e){this._view3D=e,this._threeCamera=new O.PerspectiveCamera,this._maxTanHalfHFov=0,this._baseFov=45,this._baseDistance=0;var t=N(e.initialZoom)?e.initialZoom:0;this._defaultPose=new L(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone(),this._newPose=this._currentPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get newPose(){return this._newPose}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get distance(){return this._view3D.control.zoom.type===_e.FOV?this._baseDistance:this._baseDistance-this._currentPose.zoom}get baseDistance(){return this._baseDistance}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this.distance*Math.tan(_(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._newPose.yaw=e}set pitch(e){this._newPose.pitch=e}set zoom(e){this._newPose.zoom=e}set pivot(e){this._newPose.pivot.copy(e)}set baseFov(e){this._baseFov=e}reset(e=0,t=S,s){const i=this._view3D,r=i.control,n=i.autoPlayer,o=this._newPose,a=this._currentPose,l=null!=s?s:this._defaultPose;if(e<=0)return o.copy(l),a.copy(l),i.renderer.renderSingleFrame(),r.sync(),Promise.resolve();{const h=n.enabled,c=new Fe(i,a,l);return c.duration=e,c.easing=t,c.enable(),h&&n.disable(),r.add(c),new Promise(e=>{c.onFinished(()=>{o.copy(l),a.copy(l),r.remove(c),r.sync(),h&&n.enableAfterDelay(),e()})})}}resize({width:e,height:t},s=null){const{control:i,fov:r,maintainSize:n}=this._view3D,o=this._threeCamera;o.aspect=e/t,r===$?n&&null!=s?(e=t/s.height,t=this._currentPose.zoom,s=Math.tan(_((this._baseFov-t)/2)),this._baseFov=m(2*Math.atan(e*s))+t):this._applyEffectiveFov(45):this._baseFov=r,i.zoom.updateRange()}fit(e){var t=this._view3D;const s=this._threeCamera,i=this._defaultPose,r=t.control;var n=t.pivot,o=e.bbox,a=t.fov,l=a===$?45:a;const h=e.center;var c=t.ignoreCenterOnFit||t.center===$?(new O.Vector3).subVectors(o.max,o.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(h)),0),c=Math.sqrt(c);const d=c/Math.sin(_(l/2));var u=e.reduceVertices((e,t)=>{var t=(new O.Vector3).subVectors(t,h),s=Math.hypot(t.x,t.z);return Math.max(e,s/(d-Math.abs(t.y)))},0);a===$?(this._maxTanHalfHFov=u,this._applyEffectiveFov(l)):this._maxTanHalfHFov=a,i.pivot=n===$?h.clone():ae(n,o),this._baseDistance=d,s.near=.1*(d-c),s.far=10*(d+c),r.zoom.updateRange(),N(t.initialZoom)?i.zoom=t.initialZoom:(u=this._baseFov,l=e.bbox,a=t.initialZoom.axis,n=t.initialZoom.ratio,c=(o=(new O.Vector3).subVectors(l.max,l.min))[a],e="y"===a?c/n:c/(n*s.aspect),t="z"!==a?d-o.z/2:d-o.x/2,l=m(2*Math.atan(e/(2*t))),i.zoom=u-l)}updatePosition(){const e=this._view3D;var t=e.control;const s=this._threeCamera,i=this._currentPose,r=this._newPose;var n=this._baseFov,o=this._baseDistance,t=t.zoom.type===_e.FOV,a=i.clone(),n=(i.yaw=u(r.yaw,0,360),i.pitch=d(r.pitch,De.min,De.max),i.zoom=r.zoom,i.pivot.copy(r.pivot),t?n-i.zoom:n),t=t?o:o-i.zoom;const l=j(t,i.yaw,i.pitch);l.add(i.pivot),s.fov=n,s.position.copy(l),s.lookAt(i.pivot),s.updateProjectionMatrix(),r.copy(i),e.trigger(E.CAMERA_CHANGE,{type:E.CAMERA_CHANGE,target:e,pose:i.clone(),prevPose:a})}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(_(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=m(2*Math.atan(e))}_parseBboxRatioOption(e,t){const s=t.min.toArray(),i=(new O.Vector3).subVectors(t.max,t.min).toArray();return e.map((e,t)=>{if(!o(e))return e;e=.01*parseFloat(e);return s[t]+e*i[t]})}}class Be{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const s=e.renderer.canvas;var t=s.getBoundingClientRect(),t=0!==t.width||0!==t.height;const i=new ResizeObserver(t?this._skipFirstResize:this._onResize);i.observe(s),this._resizeObserver=i}else e.resize(),window.addEventListener(p.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(p.RESIZE,this._onResize),this._enabled=!1,this}}class ke{constructor(e){this._onAnimationLoop=t=>{const e=this._view3D,s=this._actions;var i=this._clips,r=s.findIndex(e=>e===t.action);e.trigger(E.ANIMATION_LOOP,{type:E.ANIMATION_LOOP,target:e,index:r,action:t.action,clip:i[r]}),e.animationRepeatMode===me.ALL&&(i=r+1>=i.length?0:r+1,this.play(i))},this._onAnimationFinished=t=>{const e=this._view3D,s=this._actions;var i=this._clips,r=s.findIndex(e=>e===t.action);e.trigger(E.ANIMATION_FINISHED,{type:E.ANIMATION_FINISHED,target:e,index:r,action:t.action,clip:i[r]})},this._view3D=e,this._mixer=new O.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._timeScale=1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAction(){var e;return null!=(e=this._actions[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}get animating(){var e;return(null==(e=this.activeAction)?void 0:e.isRunning())&&!this.paused}get timeScale(){return this._timeScale}set timeScale(e){this._timeScale=e}init(){this._mixer.addEventListener("loop",this._onAnimationLoop),this._mixer.addEventListener("finished",this._onAnimationFinished)}destroy(){this.reset(),this._mixer.removeEventListener("loop",this._onAnimationLoop),this._mixer.removeEventListener("finished",this._onAnimationFinished)}setClips(e){const s=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=s.clipAction(e);return t.setEffectiveWeight(0),t}),this.updateRepeatMode()}play(e){const t=this._view3D,s=this._actions[e];s&&(this.stop(),this._restoreTimeScale(),s.setEffectiveTimeScale(1),s.setEffectiveWeight(1),s.play(),this._activeAnimationIdx=e,this._flushFadePromises(),t.trigger(E.ANIMATION_START,{type:E.ANIMATION_START,target:t,index:e,action:s,clip:this._clips[e]}))}crossFade(h,c,{synchronize:d=!1}={}){var u;return Q(this,void 0,void 0,function*(){const s=this._view3D,t=this._mixer;var e=this._actions,i=this._activeAnimationIdx;const r=e[h],n=null!=(u=e[i])?u:r,o="loop",a=(this._restoreTimeScale(),()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),n.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=h});if(d){const l=e=>{e.action===n&&(t.removeEventListener(o,l),a())};t.addEventListener(o,l)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(s.off(E.BEFORE_RENDER,t),e(!0))};s.on(E.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return Q(this,void 0,void 0,function*(){const s=this._view3D;const i=this._actions[this._activeAnimationIdx];return!!i&&(this._flushFadePromises(),this._restoreTimeScale(),i.fadeOut(e/1e3),new Promise(e=>{const t=()=>{0<i.getEffectiveWeight()||(s.off(E.BEFORE_RENDER,t),this._activeAnimationIdx=-1,e(!0))};s.on(E.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._view3D.renderer.renderSingleFrame(),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}updateRepeatMode(){var e=this._view3D;const t=this._actions;e.animationRepeatMode===me.NONE?t.forEach(e=>{e.clampWhenFinished=!0,e.loop=O.LoopOnce}):t.forEach(e=>{e.clampWhenFinished=!1,e.loop=O.LoopRepeat})}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=this._timeScale}_flushFadePromises(){const s=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),s.off(E.BEFORE_RENDER,t)}),this._fadePromises=[]}}class He extends s{constructor({context:e=window,repeat:t=0,duration:s=300,easing:i=S}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,s=this._repeat,e=this._time+e,i=Math.floor(e/t),e=(this._time=(this._loopCount>=s?d:u)(e,0,t),this._time/t),r={progress:e,easedProgress:this._easing(e)};this.trigger("progress",r);for(let e=0;e<i;e++){if(this._loopCount++,this._loopCount>s)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=s,this._easing=i,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const Ge={AR:"immersive-ar",VR:"immersive-vr"},Ve={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},R={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend",ESTIMATION_START:"estimationstart",ESTIMATION_END:"estimationend"},ze={TOUCH:"generic-touchscreen"},We={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{},LIGHT_ESTIMATION:{optionalFeatures:["light-estimation"]}},je={},Ke={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class Xe{constructor({scale:e=1}={}){this.rotation=new O.Quaternion,this._axis=new O.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new O.Vector2,this._fromQuat=new O.Quaternion,this._toQuat=new O.Quaternion,this._motion=new A({range:Ie}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:s}){if(this._active&&1===s.length){const i=this._prevPos,r=this._motion;s=s[0];const n=e.modelMovable.getWorldPosition(new O.Vector3);e=(new O.Vector2).fromArray(n.project(t).toArray()),t=z(e,i,s)*this._userScale,e=(new O.Quaternion).setFromAxisAngle(this._axis,t),t=this._getInterpolatedQuaternion();this._fromQuat.copy(t),this._toQuat.premultiply(e),r.reset(0),r.setEndDelta(1),i.copy(s)}}update({scene:e},t){if(this._active){const s=this._motion;s.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,s=this._fromQuat,e=e.val;return(new O.Quaternion).copy(s).slerp(t,e)}}(t=y=y||{})[t.WAITING=0]="WAITING",t[t.TRANSLATING=1]="TRANSLATING",t[t.BOUNCING=2]="BOUNCING";class qe{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:s=de.EASE_OUT_BOUNCE}={}){this._hoverPosition=new O.Vector3,this._floorPosition=new O.Vector3,this._wallRotation=new O.Quaternion,this._dragPlane=new O.Plane,this._enabled=!1,this._vertical=!1,this._state=y.WAITING,this._initialPos=new O.Vector2,this._hoverHeight=e,this._bounceMotion=new A({duration:t,easing:s,range:Ie})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=y.TRANSLATING}}deactivate(){if(!this._enabled||this._vertical||this._state===y.WAITING)this._state=y.WAITING;else{this._state=y.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const s=this._bounceMotion;t=t.y-e.y;s.reset(t),s.setEndDelta(-t)}}init(e,t,s){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=s?new O.Vector3(0,1,0).applyQuaternion(t):new O.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=s}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:s},{hitResults:i}){var r=this._state,r=r===y.WAITING||r===y.BOUNCING;if(i&&1===i.length&&!r){const c=i[0];r=this._floorPosition.clone();const d=this._floorPosition,u=this._hoverPosition;i=this._hoverHeight;const _=this._dragPlane;var n=this._vertical,o=c.results[0]&&c.results[0].getPose(t),a=o&&(new O.Matrix4).fromArray(o.transform.matrix),l=o&&.75<a.elements[5],h=o&&a.elements[5]<.25,s=(new O.Vector3).setFromMatrixPosition(s.matrixWorld),a=o&&(new O.Vector3).setFromMatrixPosition(a);if(n)if(!e||o&&h){const p=new O.Vector3(0,1,0);n=o.transform.orientation,h=p.clone().applyQuaternion(new O.Quaternion(n.x,n.y,n.z,n.w)).normalize(),n=(new O.Vector3).crossVectors(new O.Vector3(0,1,0),h);const m=new O.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(m.dot(h)))>=Math.PI/18){n=(new O.Matrix4).makeBasis(n,p,h);const g=new O.Euler(0,0,0,"YXZ").setFromRotationMatrix(n);g.z=0,g.x=Math.PI/2,this._wallRotation.setFromEuler(g),_.normal.copy(new O.Vector3(0,1,0).applyQuaternion(this._wallRotation)),_.constant=this._calcDragPlaneConstant(a)}h=(new O.Vector3).subVectors(a,s).normalize();const v=new O.Ray(s,h);n=v.intersectPlane(_,new O.Vector3);n&&d.copy(n)}else{h=e.getPose(c.inputSource.targetRaySpace,t);if(!h)return;n=h.transform.position;const f=new O.Vector3(n.x,n.y,n.z);h=f.sub(s).normalize();const E=new O.Ray(s,h);n=E.intersectPlane(_,new O.Vector3);void(n&&d.copy(n))}else if(!e||o&&l){h=-_.constant,n=a.y+i,o=(.1<n-h&&(_.constant=-n),(new O.Vector3).subVectors(a,s).normalize());const T=new O.Ray(s,o);l=T.intersectPlane(_,new O.Vector3);l&&(d.copy(l),d.setY(a.y),u.copy(l))}else{i=e.getPose(c.inputSource.targetRaySpace,t);if(!i)return;h=i.transform.position;const w=new O.Vector3(h.x,h.y,h.z);n=w.sub(s).normalize();const b=new O.Ray(s,n);o=b.intersectPlane(_,new O.Vector3);void(o&&(d.copy(o),d.setY(r.y),u.copy(o)))}}}update({scene:e},t){var s=this._state,i=this._floorPosition;const r=this._hoverPosition,n=this._bounceMotion;var o=this._vertical;s===y.BOUNCING&&(n.update(t),r.setY(i.y+n.val),1<=n.progress&&(this._state=y.WAITING)),e.setRootPosition(i),o?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-i.y)}_calcDragPlaneConstant(e){var t=this._vertical,s=this._dragPlane.normal.clone();const i=new O.Plane(s,0);s=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+s)}}class Ye{constructor({width:e=.1,padding:t=20,offset:s=.05,font:i="64px sans-serif",color:r="white"}={}){const n=document.createElement("canvas"),o=n.getContext("2d");o.font=i;var a=o.measureText("100%"),l=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,a=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,h=V(l),e=(n.width=h,e*((n.height=h)/l)),h=(this._ctx=o,this._canvas=n,this._height=e*a/l,this._texture=new O.CanvasTexture(n),new O.PlaneGeometry(e,e)),a=new O.Mesh(h,new O.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=i,this._color=r,this._padding=t,this._offset=s,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,s){const i=this._mesh;s=this._height/2+this._offset+s,s=new O.Vector3(0,s,0).applyQuaternion(e.clone().invert());i.position.copy(s),i.lookAt(t)}updateScale(e){const t=this._ctx;var s=this._canvas,i=this._padding,r=(100*e).toFixed(0),n=(t.clearRect(0,0,s.width,s.height),s.width/2),s=s.height/2,o=t.measureText(r+"%"),a=(o.actualBoundingBoxLeft+o.actualBoundingBoxRight)/2,o=(o.actualBoundingBoxAscent+o.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(n-a,s-o-i),t.lineTo(n+a,s-o-i),t.quadraticCurveTo(n+a+i,s-o-i,n+a+i,s-o),t.lineTo(n+a+i,s+o),t.quadraticCurveTo(n+a+i,s+o+i,n+a,s+o+i),t.lineTo(n-a,s+o+i),t.quadraticCurveTo(n-a-i,s+o+i,n-a-i,s+o),t.lineTo(n-a-i,s-o),t.quadraticCurveTo(n-a-i,s-o-i,n-a,s-o-i),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",n,s),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class Ze{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new Ye,this._motion=new A({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new Ye}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:s,xrCam:i,initialScale:r}){const n=this._motion;var o=n.range;if(r===$){var a=2*Math.atan(1/i.projectionMatrix.elements[5]),l=i.projectionMatrix.elements[0]/i.projectionMatrix.elements[5];const c=i.position;i=t.bbox.max.y-t.bbox.min.y,s=c.distanceTo((new O.Vector3).addVectors(s,new O.Vector3(0,i/2,0)))*Math.tan(a/2),i=s*l,a=t.bbox.getBoundingSphere(new O.Sphere),l=s/a.radius,t=i/a.radius;const h=d(Math.min(t,l),o.min,1);n.reset(h)}else n.reset(d(r,o.min,o.max));const h=this._motion.val;this._scaleMultiplier=h,e.setModelScale(h)}setInitialPos(e){this._prevCoordDistance=(new O.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const i=this._motion;var t=(new O.Vector2).subVectors(t[0],t[1]).length(),s=t-this._prevCoordDistance;i.setEndDelta(s),this._prevCoordDistance=t,this._updateUIPosition(e)}}update({scene:e},t){if(this._enabled&&this._active){const s=this._motion;s.update(t),this._scaleMultiplier=s.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:s,vertical:i}){const r=e.model;e=(new O.Vector3).setFromMatrixPosition(s.matrixWorld),s=i?r.bbox.getBoundingSphere(new O.Sphere).radius:r.bbox.max.y-r.bbox.min.y;this._ui.updatePosition(t.root.quaternion,e,s)}}class Qe{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:s=1e3}={}){var i=Math.PI/18;const r=new O.RingGeometry(.975,1,150,1,-6*i,30*i),n=(r.rotateX(-Math.PI/2),new O.RingGeometry(.96,1.015,30,1,25*i,4*i)),o=n.attributes["position"];var a=Math.floor(11*o.count/16),l=Math.floor(13*o.count/16),h=Math.floor((l-a+1)/2),c=(new O.Vector3).fromBufferAttribute(o,a).y;for(let e=a;e<l;e++){var d=e-a,d=.025*(h-Math.abs(d-h));o.setY(e,c-d)}n.rotateX(-Math.PI/2);var i=new O.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),u=new O.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),i=new O.Mesh(r,i),u=new O.Mesh(n,u);const _=new O.Group;_.add(i,u),_.position.setY(1e-4),this._mesh=_,this._ring=i,this._arrow=u,this._animator=new A({duration:s}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new O.Sphere).radius)}update({delta:e,rotation:t}){const s=this._mesh,i=this._animator;if(s.visible){i.update(e);const r=this._ring.material,n=this._arrow.material;e=this._opacityRange;r.opacity=i.val*e.min,n.opacity=i.val*e.max,i.val<=0&&(s.visible=!1),s.quaternion.copy(t),s.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(t=w=w||{})[t.WAITING=0]="WAITING",t[t.IN_DEADZONE=1]="IN_DEADZONE",t[t.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class $e{constructor({size:e=.1}={}){this._state=w.WAITING,this._detectedGesture=v.NONE,this._testingGestures=v.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new O.Vector2,this._prevTwoFingerPos=new O.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===w.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new O.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new O.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=w.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,v.NONE)}cleanup(){this._testingGestures=v.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=v.NONE,this._state=w.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,s=this._size,i=this._testingGestures,r=this._lastFingerCount,n=e.length;if(t===w.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=n,this.applyScreenAspect(e),n!==r)return this.setFirstInput(e),v.NONE;if(1===n){t=e[0],r=this._prevOneFingerPos.clone();const o=(new O.Vector2).subVectors(t,r);o.length()>s&&(Math.abs(o.x)>Math.abs(o.y)?v.ONE_FINGER_HORIZONTAL&i&&(this._detectedGesture=v.ONE_FINGER_HORIZONTAL):v.ONE_FINGER_VERTICAL&i&&(this._detectedGesture=v.ONE_FINGER_VERTICAL))}else if(2===n){t=(new O.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),r=this._prevTwoFingerPos.clone();const a=(new O.Vector2).subVectors(t,r);a.length()>s&&(Math.abs(a.x)>Math.abs(a.y)?v.TWO_FINGER_HORIZONTAL&i&&(this._detectedGesture=v.TWO_FINGER_HORIZONTAL):v.TWO_FINGER_VERTICAL&i&&(this._detectedGesture=v.TWO_FINGER_VERTICAL));n=(new O.Vector2).subVectors(e[1],e[0]).length();Math.abs(n-this._initialTwoFingerDistance)>s&&v.PINCH&i&&(this._detectedGesture=v.PINCH)}return this._detectedGesture!==v.NONE&&(this._state=w.OUT_OF_DEADZONE),this._detectedGesture}}class Je{constructor(e,t,{rotate:s,translate:i,scale:r,ring:n,deadzone:o,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var e=this._view3D,s=this._arScene,i=this._hitTestSource;const r=this._deadzoneChecker;var n=this._rotateControl,o=this._translateControl,a=this._scaleControl;const l=e.renderer.threeRenderer;var h=l.xr.getCamera(new O.PerspectiveCamera),c=l.xr.getReferenceSpace();if(i&&!(h.cameras.length<=0)){h=h.cameras[0];const d=e.model;n.enabled&&r.addTestingGestures(v.ONE_FINGER),o.enabled&&r.addTestingGestures(v.ONE_FINGER),a.enabled&&r.addTestingGestures(v.PINCH);e=t.getHitTestResultsForTransientInput(i),n=this._hitResultToVector(e);if(r.applyScreenAspect(n),r.setFirstInput(n),1===n.length){o=t.getPose(e[0].inputSource.targetRaySpace,c);if(o){a=(new O.Vector3).setFromMatrixPosition(h.matrixWorld),i=o.transform.position,n=new O.Vector3(i.x,i.y,i.z).sub(a).normalize();const u=new O.Ray(a,n),_=d.bbox.getBoundingSphere(new O.Sphere);_.applyMatrix4(s.modelMovable.matrixWorld),u.intersectSphere(_,new O.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=s,this._translate=i,this._scale=r,this._initialScale=a,this._rotateControl=new Xe(Z(s)),this._translateControl=new qe(Z(i)),this._scaleControl=new Ze(Z(r)),this._floorIndicator=new Qe(n),this._deadzoneChecker=new $e(o)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:n,session:o,size:a,vertical:l,hitPosition:h,hitRotation:c}){return Q(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var s=this._scaleControl,i=this._floorIndicator;const r=this._deadzoneChecker;this._vertical=l,t.init(h,c,l),r.setAspect(a.height/a.width),e.add(i.mesh,s.ui.mesh),this.syncTargetModel(n);i=yield o.requestHitTestSourceForTransientInput({profile:ze.TOUCH});this._hitTestSource=i,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(R.SELECT_START,this._onSelectStart),e.removeEventListener(R.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,s=this._translate,i=this._scale;const r=this._rotateControl,n=this._translateControl,o=this._scaleControl;var a=this._vertical;e.addEventListener(R.SELECT_START,this._onSelectStart),e.addEventListener(R.SELECT_END,this._onSelectEnd),t&&!a&&r.enable(),s&&n.enable(),i&&o.enable()}disable(e){const t=this._rotateControl,s=this._translateControl,i=this._scaleControl;e.removeEventListener(R.SELECT_START,this._onSelectStart),e.removeEventListener(R.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),s.disable(),i.disable()}update(e){const{view3D:t,session:s,frame:i}=e;var r,n,o=this._hitTestSource;o&&t.model&&(r=this._deadzoneChecker,n=s.inputSources,o=null!=(o=null===i||void 0===i?void 0:i.getHitTestResultsForTransientInput(o))?o:[],n={coords:this._hitResultToVector(o),inputSources:n,hitResults:o},r.inDeadzone?this._checkDeadzone(e,n):this._processInput(e,n),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,s=this._translateControl.floorPosition,i=this._view3D.renderer.threeRenderer.xr.getCamera(new O.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:s,xrCam:i,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var s=this._arScene;const i=this._rotateControl,r=this._translateControl,n=this._scaleControl;var o=this._deadzoneChecker.check(t.map(e=>e.clone()));if(o!==v.NONE)switch(o){case v.ONE_FINGER_HORIZONTAL:case v.ONE_FINGER_VERTICAL:this._modelHit?(r.activate(),r.setInitialPos(t)):(i.activate(),i.updateRotation(s.modelMovable.quaternion),i.setInitialPos(t));break;case v.PINCH:n.activate(e),n.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const s=this._arScene,i=this._rotateControl,r=this._translateControl,n=this._scaleControl,o=this._floorIndicator;var t=1e3*t,e=(i.update(e,t),r.update(e,t),n.update(e,t),i.rotation),a=r.floorPosition;s.setRootPosition(a),o.update({delta:t,rotation:e})}_hitResultToVector(e){return e.map(e=>(new O.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class et{constructor(){this._root=new O.Scene,this._modelRoot=new O.Group,this._modelMovable=new O.Group,this._modelFixed=new O.Group,this._arRoot=new O.Group;const e=this._root,t=this._modelRoot;var s=this._modelMovable,i=this._modelFixed,r=this._arRoot;t.add(s),e.add(t,i,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,s=this._modelMovable,i=this._modelFixed;e=e.scene;s.add(e.userObjects,e.envObjects),i.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,s=this._modelFixed;const i=e.scene;[...t.children,...s.children].forEach(e=>{i.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}remove(...e){this._arRoot.remove(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const s=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,s.position.setZ(t/2),s.position.setY(-e.bbox.min.z),s.rotateX(-Math.PI/2),s.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class tt{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,We.DOM_OVERLAY(e)}}class st{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(Ve.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return We.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class it{constructor(e,t,s,i,r){this.xrLight=e,this.renderer=t,this.lightProbe=s,this.xrWebGLBinding=null,this.estimationStartCallback=r,this.frameCallback=this.onXRFrame.bind(this);const n=t.xr.getSession();if(i&&"XRWebGLBinding"in window){s=new O.WebGLCubeRenderTarget(16);e.environment=s.texture;const o=t.getContext();switch(n.preferredReflectionFormat){case"srgba8":o.getExtension("EXT_sRGB");break;case"rgba16f":o.getExtension("OES_texture_half_float")}this.xrWebGLBinding=new XRWebGLBinding(n,o),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}n.requestAnimationFrame(this.frameCallback)}updateReflection(){const e=this.renderer.properties.get(this.xrLight.environment);var t;e&&(t=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe))&&(e.__webglTexture=t)}onXRFrame(e,t){if(this.xrLight){const i=t.session;i.requestAnimationFrame(this.frameCallback);var s,t=t.getLightEstimate(this.lightProbe);t&&(this.xrLight.lightProbe.sh.fromArray(t.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1,s=Math.max(1,Math.max(t.primaryLightIntensity.x,Math.max(t.primaryLightIntensity.y,t.primaryLightIntensity.z))),this.xrLight.directionalLight.color.setRGB(t.primaryLightIntensity.x/s,t.primaryLightIntensity.y/s,t.primaryLightIntensity.z/s),this.xrLight.directionalLight.intensity=s,this.xrLight.directionalLight.position.copy(t.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null))}}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class rt extends O.Group{constructor(t,s=!0){super(),this.lightProbe=new O.LightProbe,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new O.DirectionalLight,this.directionalLight.intensity=0,this.add(this.directionalLight);let i=this.environment=null,r=!1;t.xr.addEventListener("sessionstart",()=>{const e=t.xr.getSession();"requestLightProbe"in e&&e.requestLightProbe({reflectionFormat:e.preferredReflectionFormat}).then(e=>{i=new it(this,t,e,s,()=>{r=!0,this.dispatchEvent({type:"estimationstart"})})})}),t.xr.addEventListener("sessionend",()=>{i&&(i.dispose(),i=null),r&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{i&&(i.dispose(),i=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}class nt{constructor(e,t){this._onEstimationStart=()=>{var e=this._light;const t=this._arScene;e&&(t.add(e),e.environment&&(t.root.environment=e.environment))},this._onEstimationEnd=()=>{var e=this._light;const t=this._arScene;e&&(t.remove(e),t.root.environment=this._origEnvironment)},this._view3D=e,this._arScene=t,this._light=null,this._origEnvironment=null}static isAvailable(){return!0}getFeatures(){return We.LIGHT_ESTIMATION}init(){var e=this._view3D.renderer.threeRenderer;const t=new rt(e);(this._light=t).addEventListener(R.ESTIMATION_START,this._onEstimationStart),t.addEventListener(R.ESTIMATION_END,this._onEstimationEnd)}destroy(){const e=this._light;e&&(e.removeEventListener(R.ESTIMATION_START,this._onEstimationStart),e.removeEventListener(R.ESTIMATION_END,this._onEstimationEnd),this._light=null)}}class ot{constructor(e,{features:t=je,vertical:s=!1,overlayRoot:i=null,useLightEstimation:r=!0,rotate:n=!0,translate:o=!0,scale:a=!0,ring:l={},deadzone:h={},initialScale:c=$}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=s,this.overlayRoot=i,this.useLightEstimation=r,this._arScene=new et,this._control=new Je(e,this._arScene,{rotate:n,translate:o,scale:a,ring:l,deadzone:h,initialScale:c}),this._hitTest=new st,this._domOverlay=new tt,this._lightEstimation=new nt(e,this._arScene)}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&st.isAvailable()&&tt.isAvailable()?navigator.xr.isSessionSupported(Ge.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}get lightEstimation(){return this._lightEstimation}enter(){return Q(this,void 0,void 0,function*(){const a=this._view3D,l=a.scene,h=this._arScene,e=a.renderer,c=e.threeRenderer,d=this._control,t=this._hitTest,s=this._domOverlay;var i=this.useLightEstimation;const r=this._lightEstimation,u=this.vertical;var n=this._getAllXRFeatures();c.xr.enabled=!0,i&&r.init();const _=yield navigator.xr.requestSession(Ge.AR,n),o=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(Ve.LOCAL),yield c.xr.setSession(_),h.init(a),t.init(_);_.addEventListener("end",()=>Q(this,void 0,void 0,function*(){d.destroy(_),h.destroy(a),r.destroy(),s.destroy(),c.setPixelRatio(o),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),a.trigger(E.AR_END,{target:a,type:E.AR_END,session:this})}),{once:!0});const p=new O.Vector2(window.outerWidth,window.outerHeight),m=new O.Clock;m.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var s,i,r,n=c.xr.getCamera(new O.PerspectiveCamera),o=m.getDelta();n.cameras.length<=0||(n=n.cameras[0],s=c.xr.getReferenceSpace(),i={width:null!=(r=null==(i=_.renderState.baseLayer)?void 0:i.framebufferWidth)?r:1,height:null!=(r=null==i?void 0:i.framebufferHeight)?r:1},r={view3D:a,scene:h,session:_,delta:o,frame:t,vertical:u,referenceSpace:s,xrCam:n,size:i},t=1e3*o,a.trigger(E.BEFORE_RENDER,{type:E.BEFORE_RENDER,target:a,delta:t}),this._modelPlaced?(a.animator.update(o),d.update(r),l.shadowPlane.render(),c.render(h.root,n),a.annotation.render(n,p)):this._initModelPosition(r),a.trigger(E.RENDER,{type:E.RENDER,target:a,delta:t}))}),a.trigger(E.AR_START,{type:E.AR_START,target:a,session:this})})}exit(){return Q(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=F(this.overlayRoot))?t:this._createARRootElement();return G({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),this._lightEstimation.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:s,size:i,vertical:r,referenceSpace:n}=e,o=this._view3D;e=o.model;const a=this._arScene,l=this._hitTest;if(l.ready&&e){const u=this._control;var h=l.getResults(t);if(!(h.length<=0)){const _=h[0];h=_.getPose(n);if(h){var c=(new O.Matrix4).fromArray(h.transform.matrix);if(!(!r&&c.elements[5]<.75||r&&(.25<=c.elements[5]||c.elements[5]<=-.25))){c=(new O.Vector3).setFromMatrixPosition(c);const p=new O.Quaternion;if(r){const g=new O.Vector3(0,1,0);var h=h.transform.orientation,h=g.clone().applyQuaternion(new O.Quaternion(h.x,h.y,h.z,h.w)).normalize(),d=(new O.Vector3).crossVectors(new O.Vector3(0,1,0),h),d=(new O.Matrix4).makeBasis(d,g,h);const f=new O.Euler(0,0,0,"YXZ").setFromRotationMatrix(d);f.z=0,f.x=Math.PI/2,p.setFromEuler(f),a.setWallRotation(p)}a.updateModelRootPosition(e,r),a.setRootPosition(c),a.showModel(),l.destroy(),this._modelPlaced=!0,o.trigger(E.AR_MODEL_PLACED,{type:E.AR_MODEL_PLACED,target:o,session:this,model:e}),u.init({model:e,vertical:r,session:s,size:i,hitPosition:c,hitRotation:p});const m=u.scale.scale,v=new He({context:s,duration:1e3});v.on("progress",e=>{a.setModelScale(e.easedProgress*m)}),v.on("finish",()=>{a.setModelScale(m),u.enable(s)}),v.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement(f);return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(E.AR_END,()=>{e.rootEl.removeChild(t)}),t}}ot.type=e.WEBXR;class at{constructor(e,t={}){var{file:s=null,mode:i=pe.ONLY_AR,fallbackURL:r=null,title:n=null,link:o=null,sound:a=null,resizable:l=!0,vertical:h=!1,disableOcclusion:c=!1,initialScale:d=$,shareText:u=null}=t,t=le(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=s,this.fallbackURL=r,this.mode=i,this.title=n,this.link=o,this.sound=a,this.resizable=l,this.vertical=h,this.disableOcclusion=c,this.initialScale=d,this.shareText=u,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var r;return Q(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=W(this.resizable),t.enable_vertical_placement=W(this.vertical),t.disable_occlusion=W(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var s=null!=(r=this.file)?r:e.src;if(!s)return Promise.reject(new l(c.FILE_NOT_SUPPORTED(null!=(r=this.file)?r:e.src),h.FILE_NOT_SUPPORTED));t.file=new URL(s,window.location.href).href;e=this.fallbackURL,s=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===pe.ONLY_AR?Ke.INTENT_AR_CORE(s,e):Ke.INTENT_SEARCHBOX(s,e||Ke.FALLBACK_DEFAULT(s));const i=document.createElement("a");i.href=e,i.click()})}exit(){return Promise.resolve()}}at.type=e.SCENE_VIEWER;class lt{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:s=null,applePayButtonType:i=null,callToAction:r=null,checkoutTitle:n=null,checkoutSubtitle:o=null,price:a=null,custom:l=null,customHeight:h=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=s,this.applePayButtonType=i,this.callToAction=r,this.checkoutTitle=n,this.checkoutSubtitle=o,this.price=a,this.custom=l,this.customHeight=h}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new l(c.FILE_NOT_SUPPORTED(""+e),h.FILE_NOT_SUPPORTED));var s=this.canonicalWebPageURL,i=this.custom,r=window.location.href;const n=document.createElement("a"),o=(n.setAttribute("rel","ar"),n.appendChild(document.createElement("img")),Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,s])=>(s&&(e[t]=s),e),{})),a=new URL(e,r);return this.allowsContentScaling||(o.allowsContentScaling="0"),s&&(o.canonicalWebPageURL=new URL(s,r).href),i&&(o.custom=new URL(i,r).href),a.hash=new URLSearchParams(o).toString(),n.setAttribute("href",a.href),n.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(E.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:E.QUICK_LOOK_TAP,target:t}))},!1),n.click(),Promise.resolve()}exit(){return Promise.resolve()}}lt.type=e.QUICK_LOOK;const ht={[e.WEBXR]:ot,[e.SCENE_VIEWER]:at,[e.QUICK_LOOK]:lt};class ct{constructor(e){this._view3D=e,this._activeSession=null,e.on(E.AR_START,({session:e})=>{this._activeSession=e}),e.on(E.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return Q(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return Q(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new l(c.NOT_INITIALIZED,h.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const s=new t(e,Z(e[t.type]));return yield s.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return Q(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>ht[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class dt{constructor(e,{element:t=null,focus:s=[],focusDuration:i=1e3,focusOffset:r=[],baseFov:n=45,baseDistance:o=null}={}){this._onClick=()=>{this.focus()},this._onWheel=e=>{e.preventDefault(),e.stopPropagation()},this._view3D=e,this._element=t,this._focus=s,this._focusDuration=i,this._focusOffset=r,this._baseFov=n,this._baseDistance=o,this._enabled=!1,this._hidden=!1,this._focusing=!1,this._tooltipSize=new O.Vector2,t&&(t.draggable=!1,this.resize())}get element(){return this._element}get renderable(){return!!this._element}get focusing(){return this._focusing}get focusPose(){return this._focus}get focusDuration(){return this._focusDuration}get focusOffset(){return this._focusOffset}get baseFov(){return this._baseFov}get baseDistance(){return this._baseDistance}get hidden(){return this._hidden}set focusDuration(e){this._focusDuration=e}set baseFov(e){this._baseFov=e}set baseDistance(e){this._baseDistance=e}destroy(){const e=this._view3D.annotation.wrapper;var t=this._element;this.disableEvents(),t&&t.parentElement===e&&e.removeChild(t)}resize(){const e=this._element;var t;!e||(t=e.querySelector("."+J.ANNOTATION_TOOLTIP))&&this._tooltipSize.set(t.offsetWidth,t.offsetHeight)}render({screenPos:e,screenSize:t,renderOrder:s}){const i=this._element;var r=this._tooltipSize;i&&!this._hidden&&(i.style.zIndex=""+(s+1),i.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`,e.y+r.y>t.y?i.classList.add(J.ANNOTATION_FLIP_Y):i.classList.remove(J.ANNOTATION_FLIP_Y),e.x+r.x>t.x?i.classList.add(J.ANNOTATION_FLIP_X):i.classList.remove(J.ANNOTATION_FLIP_X))}show(){const e=this._element;this._hidden=!1,e&&e.classList.remove(J.ANNOTATION_HIDDEN)}hide(){const e=this._element;this._hidden=!0,e&&e.classList.add(J.ANNOTATION_HIDDEN)}setOpacity(e){const t=this._element;t&&(t.style.opacity=""+e)}enableEvents(){const e=this._element;e&&!this._enabled&&(e.addEventListener(p.CLICK,this._onClick),e.addEventListener(p.WHEEL,this._onWheel),this._enabled=!0)}disableEvents(){const e=this._element;e&&this._enabled&&(e.removeEventListener(p.CLICK,this._onClick),e.removeEventListener(p.WHEEL,this._onWheel),this._enabled=!1)}handleUserInput(){this._focusing&&this._view3D.annotationAutoUnfocus&&this.unfocus()}_getFocus(){var e=this._view3D;const t=(new O.Vector3).fromArray(this._focus);var s=e.camera.baseDistance,i=this._baseFov,r=(null!=(r=this._baseDistance)?r:s)*Math.tan(_((i-t.z)/2)),i=2*m(Math.atan(r/s));return t.z=e.camera.baseFov-i,t}_getPivotOffset(){var e,t=this._focusOffset;return new O.Vector3(null!=(e=t[0])?e:0,null!=(e=t[1])?e:0,null!=(e=t[2])?e:0)}_onFocus(){const e=this._view3D,t=this._element;e.annotation.list.forEach(e=>{e._focusing&&e.unfocus()}),t&&t.classList.add(J.ANNOTATION_SELECTED),this._focusing=!0,e.trigger(E.ANNOTATION_FOCUS,{type:E.ANNOTATION_FOCUS,target:e,annotation:this})}_onUnfocus(){const e=this._view3D,t=this._element;t&&t.classList.remove(J.ANNOTATION_SELECTED),this._focusing=!1,e.trigger(E.ANNOTATION_UNFOCUS,{type:E.ANNOTATION_UNFOCUS,target:e,annotation:this})}}class ut extends dt{constructor(e,t={}){var{position:s=[]}=t;super(e,le(t,["position"])),this._position=(new O.Vector3).fromArray(s)}get position(){return this._position}focus(){return Q(this,void 0,void 0,function*(){if(!this._focusing){const i=this._view3D["camera"];var t=this._focus;let e;var s=this._getPivotOffset();const r=(new O.Vector3).addVectors(this._position,s);return e=0<t.length?(s=this._getFocus(),new L(s.x,s.y,s.z,r.toArray())):(t=this._calculateNormalFromModelCenter(),{yaw:s,pitch:t}=K(t),new L(m(s),m(t),0,r.toArray())),window.addEventListener(p.CLICK,()=>{this.unfocus()},{once:!0,capture:!0}),this._onFocus(),e.equals(i.currentPose)?Promise.resolve():i.reset(this._focusDuration,S,e)}})}unfocus(){this._focusing&&this._onUnfocus()}toJSON(){return{position:this._position.toArray(),focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}_calculateNormalFromModelCenter(){const e=this._view3D.model;var t=e?e.bbox.getCenter(new O.Vector3):new O.Vector3;return(new O.Vector3).subVectors(this._position,t).normalize()}}class _t extends dt{constructor(e,t={}){var{meshIndex:s=-1,faceIndex:i=-1,weights:r=k(3).map(()=>1/3)}=t;super(e,le(t,["meshIndex","faceIndex","weights"])),this._meshIndex=s,this._faceIndex=i,this._weights=r,this._trackingControl=null}get position(){return this._getPosition()}get renderable(){return!!this._element&&0<=this._meshIndex&&0<=this._faceIndex}get meshIndex(){return this._meshIndex}get faceIndex(){return this._faceIndex}get weights(){return this._weights}focus(){return Q(this,void 0,void 0,function*(){if(!this._focusing){var e=this._view3D;const{camera:s,control:i}=e;var t=this._getFocus();const r=this._getFocusPivot();t=new L(t.x,t.y,t.z,r.toArray());const n=new Fe(e,s.currentPose,t,{duration:this._focusDuration,disableOnFinish:!1});(this._trackingControl=n).enable(),i.add(n),this._onFocus()}})}unfocus(){this._focusing&&(this.destroyTrackingControl(),this._onUnfocus())}render(e){super.render(e);const t=this._trackingControl;if(t){var e=this._view3D["camera"],s=this._getFocus();const i=this._getFocusPivot();s=new L(s.x,s.y,s.z,i.toArray());t.changeStartEnd(e.currentPose,s),t.reset()}}handleUserInput(){this._focusing&&(this._view3D.annotationAutoUnfocus?this.unfocus():this.destroyTrackingControl())}toJSON(){return{meshIndex:this._meshIndex,faceIndex:this._faceIndex,focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}destroyTrackingControl(){const e=this._view3D["control"],t=this._trackingControl;t&&(e.sync(),e.remove(t),t.destroy(),this._trackingControl=null)}_getPosition(){var e=this._view3D.model,t=this._meshIndex,s=this._faceIndex,i=this._weights,e=re(e,t,s);return e?(new O.Vector3).addScaledVector(e[0],i[0]).addScaledVector(e[1],i[1]).addScaledVector(e[2],i[2]):new O.Vector3}_getFocusPivot(){var e=this._getPosition(),t=this._getPivotOffset();return(new O.Vector3).addVectors(e,t)}}class pt{constructor(e){this._onInput=()=>{const e=this._list;e.forEach(e=>{e.handleUserInput()})},this._view3D=e,this._list=[],this._wrapper=F(e.annotationWrapper,e.rootEl)||this._createWrapper()}get list(){return this._list}get wrapper(){return this._wrapper}init(){const e=this._view3D;e.control.controls.forEach(e=>{e.on({[T.HOLD]:this._onInput})})}destroy(){this._view3D.control.controls.forEach(e=>{e.off({[T.HOLD]:this._onInput})}),this.reset()}resize(){this._list.forEach(e=>{e.resize()})}collect(){const o=this._view3D,e=this._wrapper,t=[].slice.apply(e.querySelectorAll(o.annotationSelector));var s=t.map(e=>{const t=e.dataset.focus;var s,i={element:e,focus:t?t.split(" ").map(e=>parseFloat(e)):[],focusDuration:e.dataset.duration?parseFloat(e.dataset.duration):void 0};if(e.dataset.meshIndex)return r=parseFloat(e.dataset.meshIndex),s=e.dataset.faceIndex?parseFloat(e.dataset.faceIndex):void 0,new _t(o,Object.assign(Object.assign({},i),{meshIndex:r,faceIndex:s}));{const n=e.dataset.position;var r=n?n.split(" ").map(e=>parseFloat(e)):[];return new ut(o,Object.assign(Object.assign({},i),{position:r}))}});this.add(...s)}load(e){const i=new O.FileLoader;return new Promise((t,s)=>{i.load(e,e=>{e=JSON.parse(e),e=this.parse(e);this.add(...e),t(e)},void 0,e=>{s(e)})})}parse(e){const n=this._view3D,{baseFov:o,baseDistance:a,items:t}=e;return t.map(e=>{var{meshIndex:t,faceIndex:s,position:i}=e,r=le(e,["meshIndex","faceIndex","position"]),e=this._createDefaultAnnotationElement(e.label);return null!=t&&null!=s?new _t(n,Object.assign(Object.assign({meshIndex:t,faceIndex:s},r),{baseFov:o,baseDistance:a,element:e})):new ut(n,Object.assign(Object.assign({position:i},r),{baseFov:o,baseDistance:a,element:e}))})}render(e,t){var s=this._view3D,i=s.model;if(i){const l=null!=t?t:s.renderer.canvasSize,h=l.clone().multiplyScalar(.5),c=null!=e?e:s.camera.threeCamera,r=c.position,d=i.center,u=s.annotationBreakpoints,n=[...this._list].filter(e=>e.renderable).map(e=>{var t=e.position;return{annotation:e,position:t,distToCameraSquared:r.distanceToSquared(t)}}).sort((e,t)=>t.distToCameraSquared-e.distToCameraSquared),_=(new O.Vector3).subVectors(r,d).normalize(),p=Object.keys(u).map(e=>parseFloat(e)).sort((e,t)=>t-e);n.forEach(({annotation:e,position:t},s)=>{if(e.element){var i=t.clone().project(c);const n=new O.Vector2(i.x,-i.y),o=(new O.Vector3).subVectors(t,d).normalize();var r=m(Math.abs(Math.acos(o.dot(_))));n.multiply(h),n.add(h);for(const a of p)if(r>=a){e.setOpacity(u[a]);break}e.render({position:t,renderOrder:s,screenPos:n,screenSize:l})}})}}add(...e){const t=this._wrapper;e.forEach(e=>{e.enableEvents(),e.element&&e.element.parentElement!==t&&t.appendChild(e.element)}),this._list.push(...e)}remove(e){const t=this._list.splice(e,1)[0];return t?(t.destroy(),t):null}reset(){const e=this._list,t=e.splice(0,e.length);t.forEach(e=>{e.destroy()})}toJSON(){var e=this._view3D;const t=this._list;var s=t.map(e=>{return Object.assign(Object.assign({},e.toJSON()),{label:(null==(e=null==(e=e.element)?void 0:e.querySelector("."+J.ANNOTATION_TOOLTIP))?void 0:e.innerHTML)||null})}),i=e.renderer.size,i=Math.max(i.height/i.width,1);return{baseFov:e.camera.baseFov,baseDistance:e.camera.baseDistance,aspect:i,items:s}}_createWrapper(){const e=this._view3D,t=document.createElement(f);return t.classList.add(J.ANNOTATION_WRAPPER),e.rootEl.appendChild(t),t}_createDefaultAnnotationElement(e){const t=document.createElement(f);if(t.classList.add(J.ANNOTATION),t.classList.add(J.ANNOTATION_DEFAULT),e){const s=document.createElement(f);s.classList.add(J.ANNOTATION_TOOLTIP),s.classList.add(J.ANNOTATION_DEFAULT),s.innerHTML=e,t.appendChild(s)}return t}}class mt extends s{constructor(e,{duration:t=300,easing:s=S,scale:i=1,disablePitch:r=!1,disableYaw:n=!1}={}){super(),this._screenScale=new O.Vector2(0,0),this._prevPos=new O.Vector2(0,0),this._isFirstTouch=!1,this._scrolling=!1,this._enabled=!1,this._onMouseDown=e=>{if(e.button===ne.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(p.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.HOLD,{inputType:g.ROTATE})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,s=new O.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);s.multiply(this._screenScale),this._xMotion.setEndDelta(s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.ROTATE})},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY),this.trigger(T.HOLD,{inputType:g.ROTATE})},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],s=this._view3D.scrollable;if(this._isFirstTouch){if(s){s=new O.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(s.y)>Math.abs(s.x))return void(this._scrolling=!0)}this._isFirstTouch=!1}!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._prevPos,r=new O.Vector2(t.clientX,t.clientY).sub(i).multiplyScalar(this._scale);r.multiply(this._screenScale),this._xMotion.setEndDelta(r.x),this._yMotion.setEndDelta(r.y),i.set(t.clientX,t.clientY)}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):(this._prevPos.set(0,0),this.trigger(T.RELEASE,{inputType:g.ROTATE})),this._scrolling=!1},this._view3D=e,this._scale=i,this._duration=t,this._easing=s,this._disablePitch=r,this._disableYaw=n,this._xMotion=new A({duration:t,range:Ie,easing:s}),this._yMotion=new A({duration:t,range:De,easing:s})}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._isFirstTouch=!1,this._scrolling=!1}update(e){var t=this._view3D.camera;const s=this._xMotion,i=this._yMotion,r=t.newPose;var t=!this._disableYaw,n=!this._disablePitch,e=new O.Vector2(s.update(e),i.update(e));t&&(r.yaw+=e.x),n&&(r.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(p.MOUSE_DOWN,this._onMouseDown),e.addEventListener(p.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(p.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(p.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ROTATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(p.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(p.TOUCH_START,this._onTouchStart),e.removeEventListener(p.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(p.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ROTATE})}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class vt extends s{constructor(e,{easing:t=S,duration:s=0,scale:i=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new O.Vector2(0,0),this._screenSize=new O.Vector2(0,0),this._onMouseDown=e=>{if(e.button===ne.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(p.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(p.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(T.HOLD,{inputType:g.TRANSLATE})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var s=new O.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.TRANSLATE})},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0,this.trigger(T.HOLD,{inputType:g.TRANSLATE}))},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._prevPos;e=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return s.copy(e),void(this._touchInitialized=!0);var t=(new O.Vector2).subVectors(e,s).multiplyScalar(this._scale);this._xMotion.setEndDelta(-t.x),this._yMotion.setEndDelta(t.y),s.copy(e)}},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized&&(this._touchInitialized=!1,this.trigger(T.RELEASE,{inputType:g.TRANSLATE})):(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(p.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new A({duration:s,range:Ie,easing:t}),this._yMotion=new A({duration:s,range:Ie,easing:t}),this._scale=i}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._touchInitialized=!1}update(e){var t=this._view3D.camera;const s=t.newPose;var i=this._screenSize;const r=new O.Vector2(this._xMotion.update(e),this._yMotion.update(e)),n=new O.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),o=new O.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);e=new O.Vector2(t.renderWidth,t.renderHeight).divide(i);r.multiply(e);const a=s.pivot.clone();s.pivot=a.add(n.multiplyScalar(r.x)).add(o.multiplyScalar(r.y))}resize(e){const t=this._screenSize;t.copy(new O.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(p.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(p.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(p.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(p.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.TRANSLATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(p.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(p.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(p.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(p.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(p.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.TRANSLATE})}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new O.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class gt extends s{constructor(e,{type:t=_e.FOV,scale:s=1,duration:i=300,minFov:r=1,maxFov:n=$,minDistance:o=.1,maxDistance:a=2,doubleTap:l=!0,easing:h=S}={}){super(),this._scaleModifier=1,this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._isFirstTouch=!0,this._isWheelScrolling=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const s=this._motion;t=-this._scale*this._scaleModifier*this._wheelModifier*e.deltaY;this._isWheelScrolling||this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isWheelScrolling=!0,s.setEndDelta(t)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._motion;e=this._prevTouchDistance;const i=new O.Vector2(t[0].pageX,t[0].pageY);t=new O.Vector2(t[1].pageX,t[1].pageY);const r=i.sub(t);t=r.length()*this._scale*this._scaleModifier*this._touchModifier,e=this._isFirstTouch?0:t-e;this._prevTouchDistance=t,this._isFirstTouch&&this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isFirstTouch=!1,s.setEndDelta(e)}},this._onTouchEnd=e=>{0===e.touches.length&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._prevTouchDistance=-1,this._isFirstTouch=!0)},this._onDoubleClick=e=>{const t=this._view3D;if(this._doubleTap&&t.model){var{zoomIn:s=.8,duration:i=300,easing:r=S,useZoomOut:n=!0}=Z(this._doubleTap),s=-this._motion.range.min*s;if(t.camera.zoom>=s&&n){const l=t.camera.currentPose.clone();return l.zoom=0,void t.camera.reset(i,r,l)}const o=new O.Raycaster,a=new O.Vector2;n=t.renderer.canvasSize,e=(a.x=e.offsetX/n.x*2-1,a.y=2*-(e.offsetY/n.y)+1,o.setFromCamera(a,t.camera.threeCamera),o.intersectObject(t.model.scene));if(e.length){const h=e[0].point;var{yaw:n,pitch:e}=t.camera;const l=new L(n,e,s,h.toArray());t.camera.reset(i,r,l)}}},this._view3D=e,this._type=t,this._scale=s,this._duration=i,this._minFov=r,this._maxFov=n,this._minDistance=o,this._maxDistance=a,this._doubleTap=l,this._easing=h,this._motion=new A({duration:i,easing:h,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get animating(){return this._motion.activated}get range(){return this._motion.range}get type(){return this._type}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}get doubleTap(){return this._doubleTap}get easing(){return this._easing}set type(e){this._type=e}set scale(e){this._scale=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._prevTouchDistance=-1,this._isFirstTouch=!0,this._isWheelScrolling=!1}update(e){const t=this._view3D.camera.newPose,s=this._motion;var i=s.progress,e=s.update(e),r=s.progress;t.zoom-=e,this._isWheelScrolling&&i<1&&1<=r&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._isWheelScrolling=!1)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(p.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(p.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(p.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(p.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ZOOM})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(p.WHEEL,this._onWheel,!1),e.removeEventListener(p.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(p.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(p.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ZOOM})}}sync(){var e=this._view3D.camera;const t=this._motion;t.reset(-e.zoom),this._type===_e.FOV?this._scaleModifier=-1:this._scaleModifier=-e.baseDistance/44}updateRange(){const e=this._motion.range;var t,s,i=this._view3D["camera"];this._type===_e.FOV?(t=i.baseFov,s=this._maxFov,e.max=s===$?Math.min(t+45,175)-t:s-t,e.min=this._minFov-t):(e.max=i.baseDistance*this._maxDistance-i.baseDistance,e.min=i.baseDistance*this._minDistance-i.baseDistance)}}class ft{constructor(e){this._onEnable=({inputType:e})=>{var t;e!==g.ZOOM&&(t=(e=this._view3D).renderer.canvas,e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===i.NONE&&this._setCursor(i.GRAB))},this._onDisable=({inputType:e})=>{e===g.ZOOM||this._view3D.renderer.canvas.style.cursor===i.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(i.NONE)},this._onHold=({inputType:e})=>{const t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRABBING),t.trigger(E.INPUT_START,{type:E.INPUT_START,target:t,inputType:e})},this._onRelease=({inputType:e})=>{const t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRAB),t.trigger(E.INPUT_END,{type:E.INPUT_END,target:t,inputType:e})},this._view3D=e,this._rotateControl=new mt(e,Z(e.rotate)),this._translateControl=new vt(e,Z(e.translate)),this._zoomControl=new gt(e,Z(e.zoom)),this._extraControls=[],[this._rotateControl,this._translateControl,this._zoomControl].forEach(e=>{e.on({[T.HOLD]:this._onHold,[T.RELEASE]:this._onRelease,[T.ENABLE]:this._onEnable,[T.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}get controls(){return[this._rotateControl,this._translateControl,this._zoomControl]}get extraControls(){return this._extraControls}get animating(){return this._rotateControl.animating||this._translateControl.animating||this._zoomControl.animating||this._extraControls.some(e=>e.animating)}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy(),this._extraControls.forEach(e=>e.destroy()),this._extraControls=[]}update(t){this._rotateControl.update(t),this._translateControl.update(t),this._zoomControl.update(t),this._extraControls.forEach(e=>e.update(t))}resize(t){this._rotateControl.resize(t),this._translateControl.resize(t),this._zoomControl.resize(t),this._extraControls.forEach(e=>e.resize(t))}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable(),this._extraControls.forEach(e=>e.enable())}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable(),this._extraControls.forEach(e=>e.disable())}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync(),this._extraControls.forEach(e=>e.sync())}add(e){this._extraControls.push(e)}remove(t){const e=this._extraControls;var s=e.findIndex(e=>e===t);0<=s&&e.splice(s,1)}updateCursor(){var e=this._view3D.useGrabCursor?i.GRAB:i.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===i.NONE){const s=t.renderer.canvas;s.style.cursor=e}}}class Et{constructor(e,{delay:t=2e3,delayOnMouseLeave:s=0,speed:i=1,pauseOnHover:r=!1,canInterrupt:n=!0,disableOnInterrupt:o=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==ne.LEFT&&e.button!==ne.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(p.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=s,this._speed=i,this._pauseOnHover=r,this._canInterrupt=n,this._disableOnInterrupt=o}get enabled(){return this._enabled}get animating(){return this._enabled&&!this._interrupted}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera.newPose;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(p.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(p.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(p.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(p.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(p.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(p.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}enableAfterDelay(){this.enable(),this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay)}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(p.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(p.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(p.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(p.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(p.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(p.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Tt extends O.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new St(e)}),this.register(function(e){return new Ct(e)}),this.register(function(e){return new Mt(e)}),this.register(function(e){return new At(e)}),this.register(function(e){return new Lt(e)}),this.register(function(e){return new Rt(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new Ot(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new It(e)})}load(t,s,e,i){const r=this;let n;n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:O.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);function o(e){i?i(e):console.error(e),r.manager.itemError(t),r.manager.itemEnd(t)}const a=new O.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,function(e){try{r.parse(e,n,function(e){s(e),r.manager.itemEnd(t)},o)}catch(e){o(e)}},e,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const n={},o={};if("string"==typeof e)r=e;else if(O.LoaderUtils.decodeText(new Uint8Array(e,0,4))===Dt){try{n[x.KHR_BINARY_GLTF]=new Nt(e)}catch(e){return void(i&&i(e))}r=n[x.KHR_BINARY_GLTF].content}else r=O.LoaderUtils.decodeText(new Uint8Array(e));var a=JSON.parse(r);if(void 0===a.asset||a.asset.version[0]<2)i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{const c=new ts(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){var l=this.pluginCallbacks[e](c);o[l.name]=l,n[l.name]=!0}if(a.extensionsUsed)for(let e=0;e<a.extensionsUsed.length;++e){var h=a.extensionsUsed[e];const d=a.extensionsRequired||[];switch(h){case x.KHR_MATERIALS_UNLIT:n[h]=new yt;break;case x.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:n[h]=new kt;break;case x.KHR_DRACO_MESH_COMPRESSION:n[h]=new Ft(a,this.dracoLoader);break;case x.KHR_TEXTURE_TRANSFORM:n[h]=new Ut;break;case x.KHR_MESH_QUANTIZATION:n[h]=new Ht;break;default:0<=d.indexOf(h)&&void 0===o[h]&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(n),c.setPlugins(o),c.parse(s,i)}}}function wt(){let s={};return{get:function(e){return s[e]},add:function(e,t){s[e]=t},remove:function(e){delete s[e]},removeAll:function(){s={}}}}const x={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class bt{constructor(e){this.parser=e,this.name=x.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const s=this.parser;var i=this.parser.json.nodes||[];for(let e=0,t=i.length;e<t;e++){var r=i[e];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&s._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser;var s="light:"+e;let i=t.cache.get(s);if(i)return i;var r=t.json;const n=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let o;const a=new O.Color(16777215);void 0!==n.color&&a.fromArray(n.color);var l=void 0!==n.range?n.range:0;switch(n.type){case"directional":(o=new O.DirectionalLight(a)).target.position.set(0,0,-1),o.add(o.target);break;case"point":(o=new O.PointLight(a)).distance=l;break;case"spot":(o=new O.SpotLight(a)).distance=l,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,o.angle=n.spot.outerConeAngle,o.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+n.type)}return o.position.set(0,0,0),o.decay=2,void 0!==n.intensity&&(o.intensity=n.intensity),o.name=t.createUniqueName(n.name||"light_"+e),i=Promise.resolve(o),t.cache.add(s,i),i}createNodeAttachment(e){const t=this,s=this.parser;e=s.json.nodes[e];const i=(e.extensions&&e.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return s._getNodeRef(t.cache,i,e)})}}class yt{constructor(){this.name=x.KHR_MATERIALS_UNLIT}getMaterialType(){return O.MeshBasicMaterial}extendParams(e,t,s){const i=[];e.color=new O.Color(1,1,1),e.opacity=1;var r,t=t.pbrMetallicRoughness;return t&&(Array.isArray(t.baseColorFactor)&&(r=t.baseColorFactor,e.color.fromArray(r),e.opacity=r[3]),void 0!==t.baseColorTexture&&i.push(s.assignTexture(e,"map",t.baseColorTexture))),Promise.all(i)}}class St{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser;e=s.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();const i=[];var e=e.extensions[this.name];return void 0!==e.clearcoatFactor&&(t.clearcoat=e.clearcoatFactor),void 0!==e.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",e.clearcoatTexture)),void 0!==e.clearcoatRoughnessFactor&&(t.clearcoatRoughness=e.clearcoatRoughnessFactor),void 0!==e.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",e.clearcoatRoughnessTexture)),void 0!==e.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",e.clearcoatNormalTexture)),void 0!==e.clearcoatNormalTexture.scale&&(e=e.clearcoatNormalTexture.scale,t.clearcoatNormalScale=new O.Vector2(e,e))),Promise.all(i)}}class At{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_SHEEN}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser;e=s.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new O.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;e=e.extensions[this.name];return void 0!==e.sheenColorFactor&&t.sheenColor.fromArray(e.sheenColorFactor),void 0!==e.sheenRoughnessFactor&&(t.sheenRoughness=e.sheenRoughnessFactor),void 0!==e.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",e.sheenColorTexture)),void 0!==e.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",e.sheenRoughnessTexture)),Promise.all(i)}}class Lt{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser;e=s.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();const i=[];e=e.extensions[this.name];return void 0!==e.transmissionFactor&&(t.transmission=e.transmissionFactor),void 0!==e.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",e.transmissionTexture)),Promise.all(i)}}class Rt{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_VOLUME}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser;e=s.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();const i=[];e=e.extensions[this.name],t.thickness=void 0!==e.thicknessFactor?e.thicknessFactor:0,void 0!==e.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",e.thicknessTexture)),t.attenuationDistance=e.attenuationDistance||0,e=e.attenuationColor||[1,1,1];return t.attenuationColor=new O.Color(e[0],e[1],e[2]),Promise.all(i)}}class xt{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_IOR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){e=this.parser.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();e=e.extensions[this.name];return t.ior=void 0!==e.ior?e.ior:1.5,Promise.resolve()}}class Ot{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_SPECULAR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser;e=s.json.materials[e];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();const i=[];var e=e.extensions[this.name],r=(t.specularIntensity=void 0!==e.specularFactor?e.specularFactor:1,void 0!==e.specularTexture&&i.push(s.assignTexture(t,"specularIntensityMap",e.specularTexture)),e.specularColorFactor||[1,1,1]);return t.specularColor=new O.Color(r[0],r[1],r[2]),void 0!==e.specularColorTexture&&i.push(s.assignTexture(t,"specularColorMap",e.specularColorTexture).then(function(e){e.encoding=O.sRGBEncoding})),Promise.all(i)}}class Ct{constructor(e){this.parser=e,this.name=x.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json;var i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;var i=i.extensions[this.name],i=s.images[i.source],r=t.options.ktx2Loader;if(r)return t.loadTextureImage(e,i,r);if(s.extensionsRequired&&0<=s.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}}class Mt{constructor(e){this.parser=e,this.name=x.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const s=this.name,i=this.parser,r=i.json;var e=r.textures[t];if(!e.extensions||!e.extensions[s])return null;var e=e.extensions[s];const n=r.images[e.source];let o=i.textureLoader;return n.uri&&null!==(e=i.options.manager.getHandler(n.uri))&&(o=e),this.detectSupport().then(function(e){if(e)return i.loadTextureImage(t,n,o);if(r.extensionsRequired&&0<=r.extensionsRequired.indexOf(s))throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class It{constructor(e){this.name=x.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json;e=t.bufferViews[e];if(e.extensions&&e.extensions[this.name]){const o=e.extensions[this.name];e=this.parser.getDependency("buffer",o.buffer);const a=this.parser.options.meshoptDecoder;if(a&&a.supported)return Promise.all([e,a.ready]).then(function(e){var t=o.byteOffset||0,s=o.byteLength||0,i=o.count,r=o.byteStride,n=new ArrayBuffer(i*r),e=new Uint8Array(e[0],t,s);return a.decodeGltfBuffer(new Uint8Array(n),i,r,e,o.mode,o.filter),n});if(t.extensionsRequired&&0<=t.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return null}}const Dt="glTF",Pt={JSON:1313821514,BIN:5130562};class Nt{constructor(e){this.name=x.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:O.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Dt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");var s=this.header.length-12;const i=new DataView(e,12);let r=0;for(;r<s;){var n,o=i.getUint32(r,!0),a=(r+=4,i.getUint32(r,!0));r+=4,a===Pt.JSON?(n=new Uint8Array(e,12+r,o),this.content=O.LoaderUtils.decodeText(n)):a===Pt.BIN&&(n=12+r,this.body=e.slice(n,n+o)),r+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ft{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=x.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){var s=this.json;const i=this.dracoLoader;var r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes;const o={},a={},l={};for(const _ in n){var h=qt[_]||_.toLowerCase();o[h]=n[_]}for(const p in e.attributes){var c,d,u=qt[p]||p.toLowerCase();void 0!==n[p]&&(c=s.accessors[e.attributes[p]],d=Wt[c.componentType],l[u]=d,a[u]=!0===c.normalized)}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(r){i.decodeDracoFile(e,function(e){for(const s in e.attributes){const i=e.attributes[s];var t=a[s];void 0!==t&&(i.normalized=t)}r(e)},o,l)})})}}class Ut{constructor(){this.name=x.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Bt extends O.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),r=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new O.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",r).replace("#include <metalnessmap_fragment>",n).replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){(a.specularMap.value=e)?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){(a.glossinessMap.value=e)?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class kt{constructor(){this.name=x.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Bt}extendParams(e,t,s){var i,t=t.extensions[this.name];e.color=new O.Color(1,1,1),e.opacity=1;const r=[];return Array.isArray(t.diffuseFactor)&&(i=t.diffuseFactor,e.color.fromArray(i),e.opacity=i[3]),void 0!==t.diffuseTexture&&r.push(s.assignTexture(e,"map",t.diffuseTexture)),e.emissive=new O.Color(0,0,0),e.glossiness=void 0!==t.glossinessFactor?t.glossinessFactor:1,e.specular=new O.Color(1,1,1),Array.isArray(t.specularFactor)&&e.specular.fromArray(t.specularFactor),void 0!==t.specularGlossinessTexture&&(i=t.specularGlossinessTexture,r.push(s.assignTexture(e,"glossinessMap",i)),r.push(s.assignTexture(e,"specularMap",i))),Promise.all(r)}createMaterial(e){const t=new Bt(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=O.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class Ht{constructor(){this.name=x.KHR_MESH_QUANTIZATION}}class Gt extends O.Interpolant{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=s[r+e];return t}}Gt.prototype.beforeStart_=Gt.prototype.copySampleValue_,Gt.prototype.afterEnd_=Gt.prototype.copySampleValue_,Gt.prototype.interpolate_=function(e,t,s,i){const r=this.resultBuffer;var n=this.sampleValues,o=this.valueSize,a=2*o,l=3*o,h=i-t,i=(s-t)/h,s=i*i,t=s*i,c=e*l,d=c-l,u=-2*t+3*s,_=t-s,p=1-u,m=_-s+i;for(let e=0;e!==o;e++){var v=n[d+e+o],g=n[d+e+a]*h,f=n[c+e+o],E=n[c+e]*h;r[e]=p*v+m*g+u*f+_*E}return r};const Vt=new O.Quaternion;class zt extends Gt{interpolate_(e,t,s,i){e=super.interpolate_(e,t,s,i);return Vt.fromArray(e).normalize().toArray(e),e}}const C={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Wt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},jt={9728:O.NearestFilter,9729:O.LinearFilter,9984:O.NearestMipmapNearestFilter,9985:O.LinearMipmapNearestFilter,9986:O.NearestMipmapLinearFilter,9987:O.LinearMipmapLinearFilter},Kt={33071:O.ClampToEdgeWrapping,33648:O.MirroredRepeatWrapping,10497:O.RepeatWrapping},Xt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},M={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Yt={CUBICSPLINE:void 0,LINEAR:O.InterpolateLinear,STEP:O.InterpolateDiscrete},Zt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Qt(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function $t(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Jt(s){let i="";var r=Object.keys(s).sort();for(let e=0,t=r.length;e<t;e++)i+=r[e]+":"+s[r[e]]+";";return i}function es(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class ts{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new wt,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new O.ImageBitmapLoader(this.options.manager):this.textureLoader=new O.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new O.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(s,e){const i=this,r=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(e){const t={scene:e[0][r.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:r.asset,parser:i,userData:{}};Qt(n,t,r),$t(t,r),Promise.all(i._invokeAll(function(e){return e.afterRoot&&e.afterRoot(t)})).then(function(){s(t)})}).catch(e)}_markDefs(){const s=this.json.nodes||[];var i=this.json.skins||[];const r=this.json.meshes||[];for(let e=0,t=i.length;e<t;e++){var n=i[e].joints;for(let e=0,t=n.length;e<t;e++)s[n[e]].isBone=!0}for(let e=0,t=s.length;e<t;e++){var o=s[e];void 0!==o.mesh&&(this._addNodeRef(this.meshCache,o.mesh),void 0!==o.skin&&(r[o.mesh].isSkinnedMesh=!0)),void 0!==o.camera&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(e,t)=>{var s,i,r=this.associations.get(e);null!=r&&this.associations.set(t,r);for([s,i]of e.children.entries())n(i,t.children[s])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(t){const s=Object.values(this.plugins);s.push(this);for(let e=0;e<s.length;e++){var i=t(s[e]);if(i)return i}return null}_invokeAll(t){const s=Object.values(this.plugins),i=(s.unshift(this),[]);for(let e=0;e<s.length;e++){var r=t(s[e]);r&&i.push(r)}return i}getDependency(e,t){var s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this.loadNode(t);break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this.loadAnimation(t);break;case"camera":i=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(s){let e=this.cache.get(s);if(!e){const i=this,t=this.json[s+("mesh"===s?"es":"s")]||[];e=Promise.all(t.map(function(e,t){return i.getDependency(s,t)})),this.cache.add(s,e)}return e}loadBuffer(e){const s=this.json.buffers[e],i=this.fileLoader;if(s.type&&"arraybuffer"!==s.type)throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");if(void 0===s.uri&&0===e)return Promise.resolve(this.extensions[x.KHR_BINARY_GLTF].body);const r=this.options;return new Promise(function(e,t){i.load(O.LoaderUtils.resolveURL(s.uri,r.path),e,void 0,function(){t(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))})})}loadBufferView(e){const i=this.json.bufferViews[e];return this.getDependency("buffer",i.buffer).then(function(e){var t=i.byteLength||0,s=i.byteOffset||0;return e.slice(s,s+t)})}loadAccessor(e){const v=this,g=this.json,f=this.json.accessors[e];if(void 0===f.bufferView&&void 0===f.sparse)return Promise.resolve(null);const t=[];return void 0!==f.bufferView?t.push(this.getDependency("bufferView",f.bufferView)):t.push(null),void 0!==f.sparse&&(t.push(this.getDependency("bufferView",f.sparse.indices.bufferView)),t.push(this.getDependency("bufferView",f.sparse.values.bufferView))),Promise.all(t).then(function(e){var t=e[0],s=Xt[f.type];const i=Wt[f.componentType];var r=i.BYTES_PER_ELEMENT,n=r*s,o=f.byteOffset||0,a=void 0!==f.bufferView?g.bufferViews[f.bufferView].byteStride:void 0,l=!0===f.normalized;let h,c;if(a&&a!==n){var n=Math.floor(o/a),d="InterleavedBuffer:"+f.bufferView+":"+f.componentType+":"+n+":"+f.count;let e=v.cache.get(d);e||(h=new i(t,n*a,f.count*a/r),e=new O.InterleavedBuffer(h,a/r),v.cache.add(d,e)),c=new O.InterleavedBufferAttribute(e,s,o%a/r,l)}else h=null===t?new i(f.count*s):new i(t,o,f.count*s),c=new O.BufferAttribute(h,s,l);if(void 0!==f.sparse){n=Xt.SCALAR;const m=Wt[f.sparse.indices.componentType];var d=f.sparse.indices.byteOffset||0,a=f.sparse.values.byteOffset||0,u=new m(e[1],d,f.sparse.count*n),_=new i(e[2],a,f.sparse.count*s);null!==t&&(c=new O.BufferAttribute(c.array.slice(),c.itemSize,c.normalized));for(let e=0,t=u.length;e<t;e++){var p=u[e];if(c.setX(p,_[e*s]),2<=s&&c.setY(p,_[e*s+1]),3<=s&&c.setZ(p,_[e*s+2]),4<=s&&c.setW(p,_[e*s+3]),5<=s)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return c})}loadTexture(e){var t=this.json;const s=this.options;var i=t.textures[e],t=t.images[i.source];let r=this.textureLoader;return t.uri&&null!==(i=s.manager.getHandler(t.uri))&&(r=i),this.loadTextureImage(e,t,r)}loadTextureImage(s,t,r){const i=this,n=this.json,o=this.options,a=n.textures[s];var e=(t.uri||t.bufferView)+":"+a.sampler;if(this.textureCache[e])return this.textureCache[e];const l=self.URL||self.webkitURL;let h=t.uri||"",c=!1;if(void 0!==t.bufferView)h=i.getDependency("bufferView",t.bufferView).then(function(e){c=!0;e=new Blob([e],{type:t.mimeType});return h=l.createObjectURL(e)});else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+s+" is missing URI and bufferView");var d=Promise.resolve(h).then(function(i){return new Promise(function(s,e){let t=s;!0===r.isImageBitmapLoader&&(t=function(e){const t=new O.Texture(e);t.needsUpdate=!0,s(t)}),r.load(O.LoaderUtils.resolveURL(i,o.path),t,void 0,e)})}).then(function(e){!0===c&&l.revokeObjectURL(h),e.flipY=!1,a.name&&(e.name=a.name);var t=(n.samplers||{})[a.sampler]||{};return e.magFilter=jt[t.magFilter]||O.LinearFilter,e.minFilter=jt[t.minFilter]||O.LinearMipmapLinearFilter,e.wrapS=Kt[t.wrapS]||O.RepeatWrapping,e.wrapT=Kt[t.wrapT]||O.RepeatWrapping,i.associations.set(e,{textures:s}),e}).catch(function(){return console.error("THREE.GLTFLoader: Couldn't load texture",h),null});return this.textureCache[e]=d}assignTexture(i,r,n){const o=this;return this.getDependency("texture",n.index).then(function(e){var t,s;return void 0===n.texCoord||0==n.texCoord||"aoMap"===r&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+r+" not yet supported."),o.extensions[x.KHR_TEXTURE_TRANSFORM]&&(t=void 0!==n.extensions?n.extensions[x.KHR_TEXTURE_TRANSFORM]:void 0)&&(s=o.associations.get(e),e=o.extensions[x.KHR_TEXTURE_TRANSFORM].extendTexture(e,t),o.associations.set(e,s)),i[r]=e})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;var i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){var o="PointsMaterial:"+s.uuid;let e=this.cache.get(o);e||(e=new O.PointsMaterial,O.Material.prototype.copy.call(e,s),e.color.copy(s.color),e.map=s.map,e.sizeAttenuation=!1,this.cache.add(o,e)),s=e}else if(e.isLine){o="LineBasicMaterial:"+s.uuid;let e=this.cache.get(o);e||(e=new O.LineBasicMaterial,O.Material.prototype.copy.call(e,s),e.color.copy(s.color),this.cache.add(o,e)),s=e}if(i||r||n){let e="ClonedMaterial:"+s.uuid+":",t=(s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:"),this.cache.get(e));t||(t=s.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=s}getMaterialType(){return O.MeshStandardMaterial}loadMaterial(t){const s=this;var e=this.json;const i=this.extensions,r=e.materials[t];let n;const o={};e=r.extensions||{};const a=[];if(e[x.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const h=i[x.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];n=h.getMaterialType(),a.push(h.extendParams(o,r,s))}else if(e[x.KHR_MATERIALS_UNLIT]){const c=i[x.KHR_MATERIALS_UNLIT];n=c.getMaterialType(),a.push(c.extendParams(o,r,s))}else{e=r.pbrMetallicRoughness||{};o.color=new O.Color(1,1,1),o.opacity=1,Array.isArray(e.baseColorFactor)&&(l=e.baseColorFactor,o.color.fromArray(l),o.opacity=l[3]),void 0!==e.baseColorTexture&&a.push(s.assignTexture(o,"map",e.baseColorTexture)),o.metalness=void 0!==e.metallicFactor?e.metallicFactor:1,o.roughness=void 0!==e.roughnessFactor?e.roughnessFactor:1,void 0!==e.metallicRoughnessTexture&&(a.push(s.assignTexture(o,"metalnessMap",e.metallicRoughnessTexture)),a.push(s.assignTexture(o,"roughnessMap",e.metallicRoughnessTexture))),n=this._invokeOne(function(e){return e.getMaterialType&&e.getMaterialType(t)}),a.push(Promise.all(this._invokeAll(function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,o)})))}!0===r.doubleSided&&(o.side=O.DoubleSide);var l=r.alphaMode||Zt.OPAQUE;return l===Zt.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.format=O.RGBFormat,o.transparent=!1,l===Zt.MASK&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&n!==O.MeshBasicMaterial&&(a.push(s.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new O.Vector2(1,1),void 0!==r.normalTexture.scale&&(e=r.normalTexture.scale,o.normalScale.set(e,e))),void 0!==r.occlusionTexture&&n!==O.MeshBasicMaterial&&(a.push(s.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&n!==O.MeshBasicMaterial&&(o.emissive=(new O.Color).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&n!==O.MeshBasicMaterial&&a.push(s.assignTexture(o,"emissiveMap",r.emissiveTexture)),Promise.all(a).then(function(){let e;return e=n===Bt?i[x.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new n(o),r.name&&(e.name=r.name),e.map&&(e.map.encoding=O.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=O.sRGBEncoding),$t(e,r),s.associations.set(e,{materials:t}),r.extensions&&Qt(i,e,r),e})}createUniqueName(e){var t=O.PropertyBinding.sanitizeNodeName(e||"");let s=t;for(let e=1;this.nodeNamesUsed[s];++e)s=t+"_"+e;return this.nodeNamesUsed[s]=!0,s}loadGeometries(s){const i=this,r=this.extensions,n=this.primitiveCache;const o=[];for(let e=0,t=s.length;e<t;e++){var a=s[e],l=function(e){var t=e.extensions&&e.extensions[x.KHR_DRACO_MESH_COMPRESSION];let s;return s=t?"draco:"+t.bufferView+":"+t.indices+":"+Jt(t.attributes):e.indices+":"+Jt(e.attributes)+":"+e.mode}(a),h=n[l];if(h)o.push(h.promise);else{let e;e=a.extensions&&a.extensions[x.KHR_DRACO_MESH_COMPRESSION]?function(t){return r[x.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,i).then(function(e){return ss(e,t,i)})}(a):ss(new O.BufferGeometry,a,i),n[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(u){const _=this;var e=this.json;const p=this.extensions,m=e.meshes[u],v=m.primitives,s=[];for(let e=0,t=v.length;e<t;e++){var i=void 0===v[e].material?(void 0===(i=this.cache).DefaultMaterial&&(i.DefaultMaterial=new O.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:O.FrontSide})),i.DefaultMaterial):this.getDependency("material",v[e].material);s.push(i)}return s.push(_.loadGeometries(v)),Promise.all(s).then(function(e){var s=e.slice(0,e.length-1),i=e[e.length-1];const r=[];for(let t=0,e=i.length;t<e;t++){var n=i[t],o=v[t];let e;var a=s[t];if(o.mode===C.TRIANGLES||o.mode===C.TRIANGLE_STRIP||o.mode===C.TRIANGLE_FAN||void 0===o.mode)!0!==(e=new(!0===m.isSkinnedMesh?O.SkinnedMesh:O.Mesh)(n,a)).isSkinnedMesh||e.geometry.attributes.skinWeight.normalized||e.normalizeSkinWeights(),o.mode===C.TRIANGLE_STRIP?e.geometry=is(e.geometry,O.TriangleStripDrawMode):o.mode===C.TRIANGLE_FAN&&(e.geometry=is(e.geometry,O.TriangleFanDrawMode));else if(o.mode===C.LINES)e=new O.LineSegments(n,a);else if(o.mode===C.LINE_STRIP)e=new O.Line(n,a);else if(o.mode===C.LINE_LOOP)e=new O.LineLoop(n,a);else{if(o.mode!==C.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+o.mode);e=new O.Points(n,a)}if(0<Object.keys(e.geometry.morphAttributes).length){c=h=l=void 0;var l=e,h=m;if(l.updateMorphTargets(),void 0!==h.weights)for(let e=0,t=h.weights.length;e<t;e++)l.morphTargetInfluences[e]=h.weights[e];if(h.extras&&Array.isArray(h.extras.targetNames)){var c=h.extras.targetNames;if(l.morphTargetInfluences.length===c.length){l.morphTargetDictionary={};for(let e=0,t=c.length;e<t;e++)l.morphTargetDictionary[c[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}e.name=_.createUniqueName(m.name||"mesh_"+u),$t(e,m),o.extensions&&Qt(p,e,o),_.assignFinalMaterial(e),r.push(e)}for(let e=0,t=r.length;e<t;e++)_.associations.set(r[e],{meshes:u,primitives:e});if(1===r.length)return r[0];const d=new O.Group;_.associations.set(d,{meshes:u});for(let e=0,t=r.length;e<t;e++)d.add(r[e]);return d})}loadCamera(e){let t;var e=this.json.cameras[e],s=e[e.type];if(s)return"perspective"===e.type?t=new O.PerspectiveCamera(O.MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===e.type&&(t=new O.OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),e.name&&(t.name=this.createUniqueName(e.name)),$t(t,e),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){e=this.json.skins[e];const t={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(t):this.getDependency("accessor",e.inverseBindMatrices).then(function(e){return t.inverseBindMatrices=e,t})}loadAnimation(t){const E=this.json.animations[t],s=[],i=[],r=[],n=[],o=[];for(let e=0,t=E.channels.length;e<t;e++){var a=E.channels[e],l=E.samplers[a.sampler],a=a.target,h=void 0!==a.node?a.node:a.id,c=void 0!==E.parameters?E.parameters[l.input]:l.input,d=void 0!==E.parameters?E.parameters[l.output]:l.output;s.push(this.getDependency("node",h)),i.push(this.getDependency("accessor",c)),r.push(this.getDependency("accessor",d)),n.push(l),o.push(a)}return Promise.all([Promise.all(s),Promise.all(i),Promise.all(r),Promise.all(n),Promise.all(o)]).then(function(e){var s=e[0],i=e[1],r=e[2],n=e[3],o=e[4];const a=[];for(let e=0,t=s.length;e<t;e++){const m=s[e];var l=i[e],h=r[e],c=n[e],d=o[e];if(void 0!==m){m.updateMatrix(),m.matrixAutoUpdate=!0;let s;switch(M[d.path]){case M.weights:s=O.NumberKeyframeTrack;break;case M.rotation:s=O.QuaternionKeyframeTrack;break;case M.position:case M.scale:default:s=O.VectorKeyframeTrack}var u=m.name||m.uuid,_=void 0!==c.interpolation?Yt[c.interpolation]:O.InterpolateLinear;const v=[];M[d.path]===M.weights?m.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&v.push(e.name||e.uuid)}):v.push(u);let i=h.array;if(h.normalized){var p=es(i.constructor);const g=new Float32Array(i.length);for(let e=0,t=i.length;e<t;e++)g[e]=i[e]*p;i=g}for(let e=0,t=v.length;e<t;e++){const f=new s(v[e]+"."+M[d.path],l.array,i,_);"CUBICSPLINE"===c.interpolation&&(f.createInterpolant=function(e){const t=this instanceof O.QuaternionKeyframeTrack?zt:Gt;return new t(this.times,this.values,this.getValueSize()/3,e)},f.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),a.push(f)}}}e=E.name||"animation_"+t;return new O.AnimationClip(e,void 0,a)})}createNodeMesh(e){var t=this.json;const s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(s){if(s.isMesh)for(let e=0,t=i.weights.length;e<t;e++)s.morphTargetInfluences[e]=i.weights[e]}),t})}loadNode(r){var e=this.json;const t=this.extensions,n=this,o=e.nodes[r],a=o.name?n.createUniqueName(o.name):"";return function(){const t=[];var e=n._invokeOne(function(e){return e.createNodeMesh&&e.createNodeMesh(r)});return e&&t.push(e),void 0!==o.camera&&t.push(n.getDependency("camera",o.camera).then(function(e){return n._getNodeRef(n.cameraCache,o.camera,e)})),n._invokeAll(function(e){return e.createNodeAttachment&&e.createNodeAttachment(r)}).forEach(function(e){t.push(e)}),Promise.all(t)}().then(function(s){let i;if((i=!0===o.isBone?new O.Bone:1<s.length?new O.Group:1===s.length?s[0]:new O.Object3D)!==s[0])for(let e=0,t=s.length;e<t;e++)i.add(s[e]);if(o.name&&(i.userData.name=o.name,i.name=a),$t(i,o),o.extensions&&Qt(t,i,o),void 0!==o.matrix){const e=new O.Matrix4;e.fromArray(o.matrix),i.applyMatrix4(e)}else void 0!==o.translation&&i.position.fromArray(o.translation),void 0!==o.rotation&&i.quaternion.fromArray(o.rotation),void 0!==o.scale&&i.scale.fromArray(o.scale);return n.associations.has(i)||n.associations.set(i,{}),n.associations.get(i).nodes=r,i})}loadScene(e){var s=this.json,t=this.extensions,e=this.json.scenes[e];const r=this,i=new O.Group;e.name&&(i.name=r.createUniqueName(e.name)),$t(i,e),e.extensions&&Qt(t,i,e);var n=e.nodes||[];const o=[];for(let e=0,t=n.length;e<t;e++)o.push(function o(e,t,a,l){const h=a.nodes[e];return l.getDependency("node",e).then(function(e){if(void 0===h.skin)return e;let a;return l.getDependency("skin",h.skin).then(function(e){a=e;const s=[];for(let e=0,t=a.joints.length;e<t;e++)s.push(l.getDependency("node",a.joints[e]));return Promise.all(s)}).then(function(o){return e.traverse(function(e){if(e.isMesh){const s=[],i=[];for(let e=0,t=o.length;e<t;e++){const r=o[e];if(r){s.push(r);const n=new O.Matrix4;void 0!==a.inverseBindMatrices&&n.fromArray(a.inverseBindMatrices.array,16*e),i.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',a.joints[e])}e.bind(new O.Skeleton(s,i),e.matrixWorld)}}),e})}).then(function(s){t.add(s);const i=[];if(h.children){const r=h.children;for(let e=0,t=r.length;e<t;e++){const n=r[e];i.push(o(n,s,a,l))}}return Promise.all(i)})}(n[e],i,s,r));return Promise.all(o).then(function(){return r.associations=(e=>{const s=new Map;for(var[t,i]of r.associations)(t instanceof O.Material||t instanceof O.Texture)&&s.set(t,i);return e.traverse(e=>{var t=r.associations.get(e);null!=t&&s.set(e,t)}),s})(i),i})}}function ss(u,e,_){var t=e.attributes;const s=[];for(const v in t){var i=qt[v]||v.toLowerCase();i in u.attributes||s.push(function(e,t){return _.getDependency("accessor",e).then(function(e){u.setAttribute(t,e)})}(t[v],i))}void 0===e.indices||u.index||(r=_.getDependency("accessor",e.indices).then(function(e){u.setIndex(e)}),s.push(r)),$t(u,e);{var r=u,n=e,o=_,a=n.attributes;const g=new O.Box3;if(void 0!==a.POSITION){var a=o.json.accessors[a.POSITION],l=a.min,h=a.max;if(void 0===l||void 0===h)console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");else{g.set(new O.Vector3(l[0],l[1],l[2]),new O.Vector3(h[0],h[1],h[2])),a.normalized&&(l=es(Wt[a.componentType]),g.min.multiplyScalar(l),g.max.multiplyScalar(l));var c=n.targets;if(void 0!==c){const E=new O.Vector3,T=new O.Vector3;for(let e=0,t=c.length;e<t;e++){var d,p,m=c[e];void 0!==m.POSITION&&(p=(m=o.json.accessors[m.POSITION]).min,d=m.max,void 0!==p&&void 0!==d?(T.setX(Math.max(Math.abs(p[0]),Math.abs(d[0]))),T.setY(Math.max(Math.abs(p[1]),Math.abs(d[1]))),T.setZ(Math.max(Math.abs(p[2]),Math.abs(d[2]))),m.normalized&&(p=es(Wt[m.componentType]),T.multiplyScalar(p)),E.max(T)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}g.expandByVector(E)}r.boundingBox=g;const f=new O.Sphere;g.getCenter(f.center),f.radius=g.min.distanceTo(g.max)/2,r.boundingSphere=f}}}return Promise.all(s).then(function(){if(void 0===e.targets)return u;{var r=u,n=e.targets,o=_;let s=!1,i=!1;for(let e=0,t=n.length;e<t;e++){var a=n[e];if(void 0!==a.POSITION&&(s=!0),void 0!==a.NORMAL&&(i=!0),s&&i)break}if(!s&&!i)return Promise.resolve(r);const c=[],d=[];for(let e=0,t=n.length;e<t;e++){var l,h=n[e];s&&(l=void 0!==h.POSITION?o.getDependency("accessor",h.POSITION):r.attributes.position,c.push(l)),i&&(l=void 0!==h.NORMAL?o.getDependency("accessor",h.NORMAL):r.attributes.normal,d.push(l))}return Promise.all([Promise.all(c),Promise.all(d)]).then(function(e){var t=e[0],e=e[1];return s&&(r.morphAttributes.position=t),i&&(r.morphAttributes.normal=e),r.morphTargetsRelative=!0,r})}})}function is(e,t){let s=e.getIndex();if(null===s){const a=[];var i=e.getAttribute("position");if(void 0===i)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)a.push(e);e.setIndex(a),s=e.getIndex()}var r=s.count-2;const n=[];if(t===O.TriangleFanDrawMode)for(let e=1;e<=r;e++)n.push(s.getX(0)),n.push(s.getX(e)),n.push(s.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(n.push(s.getX(e)),n.push(s.getX(e+1)),n.push(s.getX(e+2))):(n.push(s.getX(e+2)),n.push(s.getX(e+1)),n.push(s.getX(e)));n.length/3!=r&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(n),o}const rs=new WeakMap;class ns extends O.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,s,t,i){const r=new O.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,e=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(s).catch(i)},t,i)}decodeDracoFile(e,t,s,i){i={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s};this.decodeGeometry(e,i).then(t)}decodeGeometry(s,i){for(const l in i.attributeTypes){var e=i.attributeTypes[l];void 0!==e.BYTES_PER_ELEMENT&&(i.attributeTypes[l]=e.name)}var t=JSON.stringify(i);if(rs.has(s)){var r=rs.get(s);if(r.key===t)return r.promise;if(0===s.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const o=this.workerNextTaskID++;r=s.byteLength;const a=this._getWorker(o,r).then(e=>(n=e,new Promise((e,t)=>{n._callbacks[o]={resolve:e,reject:t},n.postMessage({type:"decode",id:o,taskConfig:i,buffer:s},[s])}))).then(e=>this._createGeometry(e.geometry));return a.catch(()=>!0).then(()=>{n&&o&&this._releaseTask(n,o)}),rs.set(s,{key:t,promise:a}),a}_createGeometry(t){const s=new O.BufferGeometry;t.index&&s.setIndex(new O.BufferAttribute(t.index.array,1));for(let e=0;e<t.attributes.length;e++){var i=t.attributes[e],r=i.name,n=i.array,i=i.itemSize;s.setAttribute(r,new O.BufferAttribute(n,i))}return s}_loadLibrary(s,e){const i=new O.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise((e,t)=>{i.load(s,e,void 0,t)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const i="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return i?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(e=>{const t=e[0],s=(i||(this.decoderConfig.wasmBinary=e[1]),function(){let s,t;function l(s,i,e,r){var n=r.attributeIDs,o=r.attributeTypes;let a,t;var l,h,c,d,u,_,p,m,v,g,f,E,T,w,b=i.GetEncodedGeometryType(e);if(b===s.TRIANGULAR_MESH)a=new s.Mesh,t=i.DecodeBufferToMesh(e,a);else{if(b!==s.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new s.PointCloud,t=i.DecodeBufferToPointCloud(e,a)}if(!t.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+t.error_msg());const y={index:null,attributes:[]};for(const A in n){var S=self[o[A]];let e,t;if(r.useUniqueIDs)t=n[A],e=i.GetAttributeByUniqueId(a,t);else{if(-1===(t=i.GetAttributeId(a,s[n[A]])))continue;e=i.GetAttribute(a,t)}y.attributes.push((l=s,h=i,c=a,d=A,S=S,u=e,g=v=m=p=_=void 0,_=u.num_components(),p=c.num_points(),m=(p*=_)*S.BYTES_PER_ELEMENT,v=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(l,S),g=l._malloc(m),h.GetAttributeDataArrayForAllPoints(c,u,v,m,g),h=new S(l.HEAPF32.buffer,g,p).slice(),l._free(g),{name:d,array:h,itemSize:_}))}return b===s.TRIANGULAR_MESH&&(y.index=(e=s,b=i,f=a,E=f.num_faces(),T=4*(E*=3),w=e._malloc(T),b.GetTrianglesUInt32Array(f,T,w),b=new Uint32Array(e.HEAPF32.buffer,w,E).slice(),e._free(w),{array:b,itemSize:1})),s.destroy(a),y}onmessage=function(e){const n=e.data;switch(n.type){case"init":s=n.decoderConfig,t=new Promise(function(t){s.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(s)});break;case"decode":const o=n.buffer,a=n.taskConfig;t.then(e=>{const t=e.draco;e=new t.Decoder;const s=new t.DecoderBuffer;s.Init(new Int8Array(o),o.byteLength);try{const i=l(t,e,s,a),r=i.attributes.map(e=>e.array.buffer);i.index&&r.push(i.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:i},r)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{t.destroy(s),t.destroy(e)}})}}}.toString());e=["/* draco decoder */",t,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([e]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(e){var t=e.data;switch(t.type){case"decode":s._callbacks[t.id].resolve(t);break;case"error":s._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}class os{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const s=this.workersResolve[e];if(s&&s(t),this.queue.length){const{resolve:s,msg:t,transfer:i}=this.queue.shift();this.workersResolve[e]=s,this.workers[e].postMessage(t,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(s,i){return new Promise(e=>{var t=this._getIdleWorker();-1!==t?(this._initWorker(t),this.workerStatus|=1<<t,this.workersResolve[t]=e,this.workers[t].postMessage(s,i)):this.queue.push({resolve:e,msg:s,transfer:i})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const as=new WeakMap;let ls=0;class r extends O.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new os,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}init(){if(!this.transcoderPending){const s=new O.FileLoader(this.manager);s.setPath(this.transcoderPath),s.setWithCredentials(this.withCredentials);var e=s.loadAsync("basis_transcoder.js");const i=new O.FileLoader(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);var t=i.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([e,t]).then(([e,t])=>{const s=r.BasisWorker.toString();e=["/* constants */","let _EngineFormat = "+JSON.stringify(r.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(r.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(r.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([e])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{const e=new Worker(this.workerSourceURL);var t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),0<ls&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),ls++}return this.transcoderPending}load(e,s,t,i){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const r=new O.FileLoader(this.manager),n=(r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),new O.CompressedTexture);return r.load(e,e=>{if(as.has(e)){const t=as.get(e);return t.promise.then(s).catch(i)}this._createTexture([e]).then(function(e){n.copy(e),n.needsUpdate=!0,s&&s(n)}).catch(i)},t,i),n}_createTextureFrom(e){var{mipmaps:e,width:t,height:s,format:i,type:r,error:n,dfdTransferFn:o,dfdFlags:a}=e;if("error"===r)return Promise.reject(n);const l=new O.CompressedTexture(e,t,s,i,O.UnsignedByteType);return l.minFilter=1===e.length?O.LinearFilter:O.LinearMipmapLinearFilter,l.magFilter=O.LinearFilter,l.generateMipmaps=!1,l.needsUpdate=!0,l.encoding=2===o?O.sRGBEncoding:O.LinearEncoding,l.premultiplyAlpha=!!(1&a),l}_createTexture(e,t={}){const s=t;t=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffers:e,taskConfig:s},e)).then(e=>this._createTextureFrom(e.data));return as.set(e[0],{promise:t}),t}dispose(){return URL.revokeObjectURL(this.workerSourceURL),this.workerPool.dispose(),ls--,this}}r.BasisFormat={ETC1S:0,UASTC_4x4:1},r.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},r.EngineFormat={RGBAFormat:O.RGBAFormat,RGBA_ASTC_4x4_Format:O.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:O.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:O.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:O.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:O.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:O.RGB_ETC1_Format,RGB_ETC2_Format:O.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:O.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:O.RGB_S3TC_DXT1_Format},r.BasisWorker=function(){let p,s,m;const v=_EngineFormat,g=_TranscoderFormat,f=_BasisFormat;self.addEventListener("message",function(e){const l=e.data;switch(l.type){case"init":p=l.config,t=l.transcoderBinary,s=new Promise(e=>{m={wasmBinary:t,onRuntimeInitialized:e},BASIS(m)}).then(()=>{m.initializeBasis(),void 0===m.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")});break;case"transcode":s.then(()=>{try{var{width:e,height:t,hasAlpha:s,mipmaps:i,format:r,dfdTransferFn:n,dfdFlags:o}=function(e){const t=new m.KTX2File(new Uint8Array(e));function s(){t.close(),t.delete()}if(!t.isValid())throw s(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");var e=t.isUASTC()?f.UASTC_4x4:f.ETC1S,i=t.getWidth(),r=t.getHeight(),n=t.getLevels(),o=t.getHasAlpha(),a=t.getDFDTransferFunc(),l=t.getDFDFlags(),{transcoderFormat:h,engineFormat:e}=function(t,s,i,r){let n,o;var a=t===f.ETC1S?E:T;for(let e=0;e<a.length;e++){const l=a[e];if(p[l.if]&&(l.basisFormat.includes(t)&&(!l.needsPowerOfTwo||w(s)&&w(i))))return n=l.transcoderFormat[r?1:0],o=l.engineFormat[r?1:0],{transcoderFormat:n,engineFormat:o}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),n=g.RGBA32,o=v.RGBAFormat,{transcoderFormat:n,engineFormat:o}}(e,i,r,o);if(!i||!r||!n)throw s(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!t.startTranscoding())throw s(),new Error("THREE.KTX2Loader: .startTranscoding failed");const c=[];for(let e=0;e<n;e++){var d=t.getImageLevelInfo(e,0,0),u=d.origWidth,d=d.origHeight,_=new Uint8Array(t.getImageTranscodedSizeInBytes(e,0,0,h));if(!t.transcodeImage(_,e,0,0,h,0,-1,-1))throw s(),new Error("THREE.KTX2Loader: .transcodeImage failed.");c.push({data:_,width:u,height:d})}return s(),{width:i,height:r,hasAlpha:o,mipmaps:c,format:e,dfdTransferFn:a,dfdFlags:l}}(l.buffers[0]);const a=[];for(let e=0;e<i.length;++e)a.push(i[e].data.buffer);self.postMessage({type:"transcode",id:l.id,width:e,height:t,hasAlpha:s,mipmaps:i,format:r,dfdTransferFn:n,dfdFlags:o},a)}catch(e){console.error(e),self.postMessage({type:"error",id:l.id,error:e.message})}})}var t});const e=[{if:"astcSupported",basisFormat:[f.UASTC_4x4],transcoderFormat:[g.ASTC_4x4,g.ASTC_4x4],engineFormat:[v.RGBA_ASTC_4x4_Format,v.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[f.ETC1S,f.UASTC_4x4],transcoderFormat:[g.BC7_M5,g.BC7_M5],engineFormat:[v.RGBA_BPTC_Format,v.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[f.ETC1S,f.UASTC_4x4],transcoderFormat:[g.BC1,g.BC3],engineFormat:[v.RGB_S3TC_DXT1_Format,v.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[f.ETC1S,f.UASTC_4x4],transcoderFormat:[g.ETC1,g.ETC2],engineFormat:[v.RGB_ETC2_Format,v.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[f.ETC1S,f.UASTC_4x4],transcoderFormat:[g.ETC1,g.ETC1],engineFormat:[v.RGB_ETC1_Format,v.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[f.ETC1S,f.UASTC_4x4],transcoderFormat:[g.PVRTC1_4_RGB,g.PVRTC1_4_RGBA],engineFormat:[v.RGB_PVRTC_4BPPV1_Format,v.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],E=e.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),T=e.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function w(e){return e<=2||0==(e&e-1)&&0!==e}};class hs{constructor({src:e,scenes:t,center:s=$,parser:i=null,animations:r=[],annotations:n=[],variants:o=[],fixSkinnedBbox:a=!1,castShadow:l=!0,receiveShadow:h=!1}){this._src=e;const c=new O.Group,d=(c.add(...t),this._scene=c,this._parser=i,this._animations=r,this._annotations=n,this._variants=o,this._getInitialBbox(a));e=d.min.y;c.translateY(-e),c.updateMatrixWorld(),d.translate(new O.Vector3(0,-e,0)),this._fixSkinnedBbox=a,this._bbox=d,this._center=s===$?d.getCenter(new O.Vector3):ae(s,d),this.castShadow=l,this.receiveShadow=h}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get annotations(){return this._annotations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}get center(){return this._center}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}selectVariant(s){return Q(this,void 0,void 0,function*(){const e=this._variants,r=this._parser;if(!(e.length<=0)&&r){let i=0;null!=s&&(i=o(s)?e.findIndex(({name:e})=>e===s):s);const t=this._scene,n=[];return t.traverse(s=>Q(this,void 0,void 0,function*(){if(s.isMesh&&s.userData.gltfExtensions){const t=s.userData.gltfExtensions[we];var e;t&&(s.userData.originalMaterial||(s.userData.originalMaterial=s.material),(e=t.mappings.find(e=>e.variants.includes(i)))?(e=r.getDependency("material",e.material),n.push(e),s.material=yield e,r.assignFinalMaterial(s)):s.material=s.userData.originalMaterial)}})),Promise.all(n)}})}reduceVertices(n,e){const t=this.meshes;let o=e;return t.forEach(t=>{var s=t.geometry.attributes["position"];if(s)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{o=n(o,e)});else{var i=q(s);for(let e=0;e<s.count;e++){const r=(new O.Vector3).fromBufferAttribute(s,e);s.normalized&&r.multiplyScalar(i),r.applyMatrix4(t.matrixWorld),o=n(o,r)}}}),o}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new O.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new O.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t.sort((e,t)=>e.name.localeCompare(t.name))}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,s){var e=t.geometry,i=e.attributes.position,e=e.attributes.skinWeight;const r=t.skeleton;r.update();var n=q(i),o=q(e);for(let e=0;e<i.count;e++)s(Y(e,t,n,o))}}const cs=new ns,ds=new r;class I extends fe{constructor(e){super(e),this._loader=new Tt;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(cs),t.setKTX2Loader(ds.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(i){return Q(this,void 0,void 0,function*(){return new Promise((e,t)=>{const s=document.createElement("script");s.addEventListener("load",()=>Q(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,I.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(s),e()})),s.addEventListener("error",()=>{document.body.removeChild(s),t()}),s.src=new URL(i,location.href).href,document.body.appendChild(s)})})}load(i){var e=this._view3D;const r=this._loader,n=X(e,i);return cs.setDecoderPath(e.dracoPath),ds.setTranscoderPath(e.ktxPath),I.meshoptDecoder&&r.setMeshoptDecoder(I.meshoptDecoder),r.manager=O.DefaultLoadingManager,new Promise((s,t)=>{try{r.load(i,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,i);s(e)}),e=>this._onLoadingProgress(e,i,n),e=>{n.initialized=!0,t(e)})}catch(e){t(e)}})}loadFromFiles(a){const l=this._view3D,h=this._loader,c=[],d=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return cs.setDecoderPath(l.dracoPath),ds.setTranscoderPath(l.ktxPath),I.meshoptDecoder&&h.setMeshoptDecoder(I.meshoptDecoder),new Promise((s,t)=>{if(a.length<=0)t(new Error("No files found"));else{const i=a.find(e=>/\.(gltf|glb)$/i.test(e.name));if(i){const r=new Map,n=(a.forEach(e=>{r.set(e.name,e)}),URL.createObjectURL(i)),e=(c.push(n),new O.LoadingManager),o=(e.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";return r.has(t)?(t=r.get(t),t=URL.createObjectURL(t),c.push(t),t):e}),X(l,n));h.manager=e,h.load(n,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,i.name);d(),s(e)}),e=>this._onLoadingProgress(e,n,o),e=>{o.initialized=!0,d(),t(e)})}else t(new Error("No glTF file found"))}})}_parseToModel(_,p){var m;return Q(this,void 0,void 0,function*(){const r=this._view3D;var e=r.fixSkinnedBbox;_.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const a=r.renderer.threeRenderer.capabilities.maxTextureSize,t=[],s=(_.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&t.push(e)})}),t.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[])),l=s.reduce((e,t)=>[...e,...Te.filter(e=>t[e]).map(e=>t[e])],[]),i=_.parser.associations,n=_.parser.json;var o=l.filter(e=>i.has(e)).map(e=>n.textures[i.get(e).textures]);const h=Array.from(new Set(o).values()).reduce((i,e,t)=>{var s=e.extensions&&e.extensions[be],r=e.extras&&e.extras[ye];if(!s&&!r)return i;const n=l[t],o=(s?e.extensions[be]:e.extras[ye]).levels;return o.forEach(({index:e,size:t},s)=>{t>a||(i[s]||(i[s]=[]),i[s].push({index:e,texture:n}))}),i},[]),c=h.map(()=>!1),d=(h.forEach((i,s)=>Q(this,void 0,void 0,function*(){const e=yield Promise.all(i.map(({index:e})=>_.parser.getDependency("texture",e)));var t=c.slice(s+1).some(e=>!!e);c[s]=!0,t||e.forEach((e,t)=>{const s=i[t].texture;s.image=e.image,s.needsUpdate=!0,r.renderer.renderSingleFrame()})})),[]);_.parser.json.extras&&_.parser.json.extras[Se]&&(o=_.parser.json.extras[Se],d.push(...r.annotation.parse(o)));o=null!=(m=_.userData)?m:{},o=null!=(m=o.gltfExtensions)?m:{},o=o[we]?o[we].variants:[];const u=new hs({src:p,scenes:_.scenes,center:r.center,annotations:d,parser:_.parser,animations:_.animations,variants:o,fixSkinnedBbox:e});return r.variant&&(yield u.selectVariant(r.variant)),u})}}class us extends s{constructor(e,{src:t=null,iosSrc:s=null,variant:i=null,dracoPath:r="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:n="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:o=null,fixSkinnedBbox:a=!1,fov:l=$,center:h=$,yaw:c=0,pitch:d=0,pivot:u=$,initialZoom:_=0,rotate:p=!0,translate:m=!0,zoom:v=!0,autoplay:g=!1,scrollable:f=!0,wheelScrollable:E=!1,useGrabCursor:T=!0,ignoreCenterOnFit:w=!1,skybox:b=null,envmap:y=null,background:S=null,exposure:A=1,shadow:L=!0,skyboxBlur:R=!1,toneMapping:x=ue.LINEAR,useDefaultEnv:O=!0,defaultAnimationIndex:C=0,animationRepeatMode:M=me.ONE,annotationURL:I=null,annotationWrapper:D="."+J.ANNOTATION_WRAPPER,annotationSelector:F="."+J.ANNOTATION,annotationBreakpoints:U=Pe,annotationAutoUnfocus:B=!0,webAR:k=!0,sceneViewer:H=!0,quickLook:G=!0,arPriority:V=Ne,poster:z=null,canvasSelector:W="canvas",autoInit:P=!0,autoResize:j=!0,useResizeObserver:K=!0,maintainSize:X=!1,on:q={},plugins:N=[],maxDeltaTime:Y=1/30}={}){super(),this._rootEl=ee(e),this._src=t,this._iosSrc=s,this._variant=i,this._dracoPath=r,this._ktxPath=n,this._meshoptPath=o,this._fixSkinnedBbox=a,this._fov=l,this._center=h,this._yaw=c,this._pitch=d,this._pivot=u,this._initialZoom=_,this._rotate=p,this._translate=m,this._zoom=v,this._autoplay=g,this._scrollable=f,this._wheelScrollable=E,this._useGrabCursor=T,this._ignoreCenterOnFit=w,this._skybox=b,this._envmap=y,this._background=S,this._exposure=A,this._shadow=L,this._skyboxBlur=R,this._toneMapping=x,this._useDefaultEnv=O,this._defaultAnimationIndex=C,this._animationRepeatMode=M,this._annotationURL=I,this._annotationWrapper=D,this._annotationSelector=F,this._annotationBreakpoints=U,this._annotationAutoUnfocus=B,this._webAR=k,this._sceneViewer=H,this._quickLook=G,this._arPriority=V,this._poster=z,this._canvasSelector=W,this._autoInit=P,this._autoResize=j,this._useResizeObserver=K,this._maintainSize=X,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=N,this._maxDeltaTime=Y,this._renderer=new ve(this),this._camera=new Ue(this),this._control=new ft(this),this._scene=new Ce(this),this._animator=new ke(this),this._autoPlayer=new Et(this,Z(g)),this._autoResizer=new Be(this),this._arManager=new ct(this),this._annotationManager=new pt(this),this._addEventHandlers(q),this._addPosterImage(),Q(this,void 0,void 0,function*(){yield this._initPlugins(N),t&&P&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get annotation(){return this._annotationManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get variant(){return this._variant}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get pivot(){return this._pivot}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get ignoreCenterOnFit(){return this._ignoreCenterOnFit}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get useDefaultEnv(){return this._useDefaultEnv}get defaultAnimationIndex(){return this._defaultAnimationIndex}get animationRepeatMode(){return this._animationRepeatMode}get annotationURL(){return this._annotationURL}get annotationWrapper(){return this._annotationWrapper}get annotationSelector(){return this._annotationSelector}get annotationBreakpoints(){return this._annotationBreakpoints}get annotationAutoUnfocus(){return this._annotationAutoUnfocus}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set variant(e){this._model&&this._model.selectVariant(e).then(()=>{this.renderer.renderSingleFrame()}),this._variant=e}set defaultAnimationIndex(e){this._defaultAnimationIndex=e}set initialZoom(e){this._initialZoom=e}set skybox(e){this._scene.setSkybox(e),!(this._skybox=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set envmap(e){this._scene.setEnvMap(e),!(this._envmap=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set exposure(e){this._exposure=e,this._renderer.threeRenderer.toneMappingExposure=e,this._renderer.renderSingleFrame()}set skyboxBlur(e){this._skyboxBlur=e;var t=this._scene;const s=t.root;t=t.root.environment;t&&null!==s.background&&(s.background=e?b.createBlurredHDR(this,t):t)}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e,this._renderer.renderSingleFrame()}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set animationRepeatMode(e){this._animationRepeatMode=e,this._animator.updateRepeatMode()}set autoResize(e){(this._autoResize=e)?this._autoResizer.enable():this._autoResizer.disable()}set maintainSize(e){this._maintainSize=e}set maxDeltaTime(e){this._maxDeltaTime=e}destroy(){this._scene.reset(),this._renderer.destroy(),this._control.destroy(),this._autoResizer.disable(),this._animator.destroy(),this._annotationManager.destroy(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return Q(this,void 0,void 0,function*(){if(!this._src)throw new l(c.PROVIDE_SRC_FIRST,h.PROVIDE_SRC_FIRST);const e=this._scene,t=this._renderer,s=this._control,i=this._animator,r=this._annotationManager;var n=this._meshoptPath;const o=[];this.resize(),i.init(),r.init(),this._autoResize&&this._autoResizer.enable(),n&&!I.meshoptDecoder&&(yield I.setMeshoptDecoder(n)),o.push(...e.initTextures());n=this._loadModel(this._src);o.push(...n),this._resetLoadingContextOnFinish(o),yield Promise.race(n),this._annotationURL&&(yield this._annotationManager.load(this._annotationURL)),s.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),t.renderSingleFrame(),this._initialized=!0,this.trigger(E.READY,{type:E.READY,target:this})})}resize(){const e=this._renderer;var t=this._initialized?e.size:null,s=(e.resize(),e.size);this._camera.resize(s,t),this._control.resize(s),this._annotationManager.resize(),this._initialized&&e.renderSingleFrame(!0),this.trigger(E.RESIZE,Object.assign(Object.assign({},s),{type:E.RESIZE,target:this}))}load(t){return Q(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t):(this._src=t,yield this.init())})}display(e,{resetCamera:t=!0}={}){const s=this._renderer,i=this._scene,r=this._camera,n=this._animator,o=this._annotationManager;var a=s.threeRenderer.xr.isPresenting;if(i.reset(),i.add(e.scene),i.shadowPlane.updateDimensions(e),t&&(r.fit(e),r.reset(0)),n.reset(),n.setClips(e.animations),0<e.animations.length&&n.play(this._defaultAnimationIndex),o.reset(),o.collect(),o.add(...e.annotations),this._model=e,a){const l=this._arManager.activeSession;l&&l.control.syncTargetModel(e)}this._initialized&&s.renderSingleFrame(),this.trigger(E.MODEL_CHANGE,{type:E.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return Q(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var s=t.toDataURL("png");const i=document.createElement("a");i.href=s,i.download=e,i.click()}_loadModel(e){const s=new I(this);if(Array.isArray(e)){const i=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(s,e,t,i))}return[this._loadSingleModel(s,e,0,[!1])]}_loadSingleModel(r,n,o,a){return Q(this,void 0,void 0,function*(){var t=a.length-1;this.trigger(E.LOAD_START,{type:E.LOAD_START,target:this,src:n,level:o,maxLevel:t});try{var e=yield r.load(n),s=a.slice(o+1).some(e=>!!e),i=a.some(e=>!!e);if(this.trigger(E.LOAD,{type:E.LOAD,target:this,model:e,level:o,maxLevel:t}),a[o]=!0,s)return;this.display(e,{resetCamera:!i})}catch(e){throw this.trigger(E.LOAD_ERROR,{type:E.LOAD_ERROR,target:this,level:o,maxLevel:t,error:e}),new l(c.MODEL_FAIL_TO_LOAD(n),h.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const s=this._rootEl;if(t){var i=a(t);let e;if(i||B(t)){i=i?t:s.querySelector(t);if(!i)throw new l(c.ELEMENT_NOT_FOUND(t),h.ELEMENT_NOT_FOUND);e=i}else{const r=document.createElement("img");r.className=J.POSTER,r.src=t,s.appendChild(r),e=r,this.once(E.READY,()=>{r.parentElement===s&&s.removeChild(r)})}this.once(E.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return Q(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(E.LOAD_FINISH,{type:E.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}us.VERSION="2.9.1";class _s{constructor({className:e={},showPlaneDetection:t=!0,toastText:s="Point your device downwards to find the ground and move it around."}={}){this.className=e,this.showPlaneDetection=t,this.toastText=s,this._createElements()}init(l){return Q(this,void 0,void 0,function*(){const r=this._rootEl,n=this._detectionRootEl,o=this._closeButtonEl,a=Object.assign(Object.assign({},_s.DEFAULT_CLASS),this.className);l.on(E.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){t.appendChild(r);const s=()=>{e.exit()},i=(null!==n&&void 0!==n&&n.classList.add(a.DETECTION_VISIBLE),()=>{null!==n&&void 0!==n&&n.classList.remove(a.DETECTION_VISIBLE)});l.once(E.AR_MODEL_PLACED,i),o.addEventListener(p.CLICK,s),l.once(E.AR_END,()=>{r.parentElement&&r.parentElement.removeChild(r),o.removeEventListener(p.CLICK,s),l.off(E.AR_MODEL_PLACED,i)})}})})}teardown(){}_createElements(){var e=Object.assign(Object.assign({},_s.DEFAULT_CLASS),this.className);const t=document.createElement(f),s=document.createElement(f);s.classList.add(e.CLOSE_BUTTON),s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',t.classList.add(e.ROOT),t.appendChild(s),this.showPlaneDetection&&(this._detectionRootEl=this._createPlaneDetectionElements(),t.appendChild(this._detectionRootEl)),this._rootEl=t,this._closeButtonEl=s}_createPlaneDetectionElements(){const t=Object.assign(Object.assign({},_s.DEFAULT_CLASS),this.className),e=document.createElement(f),s=document.createElement(f),i=document.createElement(f),r=document.createElement(f),n=document.createElement(f),o=document.createElement(f),a=k(5).map(()=>document.createElement(f));return e.classList.add(t.DETECTION_ROOT),s.classList.add(t.DETECTION_ICON),i.classList.add(t.DETECTION_TOAST),r.classList.add(t.DETECTION_PHONE),n.classList.add(t.DETECTION_CUBE),o.classList.add(t.DETECTION_PLANE),i.innerHTML=this.toastText,a.forEach(e=>{e.classList.add(t.DETECTION_CUBE_FACE),n.appendChild(e)}),s.appendChild(r),s.appendChild(n),s.appendChild(o),e.appendChild(s),e.appendChild(i),e}}_s.DEFAULT_CLASS={ROOT:"view3d-ar-root",CLOSE_BUTTON:"view3d-ar-close",DETECTION_ROOT:"view3d-ar-detection",DETECTION_ICON:"view3d-ar-detection-icon",DETECTION_TOAST:"view3d-ar-detection-toast",DETECTION_PHONE:"view3d-ar-phone",DETECTION_CUBE:"view3d-ar-cube",DETECTION_CUBE_FACE:"view3d-ar-cube-face",DETECTION_PLANE:"view3d-ar-plane",DETECTION_VISIBLE:"visible"};class D{constructor(e={}){this._startLoading=({target:i,level:e})=>{if(0!==e)return;const{type:t=D.TYPE.DEFAULT,loadingLabel:s="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:n="#ffffff",barWidth:o="70%",barHeight:a="10px",barBackground:l="#bbbbbb",barForeground:h="#3e8ed0",spinnerWidth:c="30%",overlayBackground:d="rgba(0, 0, 0, 0.3)"}=this._options,u=document.createElement(f),_=document.createElement(f),p=document.createElement(f),m=document.createElement(f),v=document.createElement(f);e=Object.assign(Object.assign({},this._options.className),D.DEFAULT_CLASS);if(u.classList.add(e.OVERLAY),_.classList.add(e.WRAPPER),m.classList.add(e.BASE),p.classList.add(e.LABEL),v.classList.add(e.FILLER),u.style.backgroundColor=d,t!==D.TYPE.SPINNER?(m.style.height=a,m.style.backgroundColor=l,v.style.backgroundColor=h):(m.classList.add(e.TYPE_SPINNER),m.style.width=c,m.style.paddingTop=c,v.style.borderWidth=a,v.style.borderColor=h,v.style.borderLeftColor="transparent"),t===D.TYPE.TOP?u.classList.add(e.TYPE_TOP):t===D.TYPE.DEFAULT&&(m.style.width=o),p.style.color=n,p.innerText=s,m.appendChild(v),_.appendChild(m),_.appendChild(p),u.appendChild(_),i.rootEl.appendChild(u),t!==D.TYPE.SPINNER){const g=()=>{if(i.loadingContext.every(e=>e.initialized)){var[e,t]=i.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]);if(!(t<=0)){const s=e/t*100;v.style.width=s.toFixed(2)+"%",e===t&&(p.innerText=r)}}};i.on(E.PROGRESS,g),i.once(E.LOAD_FINISH,()=>{i.off(E.PROGRESS,g)})}i.once(E.LOAD_FINISH,()=>{this._removeOverlay(i)}),this._overlay=u},this._options=e}init(e){return Q(this,void 0,void 0,function*(){e.on(E.LOAD_START,this._startLoading)})}teardown(e){e.off(E.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}D.DEFAULT_CLASS={OVERLAY:"view3d-lb-overlay",WRAPPER:"view3d-lb-wrapper",BASE:"view3d-lb-base",LABEL:"view3d-lb-label",FILLER:"view3d-lb-filler",TYPE_SPINNER:"is-spinner",TYPE_TOP:"is-top"},D.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};class ps{constructor(e,t,{position:s=P.POSITION.TOP,order:i=9999}={}){this._onResize=()=>{this._rootBbox=this._trackEl.getBoundingClientRect()},this._onRender=({target:e})=>{var e=e.animator,t=e.activeAnimationIndex,s=e.activeAnimation,e=e.actions[t];s&&e&&(t=e.time/s.duration,this._fill(t))},this._onMouseDown=e=>{if(e.button===ne.LEFT){var t=this._view3D.animator,s=t.activeAnimationIndex;const i=t.actions[s];e.preventDefault(),window.addEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(p.MOUSE_UP,this._onMouseUp,!1),this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX)}},this._onMouseMove=e=>{e.preventDefault(),this._updateAnimationProgress(e.pageX)},this._onMouseUp=()=>{window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)},this._onTouchStart=e=>{if(!(1<e.touches.length)){var e=e.touches[0],t=this._view3D.animator,s=t.activeAnimationIndex;const i=t.actions[s];this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._firstTouch={x:e.pageX,y:e.pageY},this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX)}},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],s=this._view3D.scrollable,i=this._firstTouch;if(i){if(s){s=new O.Vector2(t.pageX,t.pageY).sub(new O.Vector2(i.x,i.y));if(Math.abs(s.y)>Math.abs(s.x))return this._scrolling=!0,void this._release()}this._firstTouch=null}e.cancelable&&e.preventDefault(),e.stopPropagation(),this._setAnimationTimeScale(0),this._updateAnimationProgress(t.pageX)}},this._onTouchEnd=e=>{0<e.touches.length||(this._release(),this._scrolling=!1)},this._updateAnimationProgress=e=>{const t=this._view3D;var s=this._rootBbox;const i=this._thumbEl;var r=t.animator,n=r.activeAnimationIndex,o=r.activeAnimation;const a=r.actions[n];o&&a&&(r=(e-s.x)/s.width,n=d(r,0,1)*o.duration,a.time=n,e=Math.floor(n),s=Math.floor(100*(n-e)),r=e=>""+"0".repeat(Math.max(2-e.toString().length,0))+e,i.setAttribute("data-time",r(e)+":"+r(s)),t.renderer.renderSingleFrame())},this.position=s,this.order=i,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1,this._firstTouch=null,this._scrolling=!1,this._origTimeScale=1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){const e=this._view3D;this._enabled||(this._rootBbox=this._trackEl.getBoundingClientRect(),this._enabled=!0,e.on(E.RESIZE,this._onResize),e.on(E.RENDER,this._onRender),this._fill(0),this.enableInput())}disable(){const e=this._view3D;this._enabled&&(this._enabled=!1,e.off(E.RESIZE,this._onResize),e.off(E.RENDER,this._onRender),this.disableInput())}enableInput(){const e=this._rootEl;var t=this._view3D;this._firstTouch=null,this._scrolling=!1,t.animator.animationCount<=0||(e.addEventListener(p.MOUSE_DOWN,this._onMouseDown),e.addEventListener(p.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(p.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(p.TOUCH_END,this._onTouchEnd))}disableInput(){const e=this._rootEl;e.removeEventListener(p.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(p.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(p.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(p.TOUCH_START,this._onTouchStart),e.removeEventListener(p.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(p.TOUCH_END,this._onTouchEnd)}_createElements(){var e=this._controlBar,e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);const t=document.createElement(f),s=(t.classList.add(e.PROGRESS_ROOT),t.draggable=!1,document.createElement(f)),i=(s.classList.add(e.PROGRESS_TRACK),document.createElement(f)),r=(i.classList.add(e.PROGRESS_THUMB),document.createElement(f));r.classList.add(e.PROGRESS_FILLER),s.appendChild(r),s.appendChild(i),t.appendChild(s),this._rootEl=t,this._trackEl=s,this._thumbEl=i,this._fillerEl=r}_fill(e){this._fillerEl.style.width=100*e+"%",this._thumbEl.style.transform=`translateX(${e*this._rootBbox.width}px)`}_release(){this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)}_showThumb(){const e=this._thumbEl;var t=this._controlBar,t=Object.assign(Object.assign({},t.className),P.DEFAULT_CLASS);e.classList.add(t.VISIBLE)}_hideThumb(){const e=this._thumbEl;var t=this._controlBar,t=Object.assign(Object.assign({},t.className),P.DEFAULT_CLASS);e.classList.remove(t.VISIBLE)}_setAnimationTimeScale(e){var t=this._view3D.animator,s=t.activeAnimationIndex,i=t.activeAnimation;const r=t.actions[s];i&&r&&r.setEffectiveTimeScale(e)}}var ms='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M16 37.85V9.85L38 23.85Z"/></svg>';class vs{constructor(e,t,{position:s=P.POSITION.LEFT,order:i=9999}={}){this._updateIcon=()=>{var e=this._view3D;e.animator.paused!==this._paused&&(this._paused=e.animator.paused,this._element.innerHTML=this._paused?ms:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M28.25 38V10H36V38ZM12 38V10H19.75V38Z"/></svg>')},this._onClick=()=>{const e=this._view3D.animator;e.paused?e.resume():e.pause(),this._updateIcon()},this.position=s,this.order=i,this._view3D=e,this._element=this._createButton(t),this._enabled=!1,this._paused=!0}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.on(E.RENDER,this._updateIcon),this._element.addEventListener(p.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(E.RENDER,this._updateIcon),this._element.removeEventListener(p.CLICK,this._onClick),this._enabled=!1)}_createButton(e){const t=document.createElement(ce);e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML=ms,t}}class gs{constructor(e,t,{position:s=P.POSITION.LEFT,order:i=9999}={}){this._updateAnimations=()=>{var e=this._view3D,t=this._controlBar;const r=e.animator,s=this._rootEl,i=this._nameEl,n=this._itemListEl,o=r.clips,a=Object.assign(Object.assign({},t.className),P.DEFAULT_CLASS);for(;n.firstChild;)n.removeChild(n.firstChild);if(o.length<=0)s.classList.add(a.DISABLED);else{s.classList.remove(a.DISABLED);const l=o.map(e=>{const t=document.createElement(f);return t.classList.add(a.ANIMATION_ITEM),t.innerHTML=e.name,t}),h=(e,t)=>{l[t].classList.add(a.ANIMATION_SELECTED),i.innerHTML=e.name};o.forEach((s,i)=>{const e=l[i];i===r.activeAnimationIndex&&h(s,i),e.addEventListener(p.CLICK,e=>{var t=r.paused;r.play(i),t&&r.pause(),l.forEach(e=>{e.classList.remove(a.ANIMATION_SELECTED)}),h(s,i),this._hideList(),e.stopPropagation()}),n.appendChild(e)})}},this._toggleList=e=>{var t=this._controlBar;const s=this._itemListEl;t=Object.assign(Object.assign({},t.className),P.DEFAULT_CLASS);s.classList.toggle(t.VISIBLE),s.classList.contains(t.VISIBLE)&&this._view3D.rootEl.addEventListener(p.CLICK,this._hideList),e.stopPropagation()},this._hideList=()=>{var e=this._controlBar;const t=this._itemListEl;e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);t.classList.contains(e.VISIBLE)&&t.classList.remove(e.VISIBLE)},this.position=s,this.order=i,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.initialized&&this._updateAnimations(),this._view3D.on(E.MODEL_CHANGE,this._updateAnimations),this._nameEl.addEventListener(p.CLICK,this._toggleList),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(E.MODEL_CHANGE,this._updateAnimations),this._view3D.rootEl.removeEventListener(p.CLICK,this._hideList),this._nameEl.removeEventListener(p.CLICK,this._toggleList),this._enabled=!1)}_createElements(){var e=this._controlBar;const t=document.createElement(f),s=document.createElement(f),i=document.createElement(f);e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);t.classList.add(e.CONTROLS_ITEM),t.classList.add(e.DISABLED),s.classList.add(e.ANIMATION_NAME),i.classList.add(e.ANIMATION_LIST),t.appendChild(s),t.appendChild(i),this._rootEl=t,this._nameEl=s,this._itemListEl=i}}const fs=["requestFullscreen","webkitRequestFullscreen","webkitRequestFullScreen","webkitCancelFullScreen","mozRequestFullScreen","msRequestFullscreen"],Es=["fullscreenElement","webkitFullscreenElement","webkitCurrentFullScreenElement","mozFullScreenElement","msFullscreenElement"],Ts=["exitFullscreen","webkitExitFullscreen","webkitCancelFullScreen","mozCancelFullScreen","msExitFullscreen"];class ws{constructor(e,t,{position:s=P.POSITION.RIGHT,order:i=9999}={}){this._onClick=()=>{var e=this._view3D.rootEl;this._isFullscreen()?this._exitFullscreen():this._requestFullscreen(e)},this.position=s,this.order=i,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(p.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(p.CLICK,this._onClick),this._enabled=!1)}_isFullscreen(){if(!document)return!1;for(const e of Es)if(document[e])return!0;return!1}_requestFullscreen(e){for(const t of fs){const s=e[t];s&&s.call(e)}}_exitFullscreen(){for(const e of Ts){const t=document[e];t&&t.call(document)}}_createButton(e){const t=document.createElement(ce);e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M10 38v-9.65h3V35h6.65v3Zm0-18.35V10h9.65v3H13v6.65ZM28.35 38v-3H35v-6.65h3V38ZM35 19.65V13h-6.65v-3H38v9.65Z"/></svg>',t}}class bs{constructor(e,t,{axisWidth:s=5,font:i="14px sans-serif",xAxisColor:r="#ef2746",yAxisColor:n="#a7c031",zAxisColor:o="#6571a6"}={}){this._onRender=()=>{var e=this._view3D;const l=this._ctx;var t=this._canvasSize;const s=e.camera.threeCamera;if(l&&e.model){l.clearRect(0,0,t.x,t.y);const i=s.quaternion.clone(),r=(i.invert(),new O.Vector3(1,0,0).applyQuaternion(i)),n=new O.Vector3(0,1,0).applyQuaternion(i),o=new O.Vector3(0,0,1).applyQuaternion(i),h=new O.Vector2(.5,.5).multiply(t),a=(l.lineCap="round",l.lineWidth=this.axisWidth,new O.Color(this.xAxisColor)),c=new O.Color(this.yAxisColor),d=new O.Color(this.zAxisColor),u=[{idx:0,axis:"X",color:a,pos:r,negative:!1},{idx:1,axis:"Y",color:c,pos:n,negative:!1},{idx:2,axis:"Z",color:d,pos:o,negative:!1},{idx:3,axis:"X",color:a,pos:r.clone().negate(),negative:!0},{idx:4,axis:"Y",color:c,pos:n.clone().negate(),negative:!0},{idx:5,axis:"Z",color:d,pos:o.clone().negate(),negative:!0}].sort((e,t)=>e.pos.z-t.pos.z);u.forEach(({axis:e,pos:t,color:s,negative:i,idx:r},n)=>{var o=this._getScreenPos(t),t=0<=t.z?1:.6,s=this._getColorRGBAString(s,t);i||(l.strokeStyle=s,l.beginPath(),l.moveTo(h.x,h.y),l.lineTo(o.x,o.y),l.stroke(),l.globalCompositeOperation="destination-out",l.fillStyle="white",l.beginPath(),l.ellipse(o.x,o.y,10,10,0,0,2*Math.PI),l.fill(),l.globalCompositeOperation="source-over"),l.fillStyle=s,l.beginPath(),l.ellipse(o.x,o.y,10,10,0,0,2*Math.PI),l.fill(),i||(l.font=this.font,l.fillStyle="white",l.textAlign="center",l.textBaseline="middle",l.fillText(e,o.x,o.y));const a=this._axisEls[r];a.style.left=o.x+"px",a.style.top=o.y+"px",a.style.zIndex=n.toString()})}},this.axisWidth=s,this.font=i,this.xAxisColor=r,this.yAxisColor=n,this.zAxisColor=o,this._view3D=e,this._createElement(t),this._ctx=this._canvasEl.getContext("2d"),this._enabled=!1,this._canvasSize=new O.Vector2}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){if(!this._enabled&&this._ctx){var e=this._rootEl;const t=this._canvasEl,i=this._view3D,r=(this._enabled=!0,i.rootEl.appendChild(e),i.on(E.RENDER,this._onRender),this._canvasSize.set(t.clientWidth,t.clientHeight),t.width=this._canvasSize.x,t.height=this._canvasSize.y,[new L(-90,0,0),new L(0,90,0),new L(0,0,0),new L(90,0,0),new L(0,-90,0),new L(180,0,0)]);r.forEach(e=>{e.pivot.copy(i.camera.defaultPose.pivot)}),this._axisClickListeners=this._axisEls.map((e,t)=>{const s=r[t];t=()=>{i.camera.reset(300,S,s)};return e.addEventListener(p.CLICK,t),t})}}disable(){if(this._enabled){this._enabled=!1;const t=this._view3D.rootEl;var e=this._rootEl;e&&e.parentElement===t&&t.removeChild(e),this._view3D.off(E.RENDER,this._onRender),this._axisEls.forEach((e,t)=>{t=this._axisClickListeners[t];e.removeEventListener(p.CLICK,t)}),this._axisClickListeners=[]}}_createElement(e){const t=document.createElement(f);var s=document.createElement("canvas");const i=k(6).map(()=>document.createElement(f)),r=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);t.classList.add(r.GIZMO_ROOT),t.appendChild(s),i.forEach(e=>{e.classList.add(r.GIZMO_AXIS),t.appendChild(e)}),this._rootEl=t,this._canvasEl=s,this._axisEls=i}_getScreenPos(e){var t=this._canvasSize;return new O.Vector2(e.x,-e.y).multiplyScalar(.8).addScalar(1).multiplyScalar(.5).multiply(t)}_getColorRGBAString(e,t){return`rgba(${Math.floor(255*e.r)},${Math.floor(255*e.g)},${Math.floor(255*e.b)},${t})`}}class ys{constructor(e,t,{position:s=P.POSITION.RIGHT,order:i=9999,duration:r=500}={}){this._onClick=()=>{this._view3D.camera.reset(this.duration)},this.position=s,this.order=i,this.duration=r,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(p.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(p.CLICK,this._onClick),this._enabled=!1)}_createButton(e){const t=document.createElement(ce);e=Object.assign(Object.assign({},e.className),P.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M24 44q-3.75 0-7.025-1.4-3.275-1.4-5.725-3.85Q8.8 36.3 7.4 33.025 6 29.75 6 26h3q0 6.25 4.375 10.625T24 41q6.25 0 10.625-4.375T39 26q0-6.25-4.25-10.625T24.25 11H23.1l3.65 3.65-2.05 2.1-7.35-7.35 7.35-7.35 2.05 2.05-3.9 3.9H24q3.75 0 7.025 1.4 3.275 1.4 5.725 3.85 2.45 2.45 3.85 5.725Q42 22.25 42 26q0 3.75-1.4 7.025-1.4 3.275-3.85 5.725-2.45 2.45-5.725 3.85Q27.75 44 24 44Z"/></svg>',t}}class P{constructor({autoHide:e=!0,className:t={},progressBar:s=!0,playButton:i=!0,animationSelector:r=!0,fullscreenButton:n=!0,navigationGizmo:o=!0,cameraResetButton:a=!0}={}){this.show=()=>{const e=this._rootEl;var t=Object.assign(Object.assign({},P.DEFAULT_CLASS),this.className);e.classList.add(t.VISIBLE)},this.hide=()=>{const e=this._rootEl;var t=Object.assign(Object.assign({},P.DEFAULT_CLASS),this.className);e.classList.remove(t.VISIBLE)},this._updateModelParams=()=>{this._items.forEach(e=>{e.disable(),e.enable()})},this._hideAfterDelay=()=>{var{delay:e=0}=Z(this.autoHide);this._autoHideTimer&&(window.clearTimeout(this._autoHideTimer),this._autoHideTimer=-1),e<=0?this.hide():this._autoHideTimer=window.setTimeout(this.hide,e)},this.autoHide=e,this.className=t,this.progressBar=s,this.playButton=i,this.animationSelector=r,this.fullscreenButton=n,this.navigationGizmo=o,this.cameraResetButton=a,this._items=[],this._initElements(),this._autoHideTimer=-1}get rootEl(){return this._rootEl}get items(){return this._items}init(e){return Q(this,void 0,void 0,function*(){this._attachElements(e),e.model&&this._updateModelParams(),this._items=this._createDefaultItems(e),this._addItemElements(),this._items.forEach(e=>{e.enable()}),e.on(E.MODEL_CHANGE,this._updateModelParams),this.show(),this._setupAutoHide(e)})}teardown(e){const t=e.rootEl;t.removeEventListener(p.POINTER_ENTER,this.show),t.removeEventListener(p.POINTER_LEAVE,this._hideAfterDelay),this._removeElements(e),this._items.forEach(e=>{e.disable()}),this._items=[],e.off(E.MODEL_CHANGE,this._updateModelParams),window.clearTimeout(this._autoHideTimer)}_initElements(){var e=Object.assign(Object.assign({},P.DEFAULT_CLASS),this.className);const t=document.createElement(f),s=(t.classList.add(e.ROOT),this._rootEl=t,document.createElement(f)),i=(s.classList.add(e.CONTROLS_BG),t.appendChild(s),document.createElement(f)),r=document.createElement(f),n=document.createElement(f),o=document.createElement(f);i.classList.add(e.CONTROLS_TOP),r.classList.add(e.CONTROLS_SIDE),n.classList.add(e.CONTROLS_LEFT),o.classList.add(e.CONTROLS_RIGHT),t.appendChild(i),r.appendChild(n),r.appendChild(o),t.appendChild(r),this._topControlsWrapper=i,this._leftControlsWrapper=n,this._rightControlsWrapper=o}_addItemElements(){var e=this._topControlsWrapper,t=this._leftControlsWrapper,s=this._rightControlsWrapper;const i=this._items.filter(e=>e.position&&null!=e.order),r={[P.POSITION.TOP]:{parentEl:e,items:[]},[P.POSITION.LEFT]:{parentEl:t,items:[]},[P.POSITION.RIGHT]:{parentEl:s,items:[]}};i.forEach(e=>{r[e.position].items.push(e)}),Object.keys(r).forEach(e=>{const{parentEl:t,items:s}=r[e];s.sort((e,t)=>e.order-t.order),s.forEach(e=>{t.appendChild(e.element)})})}_attachElements(e){e.rootEl.appendChild(this._rootEl)}_removeElements(e){var t=this._rootEl;const s=this._topControlsWrapper,i=this._leftControlsWrapper,r=this._rightControlsWrapper;[s,i,r].forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)}),t.parentElement===e.rootEl&&e.rootEl.removeChild(t)}_setupAutoHide(e){if(this.autoHide){var{initialDelay:t=3e3}=Z(this.autoHide);const s=e.rootEl;this._autoHideTimer=window.setTimeout(()=>{this.hide()},t),s.addEventListener(p.POINTER_ENTER,this.show),s.addEventListener(p.POINTER_LEAVE,this._hideAfterDelay)}}_createDefaultItems(e){const t=[];return this.progressBar&&t.push(new ps(e,this,Z(this.progressBar))),this.playButton&&t.push(new vs(e,this,Z(this.playButton))),this.animationSelector&&t.push(new gs(e,this,Z(this.animationSelector))),this.cameraResetButton&&t.push(new ys(e,this,Z(this.cameraResetButton))),this.fullscreenButton&&t.push(new ws(e,this,Z(this.fullscreenButton))),this.navigationGizmo&&t.push(new bs(e,this,Z(this.navigationGizmo))),t}}P.DEFAULT_CLASS={ROOT:"view3d-control-bar",VISIBLE:"visible",DISABLED:"disabled",CONTROLS_BG:"view3d-controls-background",CONTROLS_SIDE:"view3d-side-controls",CONTROLS_TOP:"view3d-top-controls",CONTROLS_LEFT:"view3d-left-controls",CONTROLS_RIGHT:"view3d-right-controls",CONTROLS_ITEM:"view3d-control-item",PROGRESS_ROOT:"view3d-progress-bar",PROGRESS_TRACK:"view3d-progress-track",PROGRESS_THUMB:"view3d-progress-thumb",PROGRESS_FILLER:"view3d-progress-filler",ANIMATION_NAME:"view3d-animation-name",ANIMATION_LIST:"view3d-animation-list",ANIMATION_ITEM:"view3d-animation-item",ANIMATION_SELECTED:"selected",GIZMO_ROOT:"view3d-gizmo",GIZMO_AXIS:"view3d-gizmo-axis"},P.POSITION={TOP:"top",LEFT:"left",RIGHT:"right"};var t={__proto__:null,default:us,Animation:He,ARManager:ct,AutoPlayer:Et,AutoResizer:Be,Camera:Ue,Model:hs,ModelAnimator:ke,Motion:A,Pose:L,Renderer:ve,Scene:Ce,ShadowPlane:Re,Skybox:b,View3DError:l,Annotation:dt,PointAnnotation:ut,FaceAnnotation:_t,AnnotationManager:pt,AnimationControl:Fe,OrbitControl:ft,RotateControl:mt,TranslateControl:vt,ZoomControl:gt,Loader:fe,GLTFLoader:I,TextureLoader:Ee,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return Q(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return Q(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:s="view3d-ar-button",tooltipClass:i="view3d-tooltip"}=this._options;const r=yield a.ar.isAvailable(),n=document.createElement(ce),o=document.createElement(f);e=document.createTextNode(r?e:t);n.classList.add(s),o.classList.add(i),n.disabled=!0,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',n.appendChild(o),o.appendChild(e),a.rootEl.appendChild(n),this._button=n,a.initialized?yield this._setAvailable(a,n,r):a.once(E.MODEL_CHANGE,()=>{this._setAvailable(a,n,r)})})}_setAvailable(e,t,s){return Q(this,void 0,void 0,function*(){s?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:_s,LoadingBar:D,ControlBar:P,AnimationProgressBar:ps,AnimationSelector:gs,FullscreenButton:ws,PlayButton:vs,NavigationGizmo:bs,ARScene:et,WebARSession:ot,SceneViewerSession:at,QuickLookSession:lt,DOMOverlay:tt,HitTest:st,LightEstimation:nt,AUTO:$,EVENTS:E,EASING:de,DEFAULT_CLASS:J,TONE_MAPPING:ue,ZOOM_TYPE:_e,AR_SESSION_TYPE:e,SCENE_VIEWER_MODE:pe,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},INPUT_TYPE:g,ANIMATION_REPEAT_MODE:me,ERROR_CODES:n,isAvailable:({webGL:e=!0,fetch:t=!0,stream:s=!0,wasm:i=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(s&&!(window&&window.ReadableStream))return!1;if(i&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0},withMethods:(r,n)=>{[s.prototype,us.prototype].forEach(i=>{Object.getOwnPropertyNames(i).filter(e=>"_"!==e.charAt(0)&&"constructor"!==e).forEach(e=>{const s=Object.getOwnPropertyDescriptor(i,e);if(s.value)Object.defineProperty(r,e,{value:function(...e){return s.value.call(this[n],...e)}});else{const t={};s.get&&(t.get=function(){var e;return this[n]&&(null==(e=s.get)?void 0:e.call(this[n]))}),s.set&&(t.set=function(...e){var t;return null==(t=s.set)?void 0:t.call(this[n],...e)}),Object.defineProperty(r,e,t)}})})},getValidProps:s=>Object.keys(s).reduce((e,t)=>(null!=s[t]&&(e[t]=s[t]),e),{}),isNumber:N,isString:o,isElement:a,getNullableElement:F,getElement:ee,findCanvas:U,isCSSSelector:B,range:k,toRadian:_,toDegree:m,clamp:d,lerp:H,circulate:u,merge:G,getBoxPoints:e=>[e.min.clone(),new O.Vector3(e.min.x,e.min.y,e.max.z),new O.Vector3(e.min.x,e.max.y,e.min.z),new O.Vector3(e.min.x,e.max.y,e.max.z),new O.Vector3(e.max.x,e.min.y,e.min.z),new O.Vector3(e.max.x,e.min.y,e.max.z),new O.Vector3(e.max.x,e.max.y,e.min.z),e.max.clone()],toPowerOfTwo:V,getPrimaryAxisIndex:(e,s)=>{let i=0,r=0;return e.forEach((e,t)=>{e=Math.abs(s.dot(e));e>r&&(i=t,r=e)}),i},getRotationAngle:z,getObjectOption:Z,toBooleanString:W,getRotatedPosition:j,directionToYawPitch:K,createLoadingContext:X,getAttributeScale:q,getSkinnedVertex:Y,isSignedArrayBuffer:te,checkHalfFloatAvailable:se,getFaceVertices:ie,getAnimatedFace:re,subclip:(e,t,l,h)=>{const s=e.clone(),c=(s.name=t,[]);s.tracks.forEach(s=>{var i=s.getValueSize();const e=[],r=[];for(let t=0;t<s.times.length;++t){var n=s.times[t],o=s.times[t+1],a=s.times[t-1];if(o&&n<l&&l<o||l<=n&&n<h||a&&h<=n&&a<h){e.push(n);for(let e=0;e<i;++e)r.push(s.values[t*i+e])}}0!==e.length&&(s.times=oe(e,s.times.constructor),s.values=oe(r,s.values.constructor),c.push(s))}),s.tracks=c;for(let e=0;e<s.tracks.length;++e)s.tracks[e].shift(-l);return s.duration=h-l,s},parseAsBboxRatio:ae};return G(us,t),us});
