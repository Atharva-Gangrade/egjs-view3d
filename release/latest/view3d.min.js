/*
Copyright (c) 2020-present NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.0.0
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@egjs/component"),require("three"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["@egjs/component","three","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.Component,e.THREE,e.RGBELoader,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(e,f,o,s,t,i){"use strict";function p(e,n,a,h){return new(a=a||Promise)(function(s,t){function i(e){try{r(h.next(e))}catch(e){t(e)}}function o(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,o)}r((h=h.apply(e,n||[])).next())})}class L extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,L.prototype),this.name="View3DError",this.code=t}}var r={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,PROVIDE_WIDTH_OR_HEIGHT:5,FORMAT_NOT_SUPPORTED:6,FILE_NOT_SUPPORTED:7,NOT_INITIALIZED:8},D=r,A={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization',PROVIDE_WIDTH_OR_HEIGHT:"Either width or height should be given.",FORMAT_NOT_SUPPORTED:e=>`Given format "${e}" is not supported or invalid`,FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet"};const I=(e,t)=>{let s=null;if("string"==typeof e){const i=t||document;t=i.querySelector(e);if(!t)throw new L(A.ELEMENT_NOT_FOUND(e),D.ELEMENT_NOT_FOUND);s=t}else e&&e.nodeType===Node.ELEMENT_NODE&&(s=e);return s},c=e=>e*Math.PI/180,_=(e,t,s)=>Math.max(Math.min(e,s),t),n=(e,t,s)=>e*(1-s)+t*s,a=(e,t,s)=>{var i=Math.abs(s-t);return e<t?e=s-(t-e)%i:s<e&&(e=t+(e-s)%i),e},h=(i,...e)=>(e.forEach(s=>{Object.keys(s).forEach(e=>{var t=s[e];Array.isArray(i[e])&&Array.isArray(t)?i[e]=[...i[e],...t]:i[e]=t})}),i),N=e=>"object"==typeof e?e:{},l=e=>e?"true":"false",d=(e,t,s)=>{t=c(t),s=c(s);const i=new f.Vector3(0,0,0);return i.y=e*Math.sin(s),i.z=e*Math.cos(s),i.x=i.z*Math.sin(-t),i.z=i.z*Math.cos(-t),i},z="auto",w={READY:"ready",LOAD:"load",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",QUICK_LOOK_TAP:"quickLookTap",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced"},u={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,s=2.75;return e<1/s?t*e*e:e<2/s?t*(e-=1.5/s)*e+.75:e<2.5/s?t*(e-=2.25/s)*e+.9375:t*(e-=2.625/s)*e+.984375}};var v={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const m={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var g,E,M,b,y={__proto__:null,AUTO:z,EVENTS:w,EASING:u,AR_SESSION_TYPE:v,SCENE_VIEWER_MODE:m,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},ERROR_CODES:r};class V{constructor(e){this._defaultRenderLoop=e=>{const t=this._view3D,{scene:s,camera:i,control:o,autoPlayer:r,animator:n}=t;var a=1e3*e;n.update(e),o.update(a),r.update(a),t.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:t,delta:a}),i.updatePosition(),this._renderer.render(s.root,i.threeCamera),t.trigger(w.RENDER,{type:w.RENDER,target:t,delta:a})},this._view3D=e,this._canvas=((e,t)=>{t=e.querySelector(t);if(!t)throw new L(A.CANVAS_NOT_FOUND,D.CANVAS_NOT_FOUND);return t})(e.rootEl,e.canvasSelector);const t=new f.WebGLRenderer({canvas:this._canvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!0});t.toneMapping=f.LinearToneMapping,t.toneMappingExposure=e.exposure,t.outputEncoding=f.sRGBEncoding,this._renderer=t,this._clock=new f.Clock(!1),this.enableShadow()}get canvas(){return this._canvas}get context(){return this._renderer.context}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new f.Vector2);return{width:e.width,height:e.y}}resize(){const e=this._renderer;var t=this._canvas;e.xr.isPresenting||(e.setPixelRatio(window.devicePixelRatio),e.setSize(t.offsetWidth,t.offsetHeight,!1))}setAnimationLoop(i){this._clock.start(),this._renderer.setAnimationLoop((e,t)=>{var s=this._clock.getDelta();i(s,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}enableShadow(){const e=this._renderer;e.shadowMap.enabled=!0,e.shadowMap.type=f.PCFSoftShadowMap}disableShadow(){const e=this._renderer;e.shadowMap.enabled=!1}}class O{constructor(e){this._renderer=e}load(i){return new Promise((e,t)=>{const s=new f.TextureLoader;s.load(i,e,void 0,t)})}loadEquirectagularTexture(i){return new Promise((t,e)=>{const s=new f.TextureLoader;s.load(i,e=>{t(this._equirectToCubemap(e))},void 0,e)})}loadCubeTexture(i){return new Promise((e,t)=>{const s=new f.CubeTextureLoader;s.load(i,e,void 0,t)})}loadHDRTexture(i){return new Promise((t,e)=>{const s=new o.RGBELoader;s.setCrossOrigin("anonymous"),s.load(i,e=>{t(this._equirectToCubemap(e))},void 0,e)})}_equirectToCubemap(e){const t=new f.PMREMGenerator(this._renderer.threeRenderer);e=t.fromEquirectangular(e);return t.compileCubemapShader(),e}}const T=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap"],R={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"};(r=g=g||{})[r.NONE=0]="NONE",r[r.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",r[r.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",r[r.ONE_FINGER=3]="ONE_FINGER",r[r.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",r[r.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",r[r.TWO_FINGER=12]="TWO_FINGER",r[r.PINCH=16]="PINCH";const S={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",LOAD:"load",ERROR:"error"};(r=E=E||{})[r.LEFT=0]="LEFT",r[r.MIDDLE=1]="MIDDLE",r[r.RIGHT=2]="RIGHT";const x=Number.MAX_SAFE_INTEGER||9007199254740991;class P{constructor(e,{opacity:t=.3,hardness:s=6,yaw:i=0,pitch:o=0}={}){this._hardness=s,this._yaw=i,this._pitch=o,this._geometry=new f.PlaneBufferGeometry(2,2),this._material=new f.ShadowMaterial({opacity:t,fog:!1}),this._mesh=new f.Mesh(this._geometry,this._material),this._light=new f.DirectionalLight,this._baseLightPos=new f.Vector3,this._modelRadius=0;const r=this._mesh;r.rotateX(-Math.PI/2),r.scale.setScalar(Math.pow(2,32)-1),r.receiveShadow=!0,r.castShadow=!1,r.name="ShadowPlane-Mesh";const n=this._light;n.intensity=0,n.target=r,n.castShadow=!0,n.name="ShadowPlane-Light";e=e.renderer.threeRenderer.capabilities.maxTextureSize;this._maxHardness=Math.round(Math.log(e)/Math.log(2)),this._updateSoftnessLevel()}get mesh(){return this._mesh}get light(){return this._light}get opacity(){return this._material.opacity}get hardness(){return this._hardness}get yaw(){return this._yaw}get pitch(){return this._pitch}set opacity(e){this._material.opacity=e}update(e){this._updatePlane(e),this._updateLightPosition(e),this.updateShadow()}updateShadow(e=1){const t=this._light;const s=t.shadow.camera;var i=this._modelRadius;t.position.copy(this._baseLightPos.clone().multiplyScalar(e));i*=1.5*e;s.near=0,s.far=x,s.left=-i,s.right=i,s.top=i,s.bottom=-i,s.updateProjectionMatrix()}_updateSoftnessLevel(){const e=this._light;var t=_(Math.floor(this._hardness),1,this._maxHardness),t=Math.pow(2,t);e.shadow.mapSize.set(t,t)}_updatePlane(e){const t=this._mesh,s=e.bbox;e=[s.min.x,s.min.z,s.max.x,s.max.z].map(e=>Math.abs(e)),e=Math.max(...e);t.scale.setScalar(100*e)}_updateLightPosition(e){var t=this._yaw,s=this._pitch,e=e.bbox.getBoundingSphere(new f.Sphere).radius,s=d(2*e+.1,t,90-s);this._baseLightPos.copy(s),this._modelRadius=e}}class U{constructor(e){this._view3D=e,this._root=new f.Scene,this._userObjects=new f.Group,this._envObjects=new f.Group,this._fixedObjects=new f.Group,this._shadowPlane=new P(e,N(e.shadow));const t=this._root,s=this._userObjects,i=this._envObjects,o=this._fixedObjects;var r=this._shadowPlane;s.name="userObjects",i.name="envObjects",o.name="fixedObjects",t.add(s,i,o),e.shadow&&o.add(r.mesh,r.light)}get root(){return this._root}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const s=t?this._userObjects:this._envObjects;e=Array.isArray(e)?e:[e];s.add(...e)}remove(e){e=Array.isArray(e)?e:[e];this._root.remove(...e)}setBackground(i){return p(this,void 0,void 0,function*(){const e=this._root;if("number"==typeof i||"#"===i.charAt(0))e.background=new f.Color(i);else{const t=new O(this._view3D.renderer),s=yield t.load(i);s.encoding=f.sRGBEncoding,e.background=s}})}setSkybox(i){return p(this,void 0,void 0,function*(){const e=this._root;if(i){const s=new O(this._view3D.renderer);var t=yield s.loadHDRTexture(i);e.background=t.texture,e.environment=t.texture}else e.background=null,e.environment=null})}setEnvMap(s){return p(this,void 0,void 0,function*(){if(s){const t=new O(this._view3D.renderer);var e=yield t.loadHDRTexture(s);this._root.environment=e.texture}else this._root.environment=null})}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e;t.geometry.dispose();const s=Array.isArray(t.material)?t.material:[t.material];s.forEach(t=>{T.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}class C{constructor(e,t,s,i=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=s,this.pivot=(new f.Vector3).fromArray(i)}clone(){return new C(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}}const F=u.EASE_OUT_CUBIC,G=300,H={min:0,max:1},k=new C(0,15,0,[0,0,0]),B={min:-1/0,max:1/0},W={min:-89.9,max:89.9},j=[v.WEBXR,v.SCENE_VIEWER,v.QUICK_LOOK];class Y{constructor({duration:e=G,loop:t=!1,range:s=H,easing:i=F}={}){this._duration=e,this._loop=t,this._range=s,this._easing=i,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,s=this._end,i=this._duration,o=this._val,r=this._loop,i=this._progress+e/i;this._progress=(r?a:_)(i,0,1);i=this._easing(this._progress);return this._val=n(t,s,i),!r&&1<=this._progress&&(this._activated=!1),this._val-o}reset(e){var t=this._range,t=_(e,t.min,t.max);this._start=t,this._end=t,this._val=t,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=_(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class X{constructor(e,t,s,{duration:i=G,easing:o=F}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,t=t.clone(),s=s.clone(),t.yaw=a(t.yaw,0,360),s.yaw=a(s.yaw,0,360),180<Math.abs(s.yaw-t.yaw)&&(s.yaw=s.yaw<t.yaw?s.yaw+360:s.yaw-360),this._motion=new Y({duration:i,range:H,easing:o}),this._from=t,this._to=s}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}update(e){if(this._enabled){const s=this._view3D.camera,i=this._from;var t=this._to;const o=this._motion;o.update(e);e=o.val;s.yaw=n(i.yaw,t.yaw,e),s.pitch=n(i.pitch,t.pitch,e),s.zoom=n(i.zoom,t.zoom,e),s.pivot=i.pivot.clone().lerp(t.pivot,e),1<=e&&(this.disable(),this._finishCallbacks.forEach(e=>e()))}}enable(){this._enabled||(this._enabled=!0,this._motion.reset(0),this._motion.setEndDelta(1))}disable(){this._enabled&&(this._enabled=!1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class q{constructor(e){this._distance=0,this._baseFov=45,this._defaultPose=k,this._currentPose=this._defaultPose.clone(),this._view3D=e,this._threeCamera=new f.PerspectiveCamera,this._maxTanHalfHFov=0,this._defaultPose=new C(e.yaw,e.pitch,0),this._currentPose=this._defaultPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get pose(){return this._currentPose}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this._distance*Math.tan(c(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._currentPose.yaw=e}set pitch(e){this._currentPose.pitch=e}set zoom(e){this._currentPose.zoom=e}set pivot(e){this._currentPose.pivot=e}reset(n=0,a=F){return p(this,void 0,void 0,function*(){const t=this._view3D,s=t.control;var e=this._currentPose;const i=this._defaultPose;if(n<=0)return this._currentPose=i.clone(),s.sync(),Promise.resolve();{const o=new X(t,e,i);o.duration=n,o.easing=a,o.enable(),s.disable();const r=e=>{o.update(e.delta)};return t.on(w.BEFORE_RENDER,r),new Promise(e=>{o.onFinished(()=>{s.sync(),s.enable(),t.off(w.BEFORE_RENDER,r),e()})})}})}resize({width:e,height:t}){const s=this._threeCamera;var i=this._view3D.fov;s.aspect=e/t,i===z?this._applyEffectiveFov(45):this._baseFov=i}fit(e,t){var s=this._view3D;const i=this._threeCamera,o=s.control,r=this._defaultPose,n=e.bbox;var a=s.fov,s=a===z?45:a;const h=Array.isArray(t)?(new f.Vector3).fromArray(t):n.getCenter(new f.Vector3);t=e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(h)),0),t=Math.sqrt(t);const l=t/Math.sin(c(s/2));e=e.reduceVertices((e,t)=>{var s=(new f.Vector3).subVectors(t,h),t=Math.sqrt(s.x*s.x+s.z*s.z);return Math.max(e,t/(l-Math.abs(s.y)))},0);a===z?(this._maxTanHalfHFov=e,this._applyEffectiveFov(s)):this._maxTanHalfHFov=a,r.pivot=h.clone(),this._distance=l,i.near=.1*(l-t),i.far=10*(l+t),o.zoom.updateRange()}updatePosition(){var e=this._view3D["control"];const t=this._threeCamera,s=this._currentPose;var i=this._distance,o=this._baseFov,e=e.zoom.range;s.yaw=a(s.yaw,0,360),s.pitch=_(s.pitch,W.min,W.max),s.zoom=_(o+s.zoom,e.min,e.max)-o;const r=d(i,s.yaw,s.pitch);o=s.zoom+o;r.add(s.pivot),t.fov=o,t.position.copy(r),t.lookAt(s.pivot),t.updateProjectionMatrix()}_applyEffectiveFov(e){const t=this._threeCamera;e=Math.tan(c(e/2)),e*=Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=180*(2*Math.atan(e))/Math.PI,t.updateProjectionMatrix()}}class Q{constructor(e){this._onResize=()=>{this._view3d.resize()},this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const t=new ResizeObserver(this._onResize);t.observe(e.renderer.canvas),this._resizeObserver=t}else e.resize(),window.addEventListener(S.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(S.RESIZE,this._onResize),this._enabled=!1,this}}class Z{constructor(e){this._mixer=new f.AnimationMixer(e),this._clips=[],this._actions=[]}get clips(){return this._clips}get mixer(){return this._mixer}setClips(e){const t=this._mixer;this._clips=e,this._actions=e.map(e=>t.clipAction(e))}play(e){const t=this._actions[e];t&&t.play()}pause(e){const t=this._actions[e];t&&(t.timeScale=0)}resume(e){const t=this._actions[e];t&&(t.timeScale=1)}stop(e){const t=this._actions[e];t&&t.stop()}update(e){this._mixer.update(e)}reset(){const e=this._mixer;e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}}class K extends e{constructor({context:e=window,repeat:t=0,duration:s=G,easing:i=u.EASE_OUT_CUBIC}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration;this._time+=e;var s=Math.floor(this._time/t);this._time=a(this._time,0,t);var t=this._time/t,i={progress:t,easedProgress:this._easing(t)};this.trigger("progress",i);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>this._repeat)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},i),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=s,this._easing=i,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const $={AR:"immersive-ar",VR:"immersive-vr"},J={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},ee={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend"},te={TOUCH:"generic-touchscreen"},se={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{}},ie={},oe={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class re{constructor({scale:e=1}={}){this.rotation=new f.Quaternion,this._axis=new f.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new f.Vector2,this._fromQuat=new f.Quaternion,this._toQuat=new f.Quaternion,this._motion=new Y({range:B}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:s}){if(this._active&&1===s.length){const i=this._prevPos,o=this._motion;s=s[0];const r=e.modelMovable.getWorldPosition(new f.Vector3);e=((e,t,s)=>{const i=(new f.Vector2).subVectors(t,e).normalize(),o=(new f.Vector2).subVectors(s,e).normalize();s=o.angle()-i.angle(),e=-Math.sign(s)*(2*Math.PI-Math.abs(s));return Math.abs(s)<Math.abs(e)?s:e})((new f.Vector2).fromArray(r.project(t).toArray()),i,s)*this._userScale,t=(new f.Quaternion).setFromAxisAngle(this._axis,e),e=this._getInterpolatedQuaternion();this._fromQuat.copy(e),this._toQuat.premultiply(t),o.reset(0),o.setEndDelta(1),i.copy(s)}}update({scene:e},t){if(this._active){const s=this._motion;s.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,s=this._fromQuat,e=e.val;return(new f.Quaternion).copy(s).slerp(t,e)}}(r=M=M||{})[r.WAITING=0]="WAITING",r[r.TRANSLATING=1]="TRANSLATING",r[r.BOUNCING=2]="BOUNCING";class ne{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:s=u.EASE_OUT_BOUNCE}={}){this._hoverPosition=new f.Vector3,this._floorPosition=new f.Vector3,this._wallRotation=new f.Quaternion,this._dragPlane=new f.Plane,this._enabled=!1,this._vertical=!1,this._state=M.WAITING,this._initialPos=new f.Vector2,this._hoverHeight=e,this._bounceMotion=new Y({duration:t,easing:s,range:B})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=M.TRANSLATING}}deactivate(){if(this._enabled&&!this._vertical&&this._state!==M.WAITING){this._state=M.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const s=this._bounceMotion;e=t.y-e.y;s.reset(e),s.setEndDelta(-e)}else this._state=M.WAITING}init(e,t,s){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=s?new f.Vector3(0,1,0).applyQuaternion(t):new f.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=s}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:s},{hitResults:i}){var o=this._state,r=o===M.WAITING||o===M.BOUNCING;if(i&&1===i.length&&!r){const _=i[0];var n=this._floorPosition.clone();const d=this._floorPosition,u=this._hoverPosition;var a=this._hoverHeight;const p=this._dragPlane;var h=this._vertical,l=_.results[0]&&_.results[0].getPose(t),o=l&&(new f.Matrix4).fromArray(l.transform.matrix),r=l&&.75<o.elements[5],i=l&&o.elements[5]<.25,s=(new f.Vector3).setFromMatrixPosition(s.matrixWorld),o=l&&(new f.Vector3).setFromMatrixPosition(o);if(h)if(!e||l&&i){const v=new f.Vector3(0,1,0);h=l.transform.orientation,i=v.clone().applyQuaternion(new f.Quaternion(h.x,h.y,h.z,h.w)).normalize(),h=(new f.Vector3).crossVectors(new f.Vector3(0,1,0),i);const m=new f.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(m.dot(i)))>=Math.PI/18){var c=(new f.Matrix4).makeBasis(h,v,i);const E=new f.Euler(0,0,0,"YXZ").setFromRotationMatrix(c);E.z=0,E.x=Math.PI/2,this._wallRotation.setFromEuler(E),p.normal.copy(new f.Vector3(0,1,0).applyQuaternion(this._wallRotation)),p.constant=this._calcDragPlaneConstant(o)}c=(new f.Vector3).subVectors(o,s).normalize();const g=new f.Ray(s,c);c=g.intersectPlane(p,new f.Vector3);c&&d.copy(c)}else{c=e.getPose(_.inputSource.targetRaySpace,t);if(!c)return;c=c.transform.position;const w=new f.Vector3(c.x,c.y,c.z);c=w.sub(s).normalize();const b=new f.Ray(s,c);c=b.intersectPlane(p,new f.Vector3);c&&d.copy(c)}else if(!e||l&&r){r=-p.constant,a=o.y+a;.1<a-r&&(p.constant=-a);a=(new f.Vector3).subVectors(o,s).normalize();const y=new f.Ray(s,a);a=y.intersectPlane(p,new f.Vector3);a&&(d.copy(a),d.setY(o.y),u.copy(a))}else{t=e.getPose(_.inputSource.targetRaySpace,t);if(!t)return;t=t.transform.position;const O=new f.Vector3(t.x,t.y,t.z);t=O.sub(s).normalize();const T=new f.Ray(s,t);t=T.intersectPlane(p,new f.Vector3);t&&(d.copy(t),d.setY(n.y),u.copy(t))}}}update({scene:e},t){var s=this._state,i=this._floorPosition;const o=this._hoverPosition,r=this._bounceMotion;var n=this._vertical;s===M.BOUNCING&&(r.update(t),o.setY(i.y+r.val),1<=r.progress&&(this._state=M.WAITING)),e.setRootPosition(i),n?e.setWallRotation(this._wallRotation):e.setModelHovering(o.y-i.y)}_calcDragPlaneConstant(e){var t=this._vertical,s=this._dragPlane.normal.clone();const i=new f.Plane(s,0);t=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+t)}}class ae{constructor({width:e=.1,padding:t=20,offset:s=.05,font:i="64px sans-serif",color:o="white"}={}){const r=document.createElement("canvas"),n=r.getContext("2d");n.font=i;var a=n.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,l=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,a=(e=>{let t=1;for(;t<e;)t*=2;return t})(h);r.width=a;a=e*((r.height=a)/h);this._ctx=n,this._canvas=r,this._height=a*l/h,this._texture=new f.CanvasTexture(r);a=new f.PlaneGeometry(a,a),a=new f.Mesh(a,new f.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=i,this._color=o,this._padding=t,this._offset=s,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,s){const i=this._mesh;s=this._height/2+this._offset+s,e=new f.Vector3(0,s,0).applyQuaternion(e.clone().invert());i.position.copy(e),i.lookAt(t)}updateScale(e){const t=this._ctx;var s=this._canvas,i=this._padding,o=(100*e).toFixed(0);t.clearRect(0,0,s.width,s.height);var r=s.width/2,n=s.height/2,a=t.measureText(o+"%"),s=(a.actualBoundingBoxLeft+a.actualBoundingBoxRight)/2,a=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(r-s,n-a-i),t.lineTo(r+s,n-a-i),t.quadraticCurveTo(r+s+i,n-a-i,r+s+i,n-a),t.lineTo(r+s+i,n+a),t.quadraticCurveTo(r+s+i,n+a+i,r+s,n+a+i),t.lineTo(r-s,n+a+i),t.quadraticCurveTo(r-s-i,n+a+i,r-s-i,n+a),t.lineTo(r-s-i,n-a),t.quadraticCurveTo(r-s-i,n-a-i,r-s,n-a-i),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(o+"%",r,n),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class he{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new ae,this._motion=new Y({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new ae}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:s,xrCam:i,initialScale:o}){const r=this._motion;var n=r.range;if(o===z){var a=2*Math.atan(1/i.projectionMatrix.elements[5]),h=i.projectionMatrix.elements[0]/i.projectionMatrix.elements[5];const c=i.position;i=t.bbox.max.y-t.bbox.min.y,a=c.distanceTo((new f.Vector3).addVectors(s,new f.Vector3(0,i/2,0)))*Math.tan(a/2),h=a*h,t=t.bbox.getBoundingSphere(new f.Sphere),a=a/t.radius,t=h/t.radius;const l=_(Math.min(t,a),n.min,1);r.reset(l)}else r.reset(_(o,n.min,n.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new f.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const i=this._motion;var s=(new f.Vector2).subVectors(t[0],t[1]).length(),t=s-this._prevCoordDistance;i.setEndDelta(t),this._prevCoordDistance=s,this._updateUIPosition(e)}}update({view3D:e,scene:t},s){if(this._enabled&&this._active){const i=this._motion;i.update(s),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),t.setModelScale(this._scaleMultiplier),e.scene.shadowPlane.updateShadow(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:s,vertical:i}){const o=e.model;s=(new f.Vector3).setFromMatrixPosition(s.matrixWorld),i=i?o.bbox.getBoundingSphere(new f.Sphere).radius:o.bbox.max.y-o.bbox.min.y;this._ui.updatePosition(t.root.quaternion,s,i)}}class le{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:s=1e3}={}){var i=Math.PI/18;const o=new f.RingGeometry(.975,1,150,1,-6*i,30*i),r=new f.CircleGeometry(.1,30,0,2*Math.PI);o.rotateX(-Math.PI/2),r.rotateX(-Math.PI/2);const n=new f.RingGeometry(.96,1.015,30,1,25*i,4*i),a=n.attributes["position"];var h=Math.floor(11*a.count/16),l=Math.floor(13*a.count/16),c=Math.floor((l-h+1)/2),_=(new f.Vector3).fromBufferAttribute(a,h).y;for(let e=h;e<l;e++){var d=e-h,d=.025*(c-Math.abs(d-c));a.setY(e,_-d)}n.rotateX(-Math.PI/2);var u=new f.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),p=new f.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),i=new f.Mesh(o,u),u=new f.Mesh(r,u),p=new f.Mesh(n,p);const v=new f.Group;v.add(i,u,p),v.position.setY(1e-4),this._mesh=v,this._ring=i,this._reticle=u,this._arrow=p,this._animator=new Y({duration:s}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new f.Sphere).radius)}update({delta:e,rotation:t}){const s=this._mesh,i=this._animator;if(s.visible){i.update(e);const o=this._ring.material,r=this._arrow.material;e=this._opacityRange;o.opacity=i.val*e.min,r.opacity=i.val*e.max,i.val<=0&&(s.visible=!1),s.quaternion.copy(t),s.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(r=b=b||{})[r.WAITING=0]="WAITING",r[r.IN_DEADZONE=1]="IN_DEADZONE",r[r.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class ce{constructor({size:e=.1}={}){this._state=b.WAITING,this._detectedGesture=g.NONE,this._testingGestures=g.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new f.Vector2,this._prevTwoFingerPos=new f.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===b.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new f.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new f.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=b.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,g.NONE)}cleanup(){this._testingGestures=g.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=g.NONE,this._state=b.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,s=this._size,i=this._testingGestures,o=this._lastFingerCount,r=e.length;if(t===b.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=r,this.applyScreenAspect(e),r!==o)return this.setFirstInput(e),g.NONE;if(1===r){var o=e[0],n=this._prevOneFingerPos.clone();const a=(new f.Vector2).subVectors(o,n);a.length()>s&&(Math.abs(a.x)>Math.abs(a.y)?g.ONE_FINGER_HORIZONTAL&i&&(this._detectedGesture=g.ONE_FINGER_HORIZONTAL):g.ONE_FINGER_VERTICAL&i&&(this._detectedGesture=g.ONE_FINGER_VERTICAL))}else if(2===r){n=(new f.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),r=this._prevTwoFingerPos.clone();const h=(new f.Vector2).subVectors(n,r);h.length()>s&&(Math.abs(h.x)>Math.abs(h.y)?g.TWO_FINGER_HORIZONTAL&i&&(this._detectedGesture=g.TWO_FINGER_HORIZONTAL):g.TWO_FINGER_VERTICAL&i&&(this._detectedGesture=g.TWO_FINGER_VERTICAL));e=(new f.Vector2).subVectors(e[1],e[0]).length();Math.abs(e-this._initialTwoFingerDistance)>s&&g.PINCH&i&&(this._detectedGesture=g.PINCH)}return this._detectedGesture!==g.NONE&&(this._state=b.OUT_OF_DEADZONE),this._detectedGesture}}class _e{constructor(e,t,{rotate:s,translate:i,scale:o,ring:r,deadzone:n,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var s=this._view3D,i=this._arScene,o=this._hitTestSource;const r=this._deadzoneChecker;var n=this._rotateControl,a=this._translateControl,h=this._scaleControl;const l=s.renderer.threeRenderer;var c=l.xr.getCamera(new f.PerspectiveCamera),e=l.xr.getReferenceSpace();if(o&&!(c.cameras.length<=0)){c=c.cameras[0];const _=s.model;n.enabled&&r.addTestingGestures(g.ONE_FINGER),a.enabled&&r.addTestingGestures(g.ONE_FINGER),h.enabled&&r.addTestingGestures(g.PINCH);h=t.getHitTestResultsForTransientInput(o),o=this._hitResultToVector(h);if(r.applyScreenAspect(o),r.setFirstInput(o),1===o.length){e=t.getPose(h[0].inputSource.targetRaySpace,e);if(e){c=(new f.Vector3).setFromMatrixPosition(c.matrixWorld),e=e.transform.position,e=new f.Vector3(e.x,e.y,e.z).sub(c).normalize();const d=new f.Ray(c,e),u=_.bbox.getBoundingSphere(new f.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new f.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=s,this._translate=i,this._scale=o,this._initialScale=a,this._rotateControl=new re(N(s)),this._translateControl=new ne(N(i)),this._scaleControl=new he(N(o)),this._floorIndicator=new le(r),this._deadzoneChecker=new ce(n)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:r,session:n,size:a,vertical:h,hitPosition:l,hitRotation:c}){return p(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var s=this._scaleControl,i=this._floorIndicator;const o=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),o.setAspect(a.height/a.width),e.add(i.mesh,s.ui.mesh),this.syncTargetModel(r);s=yield n.requestHitTestSourceForTransientInput({profile:te.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(ee.SELECT_START,this._onSelectStart),e.removeEventListener(ee.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,s=this._translate,i=this._scale;const o=this._rotateControl,r=this._translateControl,n=this._scaleControl;var a=this._vertical;e.addEventListener(ee.SELECT_START,this._onSelectStart),e.addEventListener(ee.SELECT_END,this._onSelectEnd),t&&!a&&o.enable(),s&&r.enable(),i&&n.enable()}disable(e){const t=this._rotateControl,s=this._translateControl,i=this._scaleControl;e.removeEventListener(ee.SELECT_START,this._onSelectStart),e.removeEventListener(ee.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),s.disable(),i.disable()}update(e){const{view3D:t,session:s,frame:i}=e;var o,r,n=this._hitTestSource;n&&t.model&&(o=this._deadzoneChecker,r=s.inputSources,n=null!==(n=null===i||void 0===i?void 0:i.getHitTestResultsForTransientInput(n))&&void 0!==n?n:[],n={coords:this._hitResultToVector(n),inputSources:r,hitResults:n},o.inDeadzone?this._checkDeadzone(e,n):this._processInput(e,n),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,s=this._translateControl.floorPosition,i=this._view3D.renderer.threeRenderer.xr.getCamera(new f.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:s,xrCam:i,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var s=this._arScene;const i=this._rotateControl,o=this._translateControl,r=this._scaleControl;var n=this._deadzoneChecker.check(t.map(e=>e.clone()));if(n!==g.NONE)switch(n){case g.ONE_FINGER_HORIZONTAL:case g.ONE_FINGER_VERTICAL:this._modelHit?(o.activate(),o.setInitialPos(t)):(i.activate(),i.updateRotation(s.modelMovable.quaternion),i.setInitialPos(t));break;case g.PINCH:r.activate(e),r.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const s=this._arScene,i=this._rotateControl,o=this._translateControl,r=this._scaleControl,n=this._floorIndicator;var a=1e3*t;i.update(e,a),o.update(e,a),r.update(e,a);t=i.rotation,e=o.floorPosition;s.setRootPosition(e),n.update({delta:a,rotation:t})}_hitResultToVector(e){return e.map(e=>(new f.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class de{constructor(){this._root=new f.Scene,this._modelRoot=new f.Group,this._modelMovable=new f.Group,this._modelFixed=new f.Group,this._arRoot=new f.Group;const e=this._root,t=this._modelRoot;var s=this._modelMovable,i=this._modelFixed,o=this._arRoot;t.add(s),e.add(t,i,o)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,s=this._modelMovable,i=this._modelFixed;e=e.scene;s.add(e.userObjects,e.envObjects),i.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,s=this._modelFixed;const i=e.scene;[...t.children,...s.children].forEach(e=>{i.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const s=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,s.position.setZ(t/2),s.position.setY(-e.bbox.min.z),s.rotateX(-Math.PI/2),s.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class ue{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,se.DOM_OVERLAY(e)}}class pe{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(J.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return se.HIT_TEST}getResults(e){return null!==(e=null==e?void 0:e.getHitTestResults(this._source))&&void 0!==e?e:[]}}class ve{constructor(e,{features:t=ie,vertical:s=!1,overlayRoot:i=null,rotate:o=!0,translate:r=!0,scale:n=!0,ring:a={},deadzone:h={},initialScale:l=z}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=s,this.overlayRoot=i,this._arScene=new de,this._control=new _e(e,this._arScene,{rotate:o,translate:r,scale:n,ring:a,deadzone:h,initialScale:l}),this._hitTest=new pe,this._domOverlay=new ue}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&pe.isAvailable()&&ue.isAvailable()?navigator.xr.isSessionSupported($.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}enter(){return p(this,void 0,void 0,function*(){const a=this._view3D,h=this._arScene,t=a.renderer,l=t.threeRenderer,c=this._control,e=this._hitTest,s=this._domOverlay,_=this.vertical;var i=this._getAllXRFeatures();l.xr.enabled=!0;const d=yield navigator.xr.requestSession($.AR,i),o=l.getPixelRatio();l.setPixelRatio(1),l.xr.setReferenceSpaceType(J.LOCAL),yield l.xr.setSession(d),h.init(a),e.init(d);d.addEventListener("end",()=>p(this,void 0,void 0,function*(){var e=s.root;c.destroy(d),h.destroy(a),!this.overlayRoot&&e&&a.rootEl.removeChild(e),s.destroy(),a.scene.shadowPlane.updateShadow(),l.setPixelRatio(o),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),a.trigger(w.AR_END,{target:a,type:w.AR_END,session:this})}),{once:!0});const u=new f.Clock;u.start(),t.stopAnimationLoop(),l.xr.setAnimationLoop((e,t)=>{var s,i,o,r=l.xr.getCamera(new f.PerspectiveCamera),n=u.getDelta();r.cameras.length<=0||(s=r.cameras[0],i=l.xr.getReferenceSpace(),o={width:null!==(r=null==(o=d.renderState.baseLayer)?void 0:o.framebufferWidth)&&void 0!==r?r:1,height:null!==(o=null==o?void 0:o.framebufferHeight)&&void 0!==o?o:1},i={view3D:a,scene:h,session:d,delta:n,frame:t,vertical:_,referenceSpace:i,xrCam:s,size:o},o=1e3*n,a.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:a,delta:o}),this._modelPlaced?(c.update(i),a.animator.update(n),l.render(h.root,s)):this._initModelPosition(i),a.trigger(w.RENDER,{type:w.RENDER,target:a,delta:o}))}),a.trigger(w.AR_START,{type:w.AR_START,target:a,session:this})})}exit(){return p(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!==(t=I(this.overlayRoot))&&void 0!==t?t:this._createARRootElement();return h({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:s,size:i,vertical:o,referenceSpace:r}=e,n=this._view3D;var a=n.model;const h=this._arScene,l=this._hitTest;if(l.ready&&a){const d=this._control;var c=l.getResults(t);if(!(c.length<=0)){const u=c[0];var _=u.getPose(r);if(_){e=(new f.Matrix4).fromArray(_.transform.matrix);if(!(!o&&e.elements[5]<.75||o&&(.25<=e.elements[5]||e.elements[5]<=-.25))){c=(new f.Vector3).setFromMatrixPosition(e);const p=new f.Quaternion;if(o){const g=new f.Vector3(0,1,0);e=_.transform.orientation,_=g.clone().applyQuaternion(new f.Quaternion(e.x,e.y,e.z,e.w)).normalize(),e=(new f.Vector3).crossVectors(new f.Vector3(0,1,0),_),_=(new f.Matrix4).makeBasis(e,g,_);const E=new f.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);E.z=0,E.x=Math.PI/2,p.setFromEuler(E),h.setWallRotation(p)}h.updateModelRootPosition(a,o),h.setRootPosition(c),h.showModel(),l.destroy(),this._modelPlaced=!0,n.trigger(w.AR_MODEL_PLACED,{type:w.AR_MODEL_PLACED,target:n,session:this,model:a}),d.init({model:a,vertical:o,session:s,size:i,hitPosition:c,hitRotation:p});const v=d.scale.scale,m=new K({context:s,duration:1e3});m.on("progress",e=>{h.setModelScale(e.easedProgress*v)}),m.on("finish",()=>{h.setModelScale(v),d.enable(s)}),m.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement("div");return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(w.AR_END,()=>{e.rootEl.removeChild(t)}),t}}ve.type=v.WEBXR;class me{constructor(e,t={}){var{file:s=null,mode:i=m.ONLY_AR,fallbackURL:o=null,title:r=null,link:n=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=z,shareText:d=null}=t,t=function(e,t){var s={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(s[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(s[o[i]]=e[o[i]]);return s}(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=s,this.fallbackURL=o,this.mode=i,this.title=r,this.link=n,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var o;return p(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=l(this.resizable),t.enable_vertical_placement=l(this.vertical),t.disable_occlusion=l(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var s=null!==(o=this.file)&&void 0!==o?o:e.src;if(!s)return Promise.reject(new L(A.FILE_NOT_SUPPORTED(null!==(o=this.file)&&void 0!==o?o:e.src),D.FILE_NOT_SUPPORTED));t.file=new URL(s,window.location.href).href;e=this.fallbackURL,s=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),s=t.mode===m.ONLY_AR?oe.INTENT_AR_CORE(s,e):oe.INTENT_SEARCHBOX(s,e||oe.FALLBACK_DEFAULT(s));const i=document.createElement("a");i.href=s,i.click()})}exit(){return Promise.resolve()}}me.type=v.SCENE_VIEWER;class ge{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:s=null,applePayButtonType:i=null,callToAction:o=null,checkoutTitle:r=null,checkoutSubtitle:n=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=s,this.applePayButtonType=i,this.callToAction=o,this.checkoutTitle=r,this.checkoutSubtitle=n,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new L(A.FILE_NOT_SUPPORTED(""+e),D.FILE_NOT_SUPPORTED));var s=this.canonicalWebPageURL,i=this.custom,o=window.location.href;const r=document.createElement("a");r.setAttribute("rel","ar"),r.appendChild(document.createElement("img"));const n=Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,s])=>(s&&(e[t]=s),e),{}),a=new URL(e,o);return this.allowsContentScaling||(n.allowsContentScaling="0"),s&&(n.canonicalWebPageURL=new URL(s,o).href),i&&(n.custom=new URL(i,o).href),a.hash=new URLSearchParams(n).toString(),r.setAttribute("href",a.href),r.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(w.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:w.QUICK_LOOK_TAP,target:t}))},!1),r.click(),Promise.resolve()}exit(){return Promise.resolve()}}ge.type=v.QUICK_LOOK;const Ee={[v.WEBXR]:ve,[v.SCENE_VIEWER]:me,[v.QUICK_LOOK]:ge};class we{constructor(e){this._view3D=e,this._activeSession=null,e.on(w.AR_START,({session:e})=>{this._activeSession=e}),e.on(w.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return p(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return p(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new L(A.NOT_INITIALIZED,D.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const s=new t(e,N(e[t.type]));return yield s.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return p(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>Ee[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}const be={GRAB:"grab",GRABBING:"grabbing",NONE:""};class ye extends e{constructor(e,{duration:t=G,easing:s=F,scale:i=1}={}){super(),this._screenScale=new f.Vector2(0,0),this._prevPos=new f.Vector2(0,0),this._enabled=!1,this._onMouseDown=e=>{if(e.button===E.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(S.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(S.MOUSE_UP,this._onMouseUp,!1),this.trigger(R.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,s=new f.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);s.multiply(this._screenScale),this._xMotion.setEndDelta(s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(S.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(S.MOUSE_UP,this._onMouseUp,!1),this.trigger(R.RELEASE)},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY)},this._onTouchMove=e=>{if(!(1<e.touches.length||this._isScrolling)){var t=e.touches[0],s=this._view3D.scrollable;if(!s||e.cancelable){if(this._isFirstTouch){if(s){var i=new f.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._isScrolling=!0)}this._isFirstTouch=!1}!s&&e.cancelable&&e.preventDefault(),e.stopPropagation();const o=this._prevPos,r=new f.Vector2(t.clientX,t.clientY).sub(o).multiplyScalar(this._scale);r.multiply(this._screenScale),this._xMotion.setEndDelta(r.x),this._yMotion.setEndDelta(r.y),o.set(t.clientX,t.clientY)}}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):this._prevPos.set(0,0),this._isScrolling=!1},this._view3D=e,this._scale=i,this._duration=t,this._easing=s,this._isFirstTouch=!1,this._isScrolling=!1,this._xMotion=new Y({duration:t,range:B,easing:s}),this._yMotion=new Y({duration:t,range:W,easing:s})}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._xMotion,i=this._yMotion;e=new f.Vector2(s.update(e),i.update(e));t.yaw+=e.x,t.pitch+=e.y}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(S.MOUSE_DOWN,this._onMouseDown),e.addEventListener(S.TOUCH_START,this._onTouchStart,{passive:!0}),e.addEventListener(S.TOUCH_MOVE,this._onTouchMove,{passive:this._view3D.scrollable}),e.addEventListener(S.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(R.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(S.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(S.MOUSE_MOVE,this._onMouseMove),window.removeEventListener(S.MOUSE_UP,this._onMouseUp),e.removeEventListener(S.TOUCH_START,this._onTouchStart),e.removeEventListener(S.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(S.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(R.DISABLE)}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Oe extends e{constructor(e,{easing:t=F,duration:s=0,scale:i=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new f.Vector2(0,0),this._screenSize=new f.Vector2(0,0),this._onMouseDown=e=>{if(e.button===E.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(S.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(S.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(S.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(R.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var s=new f.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(S.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(S.MOUSE_UP,this._onMouseUp,!1),this.trigger(R.RELEASE)},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._prevPos;var t=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return s.copy(t),void(this._touchInitialized=!0);e=(new f.Vector2).subVectors(t,s).multiplyScalar(this._scale);this._xMotion.setEndDelta(-e.x),this._yMotion.setEndDelta(e.y),s.copy(t)}},this._onTouchEnd=e=>{2===e.touches.length?(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0):this._touchInitialized=!1},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(S.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new Y({duration:s,range:B,easing:t}),this._yMotion=new Y({duration:s,range:B,easing:t}),this._scale=i}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera;var s=this._screenSize;const i=new f.Vector2(this._xMotion.update(e),this._yMotion.update(e)),o=new f.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),r=new f.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);s=new f.Vector2(t.renderWidth,t.renderHeight).divide(s);i.multiply(s),t.pivot.add(o.multiplyScalar(i.x)),t.pivot.add(r.multiplyScalar(i.y))}resize(e){const t=this._screenSize;t.copy(new f.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(S.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(S.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(S.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(S.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(R.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(S.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(S.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(S.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(S.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(S.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(S.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(S.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(R.DISABLE)}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new f.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class Te{constructor(e,{scale:t=1,duration:s=G,minFov:i=1,maxFov:o=z,easing:r=F}={}){this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const s=this._motion;e=-this._scale*this._wheelModifier*e.deltaY;s.setEndDelta(e)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._motion;var s=this._prevTouchDistance;const o=new f.Vector2(t[0].pageX,t[0].pageY);e=new f.Vector2(t[1].pageX,t[1].pageY);const r=o.sub(e);t=r.length()*this._scale*this._touchModifier,e=t-s;this._prevTouchDistance=t,s<0||i.setEndDelta(e)}},this._onTouchEnd=()=>{this._prevTouchDistance=-1},this._view3D=e,this._scale=t,this._duration=s,this._minFov=i,this._maxFov=o,this._easing=r,this._range={min:i,max:o===z?180:o},this._motion=new Y({duration:s,easing:r})}get enabled(){return this._enabled}get range(){return this._range}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get easing(){return this._easing}set scale(e){this._scale=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._motion;t.zoom-=s.update(e)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(S.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(S.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(S.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync()}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(S.WHEEL,this._onWheel,!1),e.removeEventListener(S.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(S.TOUCH_END,this._onTouchEnd,!1),this._enabled=!1}}sync(){var e=this._view3D.camera;this._motion.reset(e.zoom)}updateRange(){var e=this._maxFov;const t=this._range,s=this._motion;var i=this._view3D["camera"],i=i.baseFov;e===z&&(t.max=Math.min(i+45,175)),s.range.min=t.min-i,s.range.max=t.max-i}}class fe{constructor(e){this._onEnable=()=>{var e=this._view3D,t=e.renderer.canvas;e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===be.NONE&&this._setCursor(be.GRAB)},this._onDisable=()=>{this._view3D.renderer.canvas.style.cursor===be.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(be.NONE)},this._onHold=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(be.GRABBING)},this._onRelease=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(be.GRAB)},this._view3D=e,this._rotateControl=new ye(e,N(e.rotate)),this._translateControl=new Oe(e,N(e.translate)),this._zoomControl=new Te(e,N(e.zoom)),[this._rotateControl,this._translateControl].forEach(e=>{e.on({[R.HOLD]:this._onHold,[R.RELEASE]:this._onRelease,[R.ENABLE]:this._onEnable,[R.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy()}update(e){this._rotateControl.update(e),this._translateControl.update(e),this._zoomControl.update(e)}resize(e){this._rotateControl.resize(e),this._translateControl.resize(e),this._zoomControl.resize(e)}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable()}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable()}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync()}updateCursor(){var e=this._view3D.useGrabCursor?be.GRAB:be.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===be.NONE){const s=t.renderer.canvas;s.style.cursor=e}}}class Me{constructor(e,{delay:t=2e3,delayOnMouseLeave:s=0,speed:i=1,pauseOnHover:o=!1,canInterrupt:r=!0,disableOnInterrupt:n=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{this._canInterrupt&&(e.button!==E.LEFT&&e.button!==E.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(S.MOUSE_UP,this._onMouseUp,!1)))},this._onMouseUp=()=>{window.removeEventListener(S.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=s,this._speed=i,this._pauseOnHover=o,this._canInterrupt=r,this._disableOnInterrupt=n}get enabled(){return this._enabled}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(S.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(S.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(S.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(S.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(S.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(S.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(S.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(S.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(S.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(S.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(S.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(S.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(S.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Re{constructor({src:e,scenes:t,animations:s=[],fixSkinnedBbox:i=!1,castShadow:o=!0,receiveShadow:r=!1}){this._src=e,this._scene=new f.Group,this._scene.add(...t),this._animations=s,this._bbox=this._getInitialBbox(i);i=this._bbox.min.y;this._scene.translateY(-i),this._bbox.translate(new f.Vector3(0,-i,0)),this.castShadow=o,this.receiveShadow=r}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(o,e){const t=this.meshes;let r=e;return t.forEach(t=>{var s=t.geometry.attributes["position"];if(s){t.updateMatrixWorld();for(let e=0;e<s.count;e++){const i=(new f.Vector3).fromBufferAttribute(s,e);i.applyMatrix4(t.matrixWorld),r=o(r,i)}}}),r}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new f.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const u=new f.Box3;return this.meshes.forEach(t=>{if(t.isSkinnedMesh){var e=t.geometry;const s=e.attributes.position,i=e.attributes.skinIndex,o=e.attributes.skinWeight,r=t.skeleton;r.update();const n=r.boneMatrices,a=new f.Matrix4;for(let e=0;e<s.count;e++){a.identity();const h=new f.Vector4;h.set(0,0,0,0);const l=new f.Vector4;l.set(s.getX(e),s.getY(e),s.getZ(e),1).applyMatrix4(t.bindMatrix);const c=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)],_=[i.getX(e),i.getY(e),i.getZ(e),i.getW(e)];c.forEach((e,t)=>{t=(new f.Matrix4).fromArray(n,16*_[t]);h.add(l.clone().applyMatrix4(t).multiplyScalar(e))});const d=(new f.Vector3).fromArray(h.applyMatrix4(t.bindMatrixInverse).toArray());d.applyMatrix4(t.matrixWorld),u.expandByPoint(d)}}else u.expandByObject(t)}),u}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}}const Se=new t.DRACOLoader,xe=new i.KTX2Loader;class Pe{constructor(e){this._view3D=e,this._loader=new s.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(Se),t.setKTX2Loader(xe.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(i){return p(this,void 0,void 0,function*(){return new Promise((e,t)=>{const s=document.createElement("script");s.addEventListener("load",()=>p(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,Pe.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(s),e()})),s.addEventListener("error",()=>{document.body.removeChild(s),t()}),s.src=new URL(i,location.href).href,document.body.appendChild(s)})})}load(i){const o=this._view3D,e=this._loader;return Se.setDecoderPath(o.dracoPath),xe.setTranscoderPath(o.ktxPath),Pe.meshoptDecoder&&e.setMeshoptDecoder(Pe.meshoptDecoder),new Promise((t,s)=>{try{e.load(i,e=>{e=this._parseToModel(e,i);t(e)},e=>{o.trigger(w.PROGRESS,Object.assign(Object.assign({},e),{target:o,type:w.PROGRESS}))},e=>{s(e)})}catch(e){s(e)}})}loadFromFiles(n){var e=this._view3D;const a=this._loader,h=[],l=()=>{h.forEach(e=>{URL.revokeObjectURL(e)})};return Se.setDecoderPath(e.dracoPath),xe.setTranscoderPath(e.ktxPath),Pe.meshoptDecoder&&a.setMeshoptDecoder(Pe.meshoptDecoder),new Promise((t,s)=>{if(n.length<=0)s(new Error("No files found"));else{const i=n.find(e=>/\.(gltf|glb)$/i.test(e.name));if(i){const o=new Map;n.forEach(e=>{o.set(e.name,e)});var e=URL.createObjectURL(i);h.push(e);const r=new f.LoadingManager;r.setURLModifier(e=>{var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";if(o.has(t)){t=o.get(t),t=URL.createObjectURL(t);return h.push(t),t}return e}),a.manager=r,a.load(e,e=>{e=this._parseToModel(e,i.name);t(e),l()},void 0,e=>{s(e),l()})}else s(new Error("No glTF file found"))}})}_parseToModel(e,t){var s=this._view3D.fixSkinnedBbox;return new Re({src:t,scenes:e.scenes,animations:e.animations,fixSkinnedBbox:s})}}v={__proto__:null,GLTFLoader:Pe,TextureLoader:O};class Ce extends e{constructor(e,{src:t=null,iosSrc:s=null,dracoPath:i="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:o="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:r=null,fixSkinnedBbox:n=!1,skybox:a=null,envmap:h=null,background:l=null,fov:c=z,center:_=z,yaw:d=0,pitch:u=0,rotate:p=!0,translate:v=!0,zoom:m=!0,exposure:g=1,shadow:E=!0,autoplay:w=!1,scrollable:b=!0,wheelScrollable:y=!1,useGrabCursor:O=!0,webAR:T=!0,sceneViewer:f=!0,quickLook:M=!0,arPriority:R=j,canvasSelector:S="canvas",autoInit:x=!0,autoResize:P=!0,useResizeObserver:C=!0}={}){super(),this._rootEl=((e,t)=>{t=I(e,t);if(!t)throw new L(A.WRONG_TYPE(e,["HTMLElement","string"]),D.WRONG_TYPE);return t})(e),this._src=t,this._iosSrc=s,this._dracoPath=i,this._ktxPath=o,this._meshoptPath=r,this._fixSkinnedBbox=n,this._fov=c,this._center=_,this._yaw=d,this._pitch=u,this._rotate=p,this._translate=v,this._zoom=m,this._autoplay=w,this._scrollable=b,this._wheelScrollable=y,this._useGrabCursor=O,this._skybox=a,this._envmap=h,this._background=l,this._exposure=g,this._shadow=E,this._webAR=T,this._sceneViewer=f,this._quickLook=M,this._arPriority=R,this._canvasSelector=S,this._autoInit=x,this._autoResize=P,this._useResizeObserver=C,this._renderer=new V(this),this._camera=new q(this),this._control=new fe(this),this._scene=new U(this),this._animator=new Z(this._scene.userObjects),this._autoPlayer=new Me(this,N(w)),this._autoResizer=new Q(this),this._arManager=new we(this),this._model=null,this._initialized=!1,t&&x&&this.init()}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}set skybox(e){this._scene.setSkybox(e),this._skybox=e}set envmap(e){this._scene.setEnvMap(e),this._envmap=e}set exposure(e){this._renderer.threeRenderer.toneMappingExposure=e,this._exposure=e}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}destroy(){this._scene.reset(),this._renderer.stopAnimationLoop(),this._control.destroy(),this._autoResizer.disable()}init(){return p(this,void 0,void 0,function*(){if(!this._src)throw new L(A.PROVIDE_SRC_FIRST,D.PROVIDE_SRC_FIRST);this._autoResize&&this._autoResizer.enable();const e=this._scene;var t=this._skybox,s=this._envmap,i=this._background,o=this._meshoptPath;o&&!Pe.meshoptDecoder&&(yield Pe.setMeshoptDecoder(o));const r=[this._loadModel(this._src)];t?r.push(e.setSkybox(t)):s&&r.push(e.setEnvMap(s)),!t&&i&&r.push(e.setBackground(i));var[i]=yield Promise.all(r);this._display(i),this._control.enable(),this._autoplay&&this._autoPlayer.enable(),this._initialized=!0,this.trigger(w.READY,{type:w.READY,target:this})})}resize(){this._renderer.resize();var e=this._renderer.size;this._camera.resize(e),this._control.resize(e),this.trigger(w.RESIZE,Object.assign(Object.assign({},e),{type:w.RESIZE,target:this}))}load(t){return p(this,void 0,void 0,function*(){var e;this._initialized?(e=yield this._loadModel(t),this._src=t,this._display(e)):(this._src=t,yield this.init())})}loadPlugins(...e){return p(this,void 0,void 0,function*(){return Promise.all(e.map(e=>e.init(this)))})}_loadModel(s){return p(this,void 0,void 0,function*(){const e=new Pe(this);var t=yield e.load(s);return this.trigger(w.LOAD,{type:w.LOAD,target:this,model:t}),t})}_display(e){const t=this._renderer,s=this._scene,i=this._camera,o=this._animator;var r=t.threeRenderer.xr.isPresenting;if(s.reset(),s.add(e.scene),s.shadowPlane.update(e),i.fit(e,this._center),i.reset(0),o.reset(),o.setClips(e.animations),0<e.animations.length&&o.play(0),this._model=e,r){const n=this._arManager.activeSession;n&&n.control.syncTargetModel(e)}else t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop);this.trigger(w.MODEL_CHANGE,{type:w.MODEL_CHANGE,target:this,model:e})}}Ce.VERSION="2.0.0";t={__proto__:null,Animation:K,ARManager:we,AutoPlayer:Me,AutoResizer:Q,Camera:q,Model:Re,ModelAnimator:Z,Motion:Y,Pose:C,Renderer:V,Scene:U,ShadowPlane:P,View3DError:L},i={__proto__:null,AnimationControl:X,OrbitControl:fe,RotateControl:ye,TranslateControl:Oe,ZoomControl:Te};class Le{init(e){return p(this,void 0,void 0,function*(){})}teardown(e){return p(this,void 0,void 0,function*(){})}}e={__proto__:null,ARButton:class extends Le{constructor(e={}){super(),this._options=e}init(e){return p(this,void 0,void 0,function*(){yield this._addButton(e)})}_addButton(r){return p(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser"}=this._options;const s=yield r.ar.isAvailable(),i=document.createElement("button"),o=document.createElement("div");t=document.createTextNode(s?e:t);i.classList.add("view3d-ar-button"),o.classList.add("view3d-tooltip"),i.disabled=!0,i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',i.appendChild(o),o.appendChild(t),r.rootEl.appendChild(i),r.initialized?yield this._setAvailable(r,i,s):r.once(w.MODEL_CHANGE,()=>{this._setAvailable(r,i,s)})})}_setAvailable(e,t,s){return p(this,void 0,void 0,function*(){s?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:class extends Le{constructor(e={}){super(),this._options=e}init(o){return p(this,void 0,void 0,function*(){o.on(w.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){if(this._cachedElements)Object.values(this._cachedElements).map(e=>{t.contains(e)||t.appendChild(e)});else{const s=document.createElement("div");s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',s.classList.add("view3d-ar-close"),t.appendChild(s),this._cachedElements={closeButton:s}}const s=this._cachedElements["closeButton"],i=()=>{e.exit()};s.addEventListener("click",i),o.once(w.AR_END,()=>{s.parentElement&&s.parentElement.removeChild(s),s.removeEventListener("click",i)})}})})}}};return h(Ce,t),h(Ce,i),h(Ce,v),h(Ce,e),h(Ce,y),Ce.View3DError=L,Ce});
