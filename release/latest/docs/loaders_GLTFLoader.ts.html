

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: loaders/GLTFLoader.ts</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">@egjs/view3d Documentation</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/naver/egjs-view3d" target="_blank">
                                Github
                            </a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="../../../" target="_blank">
                                Demo
                            </a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Tutorials</h3><ul><li><a href="tutorial-Adding Controls.html">Adding Controls</a></li><li><a href="tutorial-Adding Lights.html">Adding Lights</a></li><li><a href="tutorial-Adding Skybox and Envmap.html">Adding Skybox and Envmap</a></li><li><a href="tutorial-Displaying Shadows.html">Displaying Shadows</a></li><li><a href="tutorial-Handling Errors.html">Handling Errors</a></li><li><a href="tutorial-Loading a Model.html">Loading a Model</a></li><li><a href="tutorial-Playing Animations.html">Playing Animations</a></li></ul><h3>Namespaces</h3><ul><li><a href="EASING.html">EASING</a></li><li><a href="Constants.html">Constants</a></li></ul><h3>Classes</h3><ul><li><a href="Pose.html">Pose</a></li><li><a href="View3D.html">View3D</a></li></ul><h3>Interfaces</h3><ul><li><a href="FloorARSessionOption.html">FloorARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="Animation.html#event:progress">progress</a></li><li><a href="Animation.html#event:finish">finish</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AnyFunction">AnyFunction</a></li><li><a href="global.html#AnyObject">AnyObject</a></li></ul></div><div class="category"><h2>Controls</h2><h3>Classes</h3><ul><li><a href="AnimationControl.html">AnimationControl</a></li><li><a href="AutoControl.html">AutoControl</a></li><li><a href="DistanceControl.html">DistanceControl</a></li><li><a href="OrbitControl.html">OrbitControl</a></li><li><a href="RotateControl.html">RotateControl</a></li><li><a href="TranslateControl.html">TranslateControl</a></li></ul><h3>Interfaces</h3><ul><li><a href="CameraControl.html">CameraControl</a></li></ul></div><div class="category"><h2>Controls-AR</h2><h3>Classes</h3><ul><li><a href="ARFloorControl.html">ARFloorControl</a></li><li><a href="ARFloorTranslateControl.html">ARFloorTranslateControl</a></li><li><a href="ARHoverControl.html">ARHoverControl</a></li><li><a href="ARHoverRotateControl.html">ARHoverRotateControl</a></li><li><a href="ARHoverTranslateControl.html">ARHoverTranslateControl</a></li><li><a href="ArrowIndicator.html">ArrowIndicator</a></li><li><a href="ARScaleControl.html">ARScaleControl</a></li><li><a href="ARSwipeControl.html">ARSwipeControl</a></li><li><a href="ARSwirlControl.html">ARSwirlControl</a></li><li><a href="ARWallControl.html">ARWallControl</a></li><li><a href="ARWallTranslateControl.html">ARWallTranslateControl</a></li><li><a href="DeadzoneChecker.html">DeadzoneChecker</a></li><li><a href="FloorIndicator.html">FloorIndicator</a></li><li><a href="RotationIndicator.html">RotationIndicator</a></li><li><a href="ScaleUI.html">ScaleUI</a></li></ul><h3>Interfaces</h3><ul><li><a href="ScaleUIOption.html">ScaleUIOption</a></li><li><a href="RotationIndicatorOption.html">RotationIndicatorOption</a></li><li><a href="FloorIndicatorOption.html">FloorIndicatorOption</a></li><li><a href="DeadzoneCheckerOption.html">DeadzoneCheckerOption</a></li><li><a href="ARWallTranslateControlOption.html">ARWallTranslateControlOption</a></li><li><a href="ARWallControlOption.html">ARWallControlOption</a></li><li><a href="ARSwirlControlOption.html">ARSwirlControlOption</a></li><li><a href="ARSwipeControlOption.html">ARSwipeControlOption</a></li><li><a href="ARScaleControlOption.html">ARScaleControlOption</a></li><li><a href="ArrowIndicatorOption.html">ArrowIndicatorOption</a></li><li><a href="ARHoverTranslateControlOption.html">ARHoverTranslateControlOption</a></li><li><a href="ARHoverRotateControlOption.html">ARHoverRotateControlOption</a></li><li><a href="ARHoverControlOption.html">ARHoverControlOption</a></li><li><a href="ARFloorTranslateControlOption.html">ARFloorTranslateControlOption</a></li><li><a href="ARFloorControlOption.html">ARFloorControlOption</a></li><li><a href="ARControl.html">ARControl</a></li></ul></div><div class="category"><h2>Core</h2><h3>Classes</h3><ul><li><a href="Animation.html">Animation</a></li><li><a href="Camera.html">Camera</a></li><li><a href="Controller.html">Controller</a></li><li><a href="Model.html">Model</a></li><li><a href="ModelAnimator.html">ModelAnimator</a></li><li><a href="Renderer.html">Renderer</a></li><li><a href="Scene.html">Scene</a></li><li><a href="XRManager.html">XRManager</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:afterRender">afterRender</a></li></ul></div><div class="category"><h2>Environment</h2><h3>Classes</h3><ul><li><a href="AutoDirectionalLight.html">AutoDirectionalLight</a></li><li><a href="ShadowPlane.html">ShadowPlane</a></li></ul><h3>Interfaces</h3><ul><li><a href="Environment.html">Environment</a></li></ul></div><div class="category"><h2>Extra</h2><h3>Classes</h3><ul><li><a href="TextureModel.html">TextureModel</a></li></ul></div><div class="category"><h2>Loaders</h2><h3>Classes</h3><ul><li><a href="GLTFLoader.html">GLTFLoader</a></li><li><a href="TextureLoader.html">TextureLoader</a></li></ul><h3>Interfaces</h3><ul><li><a href="ModelLoadOption.html">ModelLoadOption</a></li></ul></div><div class="category"><h2>XR</h2><h3>Classes</h3><ul><li><a href="DOMOverlay.html">DOMOverlay</a></li><li><a href="FloorARSession.html">FloorARSession</a></li><li><a href="HitTest.html">HitTest</a></li><li><a href="HoverARSession.html">HoverARSession</a></li><li><a href="QuickLookSession.html">QuickLookSession</a></li><li><a href="SceneViewerSession.html">SceneViewerSession</a></li><li><a href="WallARSession.html">WallARSession</a></li><li><a href="WebARSession.html">WebARSession</a></li></ul><h3>Interfaces</h3><ul><li><a href="XRSession.html">XRSession</a></li><li><a href="WebARSessionOption.html">WebARSessionOption</a></li><li><a href="WallARSessionOption.html">WallARSessionOption</a></li><li><a href="HoverARSessionOption.html">HoverARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="WebARSession.html#.event:start">start</a></li><li><a href="WebARSession.html#.event:modelPlaced">modelPlaced</a></li><li><a href="WebARSession.html#.event:end">end</a></li><li><a href="WebARSession.html#.event:canPlace">canPlace</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>loaders/GLTFLoader.ts</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2020 NAVER Corp.
 * egjs projects are licensed under the MIT license
 */

import * as THREE from "three";
import { GLTFLoader as ThreeGLTFLoader, GLTF } from "three/examples/jsm/loaders/GLTFLoader";
import { DRACOLoader } from "three/examples/jsm/loaders/DRACOLoader";
import Model from "~/core/Model";
import * as DEFAULT from "~/consts/default";
import View3D from "~/View3D";
import { ShadowPlane, AutoDirectionalLight } from "~/environments";
import { ModelLoadOption } from "~/types/external";

/**
 * GLTFLoader
 * @category Loaders
 */
class GLTFLoader {
  private _loader: ThreeGLTFLoader;
  private _dracoLoader: DRACOLoader;

  public get loader() { return this._loader; }
  public get dracoLoader() { return this._dracoLoader; }

  /**
   * Create a new instance of GLTFLoader
   */
  constructor() {
    this._loader = new ThreeGLTFLoader();

    const loader = this._loader;
    loader.setCrossOrigin("anonymous");

    const dracoLoader = new DRACOLoader();
    dracoLoader.setDecoderPath(DEFAULT.DRACO_DECODER_URL);
    loader.setDRACOLoader(dracoLoader);
  }

  /**
   * Load new GLTF model from the given url
   * @param url URL to fetch glTF/glb file
   * @param options Options for a loaded model
   * @returns Promise that resolves {@link Model}
   */
  public load(url: string, options: Partial&lt;ModelLoadOption> = {}): Promise&lt;Model> {
    const loader = this._loader;
    loader.manager = new THREE.LoadingManager();

    return new Promise((resolve, reject) => {
      loader.load(url, gltf => {
        const model = this._parseToModel(gltf, options);
        resolve(model);
      }, undefined, err => {
        reject(err);
      });
    });
  }

  /**
   * Load preset generated from View3D editor.
   * @param viewer Instance of the {@link View3D}.
   * @param url Preset url
   * @param {object} options Options
   * @param {string} [options.path] Base path for additional files.
   * @param {function} [options.onLoad] Callback which called after each model LOD is loaded.
   */
  public loadPreset(viewer: View3D, url: string, options: Partial&lt;{
    path: string;
    onLoad: (model: Model, lodIndex: number) => any;
  }> = {}): Promise&lt;void> {
    const loader = this._loader;
    const fileLoader = new THREE.FileLoader();

    return fileLoader.loadAsync(url)
      .then(jsonRaw => {
        const json = JSON.parse(jsonRaw);
        const baseURL = THREE.LoaderUtils.extractUrlBase(url);

        // Reset
        viewer.scene.reset();
        viewer.camera.reset();
        viewer.animator.reset();

        const modelOptions = json.model;
        const cameraOptions = json.camera;
        const environmentOptions = json.env;

        viewer.camera.setDefaultPose({
          yaw: cameraOptions.yaw,
          pitch: cameraOptions.pitch,
        });
        viewer.camera.minDistance = cameraOptions.distanceRange[0];
        viewer.camera.maxDistance = cameraOptions.distanceRange[1];

        if (environmentOptions.background) {
          viewer.scene.setBackground(new THREE.Color(environmentOptions.background));
        }

        const shadowPlane = new ShadowPlane();
        shadowPlane.opacity = environmentOptions.shadow.opacity;
        viewer.scene.addEnv(shadowPlane);

        const ambientOptions = environmentOptions.ambient;
        const ambient = new THREE.AmbientLight(new THREE.Color(ambientOptions.color), ambientOptions.intensity);
        viewer.scene.addEnv(ambient);

        const lightOptions = [environmentOptions.light1, environmentOptions.light2, environmentOptions.light3];
        lightOptions.forEach(lightOption => {
          const lightDirection = new THREE.Vector3(lightOption.x, lightOption.y, lightOption.z).negate();
          const directional = new AutoDirectionalLight(new THREE.Color(lightOption.color), lightOption.intensity, {
            direction: lightDirection,
          });
          directional.light.castShadow = lightOption.castShadow;
          directional.light.updateMatrixWorld();
          viewer.scene.addEnv(directional);
        });

        let isFirstLoad = true;
        const loadFlags = json.LOD.map(() => false) as boolean[];
        json.LOD.forEach((fileName: string, lodIndex: number) => {
          const glbURL = this._resolveURL(`${baseURL}${fileName}`, options.path || "");

          loader.load(glbURL, gltf => {
            loadFlags[lodIndex] = true;
            const higherLODLoaded = loadFlags.slice(lodIndex + 1).some(loaded => loaded);
            if (higherLODLoaded) return;

            const model = this._parseToModel(gltf);

            viewer.display(model, {
              size: modelOptions.size,
              resetView: isFirstLoad,
            });
            isFirstLoad = false;

            model.castShadow = modelOptions.castShadow;
            model.receiveShadow = modelOptions.receiveShadow;

            if (options.onLoad) {
              options.onLoad(model, lodIndex);
            }
          }, undefined, err => {
            throw err;
          });
        });
        return;
      });
  }

  /**
   * Load new GLTF model from the given files
   * @param files Files that has glTF/glb and all its associated resources like textures and .bin data files
   * @param options Options for a loaded model
   * @returns Promise that resolves {@link Model}
   */
  public loadFromFiles(files: File[], options: Partial&lt;ModelLoadOption> = {}): Promise&lt;Model> {
    const objectURLs: string[] = [];
    const revokeURLs = () => {
      objectURLs.forEach(url => {
        URL.revokeObjectURL(url);
      });
    };

    return new Promise((resolve, reject) => {
      if (files.length &lt;= 0) {
        reject(new Error("No files found"));
        return;
      }

      const gltfFile = files.find(file => /\.(gltf|glb)$/i.test(file.name));
      if (!gltfFile) {
        reject(new Error("No glTF file found"));
        return;
      }

      const filesMap = new Map&lt;string, File>();
      files.forEach(file => {
        filesMap.set(file.name, file);
      });

      const gltfURL = URL.createObjectURL(gltfFile);

      objectURLs.push(gltfURL);

      const manager = new THREE.LoadingManager();
      manager.setURLModifier(fileURL => {
        const fileNameResult = /[^\/|\\]+$/.exec(fileURL);
        const fileName = (fileNameResult &amp;&amp; fileNameResult[0]) || "";

        if (filesMap.has(fileName)) {
          const blob = filesMap.get(fileName);
          const blobURL = URL.createObjectURL(blob);
          objectURLs.push(blobURL);

          return blobURL;
        }

        return fileURL;
      });

      const loader = this._loader;
      loader.manager = manager;
      loader.load(gltfURL, gltf => {
        const model = this._parseToModel(gltf, options);
        resolve(model);
        revokeURLs();
      }, undefined, err => {
        reject(err);
        revokeURLs();
      });
    });
  }

  /**
   * Parse from array buffer
   * @param data glTF asset to parse, as an ArrayBuffer or JSON string.
   * @param path The base path from which to find subsequent glTF resources such as textures and .bin data files.
   * @param options Options for a loaded model
   * @returns Promise that resolves {@link Model}
   */
  public parse(data: ArrayBuffer, path: string, options: Partial&lt;ModelLoadOption> = {}): Promise&lt;Model> {
    const loader = this._loader;
    loader.manager = new THREE.LoadingManager();

    return new Promise((resolve, reject) => {
      loader.parse(data, path, gltf => {
        const model = this._parseToModel(gltf, options);
        resolve(model);
      }, err => {
        reject(err);
      });
    });
  }

  private _parseToModel(gltf: GLTF, {
    fixSkinnedBbox = false,
  }: Partial&lt;ModelLoadOption> = {}): Model {
    const model = new Model({
      scenes: gltf.scenes,
      animations: gltf.animations,
      fixSkinnedBbox,
    });

    model.meshes.forEach(mesh => {
      const materials = Array.isArray(mesh.material)
        ? mesh.material
        : [mesh.material];

      materials.forEach((mat: THREE.MeshStandardMaterial) => {
        if (mat.map) {
          mat.map.encoding = THREE.sRGBEncoding;
        }
      });
    });

    return model;
  }

  // Grabbed from three.js/GLTFLoader
  // Original code: https://github.com/mrdoob/three.js/blob/master/examples/jsm/loaders/GLTFLoader.js#L1221
  // License: MIT
  private _resolveURL(url: string, path: string): string {
    // Invalid URL
    if ( typeof url !== "string" || url === "" ) return "";

    // Host Relative URL
    if ( /^https?:\/\//i.test( path ) &amp;&amp; /^\//.test( url ) ) {

      path = path.replace( /(^https?:\/\/[^\/]+).*/i, "$1" );

    }

    // Absolute URL http://,https://,//
    if ( /^(https?:)?\/\//i.test( url ) ) return url;

    // Data URI
    if ( /^data:.*,.*$/i.test( url ) ) return url;

    // Blob URL
    if ( /^blob:.*$/i.test( url ) ) return url;

    // Relative URL
    return path + url;
  }
}

export default GLTFLoader;
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>


<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 0.3.7</a> on Mon Nov 16 2020 20:43:02 GMT+0900 (Korean Standard Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>


<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
