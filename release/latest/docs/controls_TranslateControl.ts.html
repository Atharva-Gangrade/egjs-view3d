

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: controls/TranslateControl.ts</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">@egjs/view3d Documentation</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/naver/egjs-view3d" target="_blank">
                                Github
                            </a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="./demo/index.html" target="_blank">
                                Demo
                            </a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Tutorials</h3><ul><li><a href="tutorial-Adding Controls.html">Adding Controls</a></li><li><a href="tutorial-Adding Lights.html">Adding Lights</a></li><li><a href="tutorial-Adding Skybox and Envmap.html">Adding Skybox and Envmap</a></li><li><a href="tutorial-Displaying Shadows.html">Displaying Shadows</a></li><li><a href="tutorial-Handling Errors.html">Handling Errors</a></li><li><a href="tutorial-Loading a Model.html">Loading a Model</a></li><li><a href="tutorial-Playing Animations.html">Playing Animations</a></li></ul><h3>Namespaces</h3><ul><li><a href="EASING.html">EASING</a></li><li><a href="Constants.html">Constants</a></li></ul><h3>Classes</h3><ul><li><a href="Pose.html">Pose</a></li><li><a href="View3D.html">View3D</a></li></ul><h3>Interfaces</h3><ul><li><a href="FloorARSessionOption.html">FloorARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="Animation.html#event:progress">progress</a></li><li><a href="Animation.html#event:finish">finish</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AnyFunction">AnyFunction</a></li><li><a href="global.html#AnyObject">AnyObject</a></li></ul></div><div class="category"><h2>Controls</h2><h3>Classes</h3><ul><li><a href="AnimationControl.html">AnimationControl</a></li><li><a href="AutoControl.html">AutoControl</a></li><li><a href="DistanceControl.html">DistanceControl</a></li><li><a href="OrbitControl.html">OrbitControl</a></li><li><a href="RotateControl.html">RotateControl</a></li><li><a href="TranslateControl.html">TranslateControl</a></li></ul><h3>Interfaces</h3><ul><li><a href="CameraControl.html">CameraControl</a></li></ul></div><div class="category"><h2>Controls-AR</h2><h3>Classes</h3><ul><li><a href="ARFloorControl.html">ARFloorControl</a></li><li><a href="ARFloorTranslateControl.html">ARFloorTranslateControl</a></li><li><a href="ARHoverControl.html">ARHoverControl</a></li><li><a href="ARHoverRotateControl.html">ARHoverRotateControl</a></li><li><a href="ARHoverTranslateControl.html">ARHoverTranslateControl</a></li><li><a href="ArrowIndicator.html">ArrowIndicator</a></li><li><a href="ARScaleControl.html">ARScaleControl</a></li><li><a href="ARSwipeControl.html">ARSwipeControl</a></li><li><a href="ARSwirlControl.html">ARSwirlControl</a></li><li><a href="ARWallControl.html">ARWallControl</a></li><li><a href="ARWallTranslateControl.html">ARWallTranslateControl</a></li><li><a href="DeadzoneChecker.html">DeadzoneChecker</a></li><li><a href="FloorIndicator.html">FloorIndicator</a></li><li><a href="RotationIndicator.html">RotationIndicator</a></li><li><a href="ScaleUI.html">ScaleUI</a></li></ul><h3>Interfaces</h3><ul><li><a href="ScaleUIOption.html">ScaleUIOption</a></li><li><a href="RotationIndicatorOption.html">RotationIndicatorOption</a></li><li><a href="FloorIndicatorOption.html">FloorIndicatorOption</a></li><li><a href="DeadzoneCheckerOption.html">DeadzoneCheckerOption</a></li><li><a href="ARWallTranslateControlOption.html">ARWallTranslateControlOption</a></li><li><a href="ARWallControlOption.html">ARWallControlOption</a></li><li><a href="ARSwirlControlOption.html">ARSwirlControlOption</a></li><li><a href="ARSwipeControlOption.html">ARSwipeControlOption</a></li><li><a href="ARScaleControlOption.html">ARScaleControlOption</a></li><li><a href="ArrowIndicatorOption.html">ArrowIndicatorOption</a></li><li><a href="ARHoverTranslateControlOption.html">ARHoverTranslateControlOption</a></li><li><a href="ARHoverRotateControlOption.html">ARHoverRotateControlOption</a></li><li><a href="ARHoverControlOption.html">ARHoverControlOption</a></li><li><a href="ARFloorTranslateControlOption.html">ARFloorTranslateControlOption</a></li><li><a href="ARFloorControlOption.html">ARFloorControlOption</a></li><li><a href="ARControl.html">ARControl</a></li></ul></div><div class="category"><h2>Core</h2><h3>Classes</h3><ul><li><a href="Animation.html">Animation</a></li><li><a href="Camera.html">Camera</a></li><li><a href="Controller.html">Controller</a></li><li><a href="Model.html">Model</a></li><li><a href="ModelAnimator.html">ModelAnimator</a></li><li><a href="Renderer.html">Renderer</a></li><li><a href="Scene.html">Scene</a></li><li><a href="XRManager.html">XRManager</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:afterRender">afterRender</a></li></ul></div><div class="category"><h2>Environment</h2><h3>Classes</h3><ul><li><a href="AutoDirectionalLight.html">AutoDirectionalLight</a></li><li><a href="ShadowPlane.html">ShadowPlane</a></li></ul><h3>Interfaces</h3><ul><li><a href="Environment.html">Environment</a></li></ul></div><div class="category"><h2>Extra</h2><h3>Classes</h3><ul><li><a href="TextureModel.html">TextureModel</a></li></ul></div><div class="category"><h2>Loaders</h2><h3>Classes</h3><ul><li><a href="GLTFLoader.html">GLTFLoader</a></li><li><a href="TextureLoader.html">TextureLoader</a></li></ul><h3>Interfaces</h3><ul><li><a href="ModelLoadOption.html">ModelLoadOption</a></li></ul></div><div class="category"><h2>XR</h2><h3>Classes</h3><ul><li><a href="DOMOverlay.html">DOMOverlay</a></li><li><a href="FloorARSession.html">FloorARSession</a></li><li><a href="HitTest.html">HitTest</a></li><li><a href="HoverARSession.html">HoverARSession</a></li><li><a href="QuickLookSession.html">QuickLookSession</a></li><li><a href="SceneViewerSession.html">SceneViewerSession</a></li><li><a href="WallARSession.html">WallARSession</a></li><li><a href="WebARSession.html">WebARSession</a></li></ul><h3>Interfaces</h3><ul><li><a href="XRSession.html">XRSession</a></li><li><a href="WebARSessionOption.html">WebARSessionOption</a></li><li><a href="WallARSessionOption.html">WallARSessionOption</a></li><li><a href="HoverARSessionOption.html">HoverARSessionOption</a></li></ul><h3>Events</h3><ul><li><a href="WebARSession.html#.event:start">start</a></li><li><a href="WebARSession.html#.event:modelPlaced">modelPlaced</a></li><li><a href="WebARSession.html#.event:end">end</a></li><li><a href="WebARSession.html#.event:canPlace">canPlace</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>controls/TranslateControl.ts</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2020 NAVER Corp.
 * egjs projects are licensed under the MIT license
 */

import * as THREE from "three";
import CameraControl from "./CameraControl";
import Motion from "./Motion";
import View3DError from "~/View3DError";
import Camera from "~/core/camera/Camera";
import { getElement } from "~/utils";
import { EVENTS, MOUSE_BUTTON } from "~/consts/event";
import { CURSOR } from "~/consts/css";
import * as DEFAULT from "~/consts/default";
import * as ERROR from "~/consts/error";
import { ValueOf } from "~/types/internal";

/**
 * Model's translation control that supports both mouse &amp; touch
 * @category Controls
 */
class TranslateControl implements CameraControl {
  // Options
  private _useGrabCursor: boolean;
  private _scaleToElement: boolean;
  private _userScale: THREE.Vector2;

  // Internal values
  private _targetEl: HTMLElement | null = null;
  private _enabled: boolean = false;
  // Sometimes, touchstart for second finger doesn't triggered.
  // This flag checks whether that happened
  private _touchInitialized: boolean = false;
  private _xMotion: Motion;
  private _yMotion: Motion;
  private _prevPos: THREE.Vector2 = new THREE.Vector2(0, 0);
  private _screenSize: THREE.Vector2 = new THREE.Vector2(0, 0);

  /**
   * Control's current target element to attach event listeners
   * @readonly
   */
  public get element() { return this._targetEl; }
  /**
   * Scale factor for translation
   * @type THREE.Vector2
   * @see https://threejs.org/docs/#api/en/math/Vector2
   * @example
   * import { TranslateControl } from "@egjs/view3d";
   * const translateControl = new TranslateControl();
   * translateControl.scale.set(2, 2);
   */
  public get scale() { return this._userScale; }
  /**
   * Whether to apply CSS style `cursor: grab` on the target element or not
   * @default true
   * @example
   * import { TranslateControl } from "@egjs/view3d";
   * const translateControl = new TranslateControl();
   * translateControl.useGrabCursor = true;
   */
  public get useGrabCursor() { return this._useGrabCursor; }
  /**
   * Scale control to fit element size.
   * When this is true, camera's pivot change will correspond same amount you've dragged.
   * @default true
   * @example
   * import View3D, { TranslateControl } from "@egjs/view3d";
   * const view3d = new View3D("#view3d-canvas");
   * const translateControl = new TranslateControl();
   * translateControl.scaleToElement = true;
   * view3d.controller.add(translateControl);
   * view3d.resize();
   */
  public get scaleToElement() { return this._scaleToElement; }
  /**
   * Whether this control is enabled or not
   * @readonly
   */
  public get enabled() { return this._enabled; }

  public set scale(val: THREE.Vector2) {
    this._userScale.copy(val);
  }
  public set useGrabCursor(val: boolean) {
    if (!val) {
      this._setCursor("");
      this._useGrabCursor = false;
    } else {
      this._useGrabCursor = true;
      this._setCursor(CURSOR.GRAB);
    }
  }
  public set scaleToElement(val: boolean) {
    this._scaleToElement = val;
  }

  /**
   * Create new TranslateControl instance
   * @param {object} options Options
   * @param {HTMLElement | null} [options.element] Target element.
   * @param {function} [options.easing=(x: number) => 1 - Math.pow(1 - x, 3)] Motion's easing function.
   * @param {THREE.Vector2} [options.scale=new THREE.Vector2(1, 1)] Scale factor for translation.
   * @param {boolean} [options.useGrabCursor=true] Whether to apply CSS style `cursor: grab` on the target element or not.
   * @param {boolean} [options.scaleToElement=true] Whether to scale control to fit element size.
   * @tutorial Adding Controls
   */
  constructor({
    element = DEFAULT.NULL_ELEMENT,
    easing = DEFAULT.EASING,
    scale = new THREE.Vector2(1, 1),
    useGrabCursor = true,
    scaleToElement = true,
  } = {}) {
    const targetEl = getElement(element);
    if (targetEl) {
      this.setElement(targetEl);
    }
    this._xMotion = new Motion({ duration: 0, range: DEFAULT.INFINITE_RANGE, easing });
    this._yMotion = new Motion({ duration: 0, range: DEFAULT.INFINITE_RANGE, easing });
    this._userScale = scale;
    this._useGrabCursor = useGrabCursor;
    this._scaleToElement = scaleToElement;
  }

  /**
   * Destroy the instance and remove all event listeners attached
   * This also will reset CSS cursor to intial
   * @returns {void} Nothing
   */
  public destroy(): void {
    this.disable();
  }

  /**
   * Update control by given deltaTime
   * @param deltaTime Number of milisec to update
   * @returns {void} Nothing
   */
  public update(camera: Camera, deltaTime: number): void {
    const screenSize = this._screenSize;

    const delta = new THREE.Vector2(
      this._xMotion.update(deltaTime),
      this._yMotion.update(deltaTime),
    );

    const viewXDir = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.threeCamera.quaternion);
    const viewYDir = new THREE.Vector3(0, 1, 0).applyQuaternion(camera.threeCamera.quaternion);

    if (this._scaleToElement) {
      const screenScale = new THREE.Vector2(camera.renderWidth, camera.renderHeight).divide(screenSize);
      delta.multiply(screenScale);
    }

    camera.pivot.add(viewXDir.multiplyScalar(delta.x));
    camera.pivot.add(viewYDir.multiplyScalar(delta.y));
  }

  /**
   * Resize control to match target size
   * This method is only meaningful when {@link RotateControl#scaleToElementSize scaleToElementSize} is enabled
   * @param size {@link https://threejs.org/docs/#api/en/math/Vector2 THREE.Vector2} instance of width(x), height(y)
   */
  public resize(size: THREE.Vector2) {
    const screenSize = this._screenSize;

    screenSize.copy(size);
  }

  /**
   * Enable this input and add event listeners
   * @returns {void} Nothing
   */
  public enable(): void {
    if (this._enabled) return;
    if (!this._targetEl) {
      throw new View3DError(ERROR.MESSAGES.ADD_CONTROL_FIRST, ERROR.CODES.ADD_CONTROL_FIRST);
    }

    const targetEl = this._targetEl;

    targetEl.addEventListener(EVENTS.MOUSE_DOWN, this._onMouseDown, false);

    targetEl.addEventListener(EVENTS.TOUCH_START, this._onTouchStart, false);
    targetEl.addEventListener(EVENTS.TOUCH_MOVE, this._onTouchMove, false);
    targetEl.addEventListener(EVENTS.TOUCH_END, this._onTouchEnd, false);

    targetEl.addEventListener(EVENTS.CONTEXT_MENU, this._onContextMenu, false);

    this._setCursor(CURSOR.GRAB);

    this._enabled = true;
  }

  /**
   * Disable this input and remove all event handlers
   * @returns {void} Nothing
   */
  public disable(): void {
    if (!this._enabled || !this._targetEl) return;

    const targetEl = this._targetEl;

    targetEl.removeEventListener(EVENTS.MOUSE_DOWN, this._onMouseDown, false);
    window.removeEventListener(EVENTS.MOUSE_MOVE, this._onMouseMove, false);
    window.removeEventListener(EVENTS.MOUSE_UP, this._onMouseUp, false);

    targetEl.removeEventListener(EVENTS.TOUCH_START, this._onTouchStart, false);
    targetEl.removeEventListener(EVENTS.TOUCH_MOVE, this._onTouchMove, false);
    targetEl.removeEventListener(EVENTS.TOUCH_END, this._onTouchEnd, false);

    targetEl.removeEventListener(EVENTS.CONTEXT_MENU, this._onContextMenu, false);

    this._setCursor("");

    this._enabled = false;
  }

  /**
   * Synchronize this control's state to given camera position
   * @param camera Camera to match state
   * @returns {void} Nothing
   */
  public sync(camera: Camera): void {
    this._xMotion.reset(0);
    this._yMotion.reset(0);
  }

  /**
   * Set target element to attach event listener
   * @param element target element
   * @returns {void} Nothing
   */
  public setElement(element: HTMLElement): void {
    this._targetEl = element;
    this.resize(new THREE.Vector2(element.offsetWidth, element.offsetHeight));
  }

  private _setCursor(val: ValueOf&lt;typeof CURSOR> | "") {
    const targetEl = this._targetEl;
    if (!this._useGrabCursor || !targetEl) return;

    targetEl.style.cursor = val;
  }

  private _onMouseDown = (evt: MouseEvent) => {
    if (evt.button !== MOUSE_BUTTON.RIGHT) return;

    const targetEl = this._targetEl!;
    evt.preventDefault();

    targetEl.focus ? targetEl.focus() : window.focus();

    this._prevPos.set(evt.clientX, evt.clientY);
    window.addEventListener(EVENTS.MOUSE_MOVE, this._onMouseMove, false);
    window.addEventListener(EVENTS.MOUSE_UP, this._onMouseUp, false);

    this._setCursor(CURSOR.GRABBING);
  }

  private _onMouseMove = (evt: MouseEvent) => {
    evt.preventDefault();

    const prevPos = this._prevPos;
    const delta = new THREE.Vector2(evt.clientX, evt.clientY)
      .sub(prevPos)
      .multiply(this._userScale);

    // X value is negated to match cursor direction
    this._xMotion.setEndDelta(-delta.x);
    this._yMotion.setEndDelta(delta.y);

    prevPos.set(evt.clientX, evt.clientY);
  }

  private _onMouseUp = () => {
    this._prevPos.set(0, 0);
    window.removeEventListener(EVENTS.MOUSE_MOVE, this._onMouseMove, false);
    window.removeEventListener(EVENTS.MOUSE_UP, this._onMouseUp, false);

    this._setCursor(CURSOR.GRAB);
  }

  private _onTouchStart = (evt: TouchEvent) => {
    // Only the two finger motion should be considered
    if (evt.touches.length !== 2) return;
    evt.preventDefault();

    this._prevPos.copy(this._getTouchesMiddle(evt.touches));
    this._touchInitialized = true;
  }

  private _onTouchMove = (evt: TouchEvent) => {
    // Only the two finger motion should be considered
    if (evt.touches.length !== 2) return;

    if (evt.cancelable !== false) {
      evt.preventDefault();
    }
    evt.stopPropagation();

    const prevPos = this._prevPos;
    const middlePoint = this._getTouchesMiddle(evt.touches);

    if (!this._touchInitialized) {
      prevPos.copy(middlePoint);
      this._touchInitialized = true;
      return;
    }

    const delta = new THREE.Vector2()
      .subVectors(middlePoint, prevPos)
      .multiply(this._userScale);

    // X value is negated to match cursor direction
    this._xMotion.setEndDelta(-delta.x);
    this._yMotion.setEndDelta(delta.y);

    prevPos.copy(middlePoint);
  }

  private _onTouchEnd = (evt: TouchEvent) => {
    // Only the two finger motion should be considered
    if (evt.touches.length !== 2) {
      this._touchInitialized = false;
      return;
    }

    // Three fingers to two fingers
    this._prevPos.copy(this._getTouchesMiddle(evt.touches));
    this._touchInitialized = true;
  }

  private _getTouchesMiddle(touches: TouchEvent["touches"]): THREE.Vector2 {
    return new THREE.Vector2(
      touches[0].clientX + touches[1].clientX,
      touches[0].clientY + touches[1].clientY,
    ).multiplyScalar(0.5);
  }

  private _onContextMenu = (evt: MouseEvent) => {
    evt.preventDefault();
  }
}

export default TranslateControl;
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>


<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 0.3.7</a> on Mon Nov 16 2020 17:20:04 GMT+0900 (Korean Standard Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>


<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
