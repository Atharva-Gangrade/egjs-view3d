/*
Copyright (c) 2020-present NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.3.0
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/shaders/HorizontalBlurShader"),require("three/examples/jsm/shaders/VerticalBlurShader"),require("three/examples/jsm/lights/LightProbeGenerator"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["three","@egjs/component","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/shaders/HorizontalBlurShader","three/examples/jsm/shaders/VerticalBlurShader","three/examples/jsm/lights/LightProbeGenerator","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.THREE,e.Component,e.RGBELoader,e.HorizontalBlurShader,e.VerticalBlurShader,e.LightProbeGenerator,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(T,e,L,P,D,A,I,N,F){"use strict";class k extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,k.prototype),this.name="View3DError",this.code=t}}var z={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,PROVIDE_WIDTH_OR_HEIGHT:5,FORMAT_NOT_SUPPORTED:6,FILE_NOT_SUPPORTED:7,NOT_INITIALIZED:8,MODEL_FAIL_TO_LOAD:9},U=z,B={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',PROVIDE_WIDTH_OR_HEIGHT:"Either width or height should be given.",FORMAT_NOT_SUPPORTED:e=>`Given format "${e}" is not supported or invalid.`,FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const V=e=>"number"==typeof e,j=e=>"string"==typeof e,Y=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,X=(e,t)=>{let i=null;if(j(e)){const s=t||document;t=s.querySelector(e);if(!t)throw new k(B.ELEMENT_NOT_FOUND(e),U.ELEMENT_NOT_FOUND);i=t}else Y(e)&&(i=e);return i},d=e=>e*Math.PI/180,u=e=>180*e/Math.PI,_=(e,t,i)=>Math.max(Math.min(e,i),t),n=(e,t,i)=>e*(1-i)+t*i,a=(e,t,i)=>{var s=Math.abs(i-t);return e<t?e=i-(t-e)%s:i<e&&(e=t+(e-i)%s),e},Z=(s,...e)=>(e.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];Array.isArray(s[e])&&Array.isArray(t)?s[e]=[...s[e],...t]:s[e]=t})}),s),G=e=>"object"==typeof e?e:{},o=e=>e?"true":"false",p=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t};function H(e,n,a,h){return new(a=a||Promise)(function(i,t){function s(e){try{o(h.next(e))}catch(e){t(e)}}function r(e){try{o(h.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?i(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(s,r)}o((h=h.apply(e,n||[])).next())})}const W="auto",b={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",QUICK_LOOK_TAP:"quickLookTap",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced"},s={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},q={POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay"},Q={LINEAR:T.LinearToneMapping,REINHARD:T.ReinhardToneMapping,CINEON:T.CineonToneMapping,ACES_FILMIC:T.ACESFilmicToneMapping};var t={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const v={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var h,m,O,l;class K{constructor(e){this._defaultRenderLoop=e=>{const t=this._view3D,i=this._renderer,{scene:s,camera:r,control:o,autoPlayer:n,animator:a}=t;var h=1e3*e;a.update(e),o.update(h),n.update(h),t.trigger(b.BEFORE_RENDER,{type:b.BEFORE_RENDER,target:t,delta:h}),r.updatePosition(),i.autoClear=!1,i.clear(),s.skybox&&s.skybox.enabled&&(s.skybox.updateCamera(),i.render(s.skybox.scene,s.skybox.camera)),s.shadowPlane.render(),i.render(s.root,r.threeCamera),i.autoClear=!0,t.trigger(b.RENDER,{type:b.RENDER,target:t,delta:h})},this._view3D=e,this._canvas=((e,t)=>{e=e.querySelector(t);if(e)return e;throw new k(B.CANVAS_NOT_FOUND,U.CANVAS_NOT_FOUND)})(e.rootEl,e.canvasSelector);const t=new T.WebGLRenderer({canvas:this._canvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!0});if(t.toneMapping=e.toneMapping,t.toneMappingExposure=e.exposure,t.outputEncoding=T.sRGBEncoding,t.setClearColor(0,0),t.capabilities.isWebGL2)this._halfFloatAvailable=!0;else{const o=t.getContext();e=o.createTexture();try{var i,s=new Uint16Array(4),r=o.getExtension("OES_texture_half_float");r?(o.bindTexture(o.TEXTURE_2D,e),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,1,1,0,o.RGBA,r.HALF_FLOAT_OES,s),i=o.getError(),this._halfFloatAvailable=i===o.NO_ERROR):this._halfFloatAvailable=!1}catch(e){this._halfFloatAvailable=!1}o.deleteTexture(e)}this._renderer=t,this._clock=new T.Clock(!1)}get canvas(){return this._canvas}get context(){return this._renderer.context}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new T.Vector2);return{width:e.width,height:e.y}}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}resize(){const e=this._renderer;var t=this._canvas;e.xr.isPresenting||(e.setPixelRatio(window.devicePixelRatio),e.setSize(t.clientWidth,t.clientHeight,!1))}setAnimationLoop(s){const r=this._view3D,o=this._clock;o.start(),this._renderer.setAnimationLoop((e,t)=>{var i=Math.min(o.getDelta(),r.maxDeltaTime);s(i,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}}const c={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",LOAD:"load",ERROR:"error"},r={GRAB:"grab",GRABBING:"grabbing",NONE:""},$=((C=h=h||{})[C.LEFT=0]="LEFT",C[C.MIDDLE=1]="MIDDLE",C[C.RIGHT=2]="RIGHT","anonymous");class J{constructor(e){this._onLoadingProgress=(e,t,i)=>{const s=this._view3D;i.initialized=!0,i.lengthComputable=e.lengthComputable,i.loaded=e.loaded,i.total=e.total,s.trigger(b.PROGRESS,{type:b.PROGRESS,target:s,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class g extends J{constructor(e){super(e)}load(r){const o=this._view3D;return new Promise((e,t)=>{const i=new T.TextureLoader,s=p(o,r);i.setCrossOrigin($),i.load(r,e,e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,t(e)})})}loadHDRTexture(r){const o=this._view3D;return new Promise((t,i)=>{const e=new L.RGBELoader,s=(o.renderer.capabilities.halfFloat||(e.type=T.FloatType),p(o,r));e.setCrossOrigin($),e.load(r,e=>{e.mapping=T.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,i(e)})})}}const ee=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap"],E={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},w=((C=m=m||{})[C.NONE=0]="NONE",C[C.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",C[C.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",C[C.ONE_FINGER=3]="ONE_FINGER",C[C.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",C[C.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",C[C.TWO_FINGER=12]="TWO_FINGER",C[C.PINCH=16]="PINCH","EXT_View3D_texture_LOD");class te{constructor(e,{darkness:t=.5,mapSize:i=9,blur:s=3.5,shadowScale:r=1,planeScale:o=2}={}){this._view3D=e,this._darkness=t,this._mapSize=i,this._blur=s,this._shadowScale=r,this._planeScale=o;t=e.renderer.threeRenderer,s=Math.min(Math.pow(2,Math.floor(i)),t.capabilities.maxTextureSize);this._root=new T.Group,this._renderTarget=new T.WebGLRenderTarget(s,s,{format:T.RGBAFormat}),this._blurTarget=new T.WebGLRenderTarget(s,s,{format:T.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1;const n=new T.OrthographicCamera(-.5,.5,.5,-.5,0);n.rotation.x=Math.PI/2,this._shadowCamera=n,this._root.add(n);r=new T.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=r,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){const t=this._root,i=this._shadowCamera;var s=this._planeScale,r=e.bbox.getBoundingSphere(new T.Sphere),s=2*s*r.radius,o=this._shadowScale;i.far=o*(e.bbox.max.y-e.bbox.min.y)/s,i.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(s),i.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:i}=e,s=this._shadowCamera;const r=t.threeRenderer;t=i.activeSession?i.activeSession.arScene:e.scene,i=r.xr.enabled;r.xr.enabled=!1;const o=t.root;var e=o.background,t=(o.background=null,o.overrideMaterial=this._depthMaterial,r.getClearAlpha()),n=(r.setClearAlpha(0),r.getRenderTarget());r.setRenderTarget(this._renderTarget),r.clear(),r.render(o,s),o.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),r.xr.enabled=i,r.setRenderTarget(n),r.setClearAlpha(t),o.background=e,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],i=this._blurCamera;const s=t.threeRenderer,r=this._blurPlane;var t=this._renderTarget,o=this._blurTarget;const n=this._horizontalBlurMaterial,a=this._verticalBlurMaterial;r.visible=!0,n.uniforms.tDiffuse.value=t.texture,n.uniforms.h.value=+e/256,n.needsUpdate=!0,r.material=n,s.setRenderTarget(o),s.render(r,i),a.uniforms.tDiffuse.value=o.texture,a.uniforms.v.value=+e/256,a.needsUpdate=!0,r.material=a,s.setRenderTarget(t),s.render(r,i),r.visible=!1}_setupPlanes(){const e=this._root;var t=new T.PlaneBufferGeometry,i=new T.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:T.BackSide,depthWrite:!1,map:this._renderTarget.texture});const s=new T.Mesh(t,i);s.renderOrder=1,s.scale.set(-1,-1,1),s.rotation.order="YXZ",s.rotation.x=Math.PI/2,this._plane=s,e.add(s);i=new T.Mesh(t);this._blurPlane=i;const r=new T.MeshDepthMaterial,o=(r.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=r,new T.ShaderMaterial(P.HorizontalBlurShader)),n=(o.depthTest=!1,this._horizontalBlurMaterial=o,new T.ShaderMaterial(D.VerticalBlurShader));n.depthTest=!1,this._verticalBlurMaterial=n}}class ie{constructor(e){this._view3D=e,this._scene=new T.Scene,this._camera=new T.PerspectiveCamera,this._enabled=!0}get scene(){return this._scene}get camera(){return this._camera}get enabled(){return this._enabled}destroy(){this._disposeOldSkybox()}enable(){this._enabled=!0}disable(){this._enabled=!1}updateCamera(){var e=this._view3D;const t=this._camera;var e=e.camera,i=e.currentPose.pivot;t.copy(e.threeCamera),t.lookAt(i),t.updateProjectionMatrix()}useBlurredHDR(e){this._disposeOldSkybox();const t=this._view3D.renderer.threeRenderer,i=new T.Scene;i.background=e;var e=t.toneMappingExposure,s=(t.toneMappingExposure=1,new T.WebGLCubeRenderTarget(256,{encoding:T.sRGBEncoding,format:T.RGBAFormat}));const r=new T.CubeCamera(.1,1e3,s);r.update(t,i);var o=A.LightProbeGenerator.fromCubeRenderTarget(t,s),n=new T.MeshStandardMaterial({side:T.BackSide});const a=new T.IcosahedronBufferGeometry(1,4),h=new T.Scene;n=new T.Mesh(a,n);const l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return h.add(n),h.add(o),r.update(t,h),t.toneMappingExposure=e,this._scene.background=s.texture,this}useTexture(e){return this._scene.background=e,this}useColor(e){return this._scene.background=new T.Color(e),this}_disposeOldSkybox(){const e=this._scene.background;e&&(e.dispose(),this._scene.background=null)}}class se{constructor(e){this._view3D=e,this._root=new T.Scene,this._skybox=null,this._userObjects=new T.Group,this._envObjects=new T.Group,this._fixedObjects=new T.Group,this._shadowPlane=new te(e,G(e.shadow));const t=this._root,i=this._userObjects,s=this._envObjects,r=this._fixedObjects;var o=this._shadowPlane;i.name="userObjects",s.name="envObjects",r.name="fixedObjects",t.add(i,s,r),e.shadow&&r.add(o.root)}get root(){return this._root}get skybox(){return this._skybox}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const i=t?this._userObjects:this._envObjects;t=Array.isArray(e)?e:[e];i.add(...t)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(r){return H(this,void 0,void 0,function*(){var e=this._view3D;const t=new ie(e);if(this._skybox=t,"number"==typeof r||"#"===r.charAt(0))t.useColor(r);else{const i=new g(e),s=yield i.load(r);s.encoding=T.sRGBEncoding,t.useTexture(s)}})}setSkybox(o){var n;return H(this,void 0,void 0,function*(){const e=this._root;var t=this._view3D;if(null!=(n=this._skybox)&&n.destroy(),o){const s=new g(t);var i=yield s.loadHDRTexture(o);const r=new ie(t);t.skyboxBlur?r.useBlurredHDR(i):r.useTexture(i),this._skybox=r,e.environment=i}else this._skybox=null,e.environment=null})}setEnvMap(i){return H(this,void 0,void 0,function*(){if(i){var e=this._view3D;const t=new g(e);e=yield t.loadHDRTexture(i);this._root.environment=e}else this._root.environment=null})}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e,i=(t.geometry.dispose(),Array.isArray(t.material)?t.material:[t.material]);i.forEach(t=>{ee.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}const f=s.EASE_OUT_CUBIC,re={min:0,max:1},y={min:-1/0,max:1/0},oe={min:-89.9,max:89.9},ne=[t.WEBXR,t.SCENE_VIEWER,t.QUICK_LOOK];class R{constructor({duration:e=300,loop:t=!1,range:i=re,easing:s=f}={}){this._duration=e,this._loop=t,this._range=i,this._easing=s,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,i=this._end,s=this._duration,r=this._val,o=this._loop,e=this._progress+e/s,s=(this._progress=(o?a:_)(e,0,1),this._easing(this._progress));return this._val=n(t,i,s),!o&&1<=this._progress&&(this._activated=!1),this._val-r}reset(e){var t=this._range,e=_(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=_(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class ae{constructor(e,t,i,{duration:s=300,easing:r=f}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,t=t.clone(),i=i.clone(),t.yaw=a(t.yaw,0,360),i.yaw=a(i.yaw,0,360),180<Math.abs(i.yaw-t.yaw)&&(i.yaw=i.yaw<t.yaw?i.yaw+360:i.yaw-360),this._motion=new R({duration:s,range:re,easing:r}),this._from=t,this._to=i}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}update(e){if(this._enabled){const i=this._view3D.camera,s=this._from;var t=this._to;const r=this._motion;r.update(e);e=r.val;i.yaw=n(s.yaw,t.yaw,e),i.pitch=n(s.pitch,t.pitch,e),i.zoom=n(s.zoom,t.zoom,e),i.pivot=s.pivot.clone().lerp(t.pivot,e),1<=e&&(this.disable(),this._finishCallbacks.forEach(e=>e()))}}enable(){this._enabled||(this._enabled=!0,this._motion.reset(0),this._motion.setEndDelta(1))}disable(){this._enabled&&(this._enabled=!1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class he{constructor(e,t,i,s=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=i,this.pivot=(new T.Vector3).fromArray(s)}clone(){return new he(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}}class le{constructor(e){this._distance=0,this._baseFov=45,this._view3D=e,this._threeCamera=new T.PerspectiveCamera,this._maxTanHalfHFov=0;var t=V(e.initialZoom)?e.initialZoom:0;this._defaultPose=new he(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this._distance*Math.tan(d(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._currentPose.yaw=e}set pitch(e){this._currentPose.pitch=e}set zoom(e){this._currentPose.zoom=e}set pivot(e){this._currentPose.pivot=e}reset(n=0,a=f){return H(this,void 0,void 0,function*(){const t=this._view3D,i=t.control;var e=this._currentPose;const s=this._defaultPose;if(n<=0)return this._currentPose=s.clone(),i.sync(),Promise.resolve();{const r=new ae(t,e,s),o=(r.duration=n,r.easing=a,r.enable(),i.disable(),e=>{r.update(e.delta)});return t.on(b.BEFORE_RENDER,o),new Promise(e=>{r.onFinished(()=>{i.sync(),i.enable(),t.off(b.BEFORE_RENDER,o),e()})})}})}resize({width:e,height:t},i=null){const{control:s,fov:r,maintainSize:o}=this._view3D,n=this._threeCamera;n.aspect=e/t,r===W?o&&null!=i?(e=t/i.height,t=this._currentPose.zoom,i=Math.tan(d((this._baseFov-t)/2)),this._baseFov=u(2*Math.atan(e*i))+t):this._applyEffectiveFov(45):this._baseFov=r,s.zoom.updateRange()}fit(e,t){var i=this._view3D;const s=this._threeCamera,r=i.control,o=this._defaultPose,n=e.bbox;var a=i.fov,h=a===W?45:a;const l=Array.isArray(t)?(new T.Vector3).fromArray(t):n.getCenter(new T.Vector3);t=t===W?(new T.Vector3).subVectors(n.max,n.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(l)),0),t=Math.sqrt(t);const c=t/Math.sin(d(h/2));var _=e.reduceVertices((e,t)=>{var t=(new T.Vector3).subVectors(t,l),i=Math.hypot(t.x,t.z);return Math.max(e,i/(c-Math.abs(t.y)))},0);a===W?(this._maxTanHalfHFov=_,this._applyEffectiveFov(h)):this._maxTanHalfHFov=a,o.pivot=l.clone(),this._distance=c,s.near=.1*(c-t),s.far=10*(c+t),r.zoom.updateRange(),V(i.initialZoom)||(_=this._baseFov,h=e.bbox,a=i.initialZoom.axis,t=i.initialZoom.ratio,i=(e=(new T.Vector3).subVectors(h.max,h.min))[a],h="y"===a?i/t:i/(t*s.aspect),i="z"!==a?c-e.z/2:c-e.x/2,t=u(2*Math.atan(h/(2*i))),o.zoom=_-t)}updatePosition(){var e=this._view3D["control"];const t=this._threeCamera,i=this._currentPose;var s=this._distance,r=this._baseFov,e=e.zoom.range;i.yaw=a(i.yaw,0,360),i.pitch=_(i.pitch,oe.min,oe.max),i.zoom=-(_(r-i.zoom,e.min,e.max)-r);const o=((e,t,i)=>{t=d(t),i=d(i);const s=new T.Vector3(0,0,0);return s.y=e*Math.sin(i),s.z=e*Math.cos(i),s.x=s.z*Math.sin(-t),s.z=s.z*Math.cos(-t),s})(s,i.yaw,i.pitch);e=r-i.zoom;o.add(i.pivot),t.fov=e,t.position.copy(o),t.lookAt(i.pivot),t.updateProjectionMatrix()}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(d(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=u(2*Math.atan(e))}}class ce{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const i=e.renderer.canvas;var t=i.getBoundingClientRect(),t=0!==t.width||0!==t.height;const s=new ResizeObserver(t?this._skipFirstResize:this._onResize);s.observe(i),this._resizeObserver=s}else e.resize(),window.addEventListener(c.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(c.RESIZE,this._onResize),this._enabled=!1,this}}class _e{constructor(e){this._view3D=e,this._mixer=new T.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}setClips(e){const i=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=i.clipAction(e);return t.setEffectiveWeight(0),t})}play(e){const t=this._actions[e];t&&(this.stop(),this._restoreTimeScale(),t.setEffectiveTimeScale(1),t.setEffectiveWeight(1),t.play(),this._activeAnimationIdx=e,this._flushFadePromises())}crossFade(l,c,{synchronize:_=!1}={}){var d;return H(this,void 0,void 0,function*(){const i=this._view3D,t=this._mixer;var e=this._actions,s=this._activeAnimationIdx;const r=e[l],o=null!=(d=e[s])?d:r,n="loop",a=(this._restoreTimeScale(),()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),o.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=l});if(_){const h=e=>{e.action===o&&(t.removeEventListener(n,h),a())};t.addEventListener(n,h)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(i.off(b.BEFORE_RENDER,t),e(!0))};i.on(b.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return H(this,void 0,void 0,function*(){const i=this._view3D;const s=this._actions[this._activeAnimationIdx];return!!s&&(this._flushFadePromises(),this._restoreTimeScale(),s.fadeOut(e/1e3),this._activeAnimationIdx=-1,new Promise(e=>{const t=()=>{0<s.getEffectiveWeight()||(i.off(b.BEFORE_RENDER,t),e(!0))};i.on(b.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=1}_flushFadePromises(){const i=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),i.off(b.BEFORE_RENDER,t)}),this._fadePromises=[]}}class de extends e{constructor({context:e=window,repeat:t=0,duration:i=300,easing:s=f}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,i=this._repeat,e=this._time+e,s=Math.floor(e/t),e=(this._time=(this._loopCount>=i?_:a)(e,0,t),this._time/t),r={progress:e,easedProgress:this._easing(e)};this.trigger("progress",r);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>i)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=i,this._easing=s,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const ue={AR:"immersive-ar",VR:"immersive-vr"},pe={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},S={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend"},ve={TOUCH:"generic-touchscreen"},me={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{}},ge={},Ee={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class be{constructor({scale:e=1}={}){this.rotation=new T.Quaternion,this._axis=new T.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new T.Vector2,this._fromQuat=new T.Quaternion,this._toQuat=new T.Quaternion,this._motion=new R({range:y}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:i}){if(this._active&&1===i.length){const s=this._prevPos,r=this._motion;i=i[0];const o=e.modelMovable.getWorldPosition(new T.Vector3);e=((e,t,i)=>{const s=(new T.Vector2).subVectors(t,e).normalize(),r=(new T.Vector2).subVectors(i,e).normalize();t=r.angle()-s.angle(),i=-Math.sign(t)*(2*Math.PI-Math.abs(t));return Math.abs(t)<Math.abs(i)?t:i})((new T.Vector2).fromArray(o.project(t).toArray()),s,i)*this._userScale,t=(new T.Quaternion).setFromAxisAngle(this._axis,e),e=this._getInterpolatedQuaternion();this._fromQuat.copy(e),this._toQuat.premultiply(t),r.reset(0),r.setEndDelta(1),s.copy(i)}}update({scene:e},t){if(this._active){const i=this._motion;i.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,i=this._fromQuat,e=e.val;return(new T.Quaternion).copy(i).slerp(t,e)}}(C=O=O||{})[C.WAITING=0]="WAITING",C[C.TRANSLATING=1]="TRANSLATING",C[C.BOUNCING=2]="BOUNCING";class we{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:i=s.EASE_OUT_BOUNCE}={}){this._hoverPosition=new T.Vector3,this._floorPosition=new T.Vector3,this._wallRotation=new T.Quaternion,this._dragPlane=new T.Plane,this._enabled=!1,this._vertical=!1,this._state=O.WAITING,this._initialPos=new T.Vector2,this._hoverHeight=e,this._bounceMotion=new R({duration:t,easing:i,range:y})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=O.TRANSLATING}}deactivate(){if(!this._enabled||this._vertical||this._state===O.WAITING)this._state=O.WAITING;else{this._state=O.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const i=this._bounceMotion;t=t.y-e.y;i.reset(t),i.setEndDelta(-t)}}init(e,t,i){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=i?new T.Vector3(0,1,0).applyQuaternion(t):new T.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=i}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:i},{hitResults:s}){var r=this._state,r=r===O.WAITING||r===O.BOUNCING;if(s&&1===s.length&&!r){const c=s[0];r=this._floorPosition.clone();const _=this._floorPosition,d=this._hoverPosition;s=this._hoverHeight;const u=this._dragPlane;var o=this._vertical,n=c.results[0]&&c.results[0].getPose(t),a=n&&(new T.Matrix4).fromArray(n.transform.matrix),h=n&&.75<a.elements[5],l=n&&a.elements[5]<.25,i=(new T.Vector3).setFromMatrixPosition(i.matrixWorld),a=n&&(new T.Vector3).setFromMatrixPosition(a);if(o)if(!e||n&&l){const p=new T.Vector3(0,1,0);o=n.transform.orientation,l=p.clone().applyQuaternion(new T.Quaternion(o.x,o.y,o.z,o.w)).normalize(),o=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),l);const v=new T.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(v.dot(l)))>=Math.PI/18){o=(new T.Matrix4).makeBasis(o,p,l);const g=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(o);g.z=0,g.x=Math.PI/2,this._wallRotation.setFromEuler(g),u.normal.copy(new T.Vector3(0,1,0).applyQuaternion(this._wallRotation)),u.constant=this._calcDragPlaneConstant(a)}l=(new T.Vector3).subVectors(a,i).normalize();const m=new T.Ray(i,l);o=m.intersectPlane(u,new T.Vector3);o&&_.copy(o)}else{l=e.getPose(c.inputSource.targetRaySpace,t);if(!l)return;o=l.transform.position;const E=new T.Vector3(o.x,o.y,o.z);l=E.sub(i).normalize();const b=new T.Ray(i,l);o=b.intersectPlane(u,new T.Vector3);void(o&&_.copy(o))}else if(!e||n&&h){l=-u.constant,o=a.y+s,n=(.1<o-l&&(u.constant=-o),(new T.Vector3).subVectors(a,i).normalize());const w=new T.Ray(i,n);h=w.intersectPlane(u,new T.Vector3);h&&(_.copy(h),_.setY(a.y),d.copy(h))}else{s=e.getPose(c.inputSource.targetRaySpace,t);if(!s)return;l=s.transform.position;const f=new T.Vector3(l.x,l.y,l.z);o=f.sub(i).normalize();const y=new T.Ray(i,o);n=y.intersectPlane(u,new T.Vector3);void(n&&(_.copy(n),_.setY(r.y),d.copy(n)))}}}update({scene:e},t){var i=this._state,s=this._floorPosition;const r=this._hoverPosition,o=this._bounceMotion;var n=this._vertical;i===O.BOUNCING&&(o.update(t),r.setY(s.y+o.val),1<=o.progress&&(this._state=O.WAITING)),e.setRootPosition(s),n?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-s.y)}_calcDragPlaneConstant(e){var t=this._vertical,i=this._dragPlane.normal.clone();const s=new T.Plane(i,0);i=t?0:this._hoverHeight;return-(s.distanceToPoint(e)+i)}}class fe{constructor({width:e=.1,padding:t=20,offset:i=.05,font:s="64px sans-serif",color:r="white"}={}){const o=document.createElement("canvas"),n=o.getContext("2d");n.font=s;var a=n.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,a=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,l=(e=>{let t=1;for(;t<e;)t*=2;return t})(h),e=(o.width=l,e*((o.height=l)/h)),l=(this._ctx=n,this._canvas=o,this._height=e*a/h,this._texture=new T.CanvasTexture(o),new T.PlaneGeometry(e,e)),a=new T.Mesh(l,new T.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=s,this._color=r,this._padding=t,this._offset=i,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,i){const s=this._mesh;i=this._height/2+this._offset+i,i=new T.Vector3(0,i,0).applyQuaternion(e.clone().invert());s.position.copy(i),s.lookAt(t)}updateScale(e){const t=this._ctx;var i=this._canvas,s=this._padding,r=(100*e).toFixed(0),o=(t.clearRect(0,0,i.width,i.height),i.width/2),i=i.height/2,n=t.measureText(r+"%"),a=(n.actualBoundingBoxLeft+n.actualBoundingBoxRight)/2,n=(n.actualBoundingBoxAscent+n.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(o-a,i-n-s),t.lineTo(o+a,i-n-s),t.quadraticCurveTo(o+a+s,i-n-s,o+a+s,i-n),t.lineTo(o+a+s,i+n),t.quadraticCurveTo(o+a+s,i+n+s,o+a,i+n+s),t.lineTo(o-a,i+n+s),t.quadraticCurveTo(o-a-s,i+n+s,o-a-s,i+n),t.lineTo(o-a-s,i-n),t.quadraticCurveTo(o-a-s,i-n-s,o-a,i-n-s),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",o,i),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class ye{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new fe,this._motion=new R({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new fe}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:i,xrCam:s,initialScale:r}){const o=this._motion;var n=o.range;if(r===W){var a=2*Math.atan(1/s.projectionMatrix.elements[5]),h=s.projectionMatrix.elements[0]/s.projectionMatrix.elements[5];const c=s.position;s=t.bbox.max.y-t.bbox.min.y,i=c.distanceTo((new T.Vector3).addVectors(i,new T.Vector3(0,s/2,0)))*Math.tan(a/2),s=i*h,a=t.bbox.getBoundingSphere(new T.Sphere),h=i/a.radius,t=s/a.radius;const l=_(Math.min(t,h),n.min,1);o.reset(l)}else o.reset(_(r,n.min,n.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new T.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const s=this._motion;var t=(new T.Vector2).subVectors(t[0],t[1]).length(),i=t-this._prevCoordDistance;s.setEndDelta(i),this._prevCoordDistance=t,this._updateUIPosition(e)}}update({scene:e},t){if(this._enabled&&this._active){const i=this._motion;i.update(t),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:i,vertical:s}){const r=e.model;e=(new T.Vector3).setFromMatrixPosition(i.matrixWorld),i=s?r.bbox.getBoundingSphere(new T.Sphere).radius:r.bbox.max.y-r.bbox.min.y;this._ui.updatePosition(t.root.quaternion,e,i)}}class Te{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:i=1e3}={}){var s=Math.PI/18;const r=new T.RingGeometry(.975,1,150,1,-6*s,30*s),o=(r.rotateX(-Math.PI/2),new T.RingGeometry(.96,1.015,30,1,25*s,4*s)),n=o.attributes["position"];var a=Math.floor(11*n.count/16),h=Math.floor(13*n.count/16),l=Math.floor((h-a+1)/2),c=(new T.Vector3).fromBufferAttribute(n,a).y;for(let e=a;e<h;e++){var _=e-a,_=.025*(l-Math.abs(_-l));n.setY(e,c-_)}o.rotateX(-Math.PI/2);var s=new T.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),d=new T.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),s=new T.Mesh(r,s),d=new T.Mesh(o,d);const u=new T.Group;u.add(s,d),u.position.setY(1e-4),this._mesh=u,this._ring=s,this._arrow=d,this._animator=new R({duration:i}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new T.Sphere).radius)}update({delta:e,rotation:t}){const i=this._mesh,s=this._animator;if(i.visible){s.update(e);const r=this._ring.material,o=this._arrow.material;e=this._opacityRange;r.opacity=s.val*e.min,o.opacity=s.val*e.max,s.val<=0&&(i.visible=!1),i.quaternion.copy(t),i.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(C=l=l||{})[C.WAITING=0]="WAITING",C[C.IN_DEADZONE=1]="IN_DEADZONE",C[C.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class Oe{constructor({size:e=.1}={}){this._state=l.WAITING,this._detectedGesture=m.NONE,this._testingGestures=m.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new T.Vector2,this._prevTwoFingerPos=new T.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===l.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new T.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new T.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=l.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,m.NONE)}cleanup(){this._testingGestures=m.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=m.NONE,this._state=l.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,i=this._size,s=this._testingGestures,r=this._lastFingerCount,o=e.length;if(t===l.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=o,this.applyScreenAspect(e),o!==r)return this.setFirstInput(e),m.NONE;if(1===o){t=e[0],r=this._prevOneFingerPos.clone();const n=(new T.Vector2).subVectors(t,r);n.length()>i&&(Math.abs(n.x)>Math.abs(n.y)?m.ONE_FINGER_HORIZONTAL&s&&(this._detectedGesture=m.ONE_FINGER_HORIZONTAL):m.ONE_FINGER_VERTICAL&s&&(this._detectedGesture=m.ONE_FINGER_VERTICAL))}else if(2===o){t=(new T.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),r=this._prevTwoFingerPos.clone();const a=(new T.Vector2).subVectors(t,r);a.length()>i&&(Math.abs(a.x)>Math.abs(a.y)?m.TWO_FINGER_HORIZONTAL&s&&(this._detectedGesture=m.TWO_FINGER_HORIZONTAL):m.TWO_FINGER_VERTICAL&s&&(this._detectedGesture=m.TWO_FINGER_VERTICAL));o=(new T.Vector2).subVectors(e[1],e[0]).length();Math.abs(o-this._initialTwoFingerDistance)>i&&m.PINCH&s&&(this._detectedGesture=m.PINCH)}return this._detectedGesture!==m.NONE&&(this._state=l.OUT_OF_DEADZONE),this._detectedGesture}}class Re{constructor(e,t,{rotate:i,translate:s,scale:r,ring:o,deadzone:n,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var e=this._view3D,i=this._arScene,s=this._hitTestSource;const r=this._deadzoneChecker;var o=this._rotateControl,n=this._translateControl,a=this._scaleControl;const h=e.renderer.threeRenderer;var l=h.xr.getCamera(new T.PerspectiveCamera),c=h.xr.getReferenceSpace();if(s&&!(l.cameras.length<=0)){l=l.cameras[0];const _=e.model;o.enabled&&r.addTestingGestures(m.ONE_FINGER),n.enabled&&r.addTestingGestures(m.ONE_FINGER),a.enabled&&r.addTestingGestures(m.PINCH);e=t.getHitTestResultsForTransientInput(s),o=this._hitResultToVector(e);if(r.applyScreenAspect(o),r.setFirstInput(o),1===o.length){n=t.getPose(e[0].inputSource.targetRaySpace,c);if(n){a=(new T.Vector3).setFromMatrixPosition(l.matrixWorld),s=n.transform.position,o=new T.Vector3(s.x,s.y,s.z).sub(a).normalize();const d=new T.Ray(a,o),u=_.bbox.getBoundingSphere(new T.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new T.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=i,this._translate=s,this._scale=r,this._initialScale=a,this._rotateControl=new be(G(i)),this._translateControl=new we(G(s)),this._scaleControl=new ye(G(r)),this._floorIndicator=new Te(o),this._deadzoneChecker=new Oe(n)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:o,session:n,size:a,vertical:h,hitPosition:l,hitRotation:c}){return H(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var i=this._scaleControl,s=this._floorIndicator;const r=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),r.setAspect(a.height/a.width),e.add(s.mesh,i.ui.mesh),this.syncTargetModel(o);s=yield n.requestHitTestSourceForTransientInput({profile:ve.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(S.SELECT_START,this._onSelectStart),e.removeEventListener(S.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,i=this._translate,s=this._scale;const r=this._rotateControl,o=this._translateControl,n=this._scaleControl;var a=this._vertical;e.addEventListener(S.SELECT_START,this._onSelectStart),e.addEventListener(S.SELECT_END,this._onSelectEnd),t&&!a&&r.enable(),i&&o.enable(),s&&n.enable()}disable(e){const t=this._rotateControl,i=this._translateControl,s=this._scaleControl;e.removeEventListener(S.SELECT_START,this._onSelectStart),e.removeEventListener(S.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),i.disable(),s.disable()}update(e){const{view3D:t,session:i,frame:s}=e;var r,o,n=this._hitTestSource;n&&t.model&&(r=this._deadzoneChecker,o=i.inputSources,n=null!=(n=null===s||void 0===s?void 0:s.getHitTestResultsForTransientInput(n))?n:[],o={coords:this._hitResultToVector(n),inputSources:o,hitResults:n},r.inDeadzone?this._checkDeadzone(e,o):this._processInput(e,o),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,i=this._translateControl.floorPosition,s=this._view3D.renderer.threeRenderer.xr.getCamera(new T.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:i,xrCam:s,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var i=this._arScene;const s=this._rotateControl,r=this._translateControl,o=this._scaleControl;var n=this._deadzoneChecker.check(t.map(e=>e.clone()));if(n!==m.NONE)switch(n){case m.ONE_FINGER_HORIZONTAL:case m.ONE_FINGER_VERTICAL:this._modelHit?(r.activate(),r.setInitialPos(t)):(s.activate(),s.updateRotation(i.modelMovable.quaternion),s.setInitialPos(t));break;case m.PINCH:o.activate(e),o.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const i=this._arScene,s=this._rotateControl,r=this._translateControl,o=this._scaleControl,n=this._floorIndicator;var t=1e3*t,e=(s.update(e,t),r.update(e,t),o.update(e,t),s.rotation),a=r.floorPosition;i.setRootPosition(a),n.update({delta:t,rotation:e})}_hitResultToVector(e){return e.map(e=>(new T.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class Se{constructor(){this._root=new T.Scene,this._modelRoot=new T.Group,this._modelMovable=new T.Group,this._modelFixed=new T.Group,this._arRoot=new T.Group;const e=this._root,t=this._modelRoot;var i=this._modelMovable,s=this._modelFixed,r=this._arRoot;t.add(i),e.add(t,s,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,i=this._modelMovable,s=this._modelFixed;e=e.scene;i.add(e.userObjects,e.envObjects),s.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,i=this._modelFixed;const s=e.scene;[...t.children,...i.children].forEach(e=>{s.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const i=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,i.position.setZ(t/2),i.position.setY(-e.bbox.min.z),i.rotateX(-Math.PI/2),i.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class xe{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,me.DOM_OVERLAY(e)}}class Me{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(pe.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return me.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class Ce{constructor(e,{features:t=ge,vertical:i=!1,overlayRoot:s=null,rotate:r=!0,translate:o=!0,scale:n=!0,ring:a={},deadzone:h={},initialScale:l=W}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=i,this.overlayRoot=s,this._arScene=new Se,this._control=new Re(e,this._arScene,{rotate:r,translate:o,scale:n,ring:a,deadzone:h,initialScale:l}),this._hitTest=new Me,this._domOverlay=new xe}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&Me.isAvailable()&&xe.isAvailable()?navigator.xr.isSessionSupported(ue.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}enter(){return H(this,void 0,void 0,function*(){const a=this._view3D,h=a.scene,l=this._arScene,e=a.renderer,c=e.threeRenderer,_=this._control,t=this._hitTest,i=this._domOverlay,d=this.vertical;var s=this._getAllXRFeatures();c.xr.enabled=!0;const u=yield navigator.xr.requestSession(ue.AR,s),r=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(pe.LOCAL),yield c.xr.setSession(u),l.init(a),t.init(u);u.addEventListener("end",()=>H(this,void 0,void 0,function*(){_.destroy(u),l.destroy(a),i.destroy(),c.setPixelRatio(r),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),a.trigger(b.AR_END,{target:a,type:b.AR_END,session:this})}),{once:!0});const p=new T.Clock;p.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var i,s,r,o=c.xr.getCamera(new T.PerspectiveCamera),n=p.getDelta();o.cameras.length<=0||(o=o.cameras[0],i=c.xr.getReferenceSpace(),s={width:null!=(r=null==(s=u.renderState.baseLayer)?void 0:s.framebufferWidth)?r:1,height:null!=(r=null==s?void 0:s.framebufferHeight)?r:1},r={view3D:a,scene:l,session:u,delta:n,frame:t,vertical:d,referenceSpace:i,xrCam:o,size:s},t=1e3*n,a.trigger(b.BEFORE_RENDER,{type:b.BEFORE_RENDER,target:a,delta:t}),this._modelPlaced?(_.update(r),a.animator.update(n),h.shadowPlane.render(),c.render(l.root,o)):this._initModelPosition(r),a.trigger(b.RENDER,{type:b.RENDER,target:a,delta:t}))}),a.trigger(b.AR_START,{type:b.AR_START,target:a,session:this})})}exit(){return H(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=X(this.overlayRoot))?t:this._createARRootElement();return Z({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:i,size:s,vertical:r,referenceSpace:o}=e,n=this._view3D;e=n.model;const a=this._arScene,h=this._hitTest;if(h.ready&&e){const d=this._control;var l=h.getResults(t);if(!(l.length<=0)){const u=l[0];l=u.getPose(o);if(l){var c=(new T.Matrix4).fromArray(l.transform.matrix);if(!(!r&&c.elements[5]<.75||r&&(.25<=c.elements[5]||c.elements[5]<=-.25))){c=(new T.Vector3).setFromMatrixPosition(c);const p=new T.Quaternion;if(r){const g=new T.Vector3(0,1,0);var l=l.transform.orientation,l=g.clone().applyQuaternion(new T.Quaternion(l.x,l.y,l.z,l.w)).normalize(),_=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),l),_=(new T.Matrix4).makeBasis(_,g,l);const E=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);E.z=0,E.x=Math.PI/2,p.setFromEuler(E),a.setWallRotation(p)}a.updateModelRootPosition(e,r),a.setRootPosition(c),a.showModel(),h.destroy(),this._modelPlaced=!0,n.trigger(b.AR_MODEL_PLACED,{type:b.AR_MODEL_PLACED,target:n,session:this,model:e}),d.init({model:e,vertical:r,session:i,size:s,hitPosition:c,hitRotation:p});const v=d.scale.scale,m=new de({context:i,duration:1e3});m.on("progress",e=>{a.setModelScale(e.easedProgress*v)}),m.on("finish",()=>{a.setModelScale(v),d.enable(i)}),m.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement("div");return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(b.AR_END,()=>{e.rootEl.removeChild(t)}),t}}Ce.type=t.WEBXR;class Le{constructor(e,t={}){var{file:i=null,mode:s=v.ONLY_AR,fallbackURL:r=null,title:o=null,link:n=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=W,shareText:d=null}=t,t=function(e,t){var i={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]]);return i}(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=i,this.fallbackURL=r,this.mode=s,this.title=o,this.link=n,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var r;return H(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=o(this.resizable),t.enable_vertical_placement=o(this.vertical),t.disable_occlusion=o(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var i=null!=(r=this.file)?r:e.src;if(!i)return Promise.reject(new k(B.FILE_NOT_SUPPORTED(null!=(r=this.file)?r:e.src),U.FILE_NOT_SUPPORTED));t.file=new URL(i,window.location.href).href;e=this.fallbackURL,i=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===v.ONLY_AR?Ee.INTENT_AR_CORE(i,e):Ee.INTENT_SEARCHBOX(i,e||Ee.FALLBACK_DEFAULT(i));const s=document.createElement("a");s.href=e,s.click()})}exit(){return Promise.resolve()}}Le.type=t.SCENE_VIEWER;class Pe{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:i=null,applePayButtonType:s=null,callToAction:r=null,checkoutTitle:o=null,checkoutSubtitle:n=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=i,this.applePayButtonType=s,this.callToAction=r,this.checkoutTitle=o,this.checkoutSubtitle=n,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new k(B.FILE_NOT_SUPPORTED(""+e),U.FILE_NOT_SUPPORTED));var i=this.canonicalWebPageURL,s=this.custom,r=window.location.href;const o=document.createElement("a"),n=(o.setAttribute("rel","ar"),o.appendChild(document.createElement("img")),Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,i])=>(i&&(e[t]=i),e),{})),a=new URL(e,r);return this.allowsContentScaling||(n.allowsContentScaling="0"),i&&(n.canonicalWebPageURL=new URL(i,r).href),s&&(n.custom=new URL(s,r).href),a.hash=new URLSearchParams(n).toString(),o.setAttribute("href",a.href),o.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(b.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:b.QUICK_LOOK_TAP,target:t}))},!1),o.click(),Promise.resolve()}exit(){return Promise.resolve()}}Pe.type=t.QUICK_LOOK;const De={[t.WEBXR]:Ce,[t.SCENE_VIEWER]:Le,[t.QUICK_LOOK]:Pe};class Ae{constructor(e){this._view3D=e,this._activeSession=null,e.on(b.AR_START,({session:e})=>{this._activeSession=e}),e.on(b.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return H(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return H(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new k(B.NOT_INITIALIZED,U.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const i=new t(e,G(e[t.type]));return yield i.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return H(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>De[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class Ie extends e{constructor(e,{duration:t=300,easing:i=f,scale:s=1,disablePitch:r=!1,disableYaw:o=!1}={}){super(),this._screenScale=new T.Vector2(0,0),this._prevPos=new T.Vector2(0,0),this._enabled=!1,this._onMouseDown=e=>{if(e.button===h.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(c.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(c.MOUSE_UP,this._onMouseUp,!1),this.trigger(E.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,i=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);i.multiply(this._screenScale),this._xMotion.setEndDelta(i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(c.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(c.MOUSE_UP,this._onMouseUp,!1),this.trigger(E.RELEASE)},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY)},this._onTouchMove=e=>{if(!(1<e.touches.length||this._isScrolling)){var t=e.touches[0],i=this._view3D.scrollable;if(!i||e.cancelable){if(this._isFirstTouch){if(i){var s=new T.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(s.y)>Math.abs(s.x))return void(this._isScrolling=!0)}this._isFirstTouch=!1}!i&&e.cancelable&&e.preventDefault(),e.stopPropagation();const r=this._prevPos,o=new T.Vector2(t.clientX,t.clientY).sub(r).multiplyScalar(this._scale);o.multiply(this._screenScale),this._xMotion.setEndDelta(o.x),this._yMotion.setEndDelta(o.y),r.set(t.clientX,t.clientY)}}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):this._prevPos.set(0,0),this._isScrolling=!1},this._view3D=e,this._scale=s,this._duration=t,this._easing=i,this._disablePitch=r,this._disableYaw=o,this._isFirstTouch=!1,this._isScrolling=!1,this._xMotion=new R({duration:t,range:y,easing:i}),this._yMotion=new R({duration:t,range:oe,easing:i})}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,i=this._xMotion,s=this._yMotion;var r=!this._disableYaw,o=!this._disablePitch,e=new T.Vector2(i.update(e),s.update(e));r&&(t.yaw+=e.x),o&&(t.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(c.MOUSE_DOWN,this._onMouseDown),e.addEventListener(c.TOUCH_START,this._onTouchStart,{passive:!0}),e.addEventListener(c.TOUCH_MOVE,this._onTouchMove,{passive:this._view3D.scrollable}),e.addEventListener(c.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(E.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(c.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(c.MOUSE_MOVE,this._onMouseMove),window.removeEventListener(c.MOUSE_UP,this._onMouseUp),e.removeEventListener(c.TOUCH_START,this._onTouchStart),e.removeEventListener(c.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(c.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(E.DISABLE)}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Ne extends e{constructor(e,{easing:t=f,duration:i=0,scale:s=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new T.Vector2(0,0),this._screenSize=new T.Vector2(0,0),this._onMouseDown=e=>{if(e.button===h.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(c.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(c.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(c.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(E.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var i=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(c.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(c.MOUSE_UP,this._onMouseUp,!1),this.trigger(E.RELEASE)},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._prevPos;e=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return i.copy(e),void(this._touchInitialized=!0);var t=(new T.Vector2).subVectors(e,i).multiplyScalar(this._scale);this._xMotion.setEndDelta(-t.x),this._yMotion.setEndDelta(t.y),i.copy(e)}},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized=!1:(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(c.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new R({duration:i,range:y,easing:t}),this._yMotion=new R({duration:i,range:y,easing:t}),this._scale=s}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera;var i=this._screenSize;const s=new T.Vector2(this._xMotion.update(e),this._yMotion.update(e)),r=new T.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),o=new T.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);e=new T.Vector2(t.renderWidth,t.renderHeight).divide(i);s.multiply(e),t.pivot.add(r.multiplyScalar(s.x)),t.pivot.add(o.multiplyScalar(s.y))}resize(e){const t=this._screenSize;t.copy(new T.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(c.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(c.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(c.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(c.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(E.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(c.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(c.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(c.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(c.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(c.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(c.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(c.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(E.DISABLE)}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new T.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class Fe{constructor(e,{scale:t=1,duration:i=300,minFov:s=1,maxFov:r=W,easing:o=f}={}){this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const i=this._motion;t=-this._scale*this._wheelModifier*e.deltaY;i.setEndDelta(t)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._motion;e=this._prevTouchDistance;const r=new T.Vector2(t[0].pageX,t[0].pageY);t=new T.Vector2(t[1].pageX,t[1].pageY);const o=r.sub(t);var t=o.length()*this._scale*this._touchModifier,i=t-e;this._prevTouchDistance=t,e<0||s.setEndDelta(i)}},this._onTouchEnd=()=>{this._prevTouchDistance=-1},this._view3D=e,this._scale=t,this._duration=i,this._minFov=s,this._maxFov=r,this._easing=o,this._range={min:s,max:r===W?180:r},this._motion=new R({duration:i,easing:o,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get range(){return this._range}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get easing(){return this._easing}set scale(e){this._scale=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,i=this._motion;t.zoom+=i.update(e)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(c.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(c.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(c.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync()}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(c.WHEEL,this._onWheel,!1),e.removeEventListener(c.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(c.TOUCH_END,this._onTouchEnd,!1),this._enabled=!1}}sync(){this._motion.reset(0)}updateRange(){var e=this._maxFov;const t=this._range;var i=this._view3D["camera"],i=i.baseFov;e===W&&(t.max=Math.min(i+45,175))}}class ze{constructor(e){this._onEnable=()=>{var e=this._view3D,t=e.renderer.canvas;e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===r.NONE&&this._setCursor(r.GRAB)},this._onDisable=()=>{this._view3D.renderer.canvas.style.cursor===r.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(r.NONE)},this._onHold=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(r.GRABBING)},this._onRelease=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(r.GRAB)},this._view3D=e,this._rotateControl=new Ie(e,G(e.rotate)),this._translateControl=new Ne(e,G(e.translate)),this._zoomControl=new Fe(e,G(e.zoom)),[this._rotateControl,this._translateControl].forEach(e=>{e.on({[E.HOLD]:this._onHold,[E.RELEASE]:this._onRelease,[E.ENABLE]:this._onEnable,[E.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy()}update(e){this._rotateControl.update(e),this._translateControl.update(e),this._zoomControl.update(e)}resize(e){this._rotateControl.resize(e),this._translateControl.resize(e),this._zoomControl.resize(e)}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable()}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable()}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync()}updateCursor(){var e=this._view3D.useGrabCursor?r.GRAB:r.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===r.NONE){const i=t.renderer.canvas;i.style.cursor=e}}}class Ve{constructor(e,{delay:t=2e3,delayOnMouseLeave:i=0,speed:s=1,pauseOnHover:r=!1,canInterrupt:o=!0,disableOnInterrupt:n=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==h.LEFT&&e.button!==h.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(c.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(c.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=i,this._speed=s,this._pauseOnHover=r,this._canInterrupt=o,this._disableOnInterrupt=n}get enabled(){return this._enabled}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(c.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(c.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(c.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(c.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(c.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(c.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(c.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(c.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(c.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(c.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(c.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(c.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(c.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class ke{constructor({src:e,scenes:t,animations:i=[],fixSkinnedBbox:s=!1,castShadow:r=!0,receiveShadow:o=!1}){this._src=e;const n=new T.Group,a=(n.add(...t),this._animations=i,this._scene=n,this._getInitialBbox(s));e=a.min.y;n.translateY(-e),n.updateMatrixWorld(),a.translate(new T.Vector3(0,-e,0)),this._fixSkinnedBbox=s,this._bbox=a,this.castShadow=r,this.receiveShadow=o}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(r,e){const t=this.meshes;let o=e;return t.forEach(t=>{var i=t.geometry.attributes["position"];if(i)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{o=r(o,e)});else for(let e=0;e<i.count;e++){const s=(new T.Vector3).fromBufferAttribute(i,e);s.applyMatrix4(t.matrixWorld),o=r(o,s)}}),o}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new T.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new T.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,i){var e=t.geometry,s=e.attributes.position;const r=e.attributes.skinIndex,o=e.attributes.skinWeight,n=t.skeleton,a=(n.update(),n.boneMatrices),h=o.normalized&&ArrayBuffer.isView(o.array)?1/(Math.pow(2,8*o.array.BYTES_PER_ELEMENT)-1):1;for(let e=0;e<s.count;e++){var l=(new T.Vector3).fromBufferAttribute(s,e);const c=new T.Vector4(0,0,0,0),_=new T.Vector4(l.x,l.y,l.z).applyMatrix4(t.bindMatrix),d=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)].map(e=>e*h),u=[r.getX(e),r.getY(e),r.getZ(e),r.getW(e)],p=(d.forEach((e,t)=>{t=(new T.Matrix4).fromArray(a,16*u[t]);c.add(_.clone().applyMatrix4(t).multiplyScalar(e))}),(new T.Vector3).fromArray(c.applyMatrix4(t.bindMatrixInverse).toArray()));p.applyMatrix4(t.matrixWorld),i(p)}}}const Ue=new N.DRACOLoader,Be=new F.KTX2Loader;class x extends J{constructor(e){super(e),this._loader=new I.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(Ue),t.setKTX2Loader(Be.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(s){return H(this,void 0,void 0,function*(){return new Promise((e,t)=>{const i=document.createElement("script");i.addEventListener("load",()=>H(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,x.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(i),e()})),i.addEventListener("error",()=>{document.body.removeChild(i),t()}),i.src=new URL(s,location.href).href,document.body.appendChild(i)})})}load(s){var e=this._view3D;const r=this._loader,o=p(e,s);return Ue.setDecoderPath(e.dracoPath),Be.setTranscoderPath(e.ktxPath),x.meshoptDecoder&&r.setMeshoptDecoder(x.meshoptDecoder),r.manager=T.DefaultLoadingManager,new Promise((t,i)=>{try{r.load(s,e=>{e=this._parseToModel(e,s);t(e)},e=>this._onLoadingProgress(e,s,o),e=>{o.initialized=!0,i(e)})}catch(e){i(e)}})}loadFromFiles(a){const h=this._view3D,l=this._loader,c=[],_=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return Ue.setDecoderPath(h.dracoPath),Be.setTranscoderPath(h.ktxPath),x.meshoptDecoder&&l.setMeshoptDecoder(x.meshoptDecoder),new Promise((t,i)=>{if(a.length<=0)i(new Error("No files found"));else{const s=a.find(e=>/\.(gltf|glb)$/i.test(e.name));if(s){const r=new Map,o=(a.forEach(e=>{r.set(e.name,e)}),URL.createObjectURL(s)),e=(c.push(o),new T.LoadingManager),n=(e.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";return r.has(t)?(t=r.get(t),t=URL.createObjectURL(t),c.push(t),t):e}),p(h,o));l.manager=e,l.load(o,e=>{e=this._parseToModel(e,s.name);_(),t(e)},e=>this._onLoadingProgress(e,o,n),e=>{n.initialized=!0,_(),i(e)})}else i(new Error("No glTF file found"))}})}_parseToModel(r,e){var t=this._view3D,i=t.fixSkinnedBbox;r.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const s=r.parser.json.extensionsUsed;if(s&&s.some(e=>e===w)){const o=t.renderer.threeRenderer.capabilities.maxTextureSize,n=[],a=(r.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&n.push(e)})}),n.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[])),h=a.reduce((e,t)=>[...e,...ee.filter(e=>t[e]).map(e=>t[e])],[]),l=r.parser.associations,c=r.parser.json,_=h.filter(e=>l.has(e)).map(e=>c.textures[l.get(e).textures]),d=_.reduce((s,e,t)=>{if(!e.extensions[w])return s;const r=h[t],i=e.extensions[w].levels;return i.forEach(({index:e,size:t},i)=>{t>o||(s[i]||(s[i]=[]),s[i].push({index:e,texture:r}))}),s},[]),u=d.map(()=>!1);d.forEach((s,i)=>H(this,void 0,void 0,function*(){const e=yield Promise.all(s.map(({index:e})=>r.parser.getDependency("texture",e)));var t=u.slice(i+1).some(e=>!!e);u[i]=!0,t||e.forEach((e,t)=>{const i=s[t].texture;i.image=e.image,i.needsUpdate=!0})}))}return new ke({src:e,scenes:r.scenes,animations:r.animations,fixSkinnedBbox:i})}}class i extends e{constructor(e,{src:t=null,iosSrc:i=null,dracoPath:s="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:r="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:o=null,fixSkinnedBbox:n=!1,fov:a=W,center:h=W,yaw:l=0,pitch:c=0,initialZoom:_=0,rotate:d=!0,translate:u=!0,zoom:p=!0,autoplay:v=!1,scrollable:m=!0,wheelScrollable:g=!1,useGrabCursor:E=!0,skybox:b=null,envmap:w=null,background:f=null,exposure:y=1,shadow:T=!0,skyboxBlur:O=!1,toneMapping:R=Q.LINEAR,webAR:S=!0,sceneViewer:x=!0,quickLook:M=!0,arPriority:C=ne,poster:L=null,canvasSelector:P="canvas",autoInit:D=!0,autoResize:A=!0,useResizeObserver:I=!0,maintainSize:F=!1,on:z={},plugins:N=[],maxDeltaTime:V=1/30}={}){super(),this._rootEl=((e,t)=>{t=X(e,t);if(t)return t;throw new k(B.WRONG_TYPE(e,["HTMLElement","string"]),U.WRONG_TYPE)})(e),this._src=t,this._iosSrc=i,this._dracoPath=s,this._ktxPath=r,this._meshoptPath=o,this._fixSkinnedBbox=n,this._fov=a,this._center=h,this._yaw=l,this._pitch=c,this._initialZoom=_,this._rotate=d,this._translate=u,this._zoom=p,this._autoplay=v,this._scrollable=m,this._wheelScrollable=g,this._useGrabCursor=E,this._skybox=b,this._envmap=w,this._background=f,this._exposure=y,this._shadow=T,this._skyboxBlur=O,this._toneMapping=R,this._webAR=S,this._sceneViewer=x,this._quickLook=M,this._arPriority=C,this._poster=L,this._canvasSelector=P,this._autoInit=D,this._autoResize=A,this._useResizeObserver=I,this._maintainSize=F,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=N,this._maxDeltaTime=V,this._renderer=new K(this),this._camera=new le(this),this._control=new ze(this),this._scene=new se(this),this._animator=new _e(this),this._autoPlayer=new Ve(this,G(v)),this._autoResizer=new ce(this),this._arManager=new Ae(this),this._addEventHandlers(z),this._addPosterImage(),H(this,void 0,void 0,function*(){yield this._initPlugins(N),t&&D&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set skybox(e){this._scene.setSkybox(e),this._skybox=e}set envmap(e){this._scene.setEnvMap(e),this._envmap=e}set exposure(e){this._renderer.threeRenderer.toneMappingExposure=e,this._exposure=e}set skyboxBlur(e){this._skyboxBlur=e;const t=this._scene;var i=t.root.environment;i&&t.skybox&&(e?t.skybox.useBlurredHDR(i):t.skybox.useTexture(i))}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set maxDeltaTime(e){this._maxDeltaTime=e}set maintainSize(e){this._maintainSize=e}destroy(){this._scene.reset(),this._renderer.stopAnimationLoop(),this._control.destroy(),this._autoResizer.disable(),this._animator.reset(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return H(this,void 0,void 0,function*(){if(!this._src)throw new k(B.PROVIDE_SRC_FIRST,U.PROVIDE_SRC_FIRST);const e=this._scene,t=this._renderer,i=this._control;var s=this._skybox,r=this._envmap,o=this._background,n=this._meshoptPath;const a=[];if(this.resize(),this._autoResize&&this._autoResizer.enable(),n&&!x.meshoptDecoder&&(yield x.setMeshoptDecoder(n)),s||r){const h=new T.AmbientLight,l=(e.add(h,!1),s?e.setSkybox(s):e.setEnvMap(r));a.push(l.then(()=>{e.remove(h)}))}!s&&o&&a.push(e.setBackground(o));n=this._loadModel(this._src);a.push(...n),this._resetLoadingContextOnFinish(a),yield Promise.race(n),i.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),this._initialized=!0,this.trigger(b.READY,{type:b.READY,target:this})})}resize(){const e=this._renderer;var t=this._initialized?e.size:null,i=(e.resize(),e.size);this._camera.resize(i,t),this._control.resize(i),e.threeRenderer.xr.isPresenting||e.defaultRenderLoop(0),this.trigger(b.RESIZE,Object.assign(Object.assign({},i),{type:b.RESIZE,target:this}))}load(t){return H(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t):(this._src=t,yield this.init())})}display(e,{resetCamera:t=!0}={}){var i=this._renderer;const s=this._scene,r=this._camera,o=this._animator;i=i.threeRenderer.xr.isPresenting;if(s.reset(),s.add(e.scene),s.shadowPlane.updateDimensions(e),t&&(r.fit(e,this._center),r.reset(0)),o.reset(),o.setClips(e.animations),0<e.animations.length&&o.play(0),this._model=e,i){const n=this._arManager.activeSession;n&&n.control.syncTargetModel(e)}this.trigger(b.MODEL_CHANGE,{type:b.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return H(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return H(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var i=t.toDataURL("png");const s=document.createElement("a");s.href=i,s.download=e,s.click()}_loadModel(e){const i=new x(this);if(Array.isArray(e)){const s=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(i,e,t,s))}return[this._loadSingleModel(i,e,0,[!1])]}_loadSingleModel(r,o,n,a){return H(this,void 0,void 0,function*(){var t=a.length-1;this.trigger(b.LOAD_START,{type:b.LOAD_START,target:this,src:o,level:n,maxLevel:t});try{var e=yield r.load(o),i=a.slice(n+1).some(e=>!!e),s=a.some(e=>!!e);if(this.trigger(b.LOAD,{type:b.LOAD,target:this,model:e,level:n,maxLevel:t}),a[n]=!0,i)return;this.display(e,{resetCamera:!s})}catch(e){throw this.trigger(b.LOAD_ERROR,{type:b.LOAD_ERROR,target:this,level:n,maxLevel:t,error:e}),new k(B.MODEL_FAIL_TO_LOAD(o),U.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const i=this._rootEl;if(t){var s=Y(t);let e;if(s||(e=>{if(!j(e))return!1;const t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0})(t)){s=s?t:i.querySelector(t);if(!s)throw new k(B.ELEMENT_NOT_FOUND(t),U.ELEMENT_NOT_FOUND);e=s}else{const r=document.createElement("img");r.className=q.POSTER,r.src=t,i.appendChild(r),e=r,this.once(b.READY,()=>{r.parentElement===i&&i.removeChild(r)})}this.once(b.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return H(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return H(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(b.LOAD_FINISH,{type:b.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}i.VERSION="2.3.0";class M{constructor(e={}){this._startLoading=({target:s,level:e})=>{if(0!==e)return;const{type:t="default",loadingLabel:i="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:o="#ffffff",barWidth:n="70%",barHeight:a="10px",barBackground:h="#bbbbbb",barForeground:l="#3e8ed0",spinnerWidth:c="30%",overlayBackground:_="rgba(0, 0, 0, 0.3)"}=this._options,d=document.createElement("div"),u=document.createElement("div"),p=document.createElement("div"),v=document.createElement("div"),m=document.createElement("div");if(d.classList.add("view3d-lb-overlay"),u.classList.add("view3d-lb-wrapper"),v.classList.add("view3d-lb-base"),p.classList.add("view3d-lb-label"),m.classList.add("view3d-lb-filler"),d.style.backgroundColor=_,t!==M.TYPE.SPINNER?(v.style.height=a,v.style.backgroundColor=h,m.style.backgroundColor=l):(v.classList.add("type-spinner"),v.style.width=c,v.style.paddingTop=c,m.style.borderWidth=a,m.style.borderColor=l,m.style.borderLeftColor="transparent"),t===M.TYPE.TOP?d.classList.add("type-top"):t===M.TYPE.DEFAULT&&(v.style.width=n),p.style.color=o,p.innerText=i,v.appendChild(m),u.appendChild(v),u.appendChild(p),d.appendChild(u),s.rootEl.appendChild(d),t!==M.TYPE.SPINNER){const g=()=>{if(s.loadingContext.every(e=>e.initialized)){var[e,t]=s.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]);if(!(t<=0)){const i=e/t*100;m.style.width=i.toFixed(2)+"%",e===t&&(p.innerText=r)}}};s.on(b.PROGRESS,g),s.once(b.LOAD_FINISH,()=>{s.off(b.PROGRESS,g)})}s.once(b.LOAD_FINISH,()=>{this._removeOverlay(s)}),this._overlay=d},this._options=e}init(e){return H(this,void 0,void 0,function*(){e.on(b.LOAD_START,this._startLoading)})}teardown(e){e.off(b.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}M.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};var C={__proto__:null,default:i,Animation:de,ARManager:Ae,AutoPlayer:Ve,AutoResizer:ce,Camera:le,Model:ke,ModelAnimator:_e,Motion:R,Pose:he,Renderer:K,Scene:se,ShadowPlane:te,Skybox:ie,View3DError:k,AnimationControl:ae,OrbitControl:ze,RotateControl:Ie,TranslateControl:Ne,ZoomControl:Fe,GLTFLoader:x,TextureLoader:g,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return H(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return H(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:i="view3d-ar-button",tooltipClass:s="view3d-tooltip"}=this._options;const r=yield a.ar.isAvailable(),o=document.createElement("button"),n=document.createElement("div");e=document.createTextNode(r?e:t);o.classList.add(i),n.classList.add(s),o.disabled=!0,o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',o.appendChild(n),n.appendChild(e),a.rootEl.appendChild(o),this._button=o,a.initialized?yield this._setAvailable(a,o,r):a.once(b.MODEL_CHANGE,()=>{this._setAvailable(a,o,r)})})}_setAvailable(e,t,i){return H(this,void 0,void 0,function*(){i?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:class{constructor(e={}){this._options=e}init(r){return H(this,void 0,void 0,function*(){r.on(b.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){if(this._cachedElements)Object.values(this._cachedElements).map(e=>{t.contains(e)||t.appendChild(e)});else{const i=document.createElement("div");i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',i.classList.add("view3d-ar-close"),t.appendChild(i),this._cachedElements={closeButton:i}}const i=this._cachedElements["closeButton"],s=()=>{e.exit()};i.addEventListener("click",s),r.once(b.AR_END,()=>{i.parentElement&&i.parentElement.removeChild(i),i.removeEventListener("click",s)})}})})}teardown(){}},LoadingBar:M,AUTO:W,EVENTS:b,EASING:s,DEFAULT_CLASS:q,TONE_MAPPING:Q,AR_SESSION_TYPE:t,SCENE_VIEWER_MODE:v,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},ERROR_CODES:z,isAvailable:({webGL:e=!0,fetch:t=!0,stream:i=!0,wasm:s=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(i&&!(window&&window.ReadableStream))return!1;if(s&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0}};return Z(i,C),i});
