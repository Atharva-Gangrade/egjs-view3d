/*
Copyright (c) 2020-present NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.4.0
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/shaders/HorizontalBlurShader"),require("three/examples/jsm/shaders/VerticalBlurShader"),require("three/examples/jsm/lights/LightProbeGenerator"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["three","@egjs/component","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/shaders/HorizontalBlurShader","three/examples/jsm/shaders/VerticalBlurShader","three/examples/jsm/lights/LightProbeGenerator","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.THREE,e.Component,e.RGBELoader,e.HorizontalBlurShader,e.VerticalBlurShader,e.LightProbeGenerator,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(y,e,L,D,P,N,r,n,I){"use strict";class G extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,G.prototype),this.name="View3DError",this.code=t}}var F={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,PROVIDE_WIDTH_OR_HEIGHT:5,FORMAT_NOT_SUPPORTED:6,FILE_NOT_SUPPORTED:7,NOT_INITIALIZED:8,MODEL_FAIL_TO_LOAD:9},W=F,j={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',PROVIDE_WIDTH_OR_HEIGHT:"Either width or height should be given.",FORMAT_NOT_SUPPORTED:e=>`Given format "${e}" is not supported or invalid.`,FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const z=e=>"number"==typeof e,Q=e=>"string"==typeof e,V=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,K=(e,t)=>{let i=null;if(Q(e)){const s=t||document;t=s.querySelector(e);if(!t)return null;i=t}else V(e)&&(i=e);return i},d=e=>e*Math.PI/180,v=e=>180*e/Math.PI,_=(e,t,i)=>Math.max(Math.min(e,i),t),o=(e,t,i)=>e*(1-i)+t*i,l=(e,t,i)=>{var s=Math.abs(i-t);return e<t?e=i-(t-e)%s:i<e&&(e=t+(e-i)%s),e},k=(s,...e)=>(e.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];Array.isArray(s[e])&&Array.isArray(t)?s[e]=[...s[e],...t]:s[e]=t})}),s),U=(e,t,i)=>{const s=(new y.Vector2).subVectors(t,e).normalize(),r=(new y.Vector2).subVectors(i,e).normalize();t=r.angle()-s.angle(),i=-Math.sign(t)*(2*Math.PI-Math.abs(t));return Math.abs(t)<Math.abs(i)?t:i},Y=e=>"object"==typeof e?e:{},B=e=>e?"true":"false",u=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t},h=e=>{var t;return e.normalized&&ArrayBuffer.isView(e.array)?(t=(e=>{const t=new e.constructor(1);return t[0]=-1,t[0]<0})(e=e.array),e=1/(Math.pow(2,8*e.BYTES_PER_ELEMENT)-1),t?2*e:e):1},H=(e,t,i,s)=>{var r=t.geometry,n=r.attributes.position;const o=r.attributes.skinIndex,a=r.attributes.skinWeight,h=t.skeleton.boneMatrices;r=(new y.Vector3).fromBufferAttribute(n,e).multiplyScalar(i);const l=new y.Vector4(0,0,0,0),c=new y.Vector4(r.x,r.y,r.z).applyMatrix4(t.bindMatrix),_=[a.getX(e),a.getY(e),a.getZ(e),a.getW(e)].map(e=>e*s),d=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)],u=(_.forEach((e,t)=>{t=(new y.Matrix4).fromArray(h,16*d[t]);l.add(c.clone().applyMatrix4(t).multiplyScalar(e))}),(new y.Vector3).fromArray(l.applyMatrix4(t.bindMatrixInverse).toArray()));return u.applyMatrix4(t.matrixWorld),u};function $(e,t){var i={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]]);return i}function Z(e,o,a,h){return new(a=a||Promise)(function(i,t){function s(e){try{n(h.next(e))}catch(e){t(e)}}function r(e){try{n(h.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?i(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(s,r)}n((h=h.apply(e,o||[])).next())})}const q="auto",w={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",INPUT_START:"inputStart",INPUT_END:"inputEnd",CAMERA_CHANGE:"cameraChange",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced",QUICK_LOOK_TAP:"quickLookTap"},J={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},X={POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay",ANNOTATION_WRAPPER:"view3d-annotation-wrapper",ANNOTATION:"view3d-annotation",ANNOTATION_TOOLTIP:"view3d-annotation-tooltip",ANNOTATION_DEFAULT:"default",ANNOTATION_SELECTED:"selected",ANNOTATION_FLIP_X:"flip-x",ANNOTATION_FLIP_Y:"flip-y"},ee={LINEAR:y.LinearToneMapping,REINHARD:y.ReinhardToneMapping,CINEON:y.CineonToneMapping,ACES_FILMIC:y.ACESFilmicToneMapping},c={FOV:"fov",DISTANCE:"distance"};var t={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const te={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var p,a,m,O,g;(i=p=p||{})[i.ROTATE=0]="ROTATE",i[i.TRANSLATE=1]="TRANSLATE",i[i.ZOOM=2]="ZOOM";class ie{constructor(e){this._defaultRenderLoop=e=>{var{control:t,autoPlayer:i,animator:s}=this._view3D;(s.animating||t.animating||i.animating)&&this._renderFrame(e)},this._view3D=e,this._canvas=((e,t)=>{e=e.querySelector(t);if(e)return e;throw new G(j.CANVAS_NOT_FOUND,W.CANVAS_NOT_FOUND)})(e.rootEl,e.canvasSelector);const t=new y.WebGLRenderer({canvas:this._canvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!0});if(t.toneMapping=e.toneMapping,t.toneMappingExposure=e.exposure,t.outputEncoding=y.sRGBEncoding,t.setClearColor(0,0),t.capabilities.isWebGL2)this._halfFloatAvailable=!0;else{const n=t.getContext();e=n.createTexture();try{var i,s=new Uint16Array(4),r=n.getExtension("OES_texture_half_float");r?(n.bindTexture(n.TEXTURE_2D,e),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,r.HALF_FLOAT_OES,s),i=n.getError(),this._halfFloatAvailable=i===n.NO_ERROR):this._halfFloatAvailable=!1}catch(e){this._halfFloatAvailable=!1}n.deleteTexture(e)}this._renderer=t,this._clock=new y.Clock(!1)}get canvas(){return this._canvas}get context(){return this._renderer.context}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new y.Vector2);return{width:e.width,height:e.y}}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}resize(){const e=this._renderer;var t=this._canvas;e.xr.isPresenting||(e.setPixelRatio(window.devicePixelRatio),e.setSize(t.clientWidth,t.clientHeight,!1))}setAnimationLoop(s){const r=this._view3D,n=this._clock;n.start(),this._renderer.setAnimationLoop((e,t)=>{var i=Math.min(n.getDelta(),r.maxDeltaTime);s(i,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}renderSingleFrame(){this._renderer.xr.isPresenting||this._renderFrame(0)}_renderFrame(e){const t=this._view3D,i=this._renderer,{scene:s,camera:r,control:n,autoPlayer:o,animator:a,annotation:h}=t;var l=1e3*e;a.update(e),n.update(l),o.update(l),t.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:t,delta:l}),r.updatePosition(),i.autoClear=!1,i.clear(),s.skybox&&s.skybox.enabled&&(s.skybox.updateCamera(),i.render(s.skybox.scene,s.skybox.camera)),s.shadowPlane.render(),i.render(s.root,r.threeCamera),i.autoClear=!0,h.render(),t.trigger(w.RENDER,{type:w.RENDER,target:t,delta:l})}}const E={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",LOAD:"load",ERROR:"error",CLICK:"click"},s={GRAB:"grab",GRABBING:"grabbing",NONE:""},se=((i=a=a||{})[i.LEFT=0]="LEFT",i[i.MIDDLE=1]="MIDDLE",i[i.RIGHT=2]="RIGHT","anonymous");class re{constructor(e){this._onLoadingProgress=(e,t,i)=>{const s=this._view3D;i.initialized=!0,i.lengthComputable=e.lengthComputable,i.loaded=e.loaded,i.total=e.total,s.trigger(w.PROGRESS,{type:w.PROGRESS,target:s,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class b extends re{constructor(e){super(e)}load(r){const n=this._view3D;return new Promise((e,t)=>{const i=new y.TextureLoader,s=u(n,r);i.setCrossOrigin(se),i.load(r,e,e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,t(e)})})}loadHDRTexture(r){const n=this._view3D;return new Promise((t,i)=>{const e=new L.RGBELoader,s=(n.renderer.capabilities.halfFloat||(e.type=y.FloatType),u(n,r));e.setCrossOrigin(se),e.load(r,e=>{e.mapping=y.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,i(e)})})}}const ne=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap"],f={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},oe=((i=m=m||{})[i.NONE=0]="NONE",i[i.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",i[i.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",i[i.ONE_FINGER=3]="ONE_FINGER",i[i.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",i[i.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",i[i.TWO_FINGER=12]="TWO_FINGER",i[i.PINCH=16]="PINCH","EXT_View3D_texture_LOD"),ae="view3d-lod",he="view3d-annotation";class le{constructor(e,{darkness:t=.5,mapSize:i=9,blur:s=3.5,shadowScale:r=1,planeScale:n=2}={}){this._view3D=e,this._darkness=t,this._mapSize=i,this._blur=s,this._shadowScale=r,this._planeScale=n;t=e.renderer.threeRenderer,s=Math.min(Math.pow(2,Math.floor(i)),t.capabilities.maxTextureSize);this._root=new y.Group,this._renderTarget=new y.WebGLRenderTarget(s,s,{format:y.RGBAFormat}),this._blurTarget=new y.WebGLRenderTarget(s,s,{format:y.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1;const o=new y.OrthographicCamera(-.5,.5,.5,-.5,0);o.rotation.x=Math.PI/2,this._shadowCamera=o,this._root.add(o);r=new y.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=r,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){const t=this._root,i=this._shadowCamera;var s=this._planeScale,r=e.bbox.getBoundingSphere(new y.Sphere),s=2*s*r.radius,n=this._shadowScale;i.far=n*(e.bbox.max.y-e.bbox.min.y)/s,i.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(s),i.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:i}=e,s=this._shadowCamera;const r=t.threeRenderer;t=i.activeSession?i.activeSession.arScene:e.scene,i=r.xr.enabled;r.xr.enabled=!1;const n=t.root;var e=n.background,t=(n.background=null,n.overrideMaterial=this._depthMaterial,r.getClearAlpha()),o=(r.setClearAlpha(0),r.getRenderTarget());r.setRenderTarget(this._renderTarget),r.clear(),r.render(n,s),n.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),r.xr.enabled=i,r.setRenderTarget(o),r.setClearAlpha(t),n.background=e,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],i=this._blurCamera;const s=t.threeRenderer,r=this._blurPlane;var t=this._renderTarget,n=this._blurTarget;const o=this._horizontalBlurMaterial,a=this._verticalBlurMaterial;r.visible=!0,o.uniforms.tDiffuse.value=t.texture,o.uniforms.h.value=+e/256,o.needsUpdate=!0,r.material=o,s.setRenderTarget(n),s.render(r,i),a.uniforms.tDiffuse.value=n.texture,a.uniforms.v.value=+e/256,a.needsUpdate=!0,r.material=a,s.setRenderTarget(t),s.render(r,i),r.visible=!1}_setupPlanes(){const e=this._root;var t=new y.PlaneBufferGeometry,i=new y.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:y.BackSide,depthWrite:!1,map:this._renderTarget.texture});const s=new y.Mesh(t,i);s.renderOrder=1,s.scale.set(-1,-1,1),s.rotation.order="YXZ",s.rotation.x=Math.PI/2,this._plane=s,e.add(s);i=new y.Mesh(t);this._blurPlane=i;const r=new y.MeshDepthMaterial,n=(r.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=r,new y.ShaderMaterial(D.HorizontalBlurShader)),o=(n.depthTest=!1,this._horizontalBlurMaterial=n,new y.ShaderMaterial(P.VerticalBlurShader));o.depthTest=!1,this._verticalBlurMaterial=o}}class ce{constructor(e){this._view3D=e,this._scene=new y.Scene,this._camera=new y.PerspectiveCamera,this._enabled=!0}get scene(){return this._scene}get camera(){return this._camera}get enabled(){return this._enabled}destroy(){this._disposeOldSkybox()}enable(){this._enabled=!0}disable(){this._enabled=!1}updateCamera(){var e=this._view3D;const t=this._camera;var e=e.camera,i=e.currentPose.pivot;t.copy(e.threeCamera),t.lookAt(i),t.updateProjectionMatrix()}useBlurredHDR(e){this._disposeOldSkybox();const t=this._view3D.renderer.threeRenderer,i=new y.Scene;i.background=e;var e=t.toneMappingExposure,s=(t.toneMappingExposure=1,new y.WebGLCubeRenderTarget(256,{encoding:y.sRGBEncoding,format:y.RGBAFormat}));const r=new y.CubeCamera(.1,1e3,s);r.update(t,i);var n=N.LightProbeGenerator.fromCubeRenderTarget(t,s),o=new y.MeshStandardMaterial({side:y.BackSide});const a=new y.IcosahedronBufferGeometry(1,4),h=new y.Scene;o=new y.Mesh(a,o);const l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return h.add(o),h.add(n),r.update(t,h),t.toneMappingExposure=e,this._scene.background=s.texture,this}useTexture(e){return this._scene.background=e,this}useColor(e){return this._scene.background=new y.Color(e),this}_disposeOldSkybox(){const e=this._scene.background;e&&(e.dispose(),this._scene.background=null)}}class _e{constructor(e){this._view3D=e,this._root=new y.Scene,this._skybox=null,this._userObjects=new y.Group,this._envObjects=new y.Group,this._fixedObjects=new y.Group,this._shadowPlane=new le(e,Y(e.shadow));const t=this._root,i=this._userObjects,s=this._envObjects,r=this._fixedObjects;var n=this._shadowPlane;i.name="userObjects",s.name="envObjects",r.name="fixedObjects",t.add(i,s,r),e.shadow&&r.add(n.root)}get root(){return this._root}get skybox(){return this._skybox}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const i=t?this._userObjects:this._envObjects;t=Array.isArray(e)?e:[e];i.add(...t)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(r){return Z(this,void 0,void 0,function*(){const e=this._view3D,t=new ce(e);if(this._skybox=t,"number"==typeof r||"#"===r.charAt(0))t.useColor(r);else{const i=new b(e),s=yield i.load(r);s.encoding=y.sRGBEncoding,t.useTexture(s)}e.renderer.renderSingleFrame()})}setSkybox(n){var o;return Z(this,void 0,void 0,function*(){const e=this._root,t=this._view3D;if(null!=(o=this._skybox)&&o.destroy(),n){const s=new b(t);var i=yield s.loadHDRTexture(n);const r=new ce(t);t.skyboxBlur?r.useBlurredHDR(i):r.useTexture(i),this._skybox=r,e.environment=i}else this._skybox=null,e.environment=null;t.renderer.renderSingleFrame()})}setEnvMap(s){return Z(this,void 0,void 0,function*(){const e=this._view3D;if(s){const i=new b(e);var t=yield i.loadHDRTexture(s);this._root.environment=t}else this._root.environment=null;e.renderer.renderSingleFrame()})}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e,i=(t.geometry.dispose(),Array.isArray(t.material)?t.material:[t.material]);i.forEach(t=>{ne.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}const T=J.EASE_OUT_CUBIC,de={min:0,max:1},x={min:-1/0,max:1/0},ue={min:-89.9,max:89.9},pe={165:0,135:.4,0:1},ve=[t.WEBXR,t.SCENE_VIEWER,t.QUICK_LOOK];class S{constructor({duration:e=300,loop:t=!1,range:i=de,easing:s=T}={}){this._duration=e,this._loop=t,this._range=i,this._easing=s,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}get activated(){return this._activated}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,i=this._end,s=this._duration,r=this._val,n=this._loop,e=this._progress+e/s,s=(this._progress=(n?l:_)(e,0,1),this._easing(this._progress));return this._val=o(t,i,s),!n&&1<=this._progress&&(this._activated=!1),this._val-r}reset(e){var t=this._range,e=_(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=_(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class me{constructor(e,t,i,{duration:s=300,easing:r=T,disableOnFinish:n=!0}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,this._motion=new S({duration:s,range:de,easing:r}),this._disableOnFinish=n,this.changeStartEnd(t,i)}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}get animating(){return this._motion.activated}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}changeStartEnd(e,t){e=e.clone(),t=t.clone(),e.yaw=l(e.yaw,0,360),t.yaw=l(t.yaw,0,360),180<Math.abs(t.yaw-e.yaw)&&(t.yaw=t.yaw<e.yaw?t.yaw+360:t.yaw-360),this._from=e,this._to=t}update(e){if(this._enabled){const i=this._view3D.camera,s=this._from;var t=this._to;const r=this._motion;r.update(e);e=r.val;i.yaw=o(s.yaw,t.yaw,e),i.pitch=o(s.pitch,t.pitch,e),i.zoom=o(s.zoom,t.zoom,e),i.pivot=s.pivot.clone().lerp(t.pivot,e),1<=e&&(this._disableOnFinish&&this.disable(),this._finishCallbacks.forEach(e=>e()),this.clearFinished())}}enable(){this._enabled||(this._enabled=!0,this.reset())}disable(){this._enabled&&(this._enabled=!1)}reset(){this._motion.reset(0),this._motion.setEndDelta(1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class R{constructor(e,t,i,s=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=i,this.pivot=(new y.Vector3).fromArray(s)}clone(){return new R(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}copy(e){this.yaw=e.yaw,this.pitch=e.pitch,this.zoom=e.zoom,this.pivot.copy(e.pivot)}equals(e){const{yaw:t,pitch:i,zoom:s,pivot:r}=this;return l(t,0,360)===l(e.yaw,0,360)&&i===e.pitch&&s===e.zoom&&r.equals(e.pivot)}}class ge{constructor(e){this._view3D=e,this._threeCamera=new y.PerspectiveCamera,this._maxTanHalfHFov=0,this._baseFov=45,this._baseDistance=0;var t=z(e.initialZoom)?e.initialZoom:0;this._defaultPose=new R(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone(),this._newPose=this._currentPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get newPose(){return this._newPose}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get distance(){return this._view3D.control.zoom.type===c.FOV?this._baseDistance:this._baseDistance-this._currentPose.zoom}get baseDistance(){return this._baseDistance}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this.distance*Math.tan(d(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._newPose.yaw=e}set pitch(e){this._newPose.pitch=e}set zoom(e){this._newPose.zoom=e}set pivot(e){this._newPose.pivot.copy(e)}reset(e=0,t=T,i){const s=this._view3D,r=s.control,n=s.autoPlayer,o=this._newPose,a=this._currentPose,h=null!=i?i:this._defaultPose;if(e<=0)return o.copy(h),a.copy(h),s.renderer.renderSingleFrame(),r.sync(),Promise.resolve();{const l=n.enabled,c=new me(s,a,h);return c.duration=e,c.easing=t,c.enable(),l&&n.disable(),r.add(c),new Promise(e=>{c.onFinished(()=>{o.copy(h),a.copy(h),r.remove(c),r.sync(),l&&n.enableAfterDelay(),e()})})}}resize({width:e,height:t},i=null){const{control:s,fov:r,maintainSize:n}=this._view3D,o=this._threeCamera;o.aspect=e/t,r===q?n&&null!=i?(e=t/i.height,t=this._currentPose.zoom,i=Math.tan(d((this._baseFov-t)/2)),this._baseFov=v(2*Math.atan(e*i))+t):this._applyEffectiveFov(45):this._baseFov=r,s.zoom.updateRange()}fit(e,t){var i=this._view3D;const s=this._threeCamera,r=i.control,n=this._defaultPose,o=e.bbox;var a=i.fov,h=a===q?45:a;const l=Array.isArray(t)?(new y.Vector3).fromArray(t):o.getCenter(new y.Vector3);t=t===q?(new y.Vector3).subVectors(o.max,o.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(l)),0),t=Math.sqrt(t);const c=t/Math.sin(d(h/2));var _=e.reduceVertices((e,t)=>{var t=(new y.Vector3).subVectors(t,l),i=Math.hypot(t.x,t.z);return Math.max(e,i/(c-Math.abs(t.y)))},0);a===q?(this._maxTanHalfHFov=_,this._applyEffectiveFov(h)):this._maxTanHalfHFov=a,n.pivot=l.clone(),this._baseDistance=c,s.near=.1*(c-t),s.far=10*(c+t),r.zoom.updateRange(),z(i.initialZoom)||(_=this._baseFov,h=e.bbox,a=i.initialZoom.axis,t=i.initialZoom.ratio,i=(e=(new y.Vector3).subVectors(h.max,h.min))[a],h="y"===a?i/t:i/(t*s.aspect),i="z"!==a?c-e.z/2:c-e.x/2,t=v(2*Math.atan(h/(2*i))),n.zoom=_-t)}updatePosition(){const e=this._view3D;var t=e.control;const i=this._threeCamera,s=this._currentPose,r=this._newPose;var n=this._baseFov,o=this._baseDistance,t=t.zoom.type===c.FOV,a=s.clone(),n=(s.yaw=l(r.yaw,0,360),s.pitch=_(r.pitch,ue.min,ue.max),s.zoom=r.zoom,s.pivot.copy(r.pivot),t?n-s.zoom:n);const h=((e,t,i)=>{t=d(t),i=d(i);const s=new y.Vector3(0,0,0);return s.y=e*Math.sin(i),s.z=e*Math.cos(i),s.x=s.z*Math.sin(-t),s.z=s.z*Math.cos(-t),s})(t?o:o-s.zoom,s.yaw,s.pitch);h.add(s.pivot),i.fov=n,i.position.copy(h),i.lookAt(s.pivot),i.updateProjectionMatrix(),r.copy(s),e.trigger(w.CAMERA_CHANGE,{type:w.CAMERA_CHANGE,target:e,pose:s.clone(),prevPose:a})}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(d(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=v(2*Math.atan(e))}}class Ee{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const i=e.renderer.canvas;var t=i.getBoundingClientRect(),t=0!==t.width||0!==t.height;const s=new ResizeObserver(t?this._skipFirstResize:this._onResize);s.observe(i),this._resizeObserver=s}else e.resize(),window.addEventListener(E.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(E.RESIZE,this._onResize),this._enabled=!1,this}}class we{constructor(e){this._view3D=e,this._mixer=new y.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}get animating(){return this.activeAnimation&&!this.paused}setClips(e){const i=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=i.clipAction(e);return t.setEffectiveWeight(0),t})}play(e){const t=this._actions[e];t&&(this.stop(),this._restoreTimeScale(),t.setEffectiveTimeScale(1),t.setEffectiveWeight(1),t.play(),this._activeAnimationIdx=e,this._flushFadePromises())}crossFade(l,c,{synchronize:_=!1}={}){var d;return Z(this,void 0,void 0,function*(){const i=this._view3D,t=this._mixer;var e=this._actions,s=this._activeAnimationIdx;const r=e[l],n=null!=(d=e[s])?d:r,o="loop",a=(this._restoreTimeScale(),()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),n.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=l});if(_){const h=e=>{e.action===n&&(t.removeEventListener(o,h),a())};t.addEventListener(o,h)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(i.off(w.BEFORE_RENDER,t),e(!0))};i.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return Z(this,void 0,void 0,function*(){const i=this._view3D;const s=this._actions[this._activeAnimationIdx];return!!s&&(this._flushFadePromises(),this._restoreTimeScale(),s.fadeOut(e/1e3),new Promise(e=>{const t=()=>{0<s.getEffectiveWeight()||(i.off(w.BEFORE_RENDER,t),this._activeAnimationIdx=-1,e(!0))};i.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._view3D.renderer.renderSingleFrame(),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=1}_flushFadePromises(){const i=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),i.off(w.BEFORE_RENDER,t)}),this._fadePromises=[]}}class be extends e{constructor({context:e=window,repeat:t=0,duration:i=300,easing:s=T}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,i=this._repeat,e=this._time+e,s=Math.floor(e/t),e=(this._time=(this._loopCount>=i?_:l)(e,0,t),this._time/t),r={progress:e,easedProgress:this._easing(e)};this.trigger("progress",r);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>i)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=i,this._easing=s,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const fe={AR:"immersive-ar",VR:"immersive-vr"},Te={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},M={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend"},ye={TOUCH:"generic-touchscreen"},Oe={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{}},xe={},Se={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class Re{constructor({scale:e=1}={}){this.rotation=new y.Quaternion,this._axis=new y.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new y.Vector2,this._fromQuat=new y.Quaternion,this._toQuat=new y.Quaternion,this._motion=new S({range:x}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:i}){if(this._active&&1===i.length){const s=this._prevPos,r=this._motion;i=i[0];const n=e.modelMovable.getWorldPosition(new y.Vector3);e=(new y.Vector2).fromArray(n.project(t).toArray()),t=U(e,s,i)*this._userScale,e=(new y.Quaternion).setFromAxisAngle(this._axis,t),t=this._getInterpolatedQuaternion();this._fromQuat.copy(t),this._toQuat.premultiply(e),r.reset(0),r.setEndDelta(1),s.copy(i)}}update({scene:e},t){if(this._active){const i=this._motion;i.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,i=this._fromQuat,e=e.val;return(new y.Quaternion).copy(i).slerp(t,e)}}(i=O=O||{})[i.WAITING=0]="WAITING",i[i.TRANSLATING=1]="TRANSLATING",i[i.BOUNCING=2]="BOUNCING";class Me{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:i=J.EASE_OUT_BOUNCE}={}){this._hoverPosition=new y.Vector3,this._floorPosition=new y.Vector3,this._wallRotation=new y.Quaternion,this._dragPlane=new y.Plane,this._enabled=!1,this._vertical=!1,this._state=O.WAITING,this._initialPos=new y.Vector2,this._hoverHeight=e,this._bounceMotion=new S({duration:t,easing:i,range:x})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=O.TRANSLATING}}deactivate(){if(!this._enabled||this._vertical||this._state===O.WAITING)this._state=O.WAITING;else{this._state=O.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const i=this._bounceMotion;t=t.y-e.y;i.reset(t),i.setEndDelta(-t)}}init(e,t,i){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=i?new y.Vector3(0,1,0).applyQuaternion(t):new y.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=i}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:i},{hitResults:s}){var r=this._state,r=r===O.WAITING||r===O.BOUNCING;if(s&&1===s.length&&!r){const c=s[0];r=this._floorPosition.clone();const _=this._floorPosition,d=this._hoverPosition;s=this._hoverHeight;const u=this._dragPlane;var n=this._vertical,o=c.results[0]&&c.results[0].getPose(t),a=o&&(new y.Matrix4).fromArray(o.transform.matrix),h=o&&.75<a.elements[5],l=o&&a.elements[5]<.25,i=(new y.Vector3).setFromMatrixPosition(i.matrixWorld),a=o&&(new y.Vector3).setFromMatrixPosition(a);if(n)if(!e||o&&l){const p=new y.Vector3(0,1,0);n=o.transform.orientation,l=p.clone().applyQuaternion(new y.Quaternion(n.x,n.y,n.z,n.w)).normalize(),n=(new y.Vector3).crossVectors(new y.Vector3(0,1,0),l);const v=new y.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(v.dot(l)))>=Math.PI/18){n=(new y.Matrix4).makeBasis(n,p,l);const g=new y.Euler(0,0,0,"YXZ").setFromRotationMatrix(n);g.z=0,g.x=Math.PI/2,this._wallRotation.setFromEuler(g),u.normal.copy(new y.Vector3(0,1,0).applyQuaternion(this._wallRotation)),u.constant=this._calcDragPlaneConstant(a)}l=(new y.Vector3).subVectors(a,i).normalize();const m=new y.Ray(i,l);n=m.intersectPlane(u,new y.Vector3);n&&_.copy(n)}else{l=e.getPose(c.inputSource.targetRaySpace,t);if(!l)return;n=l.transform.position;const E=new y.Vector3(n.x,n.y,n.z);l=E.sub(i).normalize();const w=new y.Ray(i,l);n=w.intersectPlane(u,new y.Vector3);void(n&&_.copy(n))}else if(!e||o&&h){l=-u.constant,n=a.y+s,o=(.1<n-l&&(u.constant=-n),(new y.Vector3).subVectors(a,i).normalize());const b=new y.Ray(i,o);h=b.intersectPlane(u,new y.Vector3);h&&(_.copy(h),_.setY(a.y),d.copy(h))}else{s=e.getPose(c.inputSource.targetRaySpace,t);if(!s)return;l=s.transform.position;const f=new y.Vector3(l.x,l.y,l.z);n=f.sub(i).normalize();const T=new y.Ray(i,n);o=T.intersectPlane(u,new y.Vector3);void(o&&(_.copy(o),_.setY(r.y),d.copy(o)))}}}update({scene:e},t){var i=this._state,s=this._floorPosition;const r=this._hoverPosition,n=this._bounceMotion;var o=this._vertical;i===O.BOUNCING&&(n.update(t),r.setY(s.y+n.val),1<=n.progress&&(this._state=O.WAITING)),e.setRootPosition(s),o?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-s.y)}_calcDragPlaneConstant(e){var t=this._vertical,i=this._dragPlane.normal.clone();const s=new y.Plane(i,0);i=t?0:this._hoverHeight;return-(s.distanceToPoint(e)+i)}}class Ae{constructor({width:e=.1,padding:t=20,offset:i=.05,font:s="64px sans-serif",color:r="white"}={}){const n=document.createElement("canvas"),o=n.getContext("2d");o.font=s;var a=o.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,a=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,l=(e=>{let t=1;for(;t<e;)t*=2;return t})(h),e=(n.width=l,e*((n.height=l)/h)),l=(this._ctx=o,this._canvas=n,this._height=e*a/h,this._texture=new y.CanvasTexture(n),new y.PlaneGeometry(e,e)),a=new y.Mesh(l,new y.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=s,this._color=r,this._padding=t,this._offset=i,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,i){const s=this._mesh;i=this._height/2+this._offset+i,i=new y.Vector3(0,i,0).applyQuaternion(e.clone().invert());s.position.copy(i),s.lookAt(t)}updateScale(e){const t=this._ctx;var i=this._canvas,s=this._padding,r=(100*e).toFixed(0),n=(t.clearRect(0,0,i.width,i.height),i.width/2),i=i.height/2,o=t.measureText(r+"%"),a=(o.actualBoundingBoxLeft+o.actualBoundingBoxRight)/2,o=(o.actualBoundingBoxAscent+o.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(n-a,i-o-s),t.lineTo(n+a,i-o-s),t.quadraticCurveTo(n+a+s,i-o-s,n+a+s,i-o),t.lineTo(n+a+s,i+o),t.quadraticCurveTo(n+a+s,i+o+s,n+a,i+o+s),t.lineTo(n-a,i+o+s),t.quadraticCurveTo(n-a-s,i+o+s,n-a-s,i+o),t.lineTo(n-a-s,i-o),t.quadraticCurveTo(n-a-s,i-o-s,n-a,i-o-s),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",n,i),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class Ce{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new Ae,this._motion=new S({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new Ae}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:i,xrCam:s,initialScale:r}){const n=this._motion;var o=n.range;if(r===q){var a=2*Math.atan(1/s.projectionMatrix.elements[5]),h=s.projectionMatrix.elements[0]/s.projectionMatrix.elements[5];const c=s.position;s=t.bbox.max.y-t.bbox.min.y,i=c.distanceTo((new y.Vector3).addVectors(i,new y.Vector3(0,s/2,0)))*Math.tan(a/2),s=i*h,a=t.bbox.getBoundingSphere(new y.Sphere),h=i/a.radius,t=s/a.radius;const l=_(Math.min(t,h),o.min,1);n.reset(l)}else n.reset(_(r,o.min,o.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new y.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const s=this._motion;var t=(new y.Vector2).subVectors(t[0],t[1]).length(),i=t-this._prevCoordDistance;s.setEndDelta(i),this._prevCoordDistance=t,this._updateUIPosition(e)}}update({scene:e},t){if(this._enabled&&this._active){const i=this._motion;i.update(t),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:i,vertical:s}){const r=e.model;e=(new y.Vector3).setFromMatrixPosition(i.matrixWorld),i=s?r.bbox.getBoundingSphere(new y.Sphere).radius:r.bbox.max.y-r.bbox.min.y;this._ui.updatePosition(t.root.quaternion,e,i)}}class Le{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:i=1e3}={}){var s=Math.PI/18;const r=new y.RingGeometry(.975,1,150,1,-6*s,30*s),n=(r.rotateX(-Math.PI/2),new y.RingGeometry(.96,1.015,30,1,25*s,4*s)),o=n.attributes["position"];var a=Math.floor(11*o.count/16),h=Math.floor(13*o.count/16),l=Math.floor((h-a+1)/2),c=(new y.Vector3).fromBufferAttribute(o,a).y;for(let e=a;e<h;e++){var _=e-a,_=.025*(l-Math.abs(_-l));o.setY(e,c-_)}n.rotateX(-Math.PI/2);var s=new y.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),d=new y.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),s=new y.Mesh(r,s),d=new y.Mesh(n,d);const u=new y.Group;u.add(s,d),u.position.setY(1e-4),this._mesh=u,this._ring=s,this._arrow=d,this._animator=new S({duration:i}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new y.Sphere).radius)}update({delta:e,rotation:t}){const i=this._mesh,s=this._animator;if(i.visible){s.update(e);const r=this._ring.material,n=this._arrow.material;e=this._opacityRange;r.opacity=s.val*e.min,n.opacity=s.val*e.max,s.val<=0&&(i.visible=!1),i.quaternion.copy(t),i.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(i=g=g||{})[i.WAITING=0]="WAITING",i[i.IN_DEADZONE=1]="IN_DEADZONE",i[i.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class De{constructor({size:e=.1}={}){this._state=g.WAITING,this._detectedGesture=m.NONE,this._testingGestures=m.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new y.Vector2,this._prevTwoFingerPos=new y.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===g.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new y.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new y.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=g.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,m.NONE)}cleanup(){this._testingGestures=m.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=m.NONE,this._state=g.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,i=this._size,s=this._testingGestures,r=this._lastFingerCount,n=e.length;if(t===g.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=n,this.applyScreenAspect(e),n!==r)return this.setFirstInput(e),m.NONE;if(1===n){t=e[0],r=this._prevOneFingerPos.clone();const o=(new y.Vector2).subVectors(t,r);o.length()>i&&(Math.abs(o.x)>Math.abs(o.y)?m.ONE_FINGER_HORIZONTAL&s&&(this._detectedGesture=m.ONE_FINGER_HORIZONTAL):m.ONE_FINGER_VERTICAL&s&&(this._detectedGesture=m.ONE_FINGER_VERTICAL))}else if(2===n){t=(new y.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),r=this._prevTwoFingerPos.clone();const a=(new y.Vector2).subVectors(t,r);a.length()>i&&(Math.abs(a.x)>Math.abs(a.y)?m.TWO_FINGER_HORIZONTAL&s&&(this._detectedGesture=m.TWO_FINGER_HORIZONTAL):m.TWO_FINGER_VERTICAL&s&&(this._detectedGesture=m.TWO_FINGER_VERTICAL));n=(new y.Vector2).subVectors(e[1],e[0]).length();Math.abs(n-this._initialTwoFingerDistance)>i&&m.PINCH&s&&(this._detectedGesture=m.PINCH)}return this._detectedGesture!==m.NONE&&(this._state=g.OUT_OF_DEADZONE),this._detectedGesture}}class Pe{constructor(e,t,{rotate:i,translate:s,scale:r,ring:n,deadzone:o,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var e=this._view3D,i=this._arScene,s=this._hitTestSource;const r=this._deadzoneChecker;var n=this._rotateControl,o=this._translateControl,a=this._scaleControl;const h=e.renderer.threeRenderer;var l=h.xr.getCamera(new y.PerspectiveCamera),c=h.xr.getReferenceSpace();if(s&&!(l.cameras.length<=0)){l=l.cameras[0];const _=e.model;n.enabled&&r.addTestingGestures(m.ONE_FINGER),o.enabled&&r.addTestingGestures(m.ONE_FINGER),a.enabled&&r.addTestingGestures(m.PINCH);e=t.getHitTestResultsForTransientInput(s),n=this._hitResultToVector(e);if(r.applyScreenAspect(n),r.setFirstInput(n),1===n.length){o=t.getPose(e[0].inputSource.targetRaySpace,c);if(o){a=(new y.Vector3).setFromMatrixPosition(l.matrixWorld),s=o.transform.position,n=new y.Vector3(s.x,s.y,s.z).sub(a).normalize();const d=new y.Ray(a,n),u=_.bbox.getBoundingSphere(new y.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new y.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=i,this._translate=s,this._scale=r,this._initialScale=a,this._rotateControl=new Re(Y(i)),this._translateControl=new Me(Y(s)),this._scaleControl=new Ce(Y(r)),this._floorIndicator=new Le(n),this._deadzoneChecker=new De(o)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:n,session:o,size:a,vertical:h,hitPosition:l,hitRotation:c}){return Z(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var i=this._scaleControl,s=this._floorIndicator;const r=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),r.setAspect(a.height/a.width),e.add(s.mesh,i.ui.mesh),this.syncTargetModel(n);s=yield o.requestHitTestSourceForTransientInput({profile:ye.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(M.SELECT_START,this._onSelectStart),e.removeEventListener(M.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,i=this._translate,s=this._scale;const r=this._rotateControl,n=this._translateControl,o=this._scaleControl;var a=this._vertical;e.addEventListener(M.SELECT_START,this._onSelectStart),e.addEventListener(M.SELECT_END,this._onSelectEnd),t&&!a&&r.enable(),i&&n.enable(),s&&o.enable()}disable(e){const t=this._rotateControl,i=this._translateControl,s=this._scaleControl;e.removeEventListener(M.SELECT_START,this._onSelectStart),e.removeEventListener(M.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),i.disable(),s.disable()}update(e){const{view3D:t,session:i,frame:s}=e;var r,n,o=this._hitTestSource;o&&t.model&&(r=this._deadzoneChecker,n=i.inputSources,o=null!=(o=null===s||void 0===s?void 0:s.getHitTestResultsForTransientInput(o))?o:[],n={coords:this._hitResultToVector(o),inputSources:n,hitResults:o},r.inDeadzone?this._checkDeadzone(e,n):this._processInput(e,n),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,i=this._translateControl.floorPosition,s=this._view3D.renderer.threeRenderer.xr.getCamera(new y.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:i,xrCam:s,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var i=this._arScene;const s=this._rotateControl,r=this._translateControl,n=this._scaleControl;var o=this._deadzoneChecker.check(t.map(e=>e.clone()));if(o!==m.NONE)switch(o){case m.ONE_FINGER_HORIZONTAL:case m.ONE_FINGER_VERTICAL:this._modelHit?(r.activate(),r.setInitialPos(t)):(s.activate(),s.updateRotation(i.modelMovable.quaternion),s.setInitialPos(t));break;case m.PINCH:n.activate(e),n.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const i=this._arScene,s=this._rotateControl,r=this._translateControl,n=this._scaleControl,o=this._floorIndicator;var t=1e3*t,e=(s.update(e,t),r.update(e,t),n.update(e,t),s.rotation),a=r.floorPosition;i.setRootPosition(a),o.update({delta:t,rotation:e})}_hitResultToVector(e){return e.map(e=>(new y.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class Ne{constructor(){this._root=new y.Scene,this._modelRoot=new y.Group,this._modelMovable=new y.Group,this._modelFixed=new y.Group,this._arRoot=new y.Group;const e=this._root,t=this._modelRoot;var i=this._modelMovable,s=this._modelFixed,r=this._arRoot;t.add(i),e.add(t,s,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,i=this._modelMovable,s=this._modelFixed;e=e.scene;i.add(e.userObjects,e.envObjects),s.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,i=this._modelFixed;const s=e.scene;[...t.children,...i.children].forEach(e=>{s.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const i=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,i.position.setZ(t/2),i.position.setY(-e.bbox.min.z),i.rotateX(-Math.PI/2),i.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class Ie{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,Oe.DOM_OVERLAY(e)}}class Fe{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(Te.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return Oe.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class ze{constructor(e,{features:t=xe,vertical:i=!1,overlayRoot:s=null,rotate:r=!0,translate:n=!0,scale:o=!0,ring:a={},deadzone:h={},initialScale:l=q}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=i,this.overlayRoot=s,this._arScene=new Ne,this._control=new Pe(e,this._arScene,{rotate:r,translate:n,scale:o,ring:a,deadzone:h,initialScale:l}),this._hitTest=new Fe,this._domOverlay=new Ie}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&Fe.isAvailable()&&Ie.isAvailable()?navigator.xr.isSessionSupported(fe.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}enter(){return Z(this,void 0,void 0,function*(){const a=this._view3D,h=a.scene,l=this._arScene,e=a.renderer,c=e.threeRenderer,_=this._control,t=this._hitTest,i=this._domOverlay,d=this.vertical;var s=this._getAllXRFeatures();c.xr.enabled=!0;const u=yield navigator.xr.requestSession(fe.AR,s),r=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(Te.LOCAL),yield c.xr.setSession(u),l.init(a),t.init(u);u.addEventListener("end",()=>Z(this,void 0,void 0,function*(){_.destroy(u),l.destroy(a),i.destroy(),c.setPixelRatio(r),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),a.trigger(w.AR_END,{target:a,type:w.AR_END,session:this})}),{once:!0});const p=new y.Clock;p.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var i,s,r,n=c.xr.getCamera(new y.PerspectiveCamera),o=p.getDelta();n.cameras.length<=0||(n=n.cameras[0],i=c.xr.getReferenceSpace(),s={width:null!=(r=null==(s=u.renderState.baseLayer)?void 0:s.framebufferWidth)?r:1,height:null!=(r=null==s?void 0:s.framebufferHeight)?r:1},r={view3D:a,scene:l,session:u,delta:o,frame:t,vertical:d,referenceSpace:i,xrCam:n,size:s},t=1e3*o,a.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:a,delta:t}),this._modelPlaced?(_.update(r),a.animator.update(o),h.shadowPlane.render(),c.render(l.root,n)):this._initModelPosition(r),a.trigger(w.RENDER,{type:w.RENDER,target:a,delta:t}))}),a.trigger(w.AR_START,{type:w.AR_START,target:a,session:this})})}exit(){return Z(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=K(this.overlayRoot))?t:this._createARRootElement();return k({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:i,size:s,vertical:r,referenceSpace:n}=e,o=this._view3D;e=o.model;const a=this._arScene,h=this._hitTest;if(h.ready&&e){const d=this._control;var l=h.getResults(t);if(!(l.length<=0)){const u=l[0];l=u.getPose(n);if(l){var c=(new y.Matrix4).fromArray(l.transform.matrix);if(!(!r&&c.elements[5]<.75||r&&(.25<=c.elements[5]||c.elements[5]<=-.25))){c=(new y.Vector3).setFromMatrixPosition(c);const p=new y.Quaternion;if(r){const g=new y.Vector3(0,1,0);var l=l.transform.orientation,l=g.clone().applyQuaternion(new y.Quaternion(l.x,l.y,l.z,l.w)).normalize(),_=(new y.Vector3).crossVectors(new y.Vector3(0,1,0),l),_=(new y.Matrix4).makeBasis(_,g,l);const E=new y.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);E.z=0,E.x=Math.PI/2,p.setFromEuler(E),a.setWallRotation(p)}a.updateModelRootPosition(e,r),a.setRootPosition(c),a.showModel(),h.destroy(),this._modelPlaced=!0,o.trigger(w.AR_MODEL_PLACED,{type:w.AR_MODEL_PLACED,target:o,session:this,model:e}),d.init({model:e,vertical:r,session:i,size:s,hitPosition:c,hitRotation:p});const v=d.scale.scale,m=new be({context:i,duration:1e3});m.on("progress",e=>{a.setModelScale(e.easedProgress*v)}),m.on("finish",()=>{a.setModelScale(v),d.enable(i)}),m.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement("div");return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(w.AR_END,()=>{e.rootEl.removeChild(t)}),t}}ze.type=t.WEBXR;class Ve{constructor(e,t={}){var{file:i=null,mode:s=te.ONLY_AR,fallbackURL:r=null,title:n=null,link:o=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=q,shareText:d=null}=t,t=$(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=i,this.fallbackURL=r,this.mode=s,this.title=n,this.link=o,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var r;return Z(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=B(this.resizable),t.enable_vertical_placement=B(this.vertical),t.disable_occlusion=B(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var i=null!=(r=this.file)?r:e.src;if(!i)return Promise.reject(new G(j.FILE_NOT_SUPPORTED(null!=(r=this.file)?r:e.src),W.FILE_NOT_SUPPORTED));t.file=new URL(i,window.location.href).href;e=this.fallbackURL,i=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===te.ONLY_AR?Se.INTENT_AR_CORE(i,e):Se.INTENT_SEARCHBOX(i,e||Se.FALLBACK_DEFAULT(i));const s=document.createElement("a");s.href=e,s.click()})}exit(){return Promise.resolve()}}Ve.type=t.SCENE_VIEWER;class ke{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:i=null,applePayButtonType:s=null,callToAction:r=null,checkoutTitle:n=null,checkoutSubtitle:o=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=i,this.applePayButtonType=s,this.callToAction=r,this.checkoutTitle=n,this.checkoutSubtitle=o,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new G(j.FILE_NOT_SUPPORTED(""+e),W.FILE_NOT_SUPPORTED));var i=this.canonicalWebPageURL,s=this.custom,r=window.location.href;const n=document.createElement("a"),o=(n.setAttribute("rel","ar"),n.appendChild(document.createElement("img")),Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,i])=>(i&&(e[t]=i),e),{})),a=new URL(e,r);return this.allowsContentScaling||(o.allowsContentScaling="0"),i&&(o.canonicalWebPageURL=new URL(i,r).href),s&&(o.custom=new URL(s,r).href),a.hash=new URLSearchParams(o).toString(),n.setAttribute("href",a.href),n.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(w.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:w.QUICK_LOOK_TAP,target:t}))},!1),n.click(),Promise.resolve()}exit(){return Promise.resolve()}}ke.type=t.QUICK_LOOK;const Ue={[t.WEBXR]:ze,[t.SCENE_VIEWER]:Ve,[t.QUICK_LOOK]:ke};class Be{constructor(e){this._view3D=e,this._activeSession=null,e.on(w.AR_START,({session:e})=>{this._activeSession=e}),e.on(w.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return Z(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return Z(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new G(j.NOT_INITIALIZED,W.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const i=new t(e,Y(e[t.type]));return yield i.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return Z(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>Ue[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class He{constructor(e,{element:t=null,focus:i=[],focusDuration:s=1e3}={}){this._onClick=()=>{this.focus()},this._onWheel=e=>{e.preventDefault(),e.stopPropagation()},this._view3D=e,this._element=t,this._focus=i,this._focusDuration=s,this._enabled=!1,this._tooltipSize=new y.Vector2,t&&(t.draggable=!1,this.resize())}get element(){return this._element}get renderable(){return!!this._element}destroy(){const e=this._view3D.annotation.wrapper;var t=this._element;this.disableEvents(),t&&t.parentElement===e&&e.removeChild(t)}resize(){const e=this._element;var t;!e||(t=e.querySelector("."+X.ANNOTATION_TOOLTIP))&&this._tooltipSize.set(t.offsetWidth,t.offsetHeight)}render({screenPos:e,screenSize:t,renderOrder:i}){const s=this._element;var r=this._tooltipSize;s&&(s.style.zIndex=""+(i+1),s.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`,e.y+r.y>t.y?s.classList.add(X.ANNOTATION_FLIP_Y):s.classList.remove(X.ANNOTATION_FLIP_Y),e.x+r.x>t.x?s.classList.add(X.ANNOTATION_FLIP_X):s.classList.remove(X.ANNOTATION_FLIP_X))}setOpacity(e){const t=this._element;t&&(t.style.opacity=""+e)}enableEvents(){const e=this._element;e&&!this._enabled&&(e.addEventListener(E.CLICK,this._onClick),e.addEventListener(E.WHEEL,this._onWheel),this._enabled=!0)}disableEvents(){const e=this._element;e&&this._enabled&&(e.removeEventListener(E.CLICK,this._onClick),e.removeEventListener(E.WHEEL,this._onWheel),this._enabled=!1)}}class Ge extends He{constructor(e,t={}){var{position:i=[]}=t,e=(super(e,$(t,["position"])),this._position=(new y.Vector3).fromArray(i),this._focus);0<e.length?(t=(new y.Vector3).fromArray(e),this._focusPose=new R(t.x,t.y,t.z,this._position.toArray())):this._focusPose=null}get position(){return this._position}focus(){return Z(this,void 0,void 0,function*(){const e=this._view3D["camera"],t=this._element;let i=this._focusPose;var s,r;return i||({yaw:s,pitch:r}=(e=>{const t=new y.Vector2(e.x,e.z);var i=new y.Vector2;return{yaw:Math.abs(e.y)<=.99?U(i,new y.Vector2(0,1),t):0,pitch:Math.atan2(e.y,t.distanceTo(i))}})(this._calculateNormalFromModelCenter()),i=new R(v(s),v(r),0,this._position.toArray())),t&&(t.classList.add(X.ANNOTATION_SELECTED),window.addEventListener("click",()=>{this.unfocus()},{once:!0,capture:!0})),i.equals(e.currentPose)?Promise.resolve():e.reset(this._focusDuration,T,i)})}unfocus(){const e=this._element;e&&e.classList.remove(X.ANNOTATION_SELECTED)}toJSON(){return{position:this._position.toArray(),focus:this._focus,duration:this._focusDuration}}_calculateNormalFromModelCenter(){const e=this._view3D.model;var t=e?e.bbox.getCenter(new y.Vector3):new y.Vector3;return(new y.Vector3).subVectors(this._position,t).normalize()}}class We extends He{constructor(e,t={}){var{meshIndex:i=-1,faceIndex:s=-1}=t;super(e,$(t,["meshIndex","faceIndex"])),this._meshIndex=i,this._faceIndex=s,this._trackingControl=null}get position(){return this._getPosition()}get renderable(){return!!this._element&&0<=this._meshIndex&&0<=this._faceIndex}get meshIndex(){return this._meshIndex}get faceIndex(){return this._faceIndex}focus(){return Z(this,void 0,void 0,function*(){const e=this._element;e&&e.classList.add(X.ANNOTATION_SELECTED);var t=this._view3D;const{camera:i,control:s}=t;var r=this._getFocus();const n=this._getPosition();r=new R(r.x,r.y,r.z,n.toArray());const o=new me(t,i.currentPose,r,{duration:this._focusDuration,disableOnFinish:!1});(this._trackingControl=o).enable(),s.add(o),window.addEventListener("click",()=>{this.unfocus()},{once:!0,capture:!0})})}unfocus(){const e=this._element,t=this._view3D["control"],i=this._trackingControl;e&&e.classList.remove(X.ANNOTATION_SELECTED),i&&(t.sync(),t.remove(i),i.destroy(),this._trackingControl=null)}render(e){super.render(e);const t=this._trackingControl;if(t){var e=this._view3D["camera"],i=this._getFocus();const s=this._getPosition();i=new R(i.x,i.y,i.z,s.toArray());t.changeStartEnd(e.currentPose,i),t.reset()}}toJSON(){return{meshIndex:this._meshIndex,faceIndex:this._faceIndex,focus:this._focus,duration:this._focusDuration}}_getFocus(){return(new y.Vector3).fromArray(this._focus)}_getPosition(){var e=this._getVertices();if(!e)return new y.Vector3;const t=this._getAnimatedVertices(e);return t.reduce((e,t)=>e.add(t),new y.Vector3).divideScalar(3)}_getAnimatedVertices(e){var t=this._view3D.model,i=this._faceIndex;const s=t.meshes[this._meshIndex],r=s.geometry.getIndex(),n=r.array.slice(3*i,3*i+3);if(s.isSkinnedMesh){t=s.geometry,i=t.attributes.position,t=t.attributes.skinWeight;const o=h(i),a=h(t);e.forEach((e,t)=>{t=n[t],t=H(t,s,o,a);e.copy(t)})}else e.forEach(e=>{e.applyMatrix4(s.matrixWorld)});return e}_getVertices(){var e=this._view3D,t=this._meshIndex;const i=this._faceIndex;var e=e.model;if(!e||t<0||i<0)return null;const s=e.meshes[t],r=null==(e=null===s||void 0===s?void 0:s.geometry.index)?void 0:e.array,n=r?(!(t=3)||t<=0?[]:Array.apply(0,Array(t)).map((e,t)=>t)).map(e=>r[3*i+e]):null;if(!s||!r||!n||n.some(e=>null==e))return null;const o=s.geometry.getAttribute("position");return n.map(e=>(new y.Vector3).fromBufferAttribute(o,e))}}class je{constructor(e){this._onInput=()=>{const e=this._list;e.forEach(e=>{e.element&&e.unfocus()})},this._view3D=e,this._list=[],this._wrapper=K(e.annotationWrapper,e.rootEl)||this._createWrapper()}get list(){return this._list}get wrapper(){return this._wrapper}init(){const e=this._view3D;e.control.controls.forEach(e=>{e.on({[f.HOLD]:this._onInput})})}destroy(){this._view3D.control.controls.forEach(e=>{e.off({[f.HOLD]:this._onInput})}),this.reset()}resize(){this._list.forEach(e=>{e.resize()})}collect(){const o=this._view3D,e=this._wrapper,t=[].slice.apply(e.querySelectorAll(o.annotationSelector));var i=t.map(e=>{const t=e.dataset.focus;var i,s={element:e,focus:t?t.split(" ").map(e=>parseFloat(e)):[],focusDuration:e.dataset.duration?parseFloat(e.dataset.duration):void 0};if(e.dataset.meshIndex)return r=parseFloat(e.dataset.meshIndex),i=e.dataset.faceIndex?parseFloat(e.dataset.faceIndex):void 0,new We(o,Object.assign(Object.assign({},s),{meshIndex:r,faceIndex:i}));{const n=e.dataset.position;var r=n?n.split(" ").map(e=>parseFloat(e)):[];return new Ge(o,Object.assign(Object.assign({},s),{position:r}))}});this.add(...i)}load(e){const s=new y.FileLoader;return new Promise((t,i)=>{s.load(e,e=>{e=JSON.parse(e),e=this.parse(e);this.add(...e),t(e)},void 0,e=>{i(e)})})}parse(e){const i=this._view3D;return e.map(e=>{var t=this._createDefaultAnnotationElement(e.label);return new(null!=e.meshIndex?We:Ge)(i,Object.assign(Object.assign({},e),{element:t}))})}render(){var e=this._view3D;const t=e.model;if(t){var i=e.camera;const s=e.renderer.threeRenderer,h=s.getSize(new y.Vector2),l=h.clone().multiplyScalar(.5),c=i.threeCamera,r=c.position,_=t.bbox.getCenter(new y.Vector3),d=e.annotationBreakpoints,n=[...this._list].filter(e=>e.renderable).map(e=>{var t=e.position;return{annotation:e,position:t,distToCameraSquared:r.distanceToSquared(t)}}).sort((e,t)=>t.distToCameraSquared-e.distToCameraSquared),u=(new y.Vector3).subVectors(r,_).normalize(),p=Object.keys(d).map(e=>parseFloat(e)).sort((e,t)=>t-e);n.forEach(({annotation:e,position:t},i)=>{if(e.element){var s=t.clone().project(c);const n=new y.Vector2(s.x,-s.y),o=(new y.Vector3).subVectors(t,_).normalize();var r=v(Math.abs(Math.acos(o.dot(u))));n.multiply(l),n.add(l);for(const a of p)if(r>=a){e.setOpacity(d[a]);break}e.render({position:t,renderOrder:i,screenPos:n,screenSize:h})}})}}add(...e){const t=this._wrapper;e.forEach(e=>{e.enableEvents(),e.element&&e.element.parentElement!==t&&t.appendChild(e.element)}),this._list.push(...e)}remove(e){const t=this._list.splice(e,1)[0];return t?(t.destroy(),t):null}reset(){const e=this._list,t=e.splice(0,e.length);t.forEach(e=>{e.destroy()})}_createWrapper(){const e=this._view3D,t=document.createElement("div");return t.classList.add(X.ANNOTATION_WRAPPER),e.rootEl.appendChild(t),t}_createDefaultAnnotationElement(e){const t=document.createElement("div");if(t.classList.add(X.ANNOTATION),t.classList.add(X.ANNOTATION_DEFAULT),e){const i=document.createElement("div");i.classList.add(X.ANNOTATION_TOOLTIP),i.classList.add(X.ANNOTATION_DEFAULT),i.innerHTML=e,t.appendChild(i)}return t}}class Ye extends e{constructor(e,{duration:t=300,easing:i=T,scale:s=1,disablePitch:r=!1,disableYaw:n=!1}={}){super(),this._screenScale=new y.Vector2(0,0),this._prevPos=new y.Vector2(0,0),this._enabled=!1,this._onMouseDown=e=>{if(e.button===a.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(E.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(E.MOUSE_UP,this._onMouseUp,!1),this.trigger(f.HOLD,{inputType:p.ROTATE,isTouch:!1})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,i=new y.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);i.multiply(this._screenScale),this._xMotion.setEndDelta(i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(E.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(E.MOUSE_UP,this._onMouseUp,!1),this.trigger(f.RELEASE,{inputType:p.ROTATE,isTouch:!1})},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY),this.trigger(f.HOLD,{inputType:p.ROTATE,isTouch:!0})},this._onTouchMove=e=>{if(!(1<e.touches.length||this._isScrolling)){var t=e.touches[0],i=this._view3D.scrollable;if(!i||e.cancelable){if(this._isFirstTouch){if(i){var s=new y.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(s.y)>Math.abs(s.x))return void(this._isScrolling=!0)}this._isFirstTouch=!1}!i&&e.cancelable&&e.preventDefault(),e.stopPropagation();const r=this._prevPos,n=new y.Vector2(t.clientX,t.clientY).sub(r).multiplyScalar(this._scale);n.multiply(this._screenScale),this._xMotion.setEndDelta(n.x),this._yMotion.setEndDelta(n.y),r.set(t.clientX,t.clientY)}}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):(this._prevPos.set(0,0),this.trigger(f.RELEASE,{inputType:p.ROTATE,isTouch:!0})),this._isScrolling=!1},this._view3D=e,this._scale=s,this._duration=t,this._easing=i,this._disablePitch=r,this._disableYaw=n,this._isFirstTouch=!1,this._isScrolling=!1,this._xMotion=new S({duration:t,range:x,easing:i}),this._yMotion=new S({duration:t,range:ue,easing:i})}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.off()}update(e){var t=this._view3D.camera;const i=this._xMotion,s=this._yMotion,r=t.newPose;var t=!this._disableYaw,n=!this._disablePitch,e=new y.Vector2(i.update(e),s.update(e));t&&(r.yaw+=e.x),n&&(r.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(E.MOUSE_DOWN,this._onMouseDown),e.addEventListener(E.TOUCH_START,this._onTouchStart,{passive:!0}),e.addEventListener(E.TOUCH_MOVE,this._onTouchMove,{passive:this._view3D.scrollable}),e.addEventListener(E.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(f.ENABLE,{inputType:p.ROTATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(E.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(E.MOUSE_MOVE,this._onMouseMove),window.removeEventListener(E.MOUSE_UP,this._onMouseUp),e.removeEventListener(E.TOUCH_START,this._onTouchStart),e.removeEventListener(E.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(E.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(f.DISABLE,{inputType:p.ROTATE})}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Ze extends e{constructor(e,{easing:t=T,duration:i=0,scale:s=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new y.Vector2(0,0),this._screenSize=new y.Vector2(0,0),this._onMouseDown=e=>{if(e.button===a.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(E.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(E.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(E.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(f.HOLD,{inputType:p.TRANSLATE,isTouch:!1})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var i=new y.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(E.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(E.MOUSE_UP,this._onMouseUp,!1),this.trigger(f.RELEASE,{inputType:p.TRANSLATE,isTouch:!1})},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0,this.trigger(f.HOLD,{inputType:p.TRANSLATE,isTouch:!0}))},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._prevPos;e=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return i.copy(e),void(this._touchInitialized=!0);var t=(new y.Vector2).subVectors(e,i).multiplyScalar(this._scale);this._xMotion.setEndDelta(-t.x),this._yMotion.setEndDelta(t.y),i.copy(e)}},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized&&(this._touchInitialized=!1,this.trigger(f.RELEASE,{inputType:p.TRANSLATE,isTouch:!0})):(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(E.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new S({duration:i,range:x,easing:t}),this._yMotion=new S({duration:i,range:x,easing:t}),this._scale=s}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.off()}update(e){var t=this._view3D.camera;const i=t.newPose;var s=this._screenSize;const r=new y.Vector2(this._xMotion.update(e),this._yMotion.update(e)),n=new y.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),o=new y.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);e=new y.Vector2(t.renderWidth,t.renderHeight).divide(s);r.multiply(e);const a=i.pivot.clone();i.pivot=a.add(n.multiplyScalar(r.x)).add(o.multiplyScalar(r.y))}resize(e){const t=this._screenSize;t.copy(new y.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(E.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(E.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(E.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(E.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(f.ENABLE,{inputType:p.TRANSLATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(E.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(E.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(E.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(E.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(E.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(E.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(E.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(f.DISABLE,{inputType:p.TRANSLATE})}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new y.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class qe extends e{constructor(e,{type:t=c.FOV,scale:i=1,duration:s=300,minFov:r=1,maxFov:n=q,minDistance:o=.1,maxDistance:a=2,easing:h=T}={}){super(),this._scaleModifier=1,this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const i=this._motion;t=-this._scale*this._scaleModifier*this._wheelModifier*e.deltaY;i.progress<=0&&this.trigger(f.HOLD,{inputType:p.ZOOM,isTouch:!1}),i.setEndDelta(t)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._motion;e=this._prevTouchDistance;const r=new y.Vector2(t[0].pageX,t[0].pageY);t=new y.Vector2(t[1].pageX,t[1].pageY);const n=r.sub(t);var t=n.length()*this._scale*this._scaleModifier*this._touchModifier,i=t-e;this._prevTouchDistance=t,e<0||s.setEndDelta(i)}},this._onTouchEnd=e=>{0===e.touches.length&&(this.trigger(f.RELEASE,{inputType:p.ZOOM,isTouch:!0}),this._prevTouchDistance=-1)},this._view3D=e,this._type=t,this._scale=i,this._duration=s,this._minFov=r,this._maxFov=n,this._minDistance=o,this._maxDistance=a,this._easing=h,this._motion=new S({duration:s,easing:h,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get animating(){return this._motion.activated}get range(){return this._motion.range}get type(){return this._type}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}get easing(){return this._easing}set type(e){this._type=e}set scale(e){this._scale=e}destroy(){this.disable(),this.off()}update(e){const t=this._view3D.camera.newPose,i=this._motion;t.zoom-=i.update(e)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(E.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(E.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(E.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(f.ENABLE,{inputType:p.ZOOM})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(E.WHEEL,this._onWheel,!1),e.removeEventListener(E.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(E.TOUCH_END,this._onTouchEnd,!1),this._enabled=!1,this.trigger(f.DISABLE,{inputType:p.ZOOM})}}sync(){var e=this._view3D.camera;const t=this._motion;t.reset(-e.zoom),this._type===c.FOV?this._scaleModifier=-1:this._scaleModifier=-e.baseDistance/44}updateRange(){const e=this._motion.range;var t,i,s=this._view3D["camera"];this._type===c.FOV?(t=s.baseFov,i=this._maxFov,e.max=i===q?Math.min(t+45,175)-t:i-t,e.min=this._minFov-t):(e.max=s.baseDistance*this._maxDistance-s.baseDistance,e.min=s.baseDistance*this._minDistance-s.baseDistance)}}class Xe{constructor(e){this._onEnable=({inputType:e})=>{var t;e!==p.ZOOM&&(t=(e=this._view3D).renderer.canvas,e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===s.NONE&&this._setCursor(s.GRAB))},this._onDisable=({inputType:e})=>{e===p.ZOOM||this._view3D.renderer.canvas.style.cursor===s.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(s.NONE)},this._onHold=({inputType:e,isTouch:t})=>{const i=this._view3D;e===p.ZOOM||t||i.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(s.GRABBING),i.trigger(w.INPUT_START,{type:w.INPUT_START,target:i,inputType:e})},this._onRelease=({inputType:e,isTouch:t})=>{const i=this._view3D;e===p.ZOOM||t||i.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(s.GRAB),i.trigger(w.INPUT_END,{type:w.INPUT_END,target:i,inputType:e})},this._view3D=e,this._rotateControl=new Ye(e,Y(e.rotate)),this._translateControl=new Ze(e,Y(e.translate)),this._zoomControl=new qe(e,Y(e.zoom)),this._extraControls=[],[this._rotateControl,this._translateControl,this._zoomControl].forEach(e=>{e.on({[f.HOLD]:this._onHold,[f.RELEASE]:this._onRelease,[f.ENABLE]:this._onEnable,[f.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}get controls(){return[this._rotateControl,this._translateControl,this._zoomControl]}get extraControls(){return this._extraControls}get animating(){return this._rotateControl.animating||this._translateControl.animating||this._zoomControl.animating||this._extraControls.some(e=>e.animating)}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy(),this._extraControls.forEach(e=>e.destroy()),this._extraControls=[]}update(t){this._rotateControl.update(t),this._translateControl.update(t),this._zoomControl.update(t),this._extraControls.forEach(e=>e.update(t))}resize(t){this._rotateControl.resize(t),this._translateControl.resize(t),this._zoomControl.resize(t),this._extraControls.forEach(e=>e.resize(t))}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable(),this._extraControls.forEach(e=>e.enable())}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable(),this._extraControls.forEach(e=>e.disable())}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync(),this._extraControls.forEach(e=>e.sync())}add(e){this._extraControls.push(e)}remove(t){const e=this._extraControls;var i=e.findIndex(e=>e===t);0<=i&&e.splice(i,1)}updateCursor(){var e=this._view3D.useGrabCursor?s.GRAB:s.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===s.NONE){const i=t.renderer.canvas;i.style.cursor=e}}}class Qe{constructor(e,{delay:t=2e3,delayOnMouseLeave:i=0,speed:s=1,pauseOnHover:r=!1,canInterrupt:n=!0,disableOnInterrupt:o=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==a.LEFT&&e.button!==a.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(E.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(E.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=i,this._speed=s,this._pauseOnHover=r,this._canInterrupt=n,this._disableOnInterrupt=o}get enabled(){return this._enabled}get animating(){return this._enabled&&!this._interrupted}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera.newPose;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(E.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(E.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(E.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(E.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(E.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(E.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}enableAfterDelay(){this.enable(),this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay)}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(E.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(E.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(E.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(E.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(E.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(E.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(E.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Ke{constructor({src:e,scenes:t,animations:i=[],annotations:s=[],fixSkinnedBbox:r=!1,castShadow:n=!0,receiveShadow:o=!1}){this._src=e;const a=new y.Group,h=(a.add(...t),this._animations=i,this._annotations=s,this._scene=a,this._getInitialBbox(r));e=h.min.y;a.translateY(-e),a.updateMatrixWorld(),h.translate(new y.Vector3(0,-e,0)),this._fixSkinnedBbox=r,this._bbox=h,this.castShadow=n,this.receiveShadow=o}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get annotations(){return this._annotations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(n,e){const t=this.meshes;let o=e;return t.forEach(t=>{var i=t.geometry.attributes["position"];if(i)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{o=n(o,e)});else{var s=h(i);for(let e=0;e<i.count;e++){const r=(new y.Vector3).fromBufferAttribute(i,e);i.normalized&&r.multiplyScalar(s),r.applyMatrix4(t.matrixWorld),o=n(o,r)}}}),o}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new y.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new y.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t.sort((e,t)=>e.name.localeCompare(t.name))}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,i){var e=t.geometry,s=e.attributes.position,e=e.attributes.skinWeight;const r=t.skeleton;r.update();var n=h(s),o=h(e);for(let e=0;e<s.count;e++)i(H(e,t,n,o))}}const $e=new n.DRACOLoader,Je=new I.KTX2Loader;class A extends re{constructor(e){super(e),this._loader=new r.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader($e),t.setKTX2Loader(Je.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(s){return Z(this,void 0,void 0,function*(){return new Promise((e,t)=>{const i=document.createElement("script");i.addEventListener("load",()=>Z(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,A.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(i),e()})),i.addEventListener("error",()=>{document.body.removeChild(i),t()}),i.src=new URL(s,location.href).href,document.body.appendChild(i)})})}load(s){var e=this._view3D;const r=this._loader,n=u(e,s);return $e.setDecoderPath(e.dracoPath),Je.setTranscoderPath(e.ktxPath),A.meshoptDecoder&&r.setMeshoptDecoder(A.meshoptDecoder),r.manager=y.DefaultLoadingManager,new Promise((t,i)=>{try{r.load(s,e=>{e=this._parseToModel(e,s);t(e)},e=>this._onLoadingProgress(e,s,n),e=>{n.initialized=!0,i(e)})}catch(e){i(e)}})}loadFromFiles(a){const h=this._view3D,l=this._loader,c=[],_=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return $e.setDecoderPath(h.dracoPath),Je.setTranscoderPath(h.ktxPath),A.meshoptDecoder&&l.setMeshoptDecoder(A.meshoptDecoder),new Promise((t,i)=>{if(a.length<=0)i(new Error("No files found"));else{const s=a.find(e=>/\.(gltf|glb)$/i.test(e.name));if(s){const r=new Map,n=(a.forEach(e=>{r.set(e.name,e)}),URL.createObjectURL(s)),e=(c.push(n),new y.LoadingManager),o=(e.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";return r.has(t)?(t=r.get(t),t=URL.createObjectURL(t),c.push(t),t):e}),u(h,n));l.manager=e,l.load(n,e=>{e=this._parseToModel(e,s.name);_(),t(e)},e=>this._onLoadingProgress(e,n,o),e=>{o.initialized=!0,_(),i(e)})}else i(new Error("No glTF file found"))}})}_parseToModel(r,e){const n=this._view3D;var t,i=n.fixSkinnedBbox;r.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const a=n.renderer.threeRenderer.capabilities.maxTextureSize,s=[],o=(r.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&s.push(e)})}),s.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[])),h=o.reduce((e,t)=>[...e,...ne.filter(e=>t[e]).map(e=>t[e])],[]),l=r.parser.associations,c=r.parser.json,_=h.filter(e=>l.has(e)).map(e=>c.textures[l.get(e).textures]),d=_.reduce((s,e,t)=>{var i=e.extensions&&e.extensions[oe],r=e.extras&&e.extras[ae];if(!i&&!r)return s;const n=h[t],o=(i?e.extensions[oe]:e.extras[ae]).levels;return o.forEach(({index:e,size:t},i)=>{t>a||(s[i]||(s[i]=[]),s[i].push({index:e,texture:n}))}),s},[]),u=d.map(()=>!1),p=(d.forEach((s,i)=>Z(this,void 0,void 0,function*(){const e=yield Promise.all(s.map(({index:e})=>r.parser.getDependency("texture",e)));var t=u.slice(i+1).some(e=>!!e);u[i]=!0,t||e.forEach((e,t)=>{const i=s[t].texture;i.image=e.image,i.needsUpdate=!0,n.renderer.renderSingleFrame()})})),[]);return r.parser.json.extras&&r.parser.json.extras[he]&&(t=r.parser.json.extras[he],p.push(...n.annotation.parse(t))),new Ke({src:e,scenes:r.scenes,annotations:p,animations:r.animations,fixSkinnedBbox:i})}}class et extends e{constructor(e,{src:t=null,iosSrc:i=null,dracoPath:s="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:r="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:n=null,fixSkinnedBbox:o=!1,fov:a=q,center:h=q,yaw:l=0,pitch:c=0,initialZoom:_=0,rotate:d=!0,translate:u=!0,zoom:p=!0,autoplay:v=!1,scrollable:m=!0,wheelScrollable:g=!1,useGrabCursor:E=!0,skybox:w=null,envmap:b=null,background:f=null,exposure:T=1,shadow:y=!0,skyboxBlur:O=!1,toneMapping:x=ee.LINEAR,annotationURL:S=null,annotationWrapper:R="."+X.ANNOTATION_WRAPPER,annotationSelector:M="."+X.ANNOTATION,annotationBreakpoints:A=pe,webAR:C=!0,sceneViewer:L=!0,quickLook:D=!0,arPriority:P=ve,poster:F=null,canvasSelector:z="canvas",autoInit:N=!0,autoResize:V=!0,useResizeObserver:k=!0,maintainSize:U=!1,on:B={},plugins:I=[],maxDeltaTime:H=1/30}={}){super(),this._rootEl=((e,t)=>{t=K(e,t);if(t)return t;throw Q(e)?new G(j.ELEMENT_NOT_FOUND(e),W.ELEMENT_NOT_FOUND):new G(j.WRONG_TYPE(e,["HTMLElement","string"]),W.WRONG_TYPE)})(e),this._src=t,this._iosSrc=i,this._dracoPath=s,this._ktxPath=r,this._meshoptPath=n,this._fixSkinnedBbox=o,this._fov=a,this._center=h,this._yaw=l,this._pitch=c,this._initialZoom=_,this._rotate=d,this._translate=u,this._zoom=p,this._autoplay=v,this._scrollable=m,this._wheelScrollable=g,this._useGrabCursor=E,this._skybox=w,this._envmap=b,this._background=f,this._exposure=T,this._shadow=y,this._skyboxBlur=O,this._toneMapping=x,this._annotationURL=S,this._annotationWrapper=R,this._annotationSelector=M,this._annotationBreakpoints=A,this._webAR=C,this._sceneViewer=L,this._quickLook=D,this._arPriority=P,this._poster=F,this._canvasSelector=z,this._autoInit=N,this._autoResize=V,this._useResizeObserver=k,this._maintainSize=U,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=I,this._maxDeltaTime=H,this._renderer=new ie(this),this._camera=new ge(this),this._control=new Xe(this),this._scene=new _e(this),this._animator=new we(this),this._autoPlayer=new Qe(this,Y(v)),this._autoResizer=new Ee(this),this._arManager=new Be(this),this._annotationManager=new je(this),this._addEventHandlers(B),this._addPosterImage(),Z(this,void 0,void 0,function*(){yield this._initPlugins(I),t&&N&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get annotation(){return this._annotationManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get annotationURL(){return this._annotationURL}get annotationWrapper(){return this._annotationWrapper}get annotationSelector(){return this._annotationSelector}get annotationBreakpoints(){return this._annotationBreakpoints}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set skybox(e){this._scene.setSkybox(e),this._skybox=e}set envmap(e){this._scene.setEnvMap(e),this._envmap=e}set exposure(e){this._renderer.threeRenderer.toneMappingExposure=e,this._exposure=e}set skyboxBlur(e){this._skyboxBlur=e;const t=this._scene;var i=t.root.environment;i&&t.skybox&&(e?t.skybox.useBlurredHDR(i):t.skybox.useTexture(i))}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set maxDeltaTime(e){this._maxDeltaTime=e}set maintainSize(e){this._maintainSize=e}destroy(){this._scene.reset(),this._renderer.stopAnimationLoop(),this._control.destroy(),this._autoResizer.disable(),this._animator.reset(),this._annotationManager.destroy(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return Z(this,void 0,void 0,function*(){if(!this._src)throw new G(j.PROVIDE_SRC_FIRST,W.PROVIDE_SRC_FIRST);const e=this._scene,t=this._renderer,i=this._control,s=this._annotationManager;var r=this._skybox,n=this._envmap,o=this._background,a=this._meshoptPath;const h=[];if(this.resize(),s.init(),this._autoResize&&this._autoResizer.enable(),a&&!A.meshoptDecoder&&(yield A.setMeshoptDecoder(a)),r||n){const l=new y.AmbientLight,c=(e.add(l,!1),r?e.setSkybox(r):e.setEnvMap(n));h.push(c.then(()=>{e.remove(l)}))}!r&&o&&h.push(e.setBackground(o));a=this._loadModel(this._src);h.push(...a),this._resetLoadingContextOnFinish(h),yield Promise.race(a),this._annotationURL&&(yield this._annotationManager.load(this._annotationURL)),i.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),t.renderSingleFrame(),this._initialized=!0,this.trigger(w.READY,{type:w.READY,target:this})})}resize(){const e=this._renderer;var t=this._initialized?e.size:null,i=(e.resize(),e.size);this._camera.resize(i,t),this._control.resize(i),this._annotationManager.resize(),e.renderSingleFrame(),this.trigger(w.RESIZE,Object.assign(Object.assign({},i),{type:w.RESIZE,target:this}))}load(t){return Z(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t):(this._src=t,yield this.init())})}display(e,{resetCamera:t=!0}={}){const i=this._renderer,s=this._scene,r=this._camera,n=this._animator,o=this._annotationManager;var a=i.threeRenderer.xr.isPresenting;if(s.reset(),s.add(e.scene),s.shadowPlane.updateDimensions(e),t&&(r.fit(e,this._center),r.reset(0)),n.reset(),n.setClips(e.animations),0<e.animations.length&&n.play(0),o.reset(),o.collect(),o.add(...e.annotations),this._model=e,a){const h=this._arManager.activeSession;h&&h.control.syncTargetModel(e)}i.renderSingleFrame(),this.trigger(w.MODEL_CHANGE,{type:w.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return Z(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return Z(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var i=t.toDataURL("png");const s=document.createElement("a");s.href=i,s.download=e,s.click()}_loadModel(e){const i=new A(this);if(Array.isArray(e)){const s=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(i,e,t,s))}return[this._loadSingleModel(i,e,0,[!1])]}_loadSingleModel(r,n,o,a){return Z(this,void 0,void 0,function*(){var t=a.length-1;this.trigger(w.LOAD_START,{type:w.LOAD_START,target:this,src:n,level:o,maxLevel:t});try{var e=yield r.load(n),i=a.slice(o+1).some(e=>!!e),s=a.some(e=>!!e);if(this.trigger(w.LOAD,{type:w.LOAD,target:this,model:e,level:o,maxLevel:t}),a[o]=!0,i)return;this.display(e,{resetCamera:!s})}catch(e){throw this.trigger(w.LOAD_ERROR,{type:w.LOAD_ERROR,target:this,level:o,maxLevel:t,error:e}),new G(j.MODEL_FAIL_TO_LOAD(n),W.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const i=this._rootEl;if(t){var s=V(t);let e;if(s||(e=>{if(!Q(e))return!1;const t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0})(t)){s=s?t:i.querySelector(t);if(!s)throw new G(j.ELEMENT_NOT_FOUND(t),W.ELEMENT_NOT_FOUND);e=s}else{const r=document.createElement("img");r.className=X.POSTER,r.src=t,i.appendChild(r),e=r,this.once(w.READY,()=>{r.parentElement===i&&i.removeChild(r)})}this.once(w.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return Z(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return Z(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(w.LOAD_FINISH,{type:w.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}et.VERSION="2.4.0";class C{constructor(e={}){this._startLoading=({target:s,level:e})=>{if(0!==e)return;const{type:t="default",loadingLabel:i="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:n="#ffffff",barWidth:o="70%",barHeight:a="10px",barBackground:h="#bbbbbb",barForeground:l="#3e8ed0",spinnerWidth:c="30%",overlayBackground:_="rgba(0, 0, 0, 0.3)"}=this._options,d=document.createElement("div"),u=document.createElement("div"),p=document.createElement("div"),v=document.createElement("div"),m=document.createElement("div");if(d.classList.add("view3d-lb-overlay"),u.classList.add("view3d-lb-wrapper"),v.classList.add("view3d-lb-base"),p.classList.add("view3d-lb-label"),m.classList.add("view3d-lb-filler"),d.style.backgroundColor=_,t!==C.TYPE.SPINNER?(v.style.height=a,v.style.backgroundColor=h,m.style.backgroundColor=l):(v.classList.add("type-spinner"),v.style.width=c,v.style.paddingTop=c,m.style.borderWidth=a,m.style.borderColor=l,m.style.borderLeftColor="transparent"),t===C.TYPE.TOP?d.classList.add("type-top"):t===C.TYPE.DEFAULT&&(v.style.width=o),p.style.color=n,p.innerText=i,v.appendChild(m),u.appendChild(v),u.appendChild(p),d.appendChild(u),s.rootEl.appendChild(d),t!==C.TYPE.SPINNER){const g=()=>{if(s.loadingContext.every(e=>e.initialized)){var[e,t]=s.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]);if(!(t<=0)){const i=e/t*100;m.style.width=i.toFixed(2)+"%",e===t&&(p.innerText=r)}}};s.on(w.PROGRESS,g),s.once(w.LOAD_FINISH,()=>{s.off(w.PROGRESS,g)})}s.once(w.LOAD_FINISH,()=>{this._removeOverlay(s)}),this._overlay=d},this._options=e}init(e){return Z(this,void 0,void 0,function*(){e.on(w.LOAD_START,this._startLoading)})}teardown(e){e.off(w.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}C.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};var i={__proto__:null,default:et,Animation:be,ARManager:Be,AutoPlayer:Qe,AutoResizer:Ee,Camera:ge,Model:Ke,ModelAnimator:we,Motion:S,Pose:R,Renderer:ie,Scene:_e,ShadowPlane:le,Skybox:ce,View3DError:G,Annotation:He,PointAnnotation:Ge,FaceAnnotation:We,AnnotationManager:je,AnimationControl:me,OrbitControl:Xe,RotateControl:Ye,TranslateControl:Ze,ZoomControl:qe,GLTFLoader:A,TextureLoader:b,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return Z(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return Z(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:i="view3d-ar-button",tooltipClass:s="view3d-tooltip"}=this._options;const r=yield a.ar.isAvailable(),n=document.createElement("button"),o=document.createElement("div");e=document.createTextNode(r?e:t);n.classList.add(i),o.classList.add(s),n.disabled=!0,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',n.appendChild(o),o.appendChild(e),a.rootEl.appendChild(n),this._button=n,a.initialized?yield this._setAvailable(a,n,r):a.once(w.MODEL_CHANGE,()=>{this._setAvailable(a,n,r)})})}_setAvailable(e,t,i){return Z(this,void 0,void 0,function*(){i?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:class{constructor(e={}){this._options=e}init(r){return Z(this,void 0,void 0,function*(){r.on(w.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){if(this._cachedElements)Object.values(this._cachedElements).map(e=>{t.contains(e)||t.appendChild(e)});else{const i=document.createElement("div");i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',i.classList.add("view3d-ar-close"),t.appendChild(i),this._cachedElements={closeButton:i}}const i=this._cachedElements["closeButton"],s=()=>{e.exit()};i.addEventListener("click",s),r.once(w.AR_END,()=>{i.parentElement&&i.parentElement.removeChild(i),i.removeEventListener("click",s)})}})})}teardown(){}},LoadingBar:C,AUTO:q,EVENTS:w,EASING:J,DEFAULT_CLASS:X,TONE_MAPPING:ee,ZOOM_TYPE:c,AR_SESSION_TYPE:t,SCENE_VIEWER_MODE:te,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},get INPUT_TYPE(){return p},ERROR_CODES:F,isAvailable:({webGL:e=!0,fetch:t=!0,stream:i=!0,wasm:s=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(i&&!(window&&window.ReadableStream))return!1;if(s&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0}};return k(et,i),et});
