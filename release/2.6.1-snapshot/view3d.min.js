/*
Copyright (c) NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.6.1-snapshot
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/shaders/HorizontalBlurShader"),require("three/examples/jsm/shaders/VerticalBlurShader"),require("three/examples/jsm/lights/LightProbeGenerator"),require("three/examples/jsm/webxr/XREstimatedLight"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["three","@egjs/component","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/shaders/HorizontalBlurShader","three/examples/jsm/shaders/VerticalBlurShader","three/examples/jsm/lights/LightProbeGenerator","three/examples/jsm/webxr/XREstimatedLight","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.THREE,e.Component,e.RGBELoader,e.HorizontalBlurShader,e.VerticalBlurShader,e.LightProbeGenerator,e.XREstimatedLight,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(f,e,M,I,D,N,n,o,P,F){"use strict";class Y extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,Y.prototype),this.name="View3DError",this.code=t}}var a,z={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,FILE_NOT_SUPPORTED:5,NOT_INITIALIZED:6,MODEL_FAIL_TO_LOAD:7},Z=z,X={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const U=e=>"number"==typeof e,J=e=>"string"==typeof e,V=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,ee=(e,t)=>{let i=null;if(J(e)){const s=t||document;t=s.querySelector(e);if(!t)return null;i=t}else V(e)&&(i=e);return i},B=e=>!e||e<=0?[]:Array.apply(0,Array(e)).map((e,t)=>t),d=e=>e*Math.PI/180,m=e=>180*e/Math.PI,_=(e,t,i)=>Math.max(Math.min(e,i),t),k=(e,t,i)=>e*(1-i)+t*i,l=(e,t,i)=>{var s=Math.abs(i-t);return e<t?e=i-(t-e)%s:i<e&&(e=t+(e-i)%s),e},H=(s,...e)=>(e.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];Array.isArray(s[e])&&Array.isArray(t)?s[e]=[...s[e],...t]:s[e]=t})}),s),G=(e,t,i)=>{const s=(new f.Vector2).subVectors(t,e).normalize(),n=(new f.Vector2).subVectors(i,e).normalize();t=n.angle()-s.angle(),i=-Math.sign(t)*(2*Math.PI-Math.abs(t));return Math.abs(t)<Math.abs(i)?t:i},q=e=>"object"==typeof e?e:{},W=e=>e?"true":"false",j=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t},c=e=>{var t;return e.normalized&&ArrayBuffer.isView(e.array)?(e=e.array,t=ie(e),e=1/(Math.pow(2,8*e.BYTES_PER_ELEMENT)-1),t?2*e:e):1},te=(e,t,i,s)=>{var n=t.geometry,o=n.attributes.position;const r=n.attributes.skinIndex,a=n.attributes.skinWeight,h=t.skeleton.boneMatrices;n=(new f.Vector3).fromBufferAttribute(o,e).multiplyScalar(i);const l=new f.Vector4(0,0,0,0),c=new f.Vector4(n.x,n.y,n.z).applyMatrix4(t.bindMatrix),_=[a.getX(e),a.getY(e),a.getZ(e),a.getW(e)].map(e=>e*s),d=[r.getX(e),r.getY(e),r.getZ(e),r.getW(e)],u=(_.forEach((e,t)=>{t=(new f.Matrix4).fromArray(h,16*d[t]);l.add(c.clone().applyMatrix4(t).multiplyScalar(e))}),(new f.Vector3).fromArray(l.applyMatrix4(t.bindMatrixInverse).toArray()));return u.applyMatrix4(t.matrixWorld),u},ie=e=>{const t=new e.constructor(1);return t[0]=-1,t[0]<0},se=(e,t,i)=>{const s=((e,t,i)=>{if(!e||t<0||i<0)return null;const s=e.meshes[t],n=null==(e=null===s||void 0===s?void 0:s.geometry.index)?void 0:e.array,o=n?B(3).map(e=>n[3*i+e]):null;if(!s||!n||!o||o.some(e=>null==e))return null;const r=s.geometry.getAttribute("position");return o.map(e=>(new f.Vector3).fromBufferAttribute(r,e))})(e,t,i);if(!s)return null;const n=e.meshes[t],o=n.geometry.getIndex(),r=o.array.slice(3*i,3*i+3);if(n.isSkinnedMesh){e=n.geometry,t=e.attributes.position,i=e.attributes.skinWeight;const a=c(t),h=c(i);s.forEach((e,t)=>{t=r[t],t=te(t,n,a,h);e.copy(t)})}else s.forEach(e=>{e.applyMatrix4(n.matrixWorld)});return s};function ne(e,t){var i={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]]);return i}function K(e,r,a,h){return new(a=a||Promise)(function(i,t){function s(e){try{o(h.next(e))}catch(e){t(e)}}function n(e){try{o(h.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?i(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(s,n)}o((h=h.apply(e,r||[])).next())})}const u={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",POINTER_UP:"pointerup",POINTER_ENTER:"pointerenter",POINTER_LEAVE:"pointerleave",LOAD:"load",ERROR:"error",CLICK:"click",DOUBLE_CLICK:"dblclick",CONTEXT_LOST:"webglcontextlost",CONTEXT_RESTORED:"webglcontextrestored"},s={GRAB:"grab",GRABBING:"grabbing",NONE:""},oe=((t=a=a||{})[t.LEFT=0]="LEFT",t[t.MIDDLE=1]="MIDDLE",t[t.RIGHT=2]="RIGHT","anonymous"),g="div",re="button",Q="auto",T={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",INPUT_START:"inputStart",INPUT_END:"inputEnd",CAMERA_CHANGE:"cameraChange",ANIMATION_START:"animationStart",ANIMATION_LOOP:"animationLoop",ANIMATION_FINISHED:"animationFinished",ANNOTATION_FOCUS:"annotationFocus",ANNOTATION_UNFOCUS:"annotationUnfocus",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced",QUICK_LOOK_TAP:"quickLookTap"},ae={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},$={WRAPPER:"view3d-wrapper",CANVAS:"view3d-canvas",POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay",ANNOTATION_WRAPPER:"view3d-annotation-wrapper",ANNOTATION:"view3d-annotation",ANNOTATION_TOOLTIP:"view3d-annotation-tooltip",ANNOTATION_DEFAULT:"default",ANNOTATION_SELECTED:"selected",ANNOTATION_HIDDEN:"hidden",ANNOTATION_FLIP_X:"flip-x",ANNOTATION_FLIP_Y:"flip-y",CTX_LOST:"ctx-lost"},he={LINEAR:f.LinearToneMapping,REINHARD:f.ReinhardToneMapping,CINEON:f.CineonToneMapping,ACES_FILMIC:f.ACESFilmicToneMapping},p={FOV:"fov",DISTANCE:"distance"};var t={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const le={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var v,S,h;const E={ROTATE:0,TRANSLATE:1,ZOOM:2},ce={ONE:"one",NONE:"none",ALL:"all"};class _e{constructor(e){this._defaultRenderLoop=e=>{var{control:t,autoPlayer:i,animator:s}=this._view3D;(s.animating||t.animating||i.animating)&&this._renderFrame(e)},this._onContextLost=()=>{const e=this._canvas;e.classList.add($.CTX_LOST)},this._onContextRestore=()=>{const e=this._canvas,t=this._view3D.scene;e.classList.remove($.CTX_LOST),t.initTextures(),this.renderSingleFrame()};const t=((e,t)=>{e=e.querySelector(t);if(e)return e;throw new Y(X.CANVAS_NOT_FOUND,Z.CANVAS_NOT_FOUND)})(e.rootEl,e.canvasSelector),i=(this._canvas=t,this._view3D=e,this._renderQueued=!1,new f.WebGLRenderer({canvas:t,alpha:!0,antialias:!0,preserveDrawingBuffer:!0}));i.toneMapping=e.toneMapping,i.toneMappingExposure=e.exposure,i.outputEncoding=f.sRGBEncoding,i.setClearColor(0,0),this._halfFloatAvailable=(e=>{if(e.capabilities.isWebGL2)return!0;{const n=e.getContext();e=n.createTexture();let t=!0;try{var i=new Uint16Array(4),s=n.getExtension("OES_texture_half_float");t=!!s&&(n.bindTexture(n.TEXTURE_2D,e),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,s.HALF_FLOAT_OES,i),n.getError()===n.NO_ERROR)}catch(e){t=!1}return n.deleteTexture(e),t}})(i),this._renderer=i,this._clock=new f.Clock(!1),this._canvasSize=new f.Vector2,t.addEventListener(u.CONTEXT_LOST,this._onContextLost),t.addEventListener(u.CONTEXT_RESTORED,this._onContextRestore)}get canvas(){return this._canvas}get context(){return this._renderer.getContext()}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new f.Vector2);return{width:e.width,height:e.y}}get canvasSize(){return this._canvasSize}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}destroy(){const e=this._canvas;this.stopAnimationLoop(),this._renderer.dispose(),e.removeEventListener(u.CONTEXT_LOST,this._onContextLost),e.removeEventListener(u.CONTEXT_RESTORED,this._onContextRestore)}resize(){const e=this._renderer;var t,i=this._canvas;e.xr.isPresenting||(t=i.clientWidth,i=i.clientHeight,e.setPixelRatio(window.devicePixelRatio),e.setSize(t,i,!1),this._canvasSize.set(t,i))}setAnimationLoop(s){const n=this._view3D,o=this._clock;o.start(),this._renderer.setAnimationLoop((e,t)=>{var i=Math.min(o.getDelta(),n.maxDeltaTime);s(i,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}renderSingleFrame(e=!1){this._renderer.xr.isPresenting||(e?this._renderFrame(0):this._renderQueued||(requestAnimationFrame(()=>{this._renderFrame(0)}),this._renderQueued=!0))}_renderFrame(e){const t=this._view3D,i=this._renderer,{scene:s,camera:n,control:o,autoPlayer:r,animator:a,annotation:h}=t;var l;i.getContext().isContextLost()||(l=1e3*e,this._renderQueued=!1,a.update(e),o.update(l),r.update(l),t.trigger(T.BEFORE_RENDER,{type:T.BEFORE_RENDER,target:t,delta:l}),n.updatePosition(),s.shadowPlane.render(),i.render(s.root,n.threeCamera),h.render(),t.trigger(T.RENDER,{type:T.RENDER,target:t,delta:l}))}}class de{constructor(e){this._onLoadingProgress=(e,t,i)=>{const s=this._view3D;i.initialized=!0,i.lengthComputable=e.lengthComputable,i.loaded=e.loaded,i.total=e.total,s.trigger(T.PROGRESS,{type:T.PROGRESS,target:s,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class ue extends de{constructor(e){super(e)}load(n){const o=this._view3D;return new Promise((e,t)=>{const i=new f.TextureLoader,s=j(o,n);i.setCrossOrigin(oe),i.load(n,e,e=>this._onLoadingProgress(e,n,s),e=>{s.initialized=!0,t(e)})})}loadHDRTexture(n){const o=this._view3D;return new Promise((t,i)=>{const e=new M.RGBELoader,s=(o.renderer.capabilities.halfFloat||(e.type=f.FloatType),j(o,n));e.setCrossOrigin(oe),e.load(n,e=>{e.mapping=f.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,n,s),e=>{s.initialized=!0,i(e)})})}}const pe=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap","sheenColorMap","sheenRoughnessMap","specularColorMap","specularIntensityMap","transmissionMap","clearcoatMap","clearcoatNormalMap"],w={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},me=((i=v=v||{})[i.NONE=0]="NONE",i[i.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",i[i.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",i[i.ONE_FINGER=3]="ONE_FINGER",i[i.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",i[i.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",i[i.TWO_FINGER=12]="TWO_FINGER",i[i.PINCH=16]="PINCH","EXT_View3D_texture_LOD"),ve="view3d-lod",Ee="view3d-annotation";class ge{constructor(e,{darkness:t=.5,mapSize:i=9,blur:s=3.5,shadowScale:n=1,planeScale:o=2}={}){this._view3D=e,this._darkness=t,this._mapSize=i,this._blur=s,this._shadowScale=n,this._planeScale=o;t=e.renderer.threeRenderer,s=Math.min(Math.pow(2,Math.floor(i)),t.capabilities.maxTextureSize);this._root=new f.Group,this._renderTarget=new f.WebGLRenderTarget(s,s,{format:f.RGBAFormat}),this._blurTarget=new f.WebGLRenderTarget(s,s,{format:f.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1;const r=new f.OrthographicCamera(-.5,.5,.5,-.5,0);r.rotation.x=Math.PI/2,this._shadowCamera=r,this._root.add(r);n=new f.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=n,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){const t=this._root,i=this._shadowCamera;var s=this._planeScale,n=e.bbox.getBoundingSphere(new f.Sphere),s=2*s*n.radius,o=this._shadowScale;i.far=o*(e.bbox.max.y-e.bbox.min.y)/s,i.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(n.center).setY(e.bbox.min.y),t.scale.setScalar(s),i.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:i}=e,s=this._shadowCamera;const n=t.threeRenderer;t=i.activeSession?i.activeSession.arScene:e.scene,i=n.xr.enabled;n.xr.enabled=!1;const o=t.root;var e=o.background,t=(o.background=null,o.overrideMaterial=this._depthMaterial,n.getClearAlpha()),r=(n.setClearAlpha(0),n.getRenderTarget());n.setRenderTarget(this._renderTarget),n.clear(),n.render(o,s),o.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),n.xr.enabled=i,n.setRenderTarget(r),n.setClearAlpha(t),o.background=e,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],i=this._blurCamera;const s=t.threeRenderer,n=this._blurPlane;var t=this._renderTarget,o=this._blurTarget;const r=this._horizontalBlurMaterial,a=this._verticalBlurMaterial;n.visible=!0,r.uniforms.tDiffuse.value=t.texture,r.uniforms.h.value=+e/256,r.needsUpdate=!0,n.material=r,s.setRenderTarget(o),s.render(n,i),a.uniforms.tDiffuse.value=o.texture,a.uniforms.v.value=+e/256,a.needsUpdate=!0,n.material=a,s.setRenderTarget(t),s.render(n,i),n.visible=!1}_setupPlanes(){const e=this._root;var t=new f.PlaneBufferGeometry,i=new f.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:f.BackSide,depthWrite:!1,map:this._renderTarget.texture});const s=new f.Mesh(t,i);s.renderOrder=1,s.scale.set(-1,-1,1),s.rotation.order="YXZ",s.rotation.x=Math.PI/2,this._plane=s,e.add(s);i=new f.Mesh(t);this._blurPlane=i;const n=new f.MeshDepthMaterial,o=(n.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=n,new f.ShaderMaterial(I.HorizontalBlurShader)),r=(o.depthTest=!1,this._horizontalBlurMaterial=o,new f.ShaderMaterial(D.VerticalBlurShader));r.depthTest=!1,this._verticalBlurMaterial=r}}class b{static createDefaultEnv(e){const t=new f.Scene,i=new f.PointLight(16777215,.8,20);i.decay=2,i.position.set(0,7,0),t.add(i);var s=new f.BoxBufferGeometry(1,1,1),n=new f.MeshStandardMaterial({side:f.BackSide});const o=new f.Mesh(s,n),r=(o.castShadow=!1,o.scale.set(15,45,15),o.position.set(0,20,0),t.add(o),b._createRectAreaLightSource({intensity:4.5,width:4,height:4}));r.position.set(0,2.5,0),r.rotateX(Math.PI/2);const a=b._createRectAreaLightSource({intensity:3,width:2,height:2}),h=(a.position.set(0,1,4),a.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),l=(h.position.set(-4,1,1),h.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),c=(l.position.set(4,1,1),l.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),_=(c.position.set(1.5,1,-4),c.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2}));_.position.set(-1.5,1,-4),_.lookAt(0,0,0),t.add(r,a,h,l,c,_);var s=e.outputEncoding,n=e.toneMapping,d=(e.outputEncoding=f.LinearEncoding,e.toneMapping=f.NoToneMapping,new f.PMREMGenerator(e).fromScene(t,.035));return e.outputEncoding=s,e.toneMapping=n,d.texture}static createBlurredHDR(e,t){const i=e.renderer.threeRenderer,s=new f.Scene;s.background=t;e=i.toneMappingExposure,i.toneMappingExposure=1,t=new f.WebGLCubeRenderTarget(256,{encoding:f.sRGBEncoding,format:f.RGBAFormat});const n=new f.CubeCamera(.1,1e3,t);n.update(i,s);var o=N.LightProbeGenerator.fromCubeRenderTarget(i,t),r=new f.MeshStandardMaterial({side:f.BackSide});const a=new f.IcosahedronBufferGeometry(1,4),h=new f.Scene;r=new f.Mesh(a,r);const l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return h.add(r),h.add(o),n.update(i,h),i.toneMappingExposure=e,t.texture}static _createRectAreaLightSource({intensity:e,width:t,height:i}){t=new f.PlaneBufferGeometry(t,i);const s=new f.MeshBasicMaterial;return s.color.setScalar(e),new f.Mesh(t,s)}}class Te{constructor(e){this._view3D=e,this._root=new f.Scene,this._userObjects=new f.Group,this._envObjects=new f.Group,this._fixedObjects=new f.Group,this._shadowPlane=new ge(e,q(e.shadow));const t=this._root,i=this._userObjects,s=this._envObjects,n=this._fixedObjects;var o=this._shadowPlane;i.name="userObjects",s.name="envObjects",n.name="fixedObjects",t.add(i,s,n),e.shadow&&n.add(o.root)}get root(){return this._root}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const i=t?this._userObjects:this._envObjects;t=Array.isArray(e)?e:[e];i.add(...t)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(n){return K(this,void 0,void 0,function*(){const e=this._view3D,t=this._root;if("number"==typeof n||"#"===n.charAt(0))t.background=new f.Color(n);else{const i=new ue(e),s=yield i.load(n);s.encoding=f.sRGBEncoding,t.background=s}e.renderer.renderSingleFrame()})}setSkybox(n){return K(this,void 0,void 0,function*(){const e=this._root,t=this._view3D;if(e.background&&e.background.isTexture&&e.background.dispose(),n){const s=new ue(t);var i=yield s.loadHDRTexture(n);t.skyboxBlur?e.background=b.createBlurredHDR(t,i):e.background=i,e.environment=i}else e.background=null,e.environment=null;t.renderer.renderSingleFrame()})}setEnvMap(n){return K(this,void 0,void 0,function*(){const e=this._view3D,t=this._root;if(n){const s=new ue(e);var i=yield s.loadHDRTexture(n);t.environment=i}else t.environment=null;e.renderer.renderSingleFrame()})}initTextures(){var{skybox:e,envmap:t,background:i,useDefaultEnv:s}=this._view3D;const n=[];return s&&this.setDefaultEnv(),(e||t)&&(s=e?this.setSkybox(e):this.setEnvMap(t),n.push(s)),!e&&i&&n.push(this.setBackground(i)),n}setDefaultEnv(){var e=this._view3D.renderer,e=b.createDefaultEnv(e.threeRenderer);this._root.environment=e}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e,i=(t.geometry.dispose(),Array.isArray(t.material)?t.material:[t.material]);i.forEach(t=>{pe.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}const O=ae.EASE_OUT_CUBIC,we={min:0,max:1},r={min:-1/0,max:1/0},be={min:-89.9,max:89.9},Oe={165:0,135:.4,0:1},fe=[t.WEBXR,t.SCENE_VIEWER,t.QUICK_LOOK];class L{constructor({duration:e=300,loop:t=!1,range:i=we,easing:s=O}={}){this._duration=e,this._loop=t,this._range=i,this._easing=s,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}get activated(){return this._activated}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,i=this._end,s=this._duration,n=this._val,o=this._loop,e=this._progress+e/s,s=(this._progress=(o?l:_)(e,0,1),this._easing(this._progress));return this._val=k(t,i,s),!o&&1<=this._progress&&(this._activated=!1),this._val-n}reset(e){var t=this._range,e=_(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=_(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class Se{constructor(e,t,i,{duration:s=300,easing:n=O,disableOnFinish:o=!0}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,this._motion=new L({duration:s,range:we,easing:n}),this._disableOnFinish=o,this.changeStartEnd(t,i)}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}get animating(){return this._motion.activated}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}changeStartEnd(e,t){e=e.clone(),t=t.clone(),e.yaw=l(e.yaw,0,360),t.yaw=l(t.yaw,0,360),180<Math.abs(t.yaw-e.yaw)&&(t.yaw=t.yaw<e.yaw?t.yaw+360:t.yaw-360),this._from=e,this._to=t}update(e){if(this._enabled){const i=this._view3D.camera,s=this._from;var t=this._to;const n=this._motion;n.update(e);e=n.val;i.yaw=k(s.yaw,t.yaw,e),i.pitch=k(s.pitch,t.pitch,e),i.zoom=k(s.zoom,t.zoom,e),i.pivot=s.pivot.clone().lerp(t.pivot,e),1<=e&&(this._disableOnFinish&&this.disable(),this._finishCallbacks.forEach(e=>e()),this.clearFinished())}}enable(){this._enabled||(this._enabled=!0,this.reset())}disable(){this._enabled&&(this._enabled=!1)}reset(){this._motion.reset(0),this._motion.setEndDelta(1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class A{constructor(e,t,i,s=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=i,this.pivot=(new f.Vector3).fromArray(s)}clone(){return new A(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}copy(e){this.yaw=e.yaw,this.pitch=e.pitch,this.zoom=e.zoom,this.pivot.copy(e.pivot)}equals(e){const{yaw:t,pitch:i,zoom:s,pivot:n}=this;return l(t,0,360)===l(e.yaw,0,360)&&i===e.pitch&&s===e.zoom&&n.equals(e.pivot)}}class Le{constructor(e){this._view3D=e,this._threeCamera=new f.PerspectiveCamera,this._maxTanHalfHFov=0,this._baseFov=45,this._baseDistance=0;var t=U(e.initialZoom)?e.initialZoom:0;this._defaultPose=new A(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone(),this._newPose=this._currentPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get newPose(){return this._newPose}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get distance(){return this._view3D.control.zoom.type===p.FOV?this._baseDistance:this._baseDistance-this._currentPose.zoom}get baseDistance(){return this._baseDistance}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this.distance*Math.tan(d(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._newPose.yaw=e}set pitch(e){this._newPose.pitch=e}set zoom(e){this._newPose.zoom=e}set pivot(e){this._newPose.pivot.copy(e)}set baseFov(e){this._baseFov=e}reset(e=0,t=O,i){const s=this._view3D,n=s.control,o=s.autoPlayer,r=this._newPose,a=this._currentPose,h=null!=i?i:this._defaultPose;if(e<=0)return r.copy(h),a.copy(h),s.renderer.renderSingleFrame(),n.sync(),Promise.resolve();{const l=o.enabled,c=new Se(s,a,h);return c.duration=e,c.easing=t,c.enable(),l&&o.disable(),n.add(c),new Promise(e=>{c.onFinished(()=>{r.copy(h),a.copy(h),n.remove(c),n.sync(),l&&o.enableAfterDelay(),e()})})}}resize({width:e,height:t},i=null){const{control:s,fov:n,maintainSize:o}=this._view3D,r=this._threeCamera;r.aspect=e/t,n===Q?o&&null!=i?(e=t/i.height,t=this._currentPose.zoom,i=Math.tan(d((this._baseFov-t)/2)),this._baseFov=m(2*Math.atan(e*i))+t):this._applyEffectiveFov(45):this._baseFov=n,s.zoom.updateRange()}fit(e,t){var i=this._view3D;const s=this._threeCamera,n=i.control,o=this._defaultPose,r=e.bbox;var a=i.fov,h=a===Q?45:a;const l=Array.isArray(t)?(new f.Vector3).fromArray(t):r.getCenter(new f.Vector3);t=t===Q?(new f.Vector3).subVectors(r.max,r.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(l)),0),t=Math.sqrt(t);const c=t/Math.sin(d(h/2));var _=e.reduceVertices((e,t)=>{var t=(new f.Vector3).subVectors(t,l),i=Math.hypot(t.x,t.z);return Math.max(e,i/(c-Math.abs(t.y)))},0);a===Q?(this._maxTanHalfHFov=_,this._applyEffectiveFov(h)):this._maxTanHalfHFov=a,o.pivot=l.clone(),this._baseDistance=c,s.near=.1*(c-t),s.far=10*(c+t),n.zoom.updateRange(),U(i.initialZoom)?o.zoom=i.initialZoom:(_=this._baseFov,h=e.bbox,a=i.initialZoom.axis,t=i.initialZoom.ratio,i=(e=(new f.Vector3).subVectors(h.max,h.min))[a],h="y"===a?i/t:i/(t*s.aspect),i="z"!==a?c-e.z/2:c-e.x/2,t=m(2*Math.atan(h/(2*i))),o.zoom=_-t)}updatePosition(){const e=this._view3D;var t=e.control;const i=this._threeCamera,s=this._currentPose,n=this._newPose;var o=this._baseFov,r=this._baseDistance,t=t.zoom.type===p.FOV,a=s.clone(),o=(s.yaw=l(n.yaw,0,360),s.pitch=_(n.pitch,be.min,be.max),s.zoom=n.zoom,s.pivot.copy(n.pivot),t?o-s.zoom:o);const h=((e,t,i)=>{t=d(t),i=d(i);const s=new f.Vector3(0,0,0);return s.y=e*Math.sin(i),s.z=e*Math.cos(i),s.x=s.z*Math.sin(-t),s.z=s.z*Math.cos(-t),s})(t?r:r-s.zoom,s.yaw,s.pitch);h.add(s.pivot),i.fov=o,i.position.copy(h),i.lookAt(s.pivot),i.updateProjectionMatrix(),n.copy(s),e.trigger(T.CAMERA_CHANGE,{type:T.CAMERA_CHANGE,target:e,pose:s.clone(),prevPose:a})}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(d(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=m(2*Math.atan(e))}}class Ae{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const i=e.renderer.canvas;var t=i.getBoundingClientRect(),t=0!==t.width||0!==t.height;const s=new ResizeObserver(t?this._skipFirstResize:this._onResize);s.observe(i),this._resizeObserver=s}else e.resize(),window.addEventListener(u.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(this._enabled){const e=this._resizeObserver;e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(u.RESIZE,this._onResize),this._enabled=!1}return this}}class ye{constructor(e){this._onAnimationLoop=t=>{const e=this._view3D,i=this._actions;var s=this._clips,n=i.findIndex(e=>e===t.action);e.trigger(T.ANIMATION_LOOP,{type:T.ANIMATION_LOOP,target:e,index:n,action:t.action,clip:s[n]}),e.animationRepeatMode===ce.ALL&&(s=n+1>=s.length?0:n+1,this.play(s))},this._onAnimationFinished=t=>{const e=this._view3D,i=this._actions;var s=this._clips,n=i.findIndex(e=>e===t.action);e.trigger(T.ANIMATION_FINISHED,{type:T.ANIMATION_FINISHED,target:e,index:n,action:t.action,clip:s[n]})},this._view3D=e,this._mixer=new f.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._timeScale=1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAction(){var e;return null!=(e=this._actions[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}get animating(){var e;return(null==(e=this.activeAction)?void 0:e.isRunning())&&!this.paused}get timeScale(){return this._timeScale}set timeScale(e){this._timeScale=e}init(){this._mixer.addEventListener("loop",this._onAnimationLoop),this._mixer.addEventListener("finished",this._onAnimationFinished)}destroy(){this.reset(),this._mixer.removeEventListener("loop",this._onAnimationLoop),this._mixer.removeEventListener("finished",this._onAnimationFinished)}setClips(e){const i=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=i.clipAction(e);return t.setEffectiveWeight(0),t}),this.updateRepeatMode()}play(e){const t=this._view3D,i=this._actions[e];i&&(this.stop(),this._restoreTimeScale(),i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.play(),this._activeAnimationIdx=e,this._flushFadePromises(),t.trigger(T.ANIMATION_START,{type:T.ANIMATION_START,target:t,index:e,action:i,clip:this._clips[e]}))}crossFade(l,c,{synchronize:_=!1}={}){var d;return K(this,void 0,void 0,function*(){const i=this._view3D,t=this._mixer;var e=this._actions,s=this._activeAnimationIdx;const n=e[l],o=null!=(d=e[s])?d:n,r="loop",a=(this._restoreTimeScale(),()=>{n.enabled=!0,n.setEffectiveTimeScale(1),n.setEffectiveWeight(1),n.time=0,n.play(),o.crossFadeTo(n,c/1e3,!0),this._activeAnimationIdx=l});if(_){const h=e=>{e.action===o&&(t.removeEventListener(r,h),a())};t.addEventListener(r,h)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{n.getEffectiveWeight()<1||(i.off(T.BEFORE_RENDER,t),e(!0))};i.on(T.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return K(this,void 0,void 0,function*(){const i=this._view3D;const s=this._actions[this._activeAnimationIdx];return!!s&&(this._flushFadePromises(),this._restoreTimeScale(),s.fadeOut(e/1e3),new Promise(e=>{const t=()=>{0<s.getEffectiveWeight()||(i.off(T.BEFORE_RENDER,t),this._activeAnimationIdx=-1,e(!0))};i.on(T.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._view3D.renderer.renderSingleFrame(),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}updateRepeatMode(){var e=this._view3D;const t=this._actions;e.animationRepeatMode===ce.NONE?t.forEach(e=>{e.clampWhenFinished=!0,e.loop=f.LoopOnce}):t.forEach(e=>{e.clampWhenFinished=!1,e.loop=f.LoopRepeat})}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=this._timeScale}_flushFadePromises(){const i=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),i.off(T.BEFORE_RENDER,t)}),this._fadePromises=[]}}class Ce extends e{constructor({context:e=window,repeat:t=0,duration:i=300,easing:s=O}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,i=this._repeat,e=this._time+e,s=Math.floor(e/t),e=(this._time=(this._loopCount>=i?_:l)(e,0,t),this._time/t),n={progress:e,easedProgress:this._easing(e)};this.trigger("progress",n);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>i)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},n),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=i,this._easing=s,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const Re={AR:"immersive-ar",VR:"immersive-vr"},xe={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},y={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend",ESTIMATION_START:"estimationstart",ESTIMATION_END:"estimationend"},Me={TOUCH:"generic-touchscreen"},Ie={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{},LIGHT_ESTIMATION:{optionalFeatures:["light-estimation"]}},De={},Ne={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class Pe{constructor({scale:e=1}={}){this.rotation=new f.Quaternion,this._axis=new f.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new f.Vector2,this._fromQuat=new f.Quaternion,this._toQuat=new f.Quaternion,this._motion=new L({range:r}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:i}){if(this._active&&1===i.length){const s=this._prevPos,n=this._motion;i=i[0];const o=e.modelMovable.getWorldPosition(new f.Vector3);e=(new f.Vector2).fromArray(o.project(t).toArray()),t=G(e,s,i)*this._userScale,e=(new f.Quaternion).setFromAxisAngle(this._axis,t),t=this._getInterpolatedQuaternion();this._fromQuat.copy(t),this._toQuat.premultiply(e),n.reset(0),n.setEndDelta(1),s.copy(i)}}update({scene:e},t){if(this._active){const i=this._motion;i.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,i=this._fromQuat,e=e.val;return(new f.Quaternion).copy(i).slerp(t,e)}}(i=S=S||{})[i.WAITING=0]="WAITING",i[i.TRANSLATING=1]="TRANSLATING",i[i.BOUNCING=2]="BOUNCING";class Fe{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:i=ae.EASE_OUT_BOUNCE}={}){this._hoverPosition=new f.Vector3,this._floorPosition=new f.Vector3,this._wallRotation=new f.Quaternion,this._dragPlane=new f.Plane,this._enabled=!1,this._vertical=!1,this._state=S.WAITING,this._initialPos=new f.Vector2,this._hoverHeight=e,this._bounceMotion=new L({duration:t,easing:i,range:r})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=S.TRANSLATING}}deactivate(){if(!this._enabled||this._vertical||this._state===S.WAITING)this._state=S.WAITING;else{this._state=S.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const i=this._bounceMotion;t=t.y-e.y;i.reset(t),i.setEndDelta(-t)}}init(e,t,i){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=i?new f.Vector3(0,1,0).applyQuaternion(t):new f.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=i}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:i},{hitResults:s}){var n=this._state,n=n===S.WAITING||n===S.BOUNCING;if(s&&1===s.length&&!n){const c=s[0];n=this._floorPosition.clone();const _=this._floorPosition,d=this._hoverPosition;s=this._hoverHeight;const u=this._dragPlane;var o=this._vertical,r=c.results[0]&&c.results[0].getPose(t),a=r&&(new f.Matrix4).fromArray(r.transform.matrix),h=r&&.75<a.elements[5],l=r&&a.elements[5]<.25,i=(new f.Vector3).setFromMatrixPosition(i.matrixWorld),a=r&&(new f.Vector3).setFromMatrixPosition(a);if(o)if(!e||r&&l){const p=new f.Vector3(0,1,0);o=r.transform.orientation,l=p.clone().applyQuaternion(new f.Quaternion(o.x,o.y,o.z,o.w)).normalize(),o=(new f.Vector3).crossVectors(new f.Vector3(0,1,0),l);const m=new f.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(m.dot(l)))>=Math.PI/18){o=(new f.Matrix4).makeBasis(o,p,l);const E=new f.Euler(0,0,0,"YXZ").setFromRotationMatrix(o);E.z=0,E.x=Math.PI/2,this._wallRotation.setFromEuler(E),u.normal.copy(new f.Vector3(0,1,0).applyQuaternion(this._wallRotation)),u.constant=this._calcDragPlaneConstant(a)}l=(new f.Vector3).subVectors(a,i).normalize();const v=new f.Ray(i,l);o=v.intersectPlane(u,new f.Vector3);o&&_.copy(o)}else{l=e.getPose(c.inputSource.targetRaySpace,t);if(!l)return;o=l.transform.position;const g=new f.Vector3(o.x,o.y,o.z);l=g.sub(i).normalize();const T=new f.Ray(i,l);o=T.intersectPlane(u,new f.Vector3);void(o&&_.copy(o))}else if(!e||r&&h){l=-u.constant,o=a.y+s,r=(.1<o-l&&(u.constant=-o),(new f.Vector3).subVectors(a,i).normalize());const w=new f.Ray(i,r);h=w.intersectPlane(u,new f.Vector3);h&&(_.copy(h),_.setY(a.y),d.copy(h))}else{s=e.getPose(c.inputSource.targetRaySpace,t);if(!s)return;l=s.transform.position;const b=new f.Vector3(l.x,l.y,l.z);o=b.sub(i).normalize();const O=new f.Ray(i,o);r=O.intersectPlane(u,new f.Vector3);void(r&&(_.copy(r),_.setY(n.y),d.copy(r)))}}}update({scene:e},t){var i=this._state,s=this._floorPosition;const n=this._hoverPosition,o=this._bounceMotion;var r=this._vertical;i===S.BOUNCING&&(o.update(t),n.setY(s.y+o.val),1<=o.progress&&(this._state=S.WAITING)),e.setRootPosition(s),r?e.setWallRotation(this._wallRotation):e.setModelHovering(n.y-s.y)}_calcDragPlaneConstant(e){var t=this._vertical,i=this._dragPlane.normal.clone();const s=new f.Plane(i,0);i=t?0:this._hoverHeight;return-(s.distanceToPoint(e)+i)}}class ze{constructor({width:e=.1,padding:t=20,offset:i=.05,font:s="64px sans-serif",color:n="white"}={}){const o=document.createElement("canvas"),r=o.getContext("2d");r.font=s;var a=r.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,a=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,l=(e=>{let t=1;for(;t<e;)t*=2;return t})(h),e=(o.width=l,e*((o.height=l)/h)),l=(this._ctx=r,this._canvas=o,this._height=e*a/h,this._texture=new f.CanvasTexture(o),new f.PlaneGeometry(e,e)),a=new f.Mesh(l,new f.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=s,this._color=n,this._padding=t,this._offset=i,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,i){const s=this._mesh;i=this._height/2+this._offset+i,i=new f.Vector3(0,i,0).applyQuaternion(e.clone().invert());s.position.copy(i),s.lookAt(t)}updateScale(e){const t=this._ctx;var i=this._canvas,s=this._padding,n=(100*e).toFixed(0),o=(t.clearRect(0,0,i.width,i.height),i.width/2),i=i.height/2,r=t.measureText(n+"%"),a=(r.actualBoundingBoxLeft+r.actualBoundingBoxRight)/2,r=(r.actualBoundingBoxAscent+r.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(o-a,i-r-s),t.lineTo(o+a,i-r-s),t.quadraticCurveTo(o+a+s,i-r-s,o+a+s,i-r),t.lineTo(o+a+s,i+r),t.quadraticCurveTo(o+a+s,i+r+s,o+a,i+r+s),t.lineTo(o-a,i+r+s),t.quadraticCurveTo(o-a-s,i+r+s,o-a-s,i+r),t.lineTo(o-a-s,i-r),t.quadraticCurveTo(o-a-s,i-r-s,o-a,i-r-s),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(n+"%",o,i),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class Ue{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new ze,this._motion=new L({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new ze}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:i,xrCam:s,initialScale:n}){const o=this._motion;var r=o.range;if(n===Q){var a=2*Math.atan(1/s.projectionMatrix.elements[5]),h=s.projectionMatrix.elements[0]/s.projectionMatrix.elements[5];const c=s.position;s=t.bbox.max.y-t.bbox.min.y,i=c.distanceTo((new f.Vector3).addVectors(i,new f.Vector3(0,s/2,0)))*Math.tan(a/2),s=i*h,a=t.bbox.getBoundingSphere(new f.Sphere),h=i/a.radius,t=s/a.radius;const l=_(Math.min(t,h),r.min,1);o.reset(l)}else o.reset(_(n,r.min,r.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new f.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const s=this._motion;var t=(new f.Vector2).subVectors(t[0],t[1]).length(),i=t-this._prevCoordDistance;s.setEndDelta(i),this._prevCoordDistance=t,this._updateUIPosition(e)}}update({scene:e},t){if(this._enabled&&this._active){const i=this._motion;i.update(t),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:i,vertical:s}){const n=e.model;e=(new f.Vector3).setFromMatrixPosition(i.matrixWorld),i=s?n.bbox.getBoundingSphere(new f.Sphere).radius:n.bbox.max.y-n.bbox.min.y;this._ui.updatePosition(t.root.quaternion,e,i)}}class Ve{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:i=1e3}={}){var s=Math.PI/18;const n=new f.RingGeometry(.975,1,150,1,-6*s,30*s),o=(n.rotateX(-Math.PI/2),new f.RingGeometry(.96,1.015,30,1,25*s,4*s)),r=o.attributes["position"];var a=Math.floor(11*r.count/16),h=Math.floor(13*r.count/16),l=Math.floor((h-a+1)/2),c=(new f.Vector3).fromBufferAttribute(r,a).y;for(let e=a;e<h;e++){var _=e-a,_=.025*(l-Math.abs(_-l));r.setY(e,c-_)}o.rotateX(-Math.PI/2);var s=new f.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),d=new f.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),s=new f.Mesh(n,s),d=new f.Mesh(o,d);const u=new f.Group;u.add(s,d),u.position.setY(1e-4),this._mesh=u,this._ring=s,this._arrow=d,this._animator=new L({duration:i}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new f.Sphere).radius)}update({delta:e,rotation:t}){const i=this._mesh,s=this._animator;if(i.visible){s.update(e);const n=this._ring.material,o=this._arrow.material;e=this._opacityRange;n.opacity=s.val*e.min,o.opacity=s.val*e.max,s.val<=0&&(i.visible=!1),i.quaternion.copy(t),i.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(i=h=h||{})[i.WAITING=0]="WAITING",i[i.IN_DEADZONE=1]="IN_DEADZONE",i[i.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class Be{constructor({size:e=.1}={}){this._state=h.WAITING,this._detectedGesture=v.NONE,this._testingGestures=v.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new f.Vector2,this._prevTwoFingerPos=new f.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===h.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new f.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new f.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=h.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,v.NONE)}cleanup(){this._testingGestures=v.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=v.NONE,this._state=h.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,i=this._size,s=this._testingGestures,n=this._lastFingerCount,o=e.length;if(t!==h.OUT_OF_DEADZONE){if(this._lastFingerCount=o,this.applyScreenAspect(e),o!==n)return this.setFirstInput(e),v.NONE;if(1===o){t=e[0],n=this._prevOneFingerPos.clone();const r=(new f.Vector2).subVectors(t,n);r.length()>i&&(Math.abs(r.x)>Math.abs(r.y)?v.ONE_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.ONE_FINGER_HORIZONTAL):v.ONE_FINGER_VERTICAL&s&&(this._detectedGesture=v.ONE_FINGER_VERTICAL))}else if(2===o){t=(new f.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),n=this._prevTwoFingerPos.clone();const a=(new f.Vector2).subVectors(t,n);a.length()>i&&(Math.abs(a.x)>Math.abs(a.y)?v.TWO_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.TWO_FINGER_HORIZONTAL):v.TWO_FINGER_VERTICAL&s&&(this._detectedGesture=v.TWO_FINGER_VERTICAL));o=(new f.Vector2).subVectors(e[1],e[0]).length();Math.abs(o-this._initialTwoFingerDistance)>i&&v.PINCH&s&&(this._detectedGesture=v.PINCH)}this._detectedGesture!==v.NONE&&(this._state=h.OUT_OF_DEADZONE)}return this._detectedGesture}}class ke{constructor(e,t,{rotate:i,translate:s,scale:n,ring:o,deadzone:r,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var e=this._view3D,i=this._arScene,s=this._hitTestSource;const n=this._deadzoneChecker;var o=this._rotateControl,r=this._translateControl,a=this._scaleControl;const h=e.renderer.threeRenderer;var l=h.xr.getCamera(new f.PerspectiveCamera),c=h.xr.getReferenceSpace();if(s&&!(l.cameras.length<=0)){l=l.cameras[0];const _=e.model;o.enabled&&n.addTestingGestures(v.ONE_FINGER),r.enabled&&n.addTestingGestures(v.ONE_FINGER),a.enabled&&n.addTestingGestures(v.PINCH);e=t.getHitTestResultsForTransientInput(s),o=this._hitResultToVector(e);if(n.applyScreenAspect(o),n.setFirstInput(o),1===o.length){r=t.getPose(e[0].inputSource.targetRaySpace,c);if(r){a=(new f.Vector3).setFromMatrixPosition(l.matrixWorld),s=r.transform.position,o=new f.Vector3(s.x,s.y,s.z).sub(a).normalize();const d=new f.Ray(a,o),u=_.bbox.getBoundingSphere(new f.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new f.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=i,this._translate=s,this._scale=n,this._initialScale=a,this._rotateControl=new Pe(q(i)),this._translateControl=new Fe(q(s)),this._scaleControl=new Ue(q(n)),this._floorIndicator=new Ve(o),this._deadzoneChecker=new Be(r)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:o,session:r,size:a,vertical:h,hitPosition:l,hitRotation:c}){return K(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var i=this._scaleControl,s=this._floorIndicator;const n=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),n.setAspect(a.height/a.width),e.add(s.mesh,i.ui.mesh),this.syncTargetModel(o);s=yield r.requestHitTestSourceForTransientInput({profile:Me.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(y.SELECT_START,this._onSelectStart),e.removeEventListener(y.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,i=this._translate,s=this._scale;const n=this._rotateControl,o=this._translateControl,r=this._scaleControl;var a=this._vertical;e.addEventListener(y.SELECT_START,this._onSelectStart),e.addEventListener(y.SELECT_END,this._onSelectEnd),t&&!a&&n.enable(),i&&o.enable(),s&&r.enable()}disable(e){const t=this._rotateControl,i=this._translateControl,s=this._scaleControl;e.removeEventListener(y.SELECT_START,this._onSelectStart),e.removeEventListener(y.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),i.disable(),s.disable()}update(e){const{view3D:t,session:i,frame:s}=e;var n,o,r=this._hitTestSource;r&&t.model&&(n=this._deadzoneChecker,o=i.inputSources,r=null!=(r=null===s||void 0===s?void 0:s.getHitTestResultsForTransientInput(r))?r:[],o={coords:this._hitResultToVector(r),inputSources:o,hitResults:r},n.inDeadzone?this._checkDeadzone(e,o):this._processInput(e,o),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,i=this._translateControl.floorPosition,s=this._view3D.renderer.threeRenderer.xr.getCamera(new f.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:i,xrCam:s,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var i=this._arScene;const s=this._rotateControl,n=this._translateControl,o=this._scaleControl;var r=this._deadzoneChecker.check(t.map(e=>e.clone()));if(r!==v.NONE)switch(r){case v.ONE_FINGER_HORIZONTAL:case v.ONE_FINGER_VERTICAL:this._modelHit?(n.activate(),n.setInitialPos(t)):(s.activate(),s.updateRotation(i.modelMovable.quaternion),s.setInitialPos(t));break;case v.PINCH:o.activate(e),o.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const i=this._arScene,s=this._rotateControl,n=this._translateControl,o=this._scaleControl,r=this._floorIndicator;var t=1e3*t,e=(s.update(e,t),n.update(e,t),o.update(e,t),s.rotation),a=n.floorPosition;i.setRootPosition(a),r.update({delta:t,rotation:e})}_hitResultToVector(e){return e.map(e=>(new f.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class He{constructor(){this._root=new f.Scene,this._modelRoot=new f.Group,this._modelMovable=new f.Group,this._modelFixed=new f.Group,this._arRoot=new f.Group;const e=this._root,t=this._modelRoot;var i=this._modelMovable,s=this._modelFixed,n=this._arRoot;t.add(i),e.add(t,s,n)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,i=this._modelMovable,s=this._modelFixed;e=e.scene;i.add(e.userObjects,e.envObjects),s.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,i=this._modelFixed;const s=e.scene;[...t.children,...i.children].forEach(e=>{s.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}remove(...e){this._arRoot.remove(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const i=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,i.position.setZ(t/2),i.position.setY(-e.bbox.min.z),i.rotateX(-Math.PI/2),i.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class Ge{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,Ie.DOM_OVERLAY(e)}}class We{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(xe.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return Ie.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class je{constructor(e,t){this._onEstimationStart=()=>{var e=this._light;const t=this._arScene;e&&(t.add(e),e.environment&&(t.root.environment=e.environment))},this._onEstimationEnd=()=>{var e=this._light;const t=this._arScene;e&&(t.remove(e),t.root.environment=this._origEnvironment)},this._view3D=e,this._arScene=t,this._light=null,this._origEnvironment=null}static isAvailable(){return!0}getFeatures(){return Ie.LIGHT_ESTIMATION}init(){var e=this._view3D.renderer.threeRenderer;const t=new n.XREstimatedLight(e);(this._light=t).addEventListener(y.ESTIMATION_START,this._onEstimationStart),t.addEventListener(y.ESTIMATION_END,this._onEstimationEnd)}destroy(){const e=this._light;e&&(e.removeEventListener(y.ESTIMATION_START,this._onEstimationStart),e.removeEventListener(y.ESTIMATION_END,this._onEstimationEnd),this._light=null)}}class Ye{constructor(e,{features:t=De,vertical:i=!1,overlayRoot:s=null,useLightEstimation:n=!0,rotate:o=!0,translate:r=!0,scale:a=!0,ring:h={},deadzone:l={},initialScale:c=Q}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=i,this.overlayRoot=s,this.useLightEstimation=n,this._arScene=new He,this._control=new ke(e,this._arScene,{rotate:o,translate:r,scale:a,ring:h,deadzone:l,initialScale:c}),this._hitTest=new We,this._domOverlay=new Ge,this._lightEstimation=new je(e,this._arScene)}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&We.isAvailable()&&Ge.isAvailable()?navigator.xr.isSessionSupported(Re.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}get lightEstimation(){return this._lightEstimation}enter(){return K(this,void 0,void 0,function*(){const a=this._view3D,h=a.scene,l=this._arScene,e=a.renderer,c=e.threeRenderer,_=this._control,t=this._hitTest,i=this._domOverlay;var s=this.useLightEstimation;const n=this._lightEstimation,d=this.vertical;var o=this._getAllXRFeatures();c.xr.enabled=!0,s&&n.init();const u=yield navigator.xr.requestSession(Re.AR,o),r=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(xe.LOCAL),yield c.xr.setSession(u),l.init(a),t.init(u);u.addEventListener("end",()=>K(this,void 0,void 0,function*(){_.destroy(u),l.destroy(a),n.destroy(),i.destroy(),c.setPixelRatio(r),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),a.trigger(T.AR_END,{target:a,type:T.AR_END,session:this})}),{once:!0});const p=new f.Clock;p.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var i,s,n,o=c.xr.getCamera(new f.PerspectiveCamera),r=p.getDelta();o.cameras.length<=0||(o=o.cameras[0],i=c.xr.getReferenceSpace(),s={width:null!=(n=null==(s=u.renderState.baseLayer)?void 0:s.framebufferWidth)?n:1,height:null!=(n=null==s?void 0:s.framebufferHeight)?n:1},n={view3D:a,scene:l,session:u,delta:r,frame:t,vertical:d,referenceSpace:i,xrCam:o,size:s},t=1e3*r,a.trigger(T.BEFORE_RENDER,{type:T.BEFORE_RENDER,target:a,delta:t}),this._modelPlaced?(_.update(n),a.animator.update(r),h.shadowPlane.render(),c.render(l.root,o)):this._initModelPosition(n),a.trigger(T.RENDER,{type:T.RENDER,target:a,delta:t}))}),a.trigger(T.AR_START,{type:T.AR_START,target:a,session:this})})}exit(){return K(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=ee(this.overlayRoot))?t:this._createARRootElement();return H({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),this._lightEstimation.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:i,size:s,vertical:n,referenceSpace:o}=e,r=this._view3D;e=r.model;const a=this._arScene,h=this._hitTest;if(h.ready&&e){const d=this._control;var l=h.getResults(t);if(!(l.length<=0)){const u=l[0];l=u.getPose(o);if(l){var c=(new f.Matrix4).fromArray(l.transform.matrix);if(!(!n&&c.elements[5]<.75||n&&(.25<=c.elements[5]||c.elements[5]<=-.25))){c=(new f.Vector3).setFromMatrixPosition(c);const p=new f.Quaternion;if(n){const E=new f.Vector3(0,1,0);var l=l.transform.orientation,l=E.clone().applyQuaternion(new f.Quaternion(l.x,l.y,l.z,l.w)).normalize(),_=(new f.Vector3).crossVectors(new f.Vector3(0,1,0),l),_=(new f.Matrix4).makeBasis(_,E,l);const g=new f.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);g.z=0,g.x=Math.PI/2,p.setFromEuler(g),a.setWallRotation(p)}a.updateModelRootPosition(e,n),a.setRootPosition(c),a.showModel(),h.destroy(),this._modelPlaced=!0,r.trigger(T.AR_MODEL_PLACED,{type:T.AR_MODEL_PLACED,target:r,session:this,model:e}),d.init({model:e,vertical:n,session:i,size:s,hitPosition:c,hitRotation:p});const m=d.scale.scale,v=new Ce({context:i,duration:1e3});v.on("progress",e=>{a.setModelScale(e.easedProgress*m)}),v.on("finish",()=>{a.setModelScale(m),d.enable(i)}),v.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement(g);return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(T.AR_END,()=>{e.rootEl.removeChild(t)}),t}}Ye.type=t.WEBXR;class Ze{constructor(e,t={}){var{file:i=null,mode:s=le.ONLY_AR,fallbackURL:n=null,title:o=null,link:r=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=Q,shareText:d=null}=t,t=ne(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=i,this.fallbackURL=n,this.mode=s,this.title=o,this.link=r,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var n;return K(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=W(this.resizable),t.enable_vertical_placement=W(this.vertical),t.disable_occlusion=W(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var i=null!=(n=this.file)?n:e.src;if(!i)return Promise.reject(new Y(X.FILE_NOT_SUPPORTED(null!=(n=this.file)?n:e.src),Z.FILE_NOT_SUPPORTED));t.file=new URL(i,window.location.href).href;e=this.fallbackURL,i=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===le.ONLY_AR?Ne.INTENT_AR_CORE(i,e):Ne.INTENT_SEARCHBOX(i,e||Ne.FALLBACK_DEFAULT(i));const s=document.createElement("a");s.href=e,s.click()})}exit(){return Promise.resolve()}}Ze.type=t.SCENE_VIEWER;class Xe{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:i=null,applePayButtonType:s=null,callToAction:n=null,checkoutTitle:o=null,checkoutSubtitle:r=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=i,this.applePayButtonType=s,this.callToAction=n,this.checkoutTitle=o,this.checkoutSubtitle=r,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new Y(X.FILE_NOT_SUPPORTED(""+e),Z.FILE_NOT_SUPPORTED));var i=this.canonicalWebPageURL,s=this.custom,n=window.location.href;const o=document.createElement("a"),r=(o.setAttribute("rel","ar"),o.appendChild(document.createElement("img")),Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,i])=>(i&&(e[t]=i),e),{})),a=new URL(e,n);return this.allowsContentScaling||(r.allowsContentScaling="0"),i&&(r.canonicalWebPageURL=new URL(i,n).href),s&&(r.custom=new URL(s,n).href),a.hash=new URLSearchParams(r).toString(),o.setAttribute("href",a.href),o.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(T.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:T.QUICK_LOOK_TAP,target:t}))},!1),o.click(),Promise.resolve()}exit(){return Promise.resolve()}}Xe.type=t.QUICK_LOOK;const qe={[t.WEBXR]:Ye,[t.SCENE_VIEWER]:Ze,[t.QUICK_LOOK]:Xe};class Ke{constructor(e){this._view3D=e,this._activeSession=null,e.on(T.AR_START,({session:e})=>{this._activeSession=e}),e.on(T.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return K(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return K(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new Y(X.NOT_INITIALIZED,Z.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const i=new t(e,q(e[t.type]));return yield i.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return K(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>qe[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class Qe{constructor(e,{element:t=null,focus:i=[],focusDuration:s=1e3,baseFov:n=45,baseDistance:o=null,aspect:r=1}={}){this._onClick=()=>{this.focus()},this._onWheel=e=>{e.preventDefault(),e.stopPropagation()},this._view3D=e,this._element=t,this._focus=i,this._focusDuration=s,this._baseFov=n,this._baseDistance=o,this._aspect=r,this._enabled=!1,this._hidden=!1,this._focusing=!1,this._tooltipSize=new f.Vector2,t&&(t.draggable=!1,this.resize())}get element(){return this._element}get renderable(){return!!this._element}get focusPose(){return this._focus}get focusDuration(){return this._focusDuration}get baseFov(){return this._baseFov}get baseDistance(){return this._baseDistance}get aspect(){return this._aspect}get hidden(){return this._hidden}set focusDuration(e){this._focusDuration=e}set baseFov(e){this._baseFov=e}set baseDistance(e){this._baseDistance=e}set aspect(e){this._aspect=e}destroy(){const e=this._view3D.annotation.wrapper;var t=this._element;this.disableEvents(),t&&t.parentElement===e&&e.removeChild(t)}resize(){const e=this._element;var t;!e||(t=e.querySelector("."+$.ANNOTATION_TOOLTIP))&&this._tooltipSize.set(t.offsetWidth,t.offsetHeight)}render({screenPos:e,screenSize:t,renderOrder:i}){const s=this._element;var n=this._tooltipSize;s&&!this._hidden&&(s.style.zIndex=""+(i+1),s.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`,e.y+n.y>t.y?s.classList.add($.ANNOTATION_FLIP_Y):s.classList.remove($.ANNOTATION_FLIP_Y),e.x+n.x>t.x?s.classList.add($.ANNOTATION_FLIP_X):s.classList.remove($.ANNOTATION_FLIP_X))}show(){const e=this._element;this._hidden=!1,e&&e.classList.remove($.ANNOTATION_HIDDEN)}hide(){const e=this._element;this._hidden=!0,e&&e.classList.add($.ANNOTATION_HIDDEN)}setOpacity(e){const t=this._element;t&&(t.style.opacity=""+e)}enableEvents(){const e=this._element;e&&!this._enabled&&(e.addEventListener(u.CLICK,this._onClick),e.addEventListener(u.WHEEL,this._onWheel),this._enabled=!0)}disableEvents(){const e=this._element;e&&this._enabled&&(e.removeEventListener(u.CLICK,this._onClick),e.removeEventListener(u.WHEEL,this._onWheel),this._enabled=!1)}_getFocus(){var e=this._view3D;const t=(new f.Vector3).fromArray(this._focus);var i=e.camera.baseDistance,s=e.renderer.size,s=Math.max(s.height/s.width,1),n=this._aspect,o=this._baseFov,n=s/n*(null!=(s=this._baseDistance)?s:i)*Math.tan(d((o-t.z)/2)),s=2*m(Math.atan(n/i));return t.z=e.camera.baseFov-s,t}_onFocus(){const e=this._view3D,t=this._element;t&&t.classList.add($.ANNOTATION_SELECTED),this._focusing=!0,e.trigger(T.ANNOTATION_FOCUS,{type:T.ANNOTATION_FOCUS,target:e,annotation:this})}_onUnfocus(){const e=this._view3D,t=this._element;t&&t.classList.remove($.ANNOTATION_SELECTED),this._focusing=!1,e.trigger(T.ANNOTATION_UNFOCUS,{type:T.ANNOTATION_UNFOCUS,target:e,annotation:this})}}class $e extends Qe{constructor(e,t={}){var{position:i=[]}=t;super(e,ne(t,["position"])),this._position=(new f.Vector3).fromArray(i)}get position(){return this._position}focus(){return K(this,void 0,void 0,function*(){if(!this._focusing){const s=this._view3D["camera"];let e;if(0<this._focus.length){var t=this._getFocus();const n=this._position;e=new A(t.x,t.y,t.z,n.toArray())}else{var{yaw:t,pitch:i}=(e=>{const t=new f.Vector2(e.x,e.z);var i=new f.Vector2;return{yaw:Math.abs(e.y)<=.99?G(i,new f.Vector2(0,1),t):0,pitch:Math.atan2(e.y,t.distanceTo(i))}})(this._calculateNormalFromModelCenter());e=new A(m(t),m(i),0,this._position.toArray())}return window.addEventListener(u.CLICK,()=>{this.unfocus()},{once:!0,capture:!0}),this._onFocus(),e.equals(s.currentPose)?Promise.resolve():s.reset(this._focusDuration,O,e)}})}unfocus(){this._focusing&&this._onUnfocus()}toJSON(){return{position:this._position.toArray(),focus:this._focus,duration:this._focusDuration}}_calculateNormalFromModelCenter(){const e=this._view3D.model;var t=e?e.bbox.getCenter(new f.Vector3):new f.Vector3;return(new f.Vector3).subVectors(this._position,t).normalize()}}class Je extends Qe{constructor(e,t={}){var{meshIndex:i=-1,faceIndex:s=-1,weights:n=B(3).map(()=>1/3)}=t;super(e,ne(t,["meshIndex","faceIndex","weights"])),this._meshIndex=i,this._faceIndex=s,this._weights=n,this._trackingControl=null}get position(){return this._getPosition()}get renderable(){return!!this._element&&0<=this._meshIndex&&0<=this._faceIndex}get meshIndex(){return this._meshIndex}get faceIndex(){return this._faceIndex}get weights(){return this._weights}focus(){return K(this,void 0,void 0,function*(){if(!this._focusing){var e=this._view3D;const{camera:i,control:s}=e;var t=this._getFocus();const n=this._getPosition();t=new A(t.x,t.y,t.z,n.toArray());const o=new Se(e,i.currentPose,t,{duration:this._focusDuration,disableOnFinish:!1});(this._trackingControl=o).enable(),s.add(o),window.addEventListener("click",()=>{this.unfocus()},{once:!0,capture:!0}),this._onFocus()}})}unfocus(){if(this._focusing){const e=this._view3D["control"],t=this._trackingControl;t&&(e.sync(),e.remove(t),t.destroy(),this._trackingControl=null),this._onUnfocus()}}render(e){super.render(e);const t=this._trackingControl;if(t){var e=this._view3D["camera"],i=this._getFocus();const s=this._getPosition();i=new A(i.x,i.y,i.z,s.toArray());t.changeStartEnd(e.currentPose,i),t.reset()}}toJSON(){return{meshIndex:this._meshIndex,faceIndex:this._faceIndex,focus:this._focus,duration:this._focusDuration}}_getPosition(){var e=this._view3D.model,t=this._meshIndex,i=this._faceIndex,s=this._weights,e=se(e,t,i);return e?(new f.Vector3).addScaledVector(e[0],s[0]).addScaledVector(e[1],s[1]).addScaledVector(e[2],s[2]):new f.Vector3}}class et{constructor(e){this._onInput=()=>{const e=this._list;e.forEach(e=>{e.element&&e.unfocus()})},this._view3D=e,this._list=[],this._wrapper=ee(e.annotationWrapper,e.rootEl)||this._createWrapper()}get list(){return this._list}get wrapper(){return this._wrapper}init(){const e=this._view3D;e.control.controls.forEach(e=>{e.on({[w.HOLD]:this._onInput})})}destroy(){this._view3D.control.controls.forEach(e=>{e.off({[w.HOLD]:this._onInput})}),this.reset()}resize(){this._list.forEach(e=>{e.resize()})}collect(){const r=this._view3D,e=this._wrapper,t=[].slice.apply(e.querySelectorAll(r.annotationSelector));var i=t.map(e=>{const t=e.dataset.focus;var i,s={element:e,focus:t?t.split(" ").map(e=>parseFloat(e)):[],focusDuration:e.dataset.duration?parseFloat(e.dataset.duration):void 0};if(e.dataset.meshIndex)return n=parseFloat(e.dataset.meshIndex),i=e.dataset.faceIndex?parseFloat(e.dataset.faceIndex):void 0,new Je(r,Object.assign(Object.assign({},s),{meshIndex:n,faceIndex:i}));{const o=e.dataset.position;var n=o?o.split(" ").map(e=>parseFloat(e)):[];return new $e(r,Object.assign(Object.assign({},s),{position:n}))}});this.add(...i)}load(e){const s=new f.FileLoader;return new Promise((t,i)=>{s.load(e,e=>{e=JSON.parse(e),e=this.parse(e);this.add(...e),t(e)},void 0,e=>{i(e)})})}parse(e){const o=this._view3D,{baseFov:r,baseDistance:a,aspect:h,items:t}=e;return t.map(e=>{var{meshIndex:t,faceIndex:i,position:s}=e,n=ne(e,["meshIndex","faceIndex","position"]),e=this._createDefaultAnnotationElement(e.label);return null!=t&&null!=i?new Je(o,Object.assign(Object.assign({meshIndex:t,faceIndex:i},n),{baseFov:r,baseDistance:a,aspect:h,element:e})):new $e(o,Object.assign(Object.assign({position:s},n),{baseFov:r,baseDistance:a,aspect:h,element:e}))})}render(){var e=this._view3D;const t=e.model;if(t){var i=e.camera;const h=e.renderer.canvasSize,l=h.clone().multiplyScalar(.5),c=i.threeCamera,s=c.position,_=t.bbox.getCenter(new f.Vector3),d=e.annotationBreakpoints,n=[...this._list].filter(e=>e.renderable).map(e=>{var t=e.position;return{annotation:e,position:t,distToCameraSquared:s.distanceToSquared(t)}}).sort((e,t)=>t.distToCameraSquared-e.distToCameraSquared),u=(new f.Vector3).subVectors(s,_).normalize(),p=Object.keys(d).map(e=>parseFloat(e)).sort((e,t)=>t-e);n.forEach(({annotation:e,position:t},i)=>{if(e.element){var s=t.clone().project(c);const o=new f.Vector2(s.x,-s.y),r=(new f.Vector3).subVectors(t,_).normalize();var n=m(Math.abs(Math.acos(r.dot(u))));o.multiply(l),o.add(l);for(const a of p)if(n>=a){e.setOpacity(d[a]);break}e.render({position:t,renderOrder:i,screenPos:o,screenSize:h})}})}}add(...e){const t=this._wrapper;e.forEach(e=>{e.enableEvents(),e.element&&e.element.parentElement!==t&&t.appendChild(e.element)}),this._list.push(...e)}remove(e){const t=this._list.splice(e,1)[0];return t?(t.destroy(),t):null}reset(){const e=this._list,t=e.splice(0,e.length);t.forEach(e=>{e.destroy()})}toJSON(){var e=this._view3D;const t=this._list;var i=t.map(e=>{return Object.assign(Object.assign({},e.toJSON()),{label:(null==(e=null==(e=e.element)?void 0:e.querySelector("."+$.ANNOTATION_TOOLTIP))?void 0:e.innerHTML)||null})}),s=e.renderer.size,s=Math.max(s.height/s.width,1);return{baseFov:e.camera.baseFov,baseDistance:e.camera.baseDistance,aspect:s,items:i}}_createWrapper(){const e=this._view3D,t=document.createElement(g);return t.classList.add($.ANNOTATION_WRAPPER),e.rootEl.appendChild(t),t}_createDefaultAnnotationElement(e){const t=document.createElement(g);if(t.classList.add($.ANNOTATION),t.classList.add($.ANNOTATION_DEFAULT),e){const i=document.createElement(g);i.classList.add($.ANNOTATION_TOOLTIP),i.classList.add($.ANNOTATION_DEFAULT),i.innerHTML=e,t.appendChild(i)}return t}}class tt extends e{constructor(e,{duration:t=300,easing:i=O,scale:s=1,disablePitch:n=!1,disableYaw:o=!1}={}){super(),this._screenScale=new f.Vector2(0,0),this._prevPos=new f.Vector2(0,0),this._isFirstTouch=!1,this._scrolling=!1,this._enabled=!1,this._onMouseDown=e=>{if(e.button===a.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(u.MOUSE_UP,this._onMouseUp,!1),this.trigger(w.HOLD,{inputType:E.ROTATE})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,i=new f.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);i.multiply(this._screenScale),this._xMotion.setEndDelta(i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),this.trigger(w.RELEASE,{inputType:E.ROTATE})},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY),this.trigger(w.HOLD,{inputType:E.ROTATE})},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable;if(this._isFirstTouch){if(i){i=new f.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._scrolling=!0)}this._isFirstTouch=!1}!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._prevPos,n=new f.Vector2(t.clientX,t.clientY).sub(s).multiplyScalar(this._scale);n.multiply(this._screenScale),this._xMotion.setEndDelta(n.x),this._yMotion.setEndDelta(n.y),s.set(t.clientX,t.clientY)}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):(this._prevPos.set(0,0),this.trigger(w.RELEASE,{inputType:E.ROTATE})),this._scrolling=!1},this._view3D=e,this._scale=s,this._duration=t,this._easing=i,this._disablePitch=n,this._disableYaw=o,this._xMotion=new L({duration:t,range:r,easing:i}),this._yMotion=new L({duration:t,range:be,easing:i})}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._isFirstTouch=!1,this._scrolling=!1}update(e){var t=this._view3D.camera;const i=this._xMotion,s=this._yMotion,n=t.newPose;var t=!this._disableYaw,o=!this._disablePitch,e=new f.Vector2(i.update(e),s.update(e));t&&(n.yaw+=e.x),o&&(n.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(u.MOUSE_DOWN,this._onMouseDown),e.addEventListener(u.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(u.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(u.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(w.ENABLE,{inputType:E.ROTATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(u.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(u.TOUCH_START,this._onTouchStart),e.removeEventListener(u.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(u.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(w.DISABLE,{inputType:E.ROTATE})}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class it extends e{constructor(e,{easing:t=O,duration:i=0,scale:s=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new f.Vector2(0,0),this._screenSize=new f.Vector2(0,0),this._onMouseDown=e=>{if(e.button===a.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(u.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(u.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(w.HOLD,{inputType:E.TRANSLATE})}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var i=new f.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),this.trigger(w.RELEASE,{inputType:E.TRANSLATE})},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0,this.trigger(w.HOLD,{inputType:E.TRANSLATE}))},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._prevPos;var t,e=this._getTouchesMiddle(e.touches);this._touchInitialized?(t=(new f.Vector2).subVectors(e,i).multiplyScalar(this._scale),this._xMotion.setEndDelta(-t.x),this._yMotion.setEndDelta(t.y),i.copy(e)):(i.copy(e),this._touchInitialized=!0)}},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized&&(this._touchInitialized=!1,this.trigger(w.RELEASE,{inputType:E.TRANSLATE})):(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(u.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new L({duration:i,range:r,easing:t}),this._yMotion=new L({duration:i,range:r,easing:t}),this._scale=s}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._touchInitialized=!1}update(e){var t=this._view3D.camera;const i=t.newPose;var s=this._screenSize;const n=new f.Vector2(this._xMotion.update(e),this._yMotion.update(e)),o=new f.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),r=new f.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);e=new f.Vector2(t.renderWidth,t.renderHeight).divide(s);n.multiply(e);const a=i.pivot.clone();i.pivot=a.add(o.multiplyScalar(n.x)).add(r.multiplyScalar(n.y))}resize(e){const t=this._screenSize;t.copy(new f.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(u.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(u.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(u.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(u.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(w.ENABLE,{inputType:E.TRANSLATE})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(u.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(u.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(u.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(u.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(u.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(w.DISABLE,{inputType:E.TRANSLATE})}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new f.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class st extends e{constructor(e,{type:t=p.FOV,scale:i=1,duration:s=300,minFov:n=1,maxFov:o=Q,minDistance:r=.1,maxDistance:a=2,doubleTap:h=!0,easing:l=O}={}){super(),this._scaleModifier=1,this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._isFirstTouch=!0,this._isWheelScrolling=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const i=this._motion;t=-this._scale*this._scaleModifier*this._wheelModifier*e.deltaY;this._isWheelScrolling||this.trigger(w.HOLD,{inputType:E.ZOOM}),this._isWheelScrolling=!0,i.setEndDelta(t)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._motion;e=this._prevTouchDistance;const s=new f.Vector2(t[0].pageX,t[0].pageY);t=new f.Vector2(t[1].pageX,t[1].pageY);const n=s.sub(t);t=n.length()*this._scale*this._scaleModifier*this._touchModifier,e=this._isFirstTouch?0:t-e;this._prevTouchDistance=t,this._isFirstTouch&&this.trigger(w.HOLD,{inputType:E.ZOOM}),this._isFirstTouch=!1,i.setEndDelta(e)}},this._onTouchEnd=e=>{0===e.touches.length&&(this.trigger(w.RELEASE,{inputType:E.ZOOM}),this._prevTouchDistance=-1,this._isFirstTouch=!0)},this._onDoubleClick=e=>{const t=this._view3D;if(this._doubleTap&&t.model){var{zoomIn:i=.8,duration:s=300,easing:n=O,useZoomOut:o=!0}=q(this._doubleTap),i=-this._motion.range.min*i;if(t.camera.zoom>=i&&o){const r=t.camera.currentPose.clone();r.zoom=0,void t.camera.reset(s,n,r)}else{const a=new f.Raycaster,h=new f.Vector2;o=t.renderer.canvasSize,e=(h.x=e.offsetX/o.x*2-1,h.y=2*-(e.offsetY/o.y)+1,a.setFromCamera(h,t.camera.threeCamera),a.intersectObject(t.model.scene));if(e.length){const l=e[0].point;var{yaw:o,pitch:e}=t.camera;const r=new A(o,e,i,l.toArray());t.camera.reset(s,n,r)}}}},this._view3D=e,this._type=t,this._scale=i,this._duration=s,this._minFov=n,this._maxFov=o,this._minDistance=r,this._maxDistance=a,this._doubleTap=h,this._easing=l,this._motion=new L({duration:s,easing:l,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get animating(){return this._motion.activated}get range(){return this._motion.range}get type(){return this._type}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}get doubleTap(){return this._doubleTap}get easing(){return this._easing}set type(e){this._type=e}set scale(e){this._scale=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._prevTouchDistance=-1,this._isFirstTouch=!0,this._isWheelScrolling=!1}update(e){const t=this._view3D.camera.newPose,i=this._motion;var s=i.progress,e=i.update(e),n=i.progress;t.zoom-=e,this._isWheelScrolling&&s<1&&1<=n&&(this.trigger(w.RELEASE,{inputType:E.ZOOM}),this._isWheelScrolling=!1)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(u.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(u.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(u.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(u.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!0,this.sync(),this.trigger(w.ENABLE,{inputType:E.ZOOM})}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(u.WHEEL,this._onWheel,!1),e.removeEventListener(u.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(u.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(u.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!1,this.trigger(w.DISABLE,{inputType:E.ZOOM})}}sync(){var e=this._view3D.camera;const t=this._motion;t.reset(-e.zoom),this._type===p.FOV?this._scaleModifier=-1:this._scaleModifier=-e.baseDistance/44}updateRange(){const e=this._motion.range;var t,i,s=this._view3D["camera"];this._type===p.FOV?(t=s.baseFov,i=this._maxFov,e.max=i===Q?Math.min(t+45,175)-t:i-t,e.min=this._minFov-t):(e.max=s.baseDistance*this._maxDistance-s.baseDistance,e.min=s.baseDistance*this._minDistance-s.baseDistance)}}class nt{constructor(e){this._onEnable=({inputType:e})=>{var t;e!==E.ZOOM&&(t=(e=this._view3D).renderer.canvas,e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===s.NONE&&this._setCursor(s.GRAB))},this._onDisable=({inputType:e})=>{e===E.ZOOM||this._view3D.renderer.canvas.style.cursor===s.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(s.NONE)},this._onHold=({inputType:e})=>{const t=this._view3D;e!==E.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(s.GRABBING),t.trigger(T.INPUT_START,{type:T.INPUT_START,target:t,inputType:e})},this._onRelease=({inputType:e})=>{const t=this._view3D;e!==E.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(s.GRAB),t.trigger(T.INPUT_END,{type:T.INPUT_END,target:t,inputType:e})},this._view3D=e,this._rotateControl=new tt(e,q(e.rotate)),this._translateControl=new it(e,q(e.translate)),this._zoomControl=new st(e,q(e.zoom)),this._extraControls=[],[this._rotateControl,this._translateControl,this._zoomControl].forEach(e=>{e.on({[w.HOLD]:this._onHold,[w.RELEASE]:this._onRelease,[w.ENABLE]:this._onEnable,[w.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}get controls(){return[this._rotateControl,this._translateControl,this._zoomControl]}get extraControls(){return this._extraControls}get animating(){return this._rotateControl.animating||this._translateControl.animating||this._zoomControl.animating||this._extraControls.some(e=>e.animating)}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy(),this._extraControls.forEach(e=>e.destroy()),this._extraControls=[]}update(t){this._rotateControl.update(t),this._translateControl.update(t),this._zoomControl.update(t),this._extraControls.forEach(e=>e.update(t))}resize(t){this._rotateControl.resize(t),this._translateControl.resize(t),this._zoomControl.resize(t),this._extraControls.forEach(e=>e.resize(t))}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable(),this._extraControls.forEach(e=>e.enable())}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable(),this._extraControls.forEach(e=>e.disable())}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync(),this._extraControls.forEach(e=>e.sync())}add(e){this._extraControls.push(e)}remove(t){const e=this._extraControls;var i=e.findIndex(e=>e===t);0<=i&&e.splice(i,1)}updateCursor(){var e=this._view3D.useGrabCursor?s.GRAB:s.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===s.NONE){const i=t.renderer.canvas;i.style.cursor=e}}}class ot{constructor(e,{delay:t=2e3,delayOnMouseLeave:i=0,speed:s=1,pauseOnHover:n=!1,canInterrupt:o=!0,disableOnInterrupt:r=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==a.LEFT&&e.button!==a.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(u.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=i,this._speed=s,this._pauseOnHover=n,this._canInterrupt=o,this._disableOnInterrupt=r}get enabled(){return this._enabled}get animating(){return this._enabled&&!this._interrupted}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera.newPose;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(u.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(u.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(u.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(u.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(u.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(u.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}enableAfterDelay(){this.enable(),this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay)}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(u.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(u.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(u.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(u.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(u.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(u.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class rt{constructor({src:e,scenes:t,animations:i=[],annotations:s=[],fixSkinnedBbox:n=!1,castShadow:o=!0,receiveShadow:r=!1}){this._src=e;const a=new f.Group,h=(a.add(...t),this._animations=i,this._annotations=s,this._scene=a,this._getInitialBbox(n));e=h.min.y;a.translateY(-e),a.updateMatrixWorld(),h.translate(new f.Vector3(0,-e,0)),this._fixSkinnedBbox=n,this._bbox=h,this.castShadow=o,this.receiveShadow=r}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get annotations(){return this._annotations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(o,e){const t=this.meshes;let r=e;return t.forEach(t=>{var i=t.geometry.attributes["position"];if(i)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{r=o(r,e)});else{var s=c(i);for(let e=0;e<i.count;e++){const n=(new f.Vector3).fromBufferAttribute(i,e);i.normalized&&n.multiplyScalar(s),n.applyMatrix4(t.matrixWorld),r=o(r,n)}}}),r}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new f.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new f.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t.sort((e,t)=>e.name.localeCompare(t.name))}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,i){var e=t.geometry,s=e.attributes.position,e=e.attributes.skinWeight;const n=t.skeleton;n.update();var o=c(s),r=c(e);for(let e=0;e<s.count;e++)i(te(e,t,o,r))}}const at=new P.DRACOLoader,ht=new F.KTX2Loader;class C extends de{constructor(e){super(e),this._loader=new o.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(at),t.setKTX2Loader(ht.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(s){return K(this,void 0,void 0,function*(){return new Promise((e,t)=>{const i=document.createElement("script");i.addEventListener("load",()=>K(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,C.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(i),e()})),i.addEventListener("error",()=>{document.body.removeChild(i),t()}),i.src=new URL(s,location.href).href,document.body.appendChild(i)})})}load(s){var e=this._view3D;const n=this._loader,o=j(e,s);return at.setDecoderPath(e.dracoPath),ht.setTranscoderPath(e.ktxPath),C.meshoptDecoder&&n.setMeshoptDecoder(C.meshoptDecoder),n.manager=f.DefaultLoadingManager,new Promise((t,i)=>{try{n.load(s,e=>{e=this._parseToModel(e,s);t(e)},e=>this._onLoadingProgress(e,s,o),e=>{o.initialized=!0,i(e)})}catch(e){i(e)}})}loadFromFiles(a){const h=this._view3D,l=this._loader,c=[],_=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return at.setDecoderPath(h.dracoPath),ht.setTranscoderPath(h.ktxPath),C.meshoptDecoder&&l.setMeshoptDecoder(C.meshoptDecoder),new Promise((t,i)=>{if(a.length<=0)i(new Error("No files found"));else{const s=a.find(e=>/\.(gltf|glb)$/i.test(e.name));if(s){const n=new Map,o=(a.forEach(e=>{n.set(e.name,e)}),URL.createObjectURL(s)),e=(c.push(o),new f.LoadingManager),r=(e.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";return n.has(t)?(t=n.get(t),t=URL.createObjectURL(t),c.push(t),t):e}),j(h,o));l.manager=e,l.load(o,e=>{e=this._parseToModel(e,s.name);_(),t(e)},e=>this._onLoadingProgress(e,o,r),e=>{r.initialized=!0,_(),i(e)})}else i(new Error("No glTF file found"))}})}_parseToModel(n,e){const o=this._view3D;var t=o.fixSkinnedBbox;n.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const a=o.renderer.threeRenderer.capabilities.maxTextureSize,i=[],s=(n.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&i.push(e)})}),i.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[])),h=s.reduce((e,t)=>[...e,...pe.filter(e=>t[e]).map(e=>t[e])],[]),r=n.parser.associations,l=n.parser.json;var c=h.filter(e=>r.has(e)).map(e=>l.textures[r.get(e).textures]);const _=Array.from(new Set(c).values()).reduce((s,e,t)=>{var i=e.extensions&&e.extensions[me],n=e.extras&&e.extras[ve];if(i||n){const o=h[t],r=(i?e.extensions[me]:e.extras[ve]).levels;r.forEach(({index:e,size:t},i)=>{t>a||(s[i]||(s[i]=[]),s[i].push({index:e,texture:o}))})}return s},[]),d=_.map(()=>!1),u=(_.forEach((s,i)=>K(this,void 0,void 0,function*(){const e=yield Promise.all(s.map(({index:e})=>n.parser.getDependency("texture",e)));var t=d.slice(i+1).some(e=>!!e);d[i]=!0,t||e.forEach((e,t)=>{const i=s[t].texture;i.image=e.image,i.needsUpdate=!0,o.renderer.renderSingleFrame()})})),[]);return n.parser.json.extras&&n.parser.json.extras[Ee]&&(c=n.parser.json.extras[Ee],u.push(...o.annotation.parse(c))),new rt({src:e,scenes:n.scenes,annotations:u,animations:n.animations,fixSkinnedBbox:t})}}class lt extends e{constructor(e,{src:t=null,iosSrc:i=null,dracoPath:s="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:n="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:o=null,fixSkinnedBbox:r=!1,fov:a=Q,center:h=Q,yaw:l=0,pitch:c=0,initialZoom:_=0,rotate:d=!0,translate:u=!0,zoom:p=!0,autoplay:m=!1,scrollable:v=!0,wheelScrollable:E=!1,useGrabCursor:g=!0,defaultAnimationIndex:T=0,skybox:w=null,envmap:b=null,background:O=null,exposure:f=1,shadow:S=!0,skyboxBlur:L=!1,toneMapping:A=he.LINEAR,useDefaultEnv:y=!0,animationRepeatMode:C=ce.ONE,annotationURL:R=null,annotationWrapper:x="."+$.ANNOTATION_WRAPPER,annotationSelector:M="."+$.ANNOTATION,annotationBreakpoints:I=Oe,webAR:D=!0,sceneViewer:F=!0,quickLook:z=!0,arPriority:U=fe,poster:V=null,canvasSelector:B="canvas",autoInit:N=!0,autoResize:k=!0,useResizeObserver:H=!0,maintainSize:G=!1,on:W={},plugins:P=[],maxDeltaTime:j=1/30}={}){super(),this._rootEl=((e,t)=>{t=ee(e,t);if(t)return t;throw J(e)?new Y(X.ELEMENT_NOT_FOUND(e),Z.ELEMENT_NOT_FOUND):new Y(X.WRONG_TYPE(e,["HTMLElement","string"]),Z.WRONG_TYPE)})(e),this._src=t,this._iosSrc=i,this._dracoPath=s,this._ktxPath=n,this._meshoptPath=o,this._fixSkinnedBbox=r,this._fov=a,this._center=h,this._yaw=l,this._pitch=c,this._initialZoom=_,this._rotate=d,this._translate=u,this._zoom=p,this._autoplay=m,this._scrollable=v,this._wheelScrollable=E,this._useGrabCursor=g,this._defaultAnimationIndex=T,this._skybox=w,this._envmap=b,this._background=O,this._exposure=f,this._shadow=S,this._skyboxBlur=L,this._toneMapping=A,this._useDefaultEnv=y,this._animationRepeatMode=C,this._annotationURL=R,this._annotationWrapper=x,this._annotationSelector=M,this._annotationBreakpoints=I,this._webAR=D,this._sceneViewer=F,this._quickLook=z,this._arPriority=U,this._poster=V,this._canvasSelector=B,this._autoInit=N,this._autoResize=k,this._useResizeObserver=H,this._maintainSize=G,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=P,this._maxDeltaTime=j,this._renderer=new _e(this),this._camera=new Le(this),this._control=new nt(this),this._scene=new Te(this),this._animator=new ye(this),this._autoPlayer=new ot(this,q(m)),this._autoResizer=new Ae(this),this._arManager=new Ke(this),this._annotationManager=new et(this),this._addEventHandlers(W),this._addPosterImage(),K(this,void 0,void 0,function*(){yield this._initPlugins(P),t&&N&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get annotation(){return this._annotationManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get useDefaultEnv(){return this._useDefaultEnv}get defaultAnimationIndex(){return this._defaultAnimationIndex}get animationRepeatMode(){return this._animationRepeatMode}get annotationURL(){return this._annotationURL}get annotationWrapper(){return this._annotationWrapper}get annotationSelector(){return this._annotationSelector}get annotationBreakpoints(){return this._annotationBreakpoints}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set defaultAnimationIndex(e){this._defaultAnimationIndex=e}set initialZoom(e){this._initialZoom=e}set skybox(e){this._scene.setSkybox(e),!(this._skybox=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set envmap(e){this._scene.setEnvMap(e),!(this._envmap=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set exposure(e){this._exposure=e,this._renderer.threeRenderer.toneMappingExposure=e,this._renderer.renderSingleFrame()}set skyboxBlur(e){this._skyboxBlur=e;var t=this._scene;const i=t.root;t=t.root.environment;t&&null!==i.background&&(i.background=e?b.createBlurredHDR(this,t):t)}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e,this._renderer.renderSingleFrame()}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set animationRepeatMode(e){this._animationRepeatMode=e,this._animator.updateRepeatMode()}set autoResize(e){(this._autoResize=e)?this._autoResizer.enable():this._autoResizer.disable()}set maintainSize(e){this._maintainSize=e}set maxDeltaTime(e){this._maxDeltaTime=e}destroy(){this._scene.reset(),this._renderer.destroy(),this._control.destroy(),this._autoResizer.disable(),this._animator.destroy(),this._annotationManager.destroy(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return K(this,void 0,void 0,function*(){if(!this._src)throw new Y(X.PROVIDE_SRC_FIRST,Z.PROVIDE_SRC_FIRST);const e=this._scene,t=this._renderer,i=this._control,s=this._animator,n=this._annotationManager;var o=this._meshoptPath;const r=[];this.resize(),s.init(),n.init(),this._autoResize&&this._autoResizer.enable(),o&&!C.meshoptDecoder&&(yield C.setMeshoptDecoder(o)),r.push(...e.initTextures());o=this._loadModel(this._src);r.push(...o),this._resetLoadingContextOnFinish(r),yield Promise.race(o),this._annotationURL&&(yield this._annotationManager.load(this._annotationURL)),i.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),t.renderSingleFrame(),this._initialized=!0,this.trigger(T.READY,{type:T.READY,target:this})})}resize(){const e=this._renderer;var t=this._initialized?e.size:null,i=(e.resize(),e.size);this._camera.resize(i,t),this._control.resize(i),this._annotationManager.resize(),e.renderSingleFrame(!0),this.trigger(T.RESIZE,Object.assign(Object.assign({},i),{type:T.RESIZE,target:this}))}load(t){return K(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t):(this._src=t,yield this.init())})}display(e,{resetCamera:t=!0}={}){const i=this._renderer,s=this._scene,n=this._camera,o=this._animator,r=this._annotationManager;var a=i.threeRenderer.xr.isPresenting;if(s.reset(),s.add(e.scene),s.shadowPlane.updateDimensions(e),t&&(n.fit(e,this._center),n.reset(0)),o.reset(),o.setClips(e.animations),0<e.animations.length&&o.play(this._defaultAnimationIndex),r.reset(),r.collect(),r.add(...e.annotations),this._model=e,a){const h=this._arManager.activeSession;h&&h.control.syncTargetModel(e)}i.renderSingleFrame(),this.trigger(T.MODEL_CHANGE,{type:T.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return K(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return K(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var i=t.toDataURL("png");const s=document.createElement("a");s.href=i,s.download=e,s.click()}_loadModel(e){const i=new C(this);if(Array.isArray(e)){const s=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(i,e,t,s))}return[this._loadSingleModel(i,e,0,[!1])]}_loadSingleModel(n,o,r,a){return K(this,void 0,void 0,function*(){var t=a.length-1;this.trigger(T.LOAD_START,{type:T.LOAD_START,target:this,src:o,level:r,maxLevel:t});try{var e=yield n.load(o),i=a.slice(r+1).some(e=>!!e),s=a.some(e=>!!e);this.trigger(T.LOAD,{type:T.LOAD,target:this,model:e,level:r,maxLevel:t}),a[r]=!0,i||this.display(e,{resetCamera:!s})}catch(e){throw this.trigger(T.LOAD_ERROR,{type:T.LOAD_ERROR,target:this,level:r,maxLevel:t,error:e}),new Y(X.MODEL_FAIL_TO_LOAD(o),Z.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const i=this._rootEl;if(t){var s=V(t);let e;if(s||(e=>{if(!J(e))return!1;const t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0})(t)){s=s?t:i.querySelector(t);if(!s)throw new Y(X.ELEMENT_NOT_FOUND(t),Z.ELEMENT_NOT_FOUND);e=s}else{const n=document.createElement("img");n.className=$.POSTER,n.src=t,i.appendChild(n),e=n,this.once(T.READY,()=>{n.parentElement===i&&i.removeChild(n)})}this.once(T.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return K(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return K(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(T.LOAD_FINISH,{type:T.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}lt.VERSION="2.6.1-snapshot";class ct{constructor({className:e={},showPlaneDetection:t=!0,toastText:i="Point your device downwards to find the ground and move it around."}={}){this.className=e,this.showPlaneDetection=t,this.toastText=i,this._createElements()}init(h){return K(this,void 0,void 0,function*(){const n=this._rootEl,o=this._detectionRootEl,r=this._closeButtonEl,a=Object.assign(Object.assign({},ct.DEFAULT_CLASS),this.className);h.on(T.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){t.appendChild(n);const i=()=>{e.exit()},s=(null!==o&&void 0!==o&&o.classList.add(a.DETECTION_VISIBLE),()=>{null!==o&&void 0!==o&&o.classList.remove(a.DETECTION_VISIBLE)});h.once(T.AR_MODEL_PLACED,s),r.addEventListener(u.CLICK,i),h.once(T.AR_END,()=>{n.parentElement&&n.parentElement.removeChild(n),r.removeEventListener(u.CLICK,i),h.off(T.AR_MODEL_PLACED,s)})}})})}teardown(){}_createElements(){var e=Object.assign(Object.assign({},ct.DEFAULT_CLASS),this.className);const t=document.createElement(g),i=document.createElement(g);i.classList.add(e.CLOSE_BUTTON),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',t.classList.add(e.ROOT),t.appendChild(i),this.showPlaneDetection&&(this._detectionRootEl=this._createPlaneDetectionElements(),t.appendChild(this._detectionRootEl)),this._rootEl=t,this._closeButtonEl=i}_createPlaneDetectionElements(){const t=Object.assign(Object.assign({},ct.DEFAULT_CLASS),this.className),e=document.createElement(g),i=document.createElement(g),s=document.createElement(g),n=document.createElement(g),o=document.createElement(g),r=document.createElement(g),a=B(5).map(()=>document.createElement(g));return e.classList.add(t.DETECTION_ROOT),i.classList.add(t.DETECTION_ICON),s.classList.add(t.DETECTION_TOAST),n.classList.add(t.DETECTION_PHONE),o.classList.add(t.DETECTION_CUBE),r.classList.add(t.DETECTION_PLANE),s.innerHTML=this.toastText,a.forEach(e=>{e.classList.add(t.DETECTION_CUBE_FACE),o.appendChild(e)}),i.appendChild(n),i.appendChild(o),i.appendChild(r),e.appendChild(i),e.appendChild(s),e}}ct.DEFAULT_CLASS={ROOT:"view3d-ar-root",CLOSE_BUTTON:"view3d-ar-close",DETECTION_ROOT:"view3d-ar-detection",DETECTION_ICON:"view3d-ar-detection-icon",DETECTION_TOAST:"view3d-ar-detection-toast",DETECTION_PHONE:"view3d-ar-phone",DETECTION_CUBE:"view3d-ar-cube",DETECTION_CUBE_FACE:"view3d-ar-cube-face",DETECTION_PLANE:"view3d-ar-plane",DETECTION_VISIBLE:"visible"};class R{constructor(e={}){this._startLoading=({target:s,level:e})=>{if(0!==e)return;const{type:t=R.TYPE.DEFAULT,loadingLabel:i="Loading 3D Model...",parsingLabel:n="Parsing 3D Model...",labelColor:o="#ffffff",barWidth:r="70%",barHeight:a="10px",barBackground:h="#bbbbbb",barForeground:l="#3e8ed0",spinnerWidth:c="30%",overlayBackground:_="rgba(0, 0, 0, 0.3)"}=this._options,d=document.createElement(g),u=document.createElement(g),p=document.createElement(g),m=document.createElement(g),v=document.createElement(g);e=Object.assign(Object.assign({},this._options.className),R.DEFAULT_CLASS);if(d.classList.add(e.OVERLAY),u.classList.add(e.WRAPPER),m.classList.add(e.BASE),p.classList.add(e.LABEL),v.classList.add(e.FILLER),d.style.backgroundColor=_,t!==R.TYPE.SPINNER?(m.style.height=a,m.style.backgroundColor=h,v.style.backgroundColor=l):(m.classList.add(e.TYPE_SPINNER),m.style.width=c,m.style.paddingTop=c,v.style.borderWidth=a,v.style.borderColor=l,v.style.borderLeftColor="transparent"),t===R.TYPE.TOP?d.classList.add(e.TYPE_TOP):t===R.TYPE.DEFAULT&&(m.style.width=r),p.style.color=o,p.innerText=i,m.appendChild(v),u.appendChild(m),u.appendChild(p),d.appendChild(u),s.rootEl.appendChild(d),t!==R.TYPE.SPINNER){const E=()=>{if(s.loadingContext.every(e=>e.initialized)){var[e,t]=s.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]);if(!(t<=0)){const i=e/t*100;v.style.width=i.toFixed(2)+"%",e===t&&(p.innerText=n)}}};s.on(T.PROGRESS,E),s.once(T.LOAD_FINISH,()=>{s.off(T.PROGRESS,E)})}s.once(T.LOAD_FINISH,()=>{this._removeOverlay(s)}),this._overlay=d},this._options=e}init(e){return K(this,void 0,void 0,function*(){e.on(T.LOAD_START,this._startLoading)})}teardown(e){e.off(T.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}R.DEFAULT_CLASS={OVERLAY:"view3d-lb-overlay",WRAPPER:"view3d-lb-wrapper",BASE:"view3d-lb-base",LABEL:"view3d-lb-label",FILLER:"view3d-lb-filler",TYPE_SPINNER:"is-spinner",TYPE_TOP:"is-top"},R.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};class _t{constructor(e,t,{position:i=x.POSITION.TOP,order:s=9999}={}){this._onResize=()=>{this._rootBbox=this._trackEl.getBoundingClientRect()},this._onRender=({target:e})=>{var e=e.animator,t=e.activeAnimationIndex,i=e.activeAnimation,e=e.actions[t];i&&e&&(t=e.time/i.duration,this._fill(t))},this._onMouseDown=e=>{if(e.button===a.LEFT){var t=this._view3D.animator,i=t.activeAnimationIndex;const s=t.actions[i];e.preventDefault(),window.addEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(u.MOUSE_UP,this._onMouseUp,!1),this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._origTimeScale=s.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX)}},this._onMouseMove=e=>{e.preventDefault(),this._updateAnimationProgress(e.pageX)},this._onMouseUp=()=>{window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)},this._onTouchStart=e=>{if(!(1<e.touches.length)){var e=e.touches[0],t=this._view3D.animator,i=t.activeAnimationIndex;const s=t.actions[i];this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._firstTouch={x:e.pageX,y:e.pageY},this._origTimeScale=s.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX)}},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable,s=this._firstTouch;if(s){if(i){i=new f.Vector2(t.pageX,t.pageY).sub(new f.Vector2(s.x,s.y));if(Math.abs(i.y)>Math.abs(i.x))return this._scrolling=!0,void this._release()}this._firstTouch=null}e.cancelable&&e.preventDefault(),e.stopPropagation(),this._setAnimationTimeScale(0),this._updateAnimationProgress(t.pageX)}},this._onTouchEnd=e=>{0<e.touches.length||(this._release(),this._scrolling=!1)},this._updateAnimationProgress=e=>{const t=this._view3D;var i=this._rootBbox;const s=this._thumbEl;var n=t.animator,o=n.activeAnimationIndex,r=n.activeAnimation;const a=n.actions[o];r&&a&&(n=(e-i.x)/i.width,o=_(n,0,1)*r.duration,a.time=o,e=Math.floor(o),i=Math.floor(100*(o-e)),n=e=>""+"0".repeat(Math.max(2-e.toString().length,0))+e,s.setAttribute("data-time",n(e)+":"+n(i)),t.renderer.renderSingleFrame())},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1,this._firstTouch=null,this._scrolling=!1,this._origTimeScale=1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){const e=this._view3D;this._enabled||(this._rootBbox=this._trackEl.getBoundingClientRect(),this._enabled=!0,e.on(T.RESIZE,this._onResize),e.on(T.RENDER,this._onRender),this._fill(0),this.enableInput())}disable(){const e=this._view3D;this._enabled&&(this._enabled=!1,e.off(T.RESIZE,this._onResize),e.off(T.RENDER,this._onRender),this.disableInput())}enableInput(){const e=this._rootEl;var t=this._view3D;this._firstTouch=null,this._scrolling=!1,t.animator.animationCount<=0||(e.addEventListener(u.MOUSE_DOWN,this._onMouseDown),e.addEventListener(u.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(u.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(u.TOUCH_END,this._onTouchEnd))}disableInput(){const e=this._rootEl;e.removeEventListener(u.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(u.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(u.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(u.TOUCH_START,this._onTouchStart),e.removeEventListener(u.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(u.TOUCH_END,this._onTouchEnd)}_createElements(){var e=this._controlBar,e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);const t=document.createElement(g),i=(t.classList.add(e.PROGRESS_ROOT),t.draggable=!1,document.createElement(g)),s=(i.classList.add(e.PROGRESS_TRACK),document.createElement(g)),n=(s.classList.add(e.PROGRESS_THUMB),document.createElement(g));n.classList.add(e.PROGRESS_FILLER),i.appendChild(n),i.appendChild(s),t.appendChild(i),this._rootEl=t,this._trackEl=i,this._thumbEl=s,this._fillerEl=n}_fill(e){this._fillerEl.style.width=100*e+"%",this._thumbEl.style.transform=`translateX(${e*this._rootBbox.width}px)`}_release(){this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)}_showThumb(){const e=this._thumbEl;var t=this._controlBar,t=Object.assign(Object.assign({},t.className),x.DEFAULT_CLASS);e.classList.add(t.VISIBLE)}_hideThumb(){const e=this._thumbEl;var t=this._controlBar,t=Object.assign(Object.assign({},t.className),x.DEFAULT_CLASS);e.classList.remove(t.VISIBLE)}_setAnimationTimeScale(e){var t=this._view3D.animator,i=t.activeAnimationIndex,s=t.activeAnimation;const n=t.actions[i];s&&n&&n.setEffectiveTimeScale(e)}}var dt='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M16 37.85V9.85L38 23.85Z"/></svg>';class ut{constructor(e,t,{position:i=x.POSITION.LEFT,order:s=9999}={}){this._updateIcon=()=>{var e=this._view3D;e.animator.paused!==this._paused&&(this._paused=e.animator.paused,this._element.innerHTML=this._paused?dt:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M28.25 38V10H36V38ZM12 38V10H19.75V38Z"/></svg>')},this._onClick=()=>{const e=this._view3D.animator;e.paused?e.resume():e.pause(),this._updateIcon()},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1,this._paused=!0}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.on(T.RENDER,this._updateIcon),this._element.addEventListener(u.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(T.RENDER,this._updateIcon),this._element.removeEventListener(u.CLICK,this._onClick),this._enabled=!1)}_createButton(e){const t=document.createElement(re);e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML=dt,t}}class pt{constructor(e,t,{position:i=x.POSITION.LEFT,order:s=9999}={}){this._updateAnimations=()=>{var e=this._view3D,t=this._controlBar;const n=e.animator,i=this._rootEl,s=this._nameEl,o=this._itemListEl,r=n.clips,a=Object.assign(Object.assign({},t.className),x.DEFAULT_CLASS);for(;o.firstChild;)o.removeChild(o.firstChild);if(r.length<=0)i.classList.add(a.DISABLED);else{i.classList.remove(a.DISABLED);const h=r.map(e=>{const t=document.createElement(g);return t.classList.add(a.ANIMATION_ITEM),t.innerHTML=e.name,t}),l=(e,t)=>{h[t].classList.add(a.ANIMATION_SELECTED),s.innerHTML=e.name};r.forEach((i,s)=>{const e=h[s];s===n.activeAnimationIndex&&l(i,s),e.addEventListener(u.CLICK,e=>{var t=n.paused;n.play(s),t&&n.pause(),h.forEach(e=>{e.classList.remove(a.ANIMATION_SELECTED)}),l(i,s),this._hideList(),e.stopPropagation()}),o.appendChild(e)})}},this._toggleList=e=>{var t=this._controlBar;const i=this._itemListEl;t=Object.assign(Object.assign({},t.className),x.DEFAULT_CLASS);i.classList.toggle(t.VISIBLE),i.classList.contains(t.VISIBLE)&&this._view3D.rootEl.addEventListener(u.CLICK,this._hideList),e.stopPropagation()},this._hideList=()=>{var e=this._controlBar;const t=this._itemListEl;e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);t.classList.contains(e.VISIBLE)&&t.classList.remove(e.VISIBLE)},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.initialized&&this._updateAnimations(),this._view3D.on(T.MODEL_CHANGE,this._updateAnimations),this._nameEl.addEventListener(u.CLICK,this._toggleList),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(T.MODEL_CHANGE,this._updateAnimations),this._view3D.rootEl.removeEventListener(u.CLICK,this._hideList),this._nameEl.removeEventListener(u.CLICK,this._toggleList),this._enabled=!1)}_createElements(){var e=this._controlBar;const t=document.createElement(g),i=document.createElement(g),s=document.createElement(g);e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);t.classList.add(e.CONTROLS_ITEM),t.classList.add(e.DISABLED),i.classList.add(e.ANIMATION_NAME),s.classList.add(e.ANIMATION_LIST),t.appendChild(i),t.appendChild(s),this._rootEl=t,this._nameEl=i,this._itemListEl=s}}const mt=["requestFullscreen","webkitRequestFullscreen","webkitRequestFullScreen","webkitCancelFullScreen","mozRequestFullScreen","msRequestFullscreen"],vt=["fullscreenElement","webkitFullscreenElement","webkitCurrentFullScreenElement","mozFullScreenElement","msFullscreenElement"],Et=["exitFullscreen","webkitExitFullscreen","webkitCancelFullScreen","mozCancelFullScreen","msExitFullscreen"];class gt{constructor(e,t,{position:i=x.POSITION.RIGHT,order:s=9999}={}){this._onClick=()=>{var e=this._view3D.rootEl;this._isFullscreen()?this._exitFullscreen():this._requestFullscreen(e)},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(u.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(u.CLICK,this._onClick),this._enabled=!1)}_isFullscreen(){if(document)for(const e of vt)if(document[e])return!0;return!1}_requestFullscreen(e){for(const t of mt){const i=e[t];i&&i.call(e)}}_exitFullscreen(){for(const e of Et){const t=document[e];t&&t.call(document)}}_createButton(e){const t=document.createElement(re);e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M10 38v-9.65h3V35h6.65v3Zm0-18.35V10h9.65v3H13v6.65ZM28.35 38v-3H35v-6.65h3V38ZM35 19.65V13h-6.65v-3H38v9.65Z"/></svg>',t}}class Tt{constructor(e,t,{axisWidth:i=5,font:s="14px sans-serif",xAxisColor:n="#ef2746",yAxisColor:o="#a7c031",zAxisColor:r="#6571a6"}={}){this._onRender=()=>{var e=this._view3D;const h=this._ctx;var t=this._canvasSize;const i=e.camera.threeCamera;if(h&&e.model){h.clearRect(0,0,t.x,t.y);const s=i.quaternion.clone(),n=(s.invert(),new f.Vector3(1,0,0).applyQuaternion(s)),o=new f.Vector3(0,1,0).applyQuaternion(s),r=new f.Vector3(0,0,1).applyQuaternion(s),l=new f.Vector2(.5,.5).multiply(t),a=(h.lineCap="round",h.lineWidth=this.axisWidth,new f.Color(this.xAxisColor)),c=new f.Color(this.yAxisColor),_=new f.Color(this.zAxisColor),d=[{idx:0,axis:"X",color:a,pos:n,negative:!1},{idx:1,axis:"Y",color:c,pos:o,negative:!1},{idx:2,axis:"Z",color:_,pos:r,negative:!1},{idx:3,axis:"X",color:a,pos:n.clone().negate(),negative:!0},{idx:4,axis:"Y",color:c,pos:o.clone().negate(),negative:!0},{idx:5,axis:"Z",color:_,pos:r.clone().negate(),negative:!0}].sort((e,t)=>e.pos.z-t.pos.z);d.forEach(({axis:e,pos:t,color:i,negative:s,idx:n},o)=>{var r=this._getScreenPos(t),t=0<=t.z?1:.6,i=this._getColorRGBAString(i,t);s||(h.strokeStyle=i,h.beginPath(),h.moveTo(l.x,l.y),h.lineTo(r.x,r.y),h.stroke(),h.globalCompositeOperation="destination-out",h.fillStyle="white",h.beginPath(),h.ellipse(r.x,r.y,10,10,0,0,2*Math.PI),h.fill(),h.globalCompositeOperation="source-over"),h.fillStyle=i,h.beginPath(),h.ellipse(r.x,r.y,10,10,0,0,2*Math.PI),h.fill(),s||(h.font=this.font,h.fillStyle="white",h.textAlign="center",h.textBaseline="middle",h.fillText(e,r.x,r.y));const a=this._axisEls[n];a.style.left=r.x+"px",a.style.top=r.y+"px",a.style.zIndex=o.toString()})}},this.axisWidth=i,this.font=s,this.xAxisColor=n,this.yAxisColor=o,this.zAxisColor=r,this._view3D=e,this._createElement(t),this._ctx=this._canvasEl.getContext("2d"),this._enabled=!1,this._canvasSize=new f.Vector2}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){if(!this._enabled&&this._ctx){var e=this._rootEl;const t=this._canvasEl,s=this._view3D,n=(this._enabled=!0,s.rootEl.appendChild(e),s.on(T.RENDER,this._onRender),this._canvasSize.set(t.clientWidth,t.clientHeight),t.width=this._canvasSize.x,t.height=this._canvasSize.y,[new A(-90,0,0),new A(0,90,0),new A(0,0,0),new A(90,0,0),new A(0,-90,0),new A(180,0,0)]);n.forEach(e=>{e.pivot.copy(s.camera.defaultPose.pivot)}),this._axisClickListeners=this._axisEls.map((e,t)=>{const i=n[t];t=()=>{s.camera.reset(300,O,i)};return e.addEventListener(u.CLICK,t),t})}}disable(){if(this._enabled){this._enabled=!1;const t=this._view3D.rootEl;var e=this._rootEl;e&&e.parentElement===t&&t.removeChild(e),this._view3D.off(T.RENDER,this._onRender),this._axisEls.forEach((e,t)=>{t=this._axisClickListeners[t];e.removeEventListener(u.CLICK,t)}),this._axisClickListeners=[]}}_createElement(e){const t=document.createElement(g);var i=document.createElement("canvas");const s=B(6).map(()=>document.createElement(g)),n=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);t.classList.add(n.GIZMO_ROOT),t.appendChild(i),s.forEach(e=>{e.classList.add(n.GIZMO_AXIS),t.appendChild(e)}),this._rootEl=t,this._canvasEl=i,this._axisEls=s}_getScreenPos(e){var t=this._canvasSize;return new f.Vector2(e.x,-e.y).multiplyScalar(.8).addScalar(1).multiplyScalar(.5).multiply(t)}_getColorRGBAString(e,t){return`rgba(${Math.floor(255*e.r)},${Math.floor(255*e.g)},${Math.floor(255*e.b)},${t})`}}class wt{constructor(e,t,{position:i=x.POSITION.RIGHT,order:s=9999,duration:n=500}={}){this._onClick=()=>{this._view3D.camera.reset(this.duration)},this.position=i,this.order=s,this.duration=n,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(u.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(u.CLICK,this._onClick),this._enabled=!1)}_createButton(e){const t=document.createElement(re);e=Object.assign(Object.assign({},e.className),x.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M24 44q-3.75 0-7.025-1.4-3.275-1.4-5.725-3.85Q8.8 36.3 7.4 33.025 6 29.75 6 26h3q0 6.25 4.375 10.625T24 41q6.25 0 10.625-4.375T39 26q0-6.25-4.25-10.625T24.25 11H23.1l3.65 3.65-2.05 2.1-7.35-7.35 7.35-7.35 2.05 2.05-3.9 3.9H24q3.75 0 7.025 1.4 3.275 1.4 5.725 3.85 2.45 2.45 3.85 5.725Q42 22.25 42 26q0 3.75-1.4 7.025-1.4 3.275-3.85 5.725-2.45 2.45-5.725 3.85Q27.75 44 24 44Z"/></svg>',t}}class x{constructor({autoHide:e=!0,className:t={},progressBar:i=!0,playButton:s=!0,animationSelector:n=!0,fullscreenButton:o=!0,navigationGizmo:r=!0,cameraResetButton:a=!0}={}){this.show=()=>{const e=this._rootEl;var t=Object.assign(Object.assign({},x.DEFAULT_CLASS),this.className);e.classList.add(t.VISIBLE)},this.hide=()=>{const e=this._rootEl;var t=Object.assign(Object.assign({},x.DEFAULT_CLASS),this.className);e.classList.remove(t.VISIBLE)},this._updateModelParams=()=>{this._items.forEach(e=>{e.disable(),e.enable()})},this._hideAfterDelay=()=>{var{delay:e=0}=q(this.autoHide);this._autoHideTimer&&(window.clearTimeout(this._autoHideTimer),this._autoHideTimer=-1),e<=0?this.hide():this._autoHideTimer=window.setTimeout(this.hide,e)},this.autoHide=e,this.className=t,this.progressBar=i,this.playButton=s,this.animationSelector=n,this.fullscreenButton=o,this.navigationGizmo=r,this.cameraResetButton=a,this._items=[],this._initElements(),this._autoHideTimer=-1}get rootEl(){return this._rootEl}get items(){return this._items}init(e){return K(this,void 0,void 0,function*(){this._attachElements(e),e.model&&this._updateModelParams(),this._items=this._createDefaultItems(e),this._addItemElements(),this._items.forEach(e=>{e.enable()}),e.on(T.MODEL_CHANGE,this._updateModelParams),this.show(),this._setupAutoHide(e)})}teardown(e){const t=e.rootEl;t.removeEventListener(u.POINTER_ENTER,this.show),t.removeEventListener(u.POINTER_LEAVE,this._hideAfterDelay),this._removeElements(e),this._items.forEach(e=>{e.disable()}),this._items=[],e.off(T.MODEL_CHANGE,this._updateModelParams),window.clearTimeout(this._autoHideTimer)}_initElements(){var e=Object.assign(Object.assign({},x.DEFAULT_CLASS),this.className);const t=document.createElement(g),i=(t.classList.add(e.ROOT),this._rootEl=t,document.createElement(g)),s=(i.classList.add(e.CONTROLS_BG),t.appendChild(i),document.createElement(g)),n=document.createElement(g),o=document.createElement(g),r=document.createElement(g);s.classList.add(e.CONTROLS_TOP),n.classList.add(e.CONTROLS_SIDE),o.classList.add(e.CONTROLS_LEFT),r.classList.add(e.CONTROLS_RIGHT),t.appendChild(s),n.appendChild(o),n.appendChild(r),t.appendChild(n),this._topControlsWrapper=s,this._leftControlsWrapper=o,this._rightControlsWrapper=r}_addItemElements(){var e=this._topControlsWrapper,t=this._leftControlsWrapper,i=this._rightControlsWrapper;const s=this._items.filter(e=>e.position&&null!=e.order),n={[x.POSITION.TOP]:{parentEl:e,items:[]},[x.POSITION.LEFT]:{parentEl:t,items:[]},[x.POSITION.RIGHT]:{parentEl:i,items:[]}};s.forEach(e=>{n[e.position].items.push(e)}),Object.keys(n).forEach(e=>{const{parentEl:t,items:i}=n[e];i.sort((e,t)=>e.order-t.order),i.forEach(e=>{t.appendChild(e.element)})})}_attachElements(e){e.rootEl.appendChild(this._rootEl)}_removeElements(e){var t=this._rootEl;const i=this._topControlsWrapper,s=this._leftControlsWrapper,n=this._rightControlsWrapper;[i,s,n].forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)}),t.parentElement===e.rootEl&&e.rootEl.removeChild(t)}_setupAutoHide(e){if(this.autoHide){var{initialDelay:t=3e3}=q(this.autoHide);const i=e.rootEl;this._autoHideTimer=window.setTimeout(()=>{this.hide()},t),i.addEventListener(u.POINTER_ENTER,this.show),i.addEventListener(u.POINTER_LEAVE,this._hideAfterDelay)}}_createDefaultItems(e){const t=[];return this.progressBar&&t.push(new _t(e,this,q(this.progressBar))),this.playButton&&t.push(new ut(e,this,q(this.playButton))),this.animationSelector&&t.push(new pt(e,this,q(this.animationSelector))),this.cameraResetButton&&t.push(new wt(e,this,q(this.cameraResetButton))),this.fullscreenButton&&t.push(new gt(e,this,q(this.fullscreenButton))),this.navigationGizmo&&t.push(new Tt(e,this,q(this.navigationGizmo))),t}}x.DEFAULT_CLASS={ROOT:"view3d-control-bar",VISIBLE:"visible",DISABLED:"disabled",CONTROLS_BG:"view3d-controls-background",CONTROLS_SIDE:"view3d-side-controls",CONTROLS_TOP:"view3d-top-controls",CONTROLS_LEFT:"view3d-left-controls",CONTROLS_RIGHT:"view3d-right-controls",CONTROLS_ITEM:"view3d-control-item",PROGRESS_ROOT:"view3d-progress-bar",PROGRESS_TRACK:"view3d-progress-track",PROGRESS_THUMB:"view3d-progress-thumb",PROGRESS_FILLER:"view3d-progress-filler",ANIMATION_NAME:"view3d-animation-name",ANIMATION_LIST:"view3d-animation-list",ANIMATION_ITEM:"view3d-animation-item",ANIMATION_SELECTED:"selected",GIZMO_ROOT:"view3d-gizmo",GIZMO_AXIS:"view3d-gizmo-axis"},x.POSITION={TOP:"top",LEFT:"left",RIGHT:"right"};var i={__proto__:null,default:lt,Animation:Ce,ARManager:Ke,AutoPlayer:ot,AutoResizer:Ae,Camera:Le,Model:rt,ModelAnimator:ye,Motion:L,Pose:A,Renderer:_e,Scene:Te,ShadowPlane:ge,Skybox:b,View3DError:Y,Annotation:Qe,PointAnnotation:$e,FaceAnnotation:Je,AnnotationManager:et,AnimationControl:Se,OrbitControl:nt,RotateControl:tt,TranslateControl:it,ZoomControl:st,Loader:de,GLTFLoader:C,TextureLoader:ue,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return K(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return K(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:i="view3d-ar-button",tooltipClass:s="view3d-tooltip"}=this._options;const n=yield a.ar.isAvailable(),o=document.createElement(re),r=document.createElement(g);e=document.createTextNode(n?e:t);o.classList.add(i),r.classList.add(s),o.disabled=!0,o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',o.appendChild(r),r.appendChild(e),a.rootEl.appendChild(o),this._button=o,a.initialized?yield this._setAvailable(a,o,n):a.once(T.MODEL_CHANGE,()=>{this._setAvailable(a,o,n)})})}_setAvailable(e,t,i){return K(this,void 0,void 0,function*(){i?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:ct,LoadingBar:R,ControlBar:x,AnimationProgressBar:_t,AnimationSelector:pt,FullscreenButton:gt,PlayButton:ut,NavigationGizmo:Tt,ARScene:He,WebARSession:Ye,SceneViewerSession:Ze,QuickLookSession:Xe,DOMOverlay:Ge,HitTest:We,LightEstimation:je,AUTO:Q,EVENTS:T,EASING:ae,DEFAULT_CLASS:$,TONE_MAPPING:he,ZOOM_TYPE:p,AR_SESSION_TYPE:t,SCENE_VIEWER_MODE:le,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},INPUT_TYPE:E,ANIMATION_REPEAT_MODE:ce,ERROR_CODES:z,isAvailable:({webGL:e=!0,fetch:t=!0,stream:i=!0,wasm:s=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(i&&!(window&&window.ReadableStream))return!1;if(s&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0},withMethods:(n,o)=>{[e.prototype,lt.prototype].forEach(s=>{Object.getOwnPropertyNames(s).filter(e=>"_"!==e.charAt(0)&&"constructor"!==e).forEach(e=>{const i=Object.getOwnPropertyDescriptor(s,e);if(i.value)Object.defineProperty(n,e,{value:function(...e){return i.value.call(this[o],...e)}});else{const t={};i.get&&(t.get=function(){var e;return null==(e=i.get)?void 0:e.call(this[o])}),i.set&&(t.set=function(...e){var t;return null==(t=i.set)?void 0:t.call(this[o],...e)}),Object.defineProperty(n,e,t)}})})},getValidProps:i=>Object.keys(i).reduce((e,t)=>(null!=i[t]&&(e[t]=i[t]),e),{})};return H(lt,i),lt});
