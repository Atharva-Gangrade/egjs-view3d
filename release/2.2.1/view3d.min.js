/*
Copyright (c) 2020-present NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.2.1
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/shaders/HorizontalBlurShader"),require("three/examples/jsm/shaders/VerticalBlurShader"),require("three/examples/jsm/lights/LightProbeGenerator"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader")):"function"==typeof define&&define.amd?define(["three","@egjs/component","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/shaders/HorizontalBlurShader","three/examples/jsm/shaders/VerticalBlurShader","three/examples/jsm/lights/LightProbeGenerator","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader"],t):(e=e||self).View3D=t(e.THREE,e.Component,e.RGBELoader,e.HorizontalBlurShader,e.VerticalBlurShader,e.LightProbeGenerator,e.GLTFLoader,e.DRACOLoader,e.KTX2Loader)}(this,function(T,e,n,a,h,c,s,t,i){"use strict";class V extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,V.prototype),this.name="View3DError",this.code=t}}var r={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,PROVIDE_WIDTH_OR_HEIGHT:5,FORMAT_NOT_SUPPORTED:6,FILE_NOT_SUPPORTED:7,NOT_INITIALIZED:8,MODEL_FAIL_TO_LOAD:9},U=r,k={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',PROVIDE_WIDTH_OR_HEIGHT:"Either width or height should be given.",FORMAT_NOT_SUPPORTED:e=>`Given format "${e}" is not supported or invalid.`,FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const o=e=>"string"==typeof e,l=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,B=(e,t)=>{let s=null;if(o(e)){const i=t||document;t=i.querySelector(e);if(!t)throw new V(k.ELEMENT_NOT_FOUND(e),U.ELEMENT_NOT_FOUND);s=t}else l(e)&&(s=e);return s},_=e=>e*Math.PI/180,d=(e,t,s)=>Math.max(Math.min(e,s),t),u=(e,t,s)=>e*(1-s)+t*s,p=(e,t,s)=>{var i=Math.abs(s-t);return e<t?e=s-(t-e)%i:s<e&&(e=t+(e-s)%i),e},v=(i,...e)=>(e.forEach(s=>{Object.keys(s).forEach(e=>{var t=s[e];Array.isArray(i[e])&&Array.isArray(t)?i[e]=[...i[e],...t]:i[e]=t})}),i),G=e=>"object"==typeof e?e:{},m=e=>e?"true":"false",g=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t};function H(e,n,a,h){return new(a=a||Promise)(function(s,t){function i(e){try{o(h.next(e))}catch(e){t(e)}}function r(e){try{o(h.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,r)}o((h=h.apply(e,n||[])).next())})}const W="auto",w={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",QUICK_LOOK_TAP:"quickLookTap",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced"},E={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,s=2.75;return e<1/s?t*e*e:e<2/s?t*(e-=1.5/s)*e+.75:e<2.5/s?t*(e-=2.25/s)*e+.9375:t*(e-=2.625/s)*e+.984375}},b={POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay"},j={LINEAR:T.LinearToneMapping,REINHARD:T.ReinhardToneMapping,CINEON:T.CineonToneMapping,ACES_FILMIC:T.ACESFilmicToneMapping};var f={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const y={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var O,R,M,S,x;class Y{constructor(e){this._defaultRenderLoop=e=>{const t=this._view3D,s=this._renderer,{scene:i,camera:r,control:o,autoPlayer:n,animator:a}=t;var h=1e3*e;a.update(e),o.update(h),n.update(h),t.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:t,delta:h}),r.updatePosition(),s.autoClear=!1,s.clear(),i.skybox&&i.skybox.enabled&&(i.skybox.updateCamera(),s.render(i.skybox.scene,i.skybox.camera)),i.shadowPlane.render(),s.render(i.root,r.threeCamera),s.autoClear=!0,t.trigger(w.RENDER,{type:w.RENDER,target:t,delta:h})},this._view3D=e,this._canvas=((e,t)=>{t=e.querySelector(t);if(!t)throw new V(k.CANVAS_NOT_FOUND,U.CANVAS_NOT_FOUND);return t})(e.rootEl,e.canvasSelector);const t=new T.WebGLRenderer({canvas:this._canvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!0});t.toneMapping=e.toneMapping,t.toneMappingExposure=e.exposure,t.outputEncoding=T.sRGBEncoding,t.setClearColor(0,0),this._renderer=t,this._clock=new T.Clock(!1)}get canvas(){return this._canvas}get context(){return this._renderer.context}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new T.Vector2);return{width:e.width,height:e.y}}resize(){const e=this._renderer;var t=this._canvas;e.xr.isPresenting||(e.setPixelRatio(window.devicePixelRatio),e.setSize(t.offsetWidth,t.offsetHeight,!1))}setAnimationLoop(i){const r=this._view3D,o=this._clock;o.start(),this._renderer.setAnimationLoop((e,t)=>{var s=Math.min(o.getDelta(),r.maxDeltaTime);i(s,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}}class C{constructor(e){this._onLoadingProgress=(e,t,s)=>{const i=this._view3D;s.initialized=!0,s.lengthComputable=e.lengthComputable,s.loaded=e.loaded,s.total=e.total,i.trigger(w.PROGRESS,{type:w.PROGRESS,target:i,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class P extends C{constructor(e){super(e)}load(r){const o=this._view3D;return new Promise((e,t)=>{const s=new T.TextureLoader,i=g(o,r);s.setCrossOrigin("anonymous"),s.load(r,e,e=>this._onLoadingProgress(e,r,i),e=>{i.initialized=!0,t(e)})})}loadHDRTexture(r){const o=this._view3D;return new Promise((t,s)=>{const e=new n.RGBELoader,i=g(o,r);e.setCrossOrigin("anonymous"),e.load(r,e=>{e.mapping=T.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,i),e=>{i.initialized=!0,s(e)})})}}const L=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap"],D={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"};(x=O=O||{})[x.NONE=0]="NONE",x[x.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",x[x.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",x[x.ONE_FINGER=3]="ONE_FINGER",x[x.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",x[x.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",x[x.TWO_FINGER=12]="TWO_FINGER",x[x.PINCH=16]="PINCH";const A="EXT_View3D_texture_LOD";class I{constructor(e,{darkness:t=.5,mapSize:s=9,blur:i=3.5,shadowScale:r=1,planeScale:o=2}={}){this._view3D=e,this._darkness=t,this._mapSize=s,this._blur=i,this._shadowScale=r,this._planeScale=o;e=e.renderer.threeRenderer,e=Math.min(Math.pow(2,Math.floor(s)),e.capabilities.maxTextureSize);this._root=new T.Group,this._renderTarget=new T.WebGLRenderTarget(e,e,{format:T.RGBAFormat}),this._blurTarget=new T.WebGLRenderTarget(e,e,{format:T.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1;const n=new T.OrthographicCamera(-.5,.5,.5,-.5,0);n.rotation.x=Math.PI/2,this._shadowCamera=n,this._root.add(n);e=new T.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=e,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}updateDimensions(e){const t=this._root,s=this._shadowCamera;var i=this._planeScale,r=e.bbox.getBoundingSphere(new T.Sphere),o=2*i*r.radius,i=this._shadowScale;s.far=i*(e.bbox.max.y-e.bbox.min.y)/o,s.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(o),s.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:s}=e,i=this._shadowCamera;const r=t.threeRenderer;t=s.activeSession?s.activeSession.arScene:e.scene,s=r.xr.enabled;r.xr.enabled=!1;const o=t.root;e=o.background;o.background=null,o.overrideMaterial=this._depthMaterial;t=r.getClearAlpha();r.setClearAlpha(0),r.setRenderTarget(this._renderTarget),r.clear(),r.render(o,i),o.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),r.xr.enabled=s,r.setRenderTarget(null),r.setClearAlpha(t),o.background=e,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],s=this._blurCamera;const i=t.threeRenderer,r=this._blurPlane;var o=this._renderTarget,t=this._blurTarget;const n=this._horizontalBlurMaterial,a=this._verticalBlurMaterial;r.visible=!0,n.uniforms.tDiffuse.value=o.texture,n.uniforms.h.value=+e/256,n.needsUpdate=!0,r.material=n,i.setRenderTarget(t),i.render(r,s),a.uniforms.tDiffuse.value=t.texture,a.uniforms.v.value=+e/256,a.needsUpdate=!0,r.material=a,i.setRenderTarget(o),i.render(r,s),r.visible=!1}_setupPlanes(){const e=this._root;var t=new T.PlaneBufferGeometry,s=new T.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:T.BackSide,depthWrite:!1,map:this._renderTarget.texture});const i=new T.Mesh(t,s);i.renderOrder=1,i.scale.set(-1,-1,1),i.rotation.order="YXZ",i.rotation.x=Math.PI/2,this._plane=i,e.add(i);t=new T.Mesh(t);this._blurPlane=t;const r=new T.MeshDepthMaterial;r.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=r;const o=new T.ShaderMaterial(a.HorizontalBlurShader);o.depthTest=!1,this._horizontalBlurMaterial=o;const n=new T.ShaderMaterial(h.VerticalBlurShader);n.depthTest=!1,this._verticalBlurMaterial=n}}class N{constructor(e){this._view3D=e,this._scene=new T.Scene,this._camera=new T.PerspectiveCamera,this._enabled=!0}get scene(){return this._scene}get camera(){return this._camera}get enabled(){return this._enabled}destroy(){this._disposeOldSkybox()}enable(){this._enabled=!0}disable(){this._enabled=!1}updateCamera(){var e=this._view3D;const t=this._camera;var s=e.camera,e=s.currentPose.pivot;t.copy(s.threeCamera),t.lookAt(e),t.updateProjectionMatrix()}useBlurredHDR(e){this._disposeOldSkybox();const t=this._view3D.renderer.threeRenderer,s=new T.Scene;s.background=e;var i=t.toneMappingExposure;t.toneMappingExposure=1;var r=new T.WebGLCubeRenderTarget(256,{encoding:T.sRGBEncoding,format:T.RGBAFormat});const o=new T.CubeCamera(.1,1e3,r);o.update(t,s);var n=c.LightProbeGenerator.fromCubeRenderTarget(t,r),e=new T.MeshStandardMaterial({side:T.BackSide});const a=new T.IcosahedronBufferGeometry(1,4),h=new T.Scene;e=new T.Mesh(a,e);const l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return h.add(e),h.add(n),o.update(t,h),t.toneMappingExposure=i,this._scene.background=r.texture,this}useTexture(e){return this._scene.background=e,this}useColor(e){return this._scene.background=new T.Color(e),this}_disposeOldSkybox(){const e=this._scene.background;e&&(e.dispose(),this._scene.background=null)}}class X{constructor(e){this._view3D=e,this._root=new T.Scene,this._skybox=null,this._userObjects=new T.Group,this._envObjects=new T.Group,this._fixedObjects=new T.Group,this._shadowPlane=new I(e,G(e.shadow));const t=this._root,s=this._userObjects,i=this._envObjects,r=this._fixedObjects;var o=this._shadowPlane;s.name="userObjects",i.name="envObjects",r.name="fixedObjects",t.add(s,i,r),e.shadow&&r.add(o.root)}get root(){return this._root}get skybox(){return this._skybox}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){const s=t?this._userObjects:this._envObjects;e=Array.isArray(e)?e:[e];s.add(...e)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(r){return H(this,void 0,void 0,function*(){var e=this._view3D;const t=new N(e);if(this._skybox=t,"number"==typeof r||"#"===r.charAt(0))t.useColor(r);else{const s=new P(e),i=yield s.load(r);i.encoding=T.sRGBEncoding,t.useTexture(i)}})}setSkybox(o){var n;return H(this,void 0,void 0,function*(){const e=this._root;var t=this._view3D;if(null!==(n=this._skybox)&&void 0!==n&&n.destroy(),o){const i=new P(t);var s=yield i.loadHDRTexture(o);const r=new N(t);t.skyboxBlur?r.useBlurredHDR(s):r.useTexture(s),this._skybox=r,e.environment=s}else this._skybox=null,e.environment=null})}setEnvMap(s){return H(this,void 0,void 0,function*(){if(s){var e=this._view3D;const t=new P(e);e=yield t.loadHDRTexture(s);this._root.environment=e}else this._root.environment=null})}_removeChildsOf(e){for(e.traverse(e=>{if(e.isMesh){const t=e;t.geometry.dispose();const s=Array.isArray(t.material)?t.material:[t.material];s.forEach(t=>{L.forEach(e=>{t[e]&&t[e].dispose()})})}});0<e.children.length;)e.remove(e.children[0])}}const F=E.EASE_OUT_CUBIC,z={min:0,max:1},Z={min:-1/0,max:1/0},q={min:-89.9,max:89.9},Q=[f.WEBXR,f.SCENE_VIEWER,f.QUICK_LOOK];class K{constructor({duration:e=300,loop:t=!1,range:s=z,easing:i=F}={}){this._duration=e,this._loop=t,this._range=s,this._easing=i,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){if(!this._activated)return 0;var t=this._start,s=this._end,i=this._duration,r=this._val,o=this._loop,i=this._progress+e/i;this._progress=(o?p:d)(i,0,1);i=this._easing(this._progress);return this._val=u(t,s,i),!o&&1<=this._progress&&(this._activated=!1),this._val-r}reset(e){var t=this._range,t=d(e,t.min,t.max);this._start=t,this._end=t,this._val=t,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=d(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class ${constructor(e,t,s,{duration:i=300,easing:r=F}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,t=t.clone(),s=s.clone(),t.yaw=p(t.yaw,0,360),s.yaw=p(s.yaw,0,360),180<Math.abs(s.yaw-t.yaw)&&(s.yaw=s.yaw<t.yaw?s.yaw+360:s.yaw-360),this._motion=new K({duration:i,range:z,easing:r}),this._from=t,this._to=s}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}update(e){if(this._enabled){const s=this._view3D.camera,i=this._from;var t=this._to;const r=this._motion;r.update(e);e=r.val;s.yaw=u(i.yaw,t.yaw,e),s.pitch=u(i.pitch,t.pitch,e),s.zoom=u(i.zoom,t.zoom,e),s.pivot=i.pivot.clone().lerp(t.pivot,e),1<=e&&(this.disable(),this._finishCallbacks.forEach(e=>e()))}}enable(){this._enabled||(this._enabled=!0,this._motion.reset(0),this._motion.setEndDelta(1))}disable(){this._enabled&&(this._enabled=!1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class J{constructor(e,t,s,i=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=s,this.pivot=(new T.Vector3).fromArray(i)}clone(){return new J(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}}class ee{constructor(e){this._distance=0,this._baseFov=45,this._view3D=e,this._threeCamera=new T.PerspectiveCamera,this._maxTanHalfHFov=0,this._defaultPose=new J(e.yaw,e.pitch,e.initialZoom),this._currentPose=this._defaultPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get pose(){return this._currentPose}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this._distance*Math.tan(_(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._currentPose.yaw=e}set pitch(e){this._currentPose.pitch=e}set zoom(e){this._currentPose.zoom=e}set pivot(e){this._currentPose.pivot=e}reset(n=0,a=F){return H(this,void 0,void 0,function*(){const t=this._view3D,s=t.control;var e=this._currentPose;const i=this._defaultPose;if(n<=0)return this._currentPose=i.clone(),s.sync(),Promise.resolve();{const r=new $(t,e,i);r.duration=n,r.easing=a,r.enable(),s.disable();const o=e=>{r.update(e.delta)};return t.on(w.BEFORE_RENDER,o),new Promise(e=>{r.onFinished(()=>{s.sync(),s.enable(),t.off(w.BEFORE_RENDER,o),e()})})}})}resize({width:e,height:t}){const s=this._threeCamera;var i=this._view3D.fov;s.aspect=e/t,i===W?this._applyEffectiveFov(45):this._baseFov=i}fit(e,t){var s=this._view3D;const i=this._threeCamera,r=s.control,o=this._defaultPose,n=e.bbox;var a=s.fov,s=a===W?45:a;const h=Array.isArray(t)?(new T.Vector3).fromArray(t):n.getCenter(new T.Vector3);t=e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(h)),0),t=Math.sqrt(t);const l=t/Math.sin(_(s/2));e=e.reduceVertices((e,t)=>{var s=(new T.Vector3).subVectors(t,h),t=Math.sqrt(s.x*s.x+s.z*s.z);return Math.max(e,t/(l-Math.abs(s.y)))},0);a===W?(this._maxTanHalfHFov=e,this._applyEffectiveFov(s)):this._maxTanHalfHFov=a,o.pivot=h.clone(),this._distance=l,i.near=.1*(l-t),i.far=10*(l+t),r.zoom.updateRange()}updatePosition(){var e=this._view3D["control"];const t=this._threeCamera,s=this._currentPose;var i=this._distance,r=this._baseFov,e=e.zoom.range;s.yaw=p(s.yaw,0,360),s.pitch=d(s.pitch,q.min,q.max),s.zoom=-(d(r-s.zoom,e.min,e.max)-r);const o=((e,t,s)=>{t=_(t),s=_(s);const i=new T.Vector3(0,0,0);return i.y=e*Math.sin(s),i.z=e*Math.cos(s),i.x=i.z*Math.sin(-t),i.z=i.z*Math.cos(-t),i})(i,s.yaw,s.pitch);r-=s.zoom;o.add(s.pivot),t.fov=r,t.position.copy(o),t.lookAt(s.pivot),t.updateProjectionMatrix()}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(_(e/2)),t=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=180*(2*Math.atan(t))/Math.PI}}const te={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",LOAD:"load",ERROR:"error"},se={GRAB:"grab",GRABBING:"grabbing",NONE:""};(x=R=R||{})[x.LEFT=0]="LEFT",x[x.MIDDLE=1]="MIDDLE",x[x.RIGHT=2]="RIGHT";class ie{constructor(e){this._onResize=()=>{this._view3d.resize()},this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){const e=this._view3d;if(this._enabled&&this.disable(),e.useResizeObserver&&window.ResizeObserver){const t=new ResizeObserver(this._onResize);t.observe(e.renderer.canvas),this._resizeObserver=t}else e.resize(),window.addEventListener(te.RESIZE,this._onResize);return this._enabled=!0,this}disable(){if(!this._enabled)return this;const e=this._resizeObserver;return e?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(te.RESIZE,this._onResize),this._enabled=!1,this}}class re{constructor(e){this._view3D=e,this._mixer=new T.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!==(e=this._clips[this._activeAnimationIdx])&&void 0!==e?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}setClips(e){const s=this._mixer;this._clips=e,this._actions=e.map(e=>{const t=s.clipAction(e);return t.setEffectiveWeight(0),t})}play(e){const t=this._actions[e];t&&(this.stop(),this._restoreTimeScale(),t.setEffectiveTimeScale(1),t.setEffectiveWeight(1),t.play(),this._activeAnimationIdx=e,this._flushFadePromises())}crossFade(l,c,{synchronize:_=!1}={}){var d;return H(this,void 0,void 0,function*(){const s=this._view3D,t=this._mixer;var e=this._actions,i=this._activeAnimationIdx;const r=e[l],o=null!==(d=e[i])&&void 0!==d?d:r,n="loop";this._restoreTimeScale();const a=()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),o.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=l};if(_){const h=e=>{e.action===o&&(t.removeEventListener(n,h),a())};t.addEventListener(n,h)}else a();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(s.off(w.BEFORE_RENDER,t),e(!0))};s.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return H(this,void 0,void 0,function*(){const s=this._view3D;const i=this._actions[this._activeAnimationIdx];return!!i&&(this._flushFadePromises(),this._restoreTimeScale(),i.fadeOut(e/1e3),this._activeAnimationIdx=-1,new Promise(e=>{const t=()=>{0<i.getEffectiveWeight()||(s.off(w.BEFORE_RENDER,t),e(!0))};s.on(w.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}reset(){const e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=1}_flushFadePromises(){const s=this._view3D,e=this._fadePromises;e.forEach(({resolve:e,listener:t})=>{e(!1),s.off(w.BEFORE_RENDER,t)}),this._fadePromises=[]}}class oe extends e{constructor({context:e=window,repeat:t=0,duration:s=300,easing:i=F}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,s=this._repeat,e=this._time+e,i=Math.floor(e/t);this._time=(this._loopCount>=s?d:p)(e,0,t);var t=this._time/t,r={progress:t,easedProgress:this._easing(t)};this.trigger("progress",r);for(let e=0;e<i;e++){if(this._loopCount++,this._loopCount>s)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=s,this._easing=i,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const ne={AR:"immersive-ar",VR:"immersive-vr"},ae={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},he={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend"},le={TOUCH:"generic-touchscreen"},ce={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{}},_e={},de={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class ue{constructor({scale:e=1}={}){this.rotation=new T.Quaternion,this._axis=new T.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new T.Vector2,this._fromQuat=new T.Quaternion,this._toQuat=new T.Quaternion,this._motion=new K({range:Z}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:s}){if(this._active&&1===s.length){const i=this._prevPos,r=this._motion;s=s[0];const o=e.modelMovable.getWorldPosition(new T.Vector3);e=((e,t,s)=>{const i=(new T.Vector2).subVectors(t,e).normalize(),r=(new T.Vector2).subVectors(s,e).normalize();s=r.angle()-i.angle(),e=-Math.sign(s)*(2*Math.PI-Math.abs(s));return Math.abs(s)<Math.abs(e)?s:e})((new T.Vector2).fromArray(o.project(t).toArray()),i,s)*this._userScale,t=(new T.Quaternion).setFromAxisAngle(this._axis,e),e=this._getInterpolatedQuaternion();this._fromQuat.copy(e),this._toQuat.premultiply(t),r.reset(0),r.setEndDelta(1),i.copy(s)}}update({scene:e},t){if(this._active){const s=this._motion;s.update(t);t=this._getInterpolatedQuaternion();this.rotation.copy(t),e.setModelRotation(t)}}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,s=this._fromQuat,e=e.val;return(new T.Quaternion).copy(s).slerp(t,e)}}(x=M=M||{})[x.WAITING=0]="WAITING",x[x.TRANSLATING=1]="TRANSLATING",x[x.BOUNCING=2]="BOUNCING";class pe{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:s=E.EASE_OUT_BOUNCE}={}){this._hoverPosition=new T.Vector3,this._floorPosition=new T.Vector3,this._wallRotation=new T.Quaternion,this._dragPlane=new T.Plane,this._enabled=!1,this._vertical=!1,this._state=M.WAITING,this._initialPos=new T.Vector2,this._hoverHeight=e,this._bounceMotion=new K({duration:t,easing:s,range:Z})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){if(this._enabled){const e=this._dragPlane;e.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=M.TRANSLATING}}deactivate(){if(this._enabled&&!this._vertical&&this._state!==M.WAITING){this._state=M.BOUNCING;var e=this._floorPosition,t=this._hoverPosition;const s=this._bounceMotion;e=t.y-e.y;s.reset(e),s.setEndDelta(-e)}else this._state=M.WAITING}init(e,t,s){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=s?new T.Vector3(0,1,0).applyQuaternion(t):new T.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=s}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:s},{hitResults:i}){var r=this._state,o=r===M.WAITING||r===M.BOUNCING;if(i&&1===i.length&&!o){const _=i[0];var n=this._floorPosition.clone();const d=this._floorPosition,u=this._hoverPosition;var a=this._hoverHeight;const p=this._dragPlane;var h=this._vertical,l=_.results[0]&&_.results[0].getPose(t),r=l&&(new T.Matrix4).fromArray(l.transform.matrix),o=l&&.75<r.elements[5],i=l&&r.elements[5]<.25,s=(new T.Vector3).setFromMatrixPosition(s.matrixWorld),r=l&&(new T.Vector3).setFromMatrixPosition(r);if(h)if(!e||l&&i){const v=new T.Vector3(0,1,0);h=l.transform.orientation,i=v.clone().applyQuaternion(new T.Quaternion(h.x,h.y,h.z,h.w)).normalize(),h=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),i);const m=new T.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize();if(Math.acos(Math.abs(m.dot(i)))>=Math.PI/18){var c=(new T.Matrix4).makeBasis(h,v,i);const E=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(c);E.z=0,E.x=Math.PI/2,this._wallRotation.setFromEuler(E),p.normal.copy(new T.Vector3(0,1,0).applyQuaternion(this._wallRotation)),p.constant=this._calcDragPlaneConstant(r)}c=(new T.Vector3).subVectors(r,s).normalize();const g=new T.Ray(s,c);c=g.intersectPlane(p,new T.Vector3);c&&d.copy(c)}else{c=e.getPose(_.inputSource.targetRaySpace,t);if(!c)return;c=c.transform.position;const w=new T.Vector3(c.x,c.y,c.z);c=w.sub(s).normalize();const b=new T.Ray(s,c);c=b.intersectPlane(p,new T.Vector3);c&&d.copy(c)}else if(!e||l&&o){o=-p.constant,a=r.y+a;.1<a-o&&(p.constant=-a);a=(new T.Vector3).subVectors(r,s).normalize();const f=new T.Ray(s,a);a=f.intersectPlane(p,new T.Vector3);a&&(d.copy(a),d.setY(r.y),u.copy(a))}else{t=e.getPose(_.inputSource.targetRaySpace,t);if(!t)return;t=t.transform.position;const y=new T.Vector3(t.x,t.y,t.z);t=y.sub(s).normalize();const O=new T.Ray(s,t);t=O.intersectPlane(p,new T.Vector3);t&&(d.copy(t),d.setY(n.y),u.copy(t))}}}update({scene:e},t){var s=this._state,i=this._floorPosition;const r=this._hoverPosition,o=this._bounceMotion;var n=this._vertical;s===M.BOUNCING&&(o.update(t),r.setY(i.y+o.val),1<=o.progress&&(this._state=M.WAITING)),e.setRootPosition(i),n?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-i.y)}_calcDragPlaneConstant(e){var t=this._vertical,s=this._dragPlane.normal.clone();const i=new T.Plane(s,0);t=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+t)}}class ve{constructor({width:e=.1,padding:t=20,offset:s=.05,font:i="64px sans-serif",color:r="white"}={}){const o=document.createElement("canvas"),n=o.getContext("2d");n.font=i;var a=n.measureText("100%"),h=a.actualBoundingBoxLeft+a.actualBoundingBoxRight,l=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,a=(e=>{let t=1;for(;t<e;)t*=2;return t})(h);o.width=a;a=e*((o.height=a)/h);this._ctx=n,this._canvas=o,this._height=a*l/h,this._texture=new T.CanvasTexture(o);a=new T.PlaneGeometry(a,a),a=new T.Mesh(a,new T.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=i,this._color=r,this._padding=t,this._offset=s,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,s){const i=this._mesh;s=this._height/2+this._offset+s,e=new T.Vector3(0,s,0).applyQuaternion(e.clone().invert());i.position.copy(e),i.lookAt(t)}updateScale(e){const t=this._ctx;var s=this._canvas,i=this._padding,r=(100*e).toFixed(0);t.clearRect(0,0,s.width,s.height);var o=s.width/2,n=s.height/2,a=t.measureText(r+"%"),s=(a.actualBoundingBoxLeft+a.actualBoundingBoxRight)/2,a=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(o-s,n-a-i),t.lineTo(o+s,n-a-i),t.quadraticCurveTo(o+s+i,n-a-i,o+s+i,n-a),t.lineTo(o+s+i,n+a),t.quadraticCurveTo(o+s+i,n+a+i,o+s,n+a+i),t.lineTo(o-s,n+a+i),t.quadraticCurveTo(o-s-i,n+a+i,o-s-i,n+a),t.lineTo(o-s-i,n-a),t.quadraticCurveTo(o-s-i,n-a-i,o-s,n-a-i),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",o,n),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class me{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new ve,this._motion=new K({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new ve}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:s,xrCam:i,initialScale:r}){const o=this._motion;var n=o.range;if(r===W){var a=2*Math.atan(1/i.projectionMatrix.elements[5]),h=i.projectionMatrix.elements[0]/i.projectionMatrix.elements[5];const c=i.position;i=t.bbox.max.y-t.bbox.min.y,a=c.distanceTo((new T.Vector3).addVectors(s,new T.Vector3(0,i/2,0)))*Math.tan(a/2),h=a*h,t=t.bbox.getBoundingSphere(new T.Sphere),a=a/t.radius,t=h/t.radius;const l=d(Math.min(t,a),n.min,1);o.reset(l)}else o.reset(d(r,n.min,n.max));const l=this._motion.val;this._scaleMultiplier=l,e.setModelScale(l)}setInitialPos(e){this._prevCoordDistance=(new T.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){if(2===t.length&&this._enabled&&this._active){const i=this._motion;var s=(new T.Vector2).subVectors(t[0],t[1]).length(),t=s-this._prevCoordDistance;i.setEndDelta(t),this._prevCoordDistance=s,this._updateUIPosition(e)}}update({scene:e},t){if(this._enabled&&this._active){const s=this._motion;s.update(t),this._scaleMultiplier=s.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier)}}_updateUIPosition({view3D:e,scene:t,xrCam:s,vertical:i}){const r=e.model;s=(new T.Vector3).setFromMatrixPosition(s.matrixWorld),i=i?r.bbox.getBoundingSphere(new T.Sphere).radius:r.bbox.max.y-r.bbox.min.y;this._ui.updatePosition(t.root.quaternion,s,i)}}class ge{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:s=1e3}={}){var i=Math.PI/18;const r=new T.RingGeometry(.975,1,150,1,-6*i,30*i);r.rotateX(-Math.PI/2);const o=new T.RingGeometry(.96,1.015,30,1,25*i,4*i),n=o.attributes["position"];var a=Math.floor(11*n.count/16),h=Math.floor(13*n.count/16),l=Math.floor((h-a+1)/2),c=(new T.Vector3).fromBufferAttribute(n,a).y;for(let e=a;e<h;e++){var _=e-a,_=.025*(l-Math.abs(_-l));n.setY(e,c-_)}o.rotateX(-Math.PI/2);var d=new T.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),i=new T.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),d=new T.Mesh(r,d),i=new T.Mesh(o,i);const u=new T.Group;u.add(d,i),u.position.setY(1e-4),this._mesh=u,this._ring=d,this._arrow=i,this._animator=new K({duration:s}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new T.Sphere).radius)}update({delta:e,rotation:t}){const s=this._mesh,i=this._animator;if(s.visible){i.update(e);const r=this._ring.material,o=this._arrow.material;e=this._opacityRange;r.opacity=i.val*e.min,o.opacity=i.val*e.max,i.val<=0&&(s.visible=!1),s.quaternion.copy(t),s.updateMatrix()}}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(x=S=S||{})[x.WAITING=0]="WAITING",x[x.IN_DEADZONE=1]="IN_DEADZONE",x[x.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class Ee{constructor({size:e=.1}={}){this._state=S.WAITING,this._detectedGesture=O.NONE,this._testingGestures=O.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new T.Vector2,this._prevTwoFingerPos=new T.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===S.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new T.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new T.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=S.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,O.NONE)}cleanup(){this._testingGestures=O.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=O.NONE,this._state=S.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,s=this._size,i=this._testingGestures,r=this._lastFingerCount,o=e.length;if(t===S.OUT_OF_DEADZONE)return this._detectedGesture;if(this._lastFingerCount=o,this.applyScreenAspect(e),o!==r)return this.setFirstInput(e),O.NONE;if(1===o){var r=e[0],n=this._prevOneFingerPos.clone();const a=(new T.Vector2).subVectors(r,n);a.length()>s&&(Math.abs(a.x)>Math.abs(a.y)?O.ONE_FINGER_HORIZONTAL&i&&(this._detectedGesture=O.ONE_FINGER_HORIZONTAL):O.ONE_FINGER_VERTICAL&i&&(this._detectedGesture=O.ONE_FINGER_VERTICAL))}else if(2===o){n=(new T.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),o=this._prevTwoFingerPos.clone();const h=(new T.Vector2).subVectors(n,o);h.length()>s&&(Math.abs(h.x)>Math.abs(h.y)?O.TWO_FINGER_HORIZONTAL&i&&(this._detectedGesture=O.TWO_FINGER_HORIZONTAL):O.TWO_FINGER_VERTICAL&i&&(this._detectedGesture=O.TWO_FINGER_VERTICAL));e=(new T.Vector2).subVectors(e[1],e[0]).length();Math.abs(e-this._initialTwoFingerDistance)>s&&O.PINCH&i&&(this._detectedGesture=O.PINCH)}return this._detectedGesture!==O.NONE&&(this._state=S.OUT_OF_DEADZONE),this._detectedGesture}}class we{constructor(e,t,{rotate:s,translate:i,scale:r,ring:o,deadzone:n,initialScale:a}){this._onSelectStart=e=>{const t=e.frame;var s=this._view3D,i=this._arScene,r=this._hitTestSource;const o=this._deadzoneChecker;var n=this._rotateControl,a=this._translateControl,h=this._scaleControl;const l=s.renderer.threeRenderer;var c=l.xr.getCamera(new T.PerspectiveCamera),e=l.xr.getReferenceSpace();if(r&&!(c.cameras.length<=0)){c=c.cameras[0];const _=s.model;n.enabled&&o.addTestingGestures(O.ONE_FINGER),a.enabled&&o.addTestingGestures(O.ONE_FINGER),h.enabled&&o.addTestingGestures(O.PINCH);h=t.getHitTestResultsForTransientInput(r),r=this._hitResultToVector(h);if(o.applyScreenAspect(r),o.setFirstInput(r),1===r.length){e=t.getPose(h[0].inputSource.targetRaySpace,e);if(e){c=(new T.Vector3).setFromMatrixPosition(c.matrixWorld),e=e.transform.position,e=new T.Vector3(e.x,e.y,e.z).sub(c).normalize();const d=new T.Ray(c,e),u=_.bbox.getBoundingSphere(new T.Sphere);u.applyMatrix4(i.modelMovable.matrixWorld),d.intersectSphere(u,new T.Vector3)&&(this._modelHit=!0)}}this._vertical&&!this._modelHit||this._floorIndicator.show()}},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=s,this._translate=i,this._scale=r,this._initialScale=a,this._rotateControl=new ue(G(s)),this._translateControl=new pe(G(i)),this._scaleControl=new me(G(r)),this._floorIndicator=new ge(o),this._deadzoneChecker=new Ee(n)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:o,session:n,size:a,vertical:h,hitPosition:l,hitRotation:c}){return H(this,void 0,void 0,function*(){const e=this._arScene,t=this._translateControl;var s=this._scaleControl,i=this._floorIndicator;const r=this._deadzoneChecker;this._vertical=h,t.init(l,c,h),r.setAspect(a.height/a.width),e.add(i.mesh,s.ui.mesh),this.syncTargetModel(o);s=yield n.requestHitTestSourceForTransientInput({profile:le.TOUCH});this._hitTestSource=s,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(he.SELECT_START,this._onSelectStart),e.removeEventListener(he.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,s=this._translate,i=this._scale;const r=this._rotateControl,o=this._translateControl,n=this._scaleControl;var a=this._vertical;e.addEventListener(he.SELECT_START,this._onSelectStart),e.addEventListener(he.SELECT_END,this._onSelectEnd),t&&!a&&r.enable(),s&&o.enable(),i&&n.enable()}disable(e){const t=this._rotateControl,s=this._translateControl,i=this._scaleControl;e.removeEventListener(he.SELECT_START,this._onSelectStart),e.removeEventListener(he.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),s.disable(),i.disable()}update(e){const{view3D:t,session:s,frame:i}=e;var r,o,n=this._hitTestSource;n&&t.model&&(r=this._deadzoneChecker,o=s.inputSources,n=null!==(n=null===i||void 0===i?void 0:i.getHitTestResultsForTransientInput(n))&&void 0!==n?n:[],n={coords:this._hitResultToVector(n),inputSources:o,hitResults:n},r.inDeadzone?this._checkDeadzone(e,n):this._processInput(e,n),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,s=this._translateControl.floorPosition,i=this._view3D.renderer.threeRenderer.xr.getCamera(new T.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:s,xrCam:i,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var s=this._arScene;const i=this._rotateControl,r=this._translateControl,o=this._scaleControl;var n=this._deadzoneChecker.check(t.map(e=>e.clone()));if(n!==O.NONE)switch(n){case O.ONE_FINGER_HORIZONTAL:case O.ONE_FINGER_VERTICAL:this._modelHit?(r.activate(),r.setInitialPos(t)):(i.activate(),i.updateRotation(s.modelMovable.quaternion),i.setInitialPos(t));break;case O.PINCH:o.activate(e),o.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"];const s=this._arScene,i=this._rotateControl,r=this._translateControl,o=this._scaleControl,n=this._floorIndicator;var a=1e3*t;i.update(e,a),r.update(e,a),o.update(e,a);t=i.rotation,e=r.floorPosition;s.setRootPosition(e),n.update({delta:a,rotation:t})}_hitResultToVector(e){return e.map(e=>(new T.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class be{constructor(){this._root=new T.Scene,this._modelRoot=new T.Group,this._modelMovable=new T.Group,this._modelFixed=new T.Group,this._arRoot=new T.Group;const e=this._root,t=this._modelRoot;var s=this._modelMovable,i=this._modelFixed,r=this._arRoot;t.add(s),e.add(t,i,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){const t=this._root,s=this._modelMovable,i=this._modelFixed;e=e.scene;s.add(e.userObjects,e.envObjects),i.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,s=this._modelFixed;const i=e.scene;[...t.children,...s.children].forEach(e=>{i.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}setRootPosition(e){const t=this._root;t.position.copy(e)}setWallRotation(e){const t=this._root;t.quaternion.copy(e)}updateModelRootPosition(e,t){const s=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,s.position.setZ(t/2),s.position.setY(-e.bbox.min.z),s.rotateX(-Math.PI/2),s.updateMatrix())}setModelHovering(e){const t=this._modelMovable;t.position.setY(e)}setModelRotation(e){const t=this._modelMovable;t.quaternion.copy(e)}setModelScale(e){const t=this._root;t.scale.setScalar(e)}}class fe{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,ce.DOM_OVERLAY(e)}}class ye{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(ae.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return ce.HIT_TEST}getResults(e){return null!==(e=null==e?void 0:e.getHitTestResults(this._source))&&void 0!==e?e:[]}}class Oe{constructor(e,{features:t=_e,vertical:s=!1,overlayRoot:i=null,rotate:r=!0,translate:o=!0,scale:n=!0,ring:a={},deadzone:h={},initialScale:l=W}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=s,this.overlayRoot=i,this._arScene=new be,this._control=new we(e,this._arScene,{rotate:r,translate:o,scale:n,ring:a,deadzone:h,initialScale:l}),this._hitTest=new ye,this._domOverlay=new fe}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&ye.isAvailable()&&fe.isAvailable()?navigator.xr.isSessionSupported(ne.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}enter(){return H(this,void 0,void 0,function*(){const a=this._view3D,h=a.scene,l=this._arScene,e=a.renderer,c=e.threeRenderer,_=this._control,t=this._hitTest,s=this._domOverlay,d=this.vertical;var i=this._getAllXRFeatures();c.xr.enabled=!0;const u=yield navigator.xr.requestSession(ne.AR,i),r=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(ae.LOCAL),yield c.xr.setSession(u),l.init(a),t.init(u);u.addEventListener("end",()=>H(this,void 0,void 0,function*(){_.destroy(u),l.destroy(a),s.destroy(),c.setPixelRatio(r),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),a.trigger(w.AR_END,{target:a,type:w.AR_END,session:this})}),{once:!0});const p=new T.Clock;p.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var s,i,r,o=c.xr.getCamera(new T.PerspectiveCamera),n=p.getDelta();o.cameras.length<=0||(s=o.cameras[0],i=c.xr.getReferenceSpace(),r={width:null!==(o=null==(r=u.renderState.baseLayer)?void 0:r.framebufferWidth)&&void 0!==o?o:1,height:null!==(r=null==r?void 0:r.framebufferHeight)&&void 0!==r?r:1},i={view3D:a,scene:l,session:u,delta:n,frame:t,vertical:d,referenceSpace:i,xrCam:s,size:r},r=1e3*n,a.trigger(w.BEFORE_RENDER,{type:w.BEFORE_RENDER,target:a,delta:r}),this._modelPlaced?(_.update(i),a.animator.update(n),h.shadowPlane.render(),c.render(l.root,s)):this._initModelPosition(i),a.trigger(w.RENDER,{type:w.RENDER,target:a,delta:r}))}),a.trigger(w.AR_START,{type:w.AR_START,target:a,session:this})})}exit(){return H(this,void 0,void 0,function*(){const e=this._view3D.renderer.threeRenderer.xr.getSession();return null===e||void 0===e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!==(t=B(this.overlayRoot))&&void 0!==t?t:this._createARRootElement();return v({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:s,size:i,vertical:r,referenceSpace:o}=e,n=this._view3D;var a=n.model;const h=this._arScene,l=this._hitTest;if(l.ready&&a){const d=this._control;var c=l.getResults(t);if(!(c.length<=0)){const u=c[0];var _=u.getPose(o);if(_){e=(new T.Matrix4).fromArray(_.transform.matrix);if(!(!r&&e.elements[5]<.75||r&&(.25<=e.elements[5]||e.elements[5]<=-.25))){c=(new T.Vector3).setFromMatrixPosition(e);const p=new T.Quaternion;if(r){const g=new T.Vector3(0,1,0);e=_.transform.orientation,_=g.clone().applyQuaternion(new T.Quaternion(e.x,e.y,e.z,e.w)).normalize(),e=(new T.Vector3).crossVectors(new T.Vector3(0,1,0),_),_=(new T.Matrix4).makeBasis(e,g,_);const E=new T.Euler(0,0,0,"YXZ").setFromRotationMatrix(_);E.z=0,E.x=Math.PI/2,p.setFromEuler(E),h.setWallRotation(p)}h.updateModelRootPosition(a,r),h.setRootPosition(c),h.showModel(),l.destroy(),this._modelPlaced=!0,n.trigger(w.AR_MODEL_PLACED,{type:w.AR_MODEL_PLACED,target:n,session:this,model:a}),d.init({model:a,vertical:r,session:s,size:i,hitPosition:c,hitRotation:p});const v=d.scale.scale,m=new oe({context:s,duration:1e3});m.on("progress",e=>{h.setModelScale(e.easedProgress*v)}),m.on("finish",()=>{h.setModelScale(v),d.enable(s)}),m.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement("div");return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(w.AR_END,()=>{e.rootEl.removeChild(t)}),t}}Oe.type=f.WEBXR;class Te{constructor(e,t={}){var{file:s=null,mode:i=y.ONLY_AR,fallbackURL:r=null,title:o=null,link:n=null,sound:a=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:_=W,shareText:d=null}=t,t=function(e,t){var s={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(s[r[i]]=e[r[i]]);return s}(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=s,this.fallbackURL=r,this.mode=i,this.title=o,this.link=n,this.sound=a,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=_,this.shareText=d,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var r;return H(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=m(this.resizable),t.enable_vertical_placement=m(this.vertical),t.disable_occlusion=m(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var s=null!==(r=this.file)&&void 0!==r?r:e.src;if(!s)return Promise.reject(new V(k.FILE_NOT_SUPPORTED(null!==(r=this.file)&&void 0!==r?r:e.src),U.FILE_NOT_SUPPORTED));t.file=new URL(s,window.location.href).href;e=this.fallbackURL,s=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),s=t.mode===y.ONLY_AR?de.INTENT_AR_CORE(s,e):de.INTENT_SEARCHBOX(s,e||de.FALLBACK_DEFAULT(s));const i=document.createElement("a");i.href=s,i.click()})}exit(){return Promise.resolve()}}Te.type=f.SCENE_VIEWER;class Re{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:s=null,applePayButtonType:i=null,callToAction:r=null,checkoutTitle:o=null,checkoutSubtitle:n=null,price:a=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=s,this.applePayButtonType=i,this.callToAction=r,this.checkoutTitle=o,this.checkoutSubtitle=n,this.price=a,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((()=>{const e=document.createElement("a");return e.relList&&e.relList.supports&&e.relList.supports("ar")})()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints))}enter(){const t=this._view3D;var e=t.iosSrc;if(!e)return Promise.reject(new V(k.FILE_NOT_SUPPORTED(""+e),U.FILE_NOT_SUPPORTED));var s=this.canonicalWebPageURL,i=this.custom,r=window.location.href;const o=document.createElement("a");o.setAttribute("rel","ar"),o.appendChild(document.createElement("img"));const n=Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,s])=>(s&&(e[t]=s),e),{}),a=new URL(e,r);return this.allowsContentScaling||(n.allowsContentScaling="0"),s&&(n.canonicalWebPageURL=new URL(s,r).href),i&&(n.custom=new URL(i,r).href),a.hash=new URLSearchParams(n).toString(),o.setAttribute("href",a.href),o.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(w.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:w.QUICK_LOOK_TAP,target:t}))},!1),o.click(),Promise.resolve()}exit(){return Promise.resolve()}}Re.type=f.QUICK_LOOK;const Me={[f.WEBXR]:Oe,[f.SCENE_VIEWER]:Te,[f.QUICK_LOOK]:Re};class Se{constructor(e){this._view3D=e,this._activeSession=null,e.on(w.AR_START,({session:e})=>{this._activeSession=e}),e.on(w.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return H(this,void 0,void 0,function*(){const e=this._getSesssionClasses(),t=yield Promise.all(e.map(e=>e.isAvailable()));return t.some(e=>!0===e)})}enter(){return H(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new V(k.NOT_INITIALIZED,U.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable()){const s=new t(e,G(e[t.type]));return yield s.enter(),Promise.resolve()}}catch(e){}return Promise.reject()})}exit(){return H(this,void 0,void 0,function*(){const e=this._activeSession;null!==e&&void 0!==e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>Me[e])}_getUsingSessionTypes(){const t=this._view3D,e=t.arPriority;return e.filter(e=>!!t[e])}}class xe extends e{constructor(e,{duration:t=300,easing:s=F,scale:i=1,disablePitch:r=!1,disableYaw:o=!1}={}){super(),this._screenScale=new T.Vector2(0,0),this._prevPos=new T.Vector2(0,0),this._enabled=!1,this._onMouseDown=e=>{if(e.button===R.LEFT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(te.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(te.MOUSE_UP,this._onMouseUp,!1),this.trigger(D.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos,s=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);s.multiply(this._screenScale),this._xMotion.setEndDelta(s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(te.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(te.MOUSE_UP,this._onMouseUp,!1),this.trigger(D.RELEASE)},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY)},this._onTouchMove=e=>{if(!(1<e.touches.length||this._isScrolling)){var t=e.touches[0],s=this._view3D.scrollable;if(!s||e.cancelable){if(this._isFirstTouch){if(s){var i=new T.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._isScrolling=!0)}this._isFirstTouch=!1}!s&&e.cancelable&&e.preventDefault(),e.stopPropagation();const r=this._prevPos,o=new T.Vector2(t.clientX,t.clientY).sub(r).multiplyScalar(this._scale);o.multiply(this._screenScale),this._xMotion.setEndDelta(o.x),this._yMotion.setEndDelta(o.y),r.set(t.clientX,t.clientY)}}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):this._prevPos.set(0,0),this._isScrolling=!1},this._view3D=e,this._scale=i,this._duration=t,this._easing=s,this._disablePitch=r,this._disableYaw=o,this._isFirstTouch=!1,this._isScrolling=!1,this._xMotion=new K({duration:t,range:Z,easing:s}),this._yMotion=new K({duration:t,range:q,easing:s})}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._xMotion,i=this._yMotion;var r=!this._disableYaw,o=!this._disablePitch,e=new T.Vector2(s.update(e),i.update(e));r&&(t.yaw+=e.x),o&&(t.pitch+=e.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(te.MOUSE_DOWN,this._onMouseDown),e.addEventListener(te.TOUCH_START,this._onTouchStart,{passive:!0}),e.addEventListener(te.TOUCH_MOVE,this._onTouchMove,{passive:this._view3D.scrollable}),e.addEventListener(te.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(D.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(te.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(te.MOUSE_MOVE,this._onMouseMove),window.removeEventListener(te.MOUSE_UP,this._onMouseUp),e.removeEventListener(te.TOUCH_START,this._onTouchStart),e.removeEventListener(te.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(te.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(D.DISABLE)}}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Ce extends e{constructor(e,{easing:t=F,duration:s=0,scale:i=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new T.Vector2(0,0),this._screenSize=new T.Vector2(0,0),this._onMouseDown=e=>{if(e.button===R.RIGHT){const t=this._view3D.renderer.canvas;e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(te.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(te.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(te.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(D.HOLD)}},this._onMouseMove=e=>{e.preventDefault();const t=this._prevPos;var s=new T.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-s.x),this._yMotion.setEndDelta(s.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(te.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(te.MOUSE_UP,this._onMouseUp,!1),this.trigger(D.RELEASE)},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onTouchMove=e=>{if(2===e.touches.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const s=this._prevPos;var t=this._getTouchesMiddle(e.touches);if(!this._touchInitialized)return s.copy(t),void(this._touchInitialized=!0);e=(new T.Vector2).subVectors(t,s).multiplyScalar(this._scale);this._xMotion.setEndDelta(-e.x),this._yMotion.setEndDelta(e.y),s.copy(t)}},this._onTouchEnd=e=>{2===e.touches.length?(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0):this._touchInitialized=!1},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(te.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new K({duration:s,range:Z,easing:t}),this._yMotion=new K({duration:s,range:Z,easing:t}),this._scale=i}get enabled(){return this._enabled}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable()}update(e){const t=this._view3D.camera;var s=this._screenSize;const i=new T.Vector2(this._xMotion.update(e),this._yMotion.update(e)),r=new T.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),o=new T.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion);s=new T.Vector2(t.renderWidth,t.renderHeight).divide(s);i.multiply(s),t.pivot.add(r.multiplyScalar(i.x)),t.pivot.add(o.multiplyScalar(i.y))}resize(e){const t=this._screenSize;t.copy(new T.Vector2(e.width,e.height))}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(te.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(te.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(te.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(te.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(D.ENABLE)}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(te.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(te.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(te.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(te.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(te.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(te.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(te.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(D.DISABLE)}}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new T.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class Pe{constructor(e,{scale:t=1,duration:s=300,minFov:i=1,maxFov:r=W,easing:o=F}={}){this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;if(0!==e.deltaY&&!t){e.preventDefault(),e.stopPropagation();const s=this._motion;e=-this._scale*this._wheelModifier*e.deltaY;s.setEndDelta(e)}},this._onTouchMove=e=>{var t=e.touches;if(2===t.length){!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();const i=this._motion;var s=this._prevTouchDistance;const r=new T.Vector2(t[0].pageX,t[0].pageY);e=new T.Vector2(t[1].pageX,t[1].pageY);const o=r.sub(e);t=o.length()*this._scale*this._touchModifier,e=t-s;this._prevTouchDistance=t,s<0||i.setEndDelta(e)}},this._onTouchEnd=()=>{this._prevTouchDistance=-1},this._view3D=e,this._scale=t,this._duration=s,this._minFov=i,this._maxFov=r,this._easing=o,this._range={min:i,max:r===W?180:r},this._motion=new K({duration:s,easing:o})}get enabled(){return this._enabled}get range(){return this._range}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get easing(){return this._easing}set scale(e){this._scale=e}destroy(){this.disable()}update(e){const t=this._view3D.camera,s=this._motion;t.zoom+=s.update(e)}resize(e){}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(te.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(te.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(te.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync()}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(te.WHEEL,this._onWheel,!1),e.removeEventListener(te.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(te.TOUCH_END,this._onTouchEnd,!1),this._enabled=!1}}sync(){var e=this._view3D.camera;this._motion.reset(e.zoom)}updateRange(){var e=this._maxFov;const t=this._range,s=this._motion;var i=this._view3D["camera"],i=i.baseFov;e===W&&(t.max=Math.min(i+45,175)),s.range.min=t.min-i,s.range.max=t.max-i}}class Le{constructor(e){this._onEnable=()=>{var e=this._view3D,t=e.renderer.canvas;e.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===se.NONE&&this._setCursor(se.GRAB)},this._onDisable=()=>{this._view3D.renderer.canvas.style.cursor===se.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(se.NONE)},this._onHold=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(se.GRABBING)},this._onRelease=()=>{this._view3D.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(se.GRAB)},this._view3D=e,this._rotateControl=new xe(e,G(e.rotate)),this._translateControl=new Ce(e,G(e.translate)),this._zoomControl=new Pe(e,G(e.zoom)),[this._rotateControl,this._translateControl].forEach(e=>{e.on({[D.HOLD]:this._onHold,[D.RELEASE]:this._onRelease,[D.ENABLE]:this._onEnable,[D.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy()}update(e){this._rotateControl.update(e),this._translateControl.update(e),this._zoomControl.update(e)}resize(e){this._rotateControl.resize(e),this._translateControl.resize(e),this._zoomControl.resize(e)}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable()}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable()}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync()}updateCursor(){var e=this._view3D.useGrabCursor?se.GRAB:se.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;if(t.useGrabCursor||e===se.NONE){const s=t.renderer.canvas;s.style.cursor=e}}}class De{constructor(e,{delay:t=2e3,delayOnMouseLeave:s=0,speed:i=1,pauseOnHover:r=!1,canInterrupt:o=!0,disableOnInterrupt:n=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{this._canInterrupt&&(e.button!==R.LEFT&&e.button!==R.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(te.MOUSE_UP,this._onMouseUp,!1)))},this._onMouseUp=()=>{window.removeEventListener(te.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=s,this._speed=i,this._pauseOnHover=r,this._canInterrupt=o,this._disableOnInterrupt=n}get enabled(){return this._enabled}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){if(this._enabled)if(this._interrupted)this._disableOnInterrupt&&this.disable();else{const t=this._view3D.camera;t.yaw+=this._speed*e/100}}enable(){if(!this._enabled){const e=this._view3D.renderer.canvas;e.addEventListener(te.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(te.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(te.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(te.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(te.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(te.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0}}disable(){if(this._enabled){const e=this._view3D.renderer.canvas;e.removeEventListener(te.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(te.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(te.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(te.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(te.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(te.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(te.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout()}}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Ae{constructor({src:e,scenes:t,animations:s=[],json:i={},fixSkinnedBbox:r=!1,castShadow:o=!0,receiveShadow:n=!1}){this._src=e;const a=new T.Group;a.add(...t),this._animations=s,this._json=i,this._scene=a;const h=this._getInitialBbox(r);r=h.min.y;a.translateY(-r),a.updateMatrixWorld(),h.translate(new T.Vector3(0,-r,0)),this._bbox=h,this.castShadow=o,this.receiveShadow=n}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get json(){return this._json}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}set castShadow(t){const e=this.meshes;e.forEach(e=>e.castShadow=t)}set receiveShadow(t){const e=this.meshes;e.forEach(e=>e.receiveShadow=t)}reduceVertices(r,e){const t=this.meshes;let o=e;return t.forEach(t=>{var s=t.geometry.attributes["position"];if(s){t.updateMatrixWorld();for(let e=0;e<s.count;e++){const i=(new T.Vector3).fromBufferAttribute(s,e);i.applyMatrix4(t.matrixWorld),o=r(o,i)}}}),o}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new T.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const v=new T.Box3;return this.meshes.forEach(t=>{if(t.isSkinnedMesh){var e=t.geometry,s=e.attributes.position;const r=e.attributes.skinIndex,o=e.attributes.skinWeight,n=t.skeleton;n.update();const a=n.boneMatrices,h=o.normalized&&ArrayBuffer.isView(o.array)?1/(Math.pow(2,8*o.array.BYTES_PER_ELEMENT)-1):1,l=new T.Matrix4;for(let e=0;e<s.count;e++){l.identity();var i=(new T.Vector3).fromBufferAttribute(s,e);const c=new T.Vector4;c.set(0,0,0,0);const _=new T.Vector4;_.set(i.x,i.y,i.z,1).applyMatrix4(t.bindMatrix);const d=[o.getX(e),o.getY(e),o.getZ(e),o.getW(e)].map(e=>e*h),u=[r.getX(e),r.getY(e),r.getZ(e),r.getW(e)];d.forEach((e,t)=>{t=(new T.Matrix4).fromArray(a,16*u[t]);c.add(_.clone().applyMatrix4(t).multiplyScalar(e))});const p=(new T.Vector3).fromArray(c.applyMatrix4(t.bindMatrixInverse).toArray());p.applyMatrix4(t.matrixWorld),v.expandByPoint(p)}}else v.expandByObject(t)}),v}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}}const Ie=new t.DRACOLoader,Ne=new i.KTX2Loader;class Fe extends C{constructor(e){super(e),this._loader=new s.GLTFLoader;const t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(Ie),t.setKTX2Loader(Ne.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(i){return H(this,void 0,void 0,function*(){return new Promise((e,t)=>{const s=document.createElement("script");s.addEventListener("load",()=>H(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,Fe.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(s),e()})),s.addEventListener("error",()=>{document.body.removeChild(s),t()}),s.src=new URL(i,location.href).href,document.body.appendChild(s)})})}load(i){var e=this._view3D;const r=this._loader,o=g(e,i);return Ie.setDecoderPath(e.dracoPath),Ne.setTranscoderPath(e.ktxPath),Fe.meshoptDecoder&&r.setMeshoptDecoder(Fe.meshoptDecoder),r.manager=T.DefaultLoadingManager,new Promise((t,s)=>{try{r.load(i,e=>{e=this._parseToModel(e,i);t(e)},e=>this._onLoadingProgress(e,i,o),e=>{o.initialized=!0,s(e)})}catch(e){s(e)}})}loadFromFiles(a){const h=this._view3D,l=this._loader,c=[],_=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return Ie.setDecoderPath(h.dracoPath),Ne.setTranscoderPath(h.ktxPath),Fe.meshoptDecoder&&l.setMeshoptDecoder(Fe.meshoptDecoder),new Promise((t,s)=>{if(a.length<=0)s(new Error("No files found"));else{const i=a.find(e=>/\.(gltf|glb)$/i.test(e.name));if(i){const r=new Map;a.forEach(e=>{r.set(e.name,e)});const o=URL.createObjectURL(i);c.push(o);const e=new T.LoadingManager;e.setURLModifier(e=>{if(/^data:.*,.*$/i.test(e))return e;var t=/[^\/|\\]+$/.exec(e),t=t&&t[0]||"";if(r.has(t)){t=r.get(t),t=URL.createObjectURL(t);return c.push(t),t}return e});const n=g(h,o);l.manager=e,l.load(o,e=>{e=this._parseToModel(e,i.name);t(e),_()},e=>this._onLoadingProgress(e,o,n),e=>{n.initialized=!0,s(e),_()})}else s(new Error("No glTF file found"))}})}_parseToModel(r,e){var t=this._view3D,s=t.fixSkinnedBbox;r.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const i=r.parser.json.extensionsUsed;if(i&&i.some(e=>e===A)){const o=t.renderer.threeRenderer.capabilities.maxTextureSize,n=[];r.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&n.push(e)})});const a=n.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[]),h=a.reduce((e,t)=>[...e,...L.filter(e=>t[e]).map(e=>t[e])],[]),l=r.parser.associations,c=r.parser.json,_=h.filter(e=>l.has(e)).map(e=>c.textures[l.get(e).textures]),d=_.reduce((i,e,t)=>{if(!e.extensions[A])return i;const r=h[t],s=e.extensions[A].levels;return s.forEach(({index:e,size:t},s)=>{t>o||(i[s]||(i[s]=[]),i[s].push({index:e,texture:r}))}),i},[]),u=d.map(()=>!1);d.forEach((i,s)=>H(this,void 0,void 0,function*(){const e=yield Promise.all(i.map(({index:e})=>r.parser.getDependency("texture",e)));var t=u.slice(s+1).some(e=>!!e);u[s]=!0,t||e.forEach((e,t)=>{const s=i[t].texture;s.image=e.image,s.needsUpdate=!0})}))}return new Ae({src:e,scenes:r.scenes,json:r.parser.json,animations:r.animations,fixSkinnedBbox:s})}}class ze extends e{constructor(e,{src:t=null,iosSrc:s=null,dracoPath:i="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:r="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:o=null,fixSkinnedBbox:n=!1,fov:a=W,center:h=W,yaw:l=0,pitch:c=0,initialZoom:_=0,rotate:d=!0,translate:u=!0,zoom:p=!0,autoplay:v=!1,scrollable:m=!0,wheelScrollable:g=!1,useGrabCursor:E=!0,skybox:w=null,envmap:b=null,background:f=null,exposure:y=1,shadow:O=!0,skyboxBlur:T=!1,toneMapping:R=j.LINEAR,webAR:M=!0,sceneViewer:S=!0,quickLook:x=!0,arPriority:C=Q,poster:P=null,canvasSelector:L="canvas",autoInit:D=!0,autoResize:A=!0,useResizeObserver:I=!0,on:N={},plugins:F=[],maxDeltaTime:z=1/30}={}){super(),this._rootEl=((e,t)=>{t=B(e,t);if(!t)throw new V(k.WRONG_TYPE(e,["HTMLElement","string"]),U.WRONG_TYPE);return t})(e),this._src=t,this._iosSrc=s,this._dracoPath=i,this._ktxPath=r,this._meshoptPath=o,this._fixSkinnedBbox=n,this._fov=a,this._center=h,this._yaw=l,this._pitch=c,this._initialZoom=_,this._rotate=d,this._translate=u,this._zoom=p,this._autoplay=v,this._scrollable=m,this._wheelScrollable=g,this._useGrabCursor=E,this._skybox=w,this._envmap=b,this._background=f,this._exposure=y,this._shadow=O,this._skyboxBlur=T,this._toneMapping=R,this._webAR=M,this._sceneViewer=S,this._quickLook=x,this._arPriority=C,this._poster=P,this._canvasSelector=L,this._autoInit=D,this._autoResize=A,this._useResizeObserver=I,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=F,this._maxDeltaTime=z,this._renderer=new Y(this),this._camera=new ee(this),this._control=new Le(this),this._scene=new X(this),this._animator=new re(this),this._autoPlayer=new De(this,G(v)),this._autoResizer=new ie(this),this._arManager=new Se(this),this._addEventHandlers(N),this._addPosterImage(),H(this,void 0,void 0,function*(){yield this._initPlugins(F),t&&D&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maxDeltaTime(){return this._maxDeltaTime}set skybox(e){this._scene.setSkybox(e),this._skybox=e}set envmap(e){this._scene.setEnvMap(e),this._envmap=e}set exposure(e){this._renderer.threeRenderer.toneMappingExposure=e,this._exposure=e}set skyboxBlur(e){this._skyboxBlur=e;const t=this._scene;var s=t.root.environment;s&&t.skybox&&(e?t.skybox.useBlurredHDR(s):t.skybox.useTexture(s))}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set maxDeltaTime(e){this._maxDeltaTime=e}destroy(){this._scene.reset(),this._renderer.stopAnimationLoop(),this._control.destroy(),this._autoResizer.disable(),this._animator.reset(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return H(this,void 0,void 0,function*(){if(!this._src)throw new V(k.PROVIDE_SRC_FIRST,U.PROVIDE_SRC_FIRST);this._autoResize&&this._autoResizer.enable();const e=this._scene,t=this._renderer,s=this._control;var i=this._skybox,r=this._envmap,o=this._background,n=this._meshoptPath;const a=[];if(n&&!Fe.meshoptDecoder&&(yield Fe.setMeshoptDecoder(n)),i||r){const h=new T.AmbientLight;e.add(h,!1);const l=i?e.setSkybox(i):e.setEnvMap(r);a.push(l.then(()=>{e.remove(h)}))}!i&&o&&a.push(e.setBackground(o));o=this._loadModel(this._src);a.push(...o),this._resetLoadingContextOnFinish(a),yield Promise.race(o),s.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),this._initialized=!0,this.trigger(w.READY,{type:w.READY,target:this})})}resize(){const e=this._renderer;e.resize();var t=e.size;this._camera.resize(t),this._control.resize(t),e.threeRenderer.xr.isPresenting||e.defaultRenderLoop(0),this.trigger(w.RESIZE,Object.assign(Object.assign({},t),{type:w.RESIZE,target:this}))}load(t){return H(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t):(this._src=t,yield this.init())})}display(e,{resetCamera:t=!0}={}){var s=this._renderer;const i=this._scene,r=this._camera,o=this._animator;s=s.threeRenderer.xr.isPresenting;if(i.reset(),i.add(e.scene),i.shadowPlane.updateDimensions(e),t&&(r.fit(e,this._center),r.reset(0)),o.reset(),o.setClips(e.animations),0<e.animations.length&&o.play(0),this._model=e,s){const n=this._arManager.activeSession;n&&n.control.syncTargetModel(e)}this.trigger(w.MODEL_CHANGE,{type:w.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return H(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return H(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){const t=this._renderer.canvas;var s=t.toDataURL("png");const i=document.createElement("a");i.href=s,i.download=e,i.click()}_loadModel(e){const s=new Fe(this);if(Array.isArray(e)){const i=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(s,e,t,i))}return[this._loadSingleModel(s,e,0,[!1])]}_loadSingleModel(r,o,n,a){return H(this,void 0,void 0,function*(){var t=a.length-1;this.trigger(w.LOAD_START,{type:w.LOAD_START,target:this,src:o,level:n,maxLevel:t});try{var e=yield r.load(o),s=a.slice(n+1).some(e=>!!e),i=a.some(e=>!!e);if(this.trigger(w.LOAD,{type:w.LOAD,target:this,model:e,level:n,maxLevel:t}),a[n]=!0,s)return;this.display(e,{resetCamera:!i})}catch(e){throw this.trigger(w.LOAD_ERROR,{type:w.LOAD_ERROR,target:this,level:n,maxLevel:t,error:e}),new V(k.MODEL_FAIL_TO_LOAD(o),U.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const s=this._rootEl;if(t){var i=l(t);let e;if(i||(e=>{if(!o(e))return!1;const t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0})(t)){i=i?t:s.querySelector(t);if(!i)throw new V(k.ELEMENT_NOT_FOUND(t),U.ELEMENT_NOT_FOUND);e=i}else{const r=document.createElement("img");r.className=b.POSTER,r.src=t,s.appendChild(r),e=r,this.once(w.READY,()=>{r.parentElement===s&&s.removeChild(r)})}this.once(w.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return H(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return H(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(w.LOAD_FINISH,{type:w.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}ze.VERSION="2.2.1";class Ve{constructor(e={}){this._startLoading=({target:i,level:e})=>{if(0!==e)return;const{type:t="default",loadingLabel:s="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:o="#ffffff",barWidth:n="70%",barHeight:a="10px",barBackground:h="#bbbbbb",barForeground:l="#3e8ed0",spinnerWidth:c="30%",overlayBackground:_="rgba(0, 0, 0, 0.3)"}=this._options,d=document.createElement("div"),u=document.createElement("div"),p=document.createElement("div"),v=document.createElement("div"),m=document.createElement("div");if(d.classList.add("view3d-lb-overlay"),u.classList.add("view3d-lb-wrapper"),v.classList.add("view3d-lb-base"),p.classList.add("view3d-lb-label"),m.classList.add("view3d-lb-filler"),d.style.backgroundColor=_,t!==Ve.TYPE.SPINNER?(v.style.height=a,v.style.backgroundColor=h,m.style.backgroundColor=l):(v.classList.add("type-spinner"),v.style.width=c,v.style.paddingTop=c,m.style.borderWidth=a,m.style.borderColor=l,m.style.borderLeftColor="transparent"),t===Ve.TYPE.TOP?d.classList.add("type-top"):t===Ve.TYPE.DEFAULT&&(v.style.width=n),p.style.color=o,p.innerText=s,v.appendChild(m),u.appendChild(v),u.appendChild(p),d.appendChild(u),i.rootEl.appendChild(d),t!==Ve.TYPE.SPINNER){const g=()=>{if(i.loadingContext.every(e=>e.initialized)){var[e,t]=i.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]);if(!(t<=0)){const s=e/t*100;m.style.width=s.toFixed(2)+"%",e===t&&(p.innerText=r)}}};i.on(w.PROGRESS,g),i.once(w.LOAD_FINISH,()=>{i.off(w.PROGRESS,g)})}i.once(w.LOAD_FINISH,()=>{this._removeOverlay(i)}),this._overlay=d},this._options=e}init(e){return H(this,void 0,void 0,function*(){e.on(w.LOAD_START,this._startLoading)})}teardown(e){e.off(w.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}Ve.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};r={__proto__:null,default:ze,Animation:oe,ARManager:Se,AutoPlayer:De,AutoResizer:ie,Camera:ee,Model:Ae,ModelAnimator:re,Motion:K,Pose:J,Renderer:Y,Scene:X,ShadowPlane:I,Skybox:N,View3DError:V,AnimationControl:$,OrbitControl:Le,RotateControl:xe,TranslateControl:Ce,ZoomControl:Pe,GLTFLoader:Fe,TextureLoader:P,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return H(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(a){return H(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:s="view3d-ar-button",tooltipClass:i="view3d-tooltip"}=this._options;const r=yield a.ar.isAvailable(),o=document.createElement("button"),n=document.createElement("div");t=document.createTextNode(r?e:t);o.classList.add(s),n.classList.add(i),o.disabled=!0,o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',o.appendChild(n),n.appendChild(t),a.rootEl.appendChild(o),this._button=o,a.initialized?yield this._setAvailable(a,o,r):a.once(w.MODEL_CHANGE,()=>{this._setAvailable(a,o,r)})})}_setAvailable(e,t,s){return H(this,void 0,void 0,function*(){s?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:class{constructor(e={}){this._options=e}init(r){return H(this,void 0,void 0,function*(){r.on(w.AR_START,({session:e})=>{const t=e.domOverlay.root;if(t){if(this._cachedElements)Object.values(this._cachedElements).map(e=>{t.contains(e)||t.appendChild(e)});else{const s=document.createElement("div");s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',s.classList.add("view3d-ar-close"),t.appendChild(s),this._cachedElements={closeButton:s}}const s=this._cachedElements["closeButton"],i=()=>{e.exit()};s.addEventListener("click",i),r.once(w.AR_END,()=>{s.parentElement&&s.parentElement.removeChild(s),s.removeEventListener("click",i)})}})})}teardown(){}},LoadingBar:Ve,AUTO:W,EVENTS:w,EASING:E,DEFAULT_CLASS:b,TONE_MAPPING:j,AR_SESSION_TYPE:f,SCENE_VIEWER_MODE:y,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},ERROR_CODES:r};return v(ze,r),ze});
